<!DOCTYPE html>
<html lang="es-CO">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Panel de administraci√≥n de coaches">
    <title>Gesti√≥n de Coaches - Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Prevenir zoom en iOS y scroll horizontal */
        html, body {
            overflow-x: hidden;
            position: relative;
            width: 100%;
        }
        
        /* Asegurar que los inputs tengan m√≠nimo 16px en iOS para evitar auto-zoom */
        input, textarea, select {
            font-size: 16px !important;
        }
        
        /* Para pantallas m√°s grandes, usar tama√±os normales */
        @media (min-width: 640px) {
            input, textarea, select {
                font-size: inherit !important;
            }
        }
        
        /* Prevenir el comportamiento de zoom t√°ctil */
        * {
            touch-action: manipulation;
        }
        
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .truncate-multiline {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            word-break: break-word;
            line-height: 1.3;
            max-height: 3.9em; /* 3 l√≠neas x 1.3em */
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 antialiased min-h-screen flex flex-col">
    
    <!-- Encabezado -->
    <header class="sticky top-0 z-50 bg-white border-b border-gray-200 shadow-sm">
        <div class="container mx-auto px-3 py-3 sm:px-4 sm:py-4 md:px-6 md:py-5">
            <div class="flex items-center justify-between gap-2">
                <div class="min-w-0 flex-1">
                    <h1 class="text-lg sm:text-xl md:text-2xl lg:text-3xl font-bold text-gray-900 truncate">Gesti√≥n de Coaches</h1>
                    <p class="text-xs sm:text-sm text-gray-500 mt-1 hidden sm:block">Administra tus entrenamientos y pagos</p>
                </div>
                <div class="flex items-center gap-1 sm:gap-2 flex-shrink-0">
                    <!-- Input file oculto para importar -->
                    <input type="file" id="input-importar-backup" accept="application/json,.json" class="hidden">
                    
                    <button 
                        id="btn-configuracion"
                        class="p-2 sm:px-3 sm:py-2 text-sm font-medium text-gray-600 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 flex items-center gap-2 shadow-sm"
                        title="Configuraci√≥n del sistema"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-5 sm:w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>
                    
                    <button 
                        id="btn-importar-backup"
                        class="p-2 sm:px-4 sm:py-2 text-xs sm:text-sm font-medium text-gray-700 bg-white border-2 border-green-600 rounded-lg hover:bg-green-50 flex items-center gap-1 sm:gap-2 shadow-sm"
                        title="Importar backup desde archivo JSON"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L9 8m4-4v12" />
                        </svg>
                        <span class="text-green-600 font-semibold hidden sm:inline">Importar</span>
                    </button>
                    
                    <button 
                        id="btn-descargar-backup"
                        class="p-2 sm:px-4 sm:py-2 text-xs sm:text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 flex items-center gap-1 sm:gap-2 shadow-sm"
                        title="Descargar backup de la base de datos"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        <span class="hidden sm:inline">Exportar</span>
                    </button>
                    
                    <button 
                        id="btn-volver-lista"
                        class="hidden p-2 sm:px-4 sm:py-2 text-xs sm:text-sm font-medium text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50"
                    >
                        ‚Üê <span class="hidden sm:inline">Volver a lista</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1 container mx-auto px-3 py-4 sm:px-4 sm:py-6 md:px-6 md:py-8">
        
        <!-- VISTA: Lista de Coaches -->
        <div id="vista-lista-coaches">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-xl font-bold text-gray-900">Mis Coaches</h2>
                    <p class="text-sm text-gray-500 mt-1">Selecciona un coach para ver sus detalles</p>
                </div>
                <button 
                    id="btn-agregar-coach"
                    class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700"
                >
                    + Agregar Coach
                </button>
            </div>

            <!-- Buscador -->
            <div class="mb-4">
                <input 
                    type="text" 
                    id="buscar-coach"
                    placeholder="Buscar coach por nombre..."
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
            </div>

            <!-- Grid de coaches -->
            <div id="grid-coaches" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Se llena din√°micamente -->
            </div>

            <!-- Mensaje vac√≠o -->
            <div id="mensaje-sin-coaches" class="hidden text-center py-12">
                <div class="text-gray-400 text-5xl mb-4">üë§</div>
                <h3 class="text-lg font-semibold text-gray-700 mb-2">No hay coaches registrados</h3>
                <p class="text-sm text-gray-500 mb-4">Comienza agregando tu primer coach</p>
                <button 
                    onclick="document.getElementById('btn-agregar-coach').click()"
                    class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700"
                >
                    + Agregar Coach
                </button>
            </div>
        </div>

        <!-- VISTA: Dashboard del Coach -->
        <div id="vista-dashboard-coach" class="hidden">
            
            <!-- Info del coach y selector de periodo -->
            <div class="bg-white rounded-xl border-2 border-blue-300 shadow-sm p-6 mb-6">
                <!-- Info del coach -->
                <div class="flex items-start justify-between mb-5 pb-5 border-b border-gray-200">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-3">
                            <h2 id="coach-nombre" class="text-2xl font-bold text-gray-900"></h2>
                            <span id="coach-estado-badge" class="px-3 py-1 text-xs font-semibold rounded"></span>
                        </div>
                        <div class="flex items-center gap-6">
                            <div>
                                <p class="text-xs text-gray-500">D√≠as laborables</p>
                                <p id="coach-dias" class="text-sm font-medium text-gray-900 mt-1"></p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500">Total pagado</p>
                                <p id="coach-total-pagos" class="text-sm font-semibold text-blue-600 mt-1">$ 0</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500">Cantidad de pagos</p>
                                <p id="coach-cantidad-pagos" class="text-sm font-semibold text-green-600 mt-1">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Selector de periodo (solo visible si hay pagos) -->
                <div id="contenido-con-pagos" class="hidden">
                    <div class="flex items-center justify-between gap-4">
                        <div class="flex items-center gap-3 flex-1">
                            <span class="text-2xl">üìÖ</span>
                            <div class="flex-1">
                                <label for="select-periodo-pago" class="block text-xs font-medium text-gray-500 mb-1">Periodo visualizado</label>
                                <select 
                                    id="select-periodo-pago"
                                    class="w-full px-3 py-2 text-base font-semibold text-blue-900 border border-blue-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-blue-50"
                                >
                                    <!-- Se llena din√°micamente -->
                                </select>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button 
                                id="btn-ver-historial"
                                onclick="toggleHistorialPagos()"
                                class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700"
                            >
                                üìã Gestionar periodos
                            </button>
                            <button 
                                id="btn-registrar-pago"
                                class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700"
                            >
                                + Nuevo periodo
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Mensaje sin pagos -->
                <div id="mensaje-sin-pagos" class="text-center py-4">
                    <div class="text-blue-400 text-4xl mb-3">üìÖ</div>
                    <p class="text-sm text-gray-600 mb-3">No hay periodos registrados</p>
                    <button 
                        id="btn-registrar-pago-inicio"
                        class="px-5 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700"
                    >
                        + Registrar primer periodo
                    </button>
                </div>
            </div>

            <!-- Contenido del periodo seleccionado -->
            <div id="contenido-calendario-metricas" class="hidden">

                <!-- M√©tricas del periodo seleccionado -->
                <section class="mb-6">
                    <h3 class="text-sm font-medium text-gray-600 mb-3">Estad√≠sticas del periodo seleccionado</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-5 gap-4">
                        <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                            <h3 class="text-xs font-medium text-gray-500">Programadas</h3>
                            <p id="metric-programadas" class="text-2xl font-bold text-gray-900 mt-2">0</p>
                        </div>
                        <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                            <h3 class="text-xs font-medium text-gray-500">Asistidas</h3>
                            <p id="metric-asistidas" class="text-2xl font-bold text-green-600 mt-2">0</p>
                        </div>
                        <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                            <h3 class="text-xs font-medium text-gray-500">Faltas</h3>
                            <p id="metric-faltas" class="text-2xl font-bold text-red-600 mt-2">0</p>
                        </div>
                        <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                            <h3 class="text-xs font-medium text-gray-500">Reposiciones</h3>
                            <p id="metric-reposiciones" class="text-2xl font-bold text-blue-600 mt-2">0</p>
                        </div>
                        <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                            <h3 class="text-xs font-medium text-gray-500">Pendientes</h3>
                            <p id="metric-pendientes" class="text-2xl font-bold text-orange-600 mt-2">0</p>
                        </div>
                    </div>
                </section>

                <!-- Alerta de periodo completado -->
                <div id="alerta-completado" class="hidden bg-green-50 border-2 border-green-400 rounded-xl p-4 mb-6">
                    <div class="flex items-start gap-3">
                        <div class="text-3xl">‚úÖ</div>
                        <div class="flex-1">
                            <h4 class="text-sm font-bold text-green-900 mb-1">¬°Periodo completado!</h4>
                            <p class="text-xs text-green-700">Todas las clases programadas han sido completadas. No hay pendientes en este periodo.</p>
                        </div>
                    </div>
                </div>

                <!-- Alerta de pendientes -->
                <div id="alerta-pendientes" class="hidden bg-orange-50 border-2 border-orange-300 rounded-xl p-4 mb-6">
                    <div class="flex items-start gap-3">
                        <div class="text-3xl">‚ö†Ô∏è</div>
                        <div class="flex-1">
                            <h4 class="text-sm font-bold text-orange-900 mb-1">Tienes <span id="alerta-pendientes-cantidad" class="text-lg">0</span> clase(s) pendiente(s)</h4>
                            <p class="text-xs text-orange-700 mb-3">El periodo actual est√° por terminar o ya termin√≥. Extiende el periodo para agregar m√°s d√≠as y completar las clases pendientes.</p>
                            <button 
                                onclick="abrirModalEditarPeriodo()"
                                class="px-4 py-2 text-sm font-medium text-white bg-orange-600 rounded-lg hover:bg-orange-700"
                            >
                                üìÖ Extender periodo para completar pendientes
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Calendario -->
                <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-3 sm:p-4 md:p-6">
                    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 mb-3 sm:mb-4">
                        <h3 class="text-base sm:text-lg font-bold text-gray-900">Calendario del periodo</h3>
                        <span id="periodo-label" class="text-xs sm:text-sm text-blue-600 font-medium"></span>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 mb-3 sm:mb-4">
                        <p class="text-[10px] sm:text-xs text-gray-500">Las reposiciones solo se pueden marcar en d√≠as no laborales (s√°bados/domingos)</p>
                        <span id="reposiciones-disponibles" class="text-[10px] sm:text-xs font-semibold px-2 sm:px-3 py-1 bg-blue-100 text-blue-700 rounded-full whitespace-nowrap"></span>
                    </div>
                    
                    <div id="calendar-grid" class="overflow-x-auto -mx-3 sm:-mx-4 md:-mx-6 px-3 sm:px-4 md:px-6 pb-2">
                        <!-- Se genera din√°micamente -->
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Modal: Agregar/Editar Coach -->
    <div id="modal-coach" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-xl max-w-lg w-full p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modal-coach-titulo" class="text-xl font-bold text-gray-900">Agregar Coach</h2>
                <button onclick="cerrarModalCoach()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <form id="form-coach" class="space-y-4">
                <div>
                    <label for="coach-nombre-input" class="block text-sm font-medium text-gray-700 mb-1">Nombre del coach *</label>
                    <input 
                        type="text" 
                        id="coach-nombre-input"
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="Ej: Carlos P√©rez"
                    >
                </div>

                <div>
                    <label for="coach-estado-input" class="block text-sm font-medium text-gray-700 mb-1">Estado *</label>
                    <select 
                        id="coach-estado-input"
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                        <option value="activo">Activo</option>
                        <option value="inactivo">Inactivo</option>
                        <option value="pausado">Pausado</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">D√≠as laborables *</label>
                    <div class="flex flex-wrap gap-3">
                        <label class="flex items-center gap-2 text-sm">
                            <input type="checkbox" value="1" class="dia-checkbox rounded" checked>
                            <span>Lunes</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm">
                            <input type="checkbox" value="2" class="dia-checkbox rounded" checked>
                            <span>Martes</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm">
                            <input type="checkbox" value="3" class="dia-checkbox rounded" checked>
                            <span>Mi√©rcoles</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm">
                            <input type="checkbox" value="4" class="dia-checkbox rounded" checked>
                            <span>Jueves</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm">
                            <input type="checkbox" value="5" class="dia-checkbox rounded" checked>
                            <span>Viernes</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm">
                            <input type="checkbox" value="6" class="dia-checkbox rounded">
                            <span>S√°bado</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm">
                            <input type="checkbox" value="0" class="dia-checkbox rounded">
                            <span>Domingo</span>
                        </label>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Selecciona los d√≠as en que el coach entrena. Puedes incluir s√°bado/domingo para reposiciones.</p>
                </div>

                <input type="hidden" id="coach-id-input">

                <div class="flex gap-3 pt-4">
                    <button 
                        type="button"
                        id="btn-cancelar-modal"
                        class="flex-1 px-4 py-2 text-sm font-medium text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50"
                    >
                        Cancelar
                    </button>
                    <button 
                        type="submit"
                        class="flex-1 px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700"
                    >
                        Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Registrar Pago -->
    <div id="modal-pago" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-xl max-w-lg w-full p-6">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h2 class="text-xl font-bold text-gray-900">Registrar Periodo de Entrenamiento</h2>
                    <p class="text-sm text-gray-600 mt-1">Define el periodo de tiempo en el que se va a entrenar y registra el pago asociado</p>
                </div>
                <button onclick="cerrarModalPago()" class="text-gray-400 hover:text-gray-600 flex-shrink-0 ml-4">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <form id="form-pago" class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label for="pago-periodo-inicio" class="block text-sm font-medium text-gray-700 mb-1">Inicio del periodo *</label>
                        <input 
                            type="date" 
                            id="pago-periodo-inicio"
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                    </div>
                    <div>
                        <label for="pago-periodo-fin" class="block text-sm font-medium text-gray-700 mb-1">Fin del periodo *</label>
                        <input 
                            type="date" 
                            id="pago-periodo-fin"
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                    </div>
                </div>
            
                <div>
                    <label for="pago-fecha" class="block text-sm font-medium text-gray-700 mb-1">Fecha de pago *</label>
                    <input 
                        type="date" 
                        id="pago-fecha"
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                </div>

                <div>
                    <label for="pago-monto" class="block text-sm font-medium text-gray-700 mb-1">Monto pagado (COP) *</label>
                    <input 
                        type="text" 
                        id="pago-monto"
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 font-semibold text-lg"
                        placeholder="450.000"
                    >
                    <input type="hidden" id="pago-monto-raw">
                </div>

                <div>
                    <label for="pago-nota" class="block text-sm font-medium text-gray-700 mb-1">Nota (opcional)</label>
                    <textarea 
                        id="pago-nota" 
                        rows="2"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="Observaciones sobre el periodo o el pago..."
                    ></textarea>
                </div>

                <div class="flex gap-3 pt-4">
                    <button 
                        type="button"
                        id="btn-cancelar-pago"
                        class="flex-1 px-4 py-2 text-sm font-medium text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50"
                    >
                        Cancelar
                    </button>
                    <button 
                        type="submit"
                        class="flex-1 px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700"
                    >
                        Guardar Periodo
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: Configuraci√≥n -->
    <div id="modal-configuracion" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-gray-100 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </div>
                    <h2 class="text-xl font-bold text-gray-900">Configuraci√≥n</h2>
                </div>
                <button onclick="cerrarModalConfiguracion()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="p-6 space-y-6">
                <!-- Modo de pruebas -->
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-2xl">üß™</span>
                                <h3 class="text-sm font-bold text-gray-900">Modo de pruebas</h3>
                            </div>
                            <p class="text-xs text-gray-600 mb-3">Activa el modo de pruebas para simular fechas y probar funcionalidades sin afectar los datos reales.</p>
                            
                            <!-- Toggle Switch -->
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="toggle-modo-pruebas" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                <span class="ml-3 text-sm font-medium text-gray-700" id="estado-modo-pruebas">Desactivado</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Informaci√≥n adicional -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <p class="text-xs text-blue-800">
                        <strong>üí° Tip:</strong> El modo de pruebas te permite simular fechas futuras para probar alertas de pendientes y otros comportamientos del sistema.
                    </p>
                </div>
            </div>

            <div class="p-6 border-t border-gray-200">
                <button 
                    onclick="cerrarModalConfiguracion()"
                    class="w-full px-4 py-2 text-sm font-medium text-white bg-gray-800 rounded-lg hover:bg-gray-900"
                >
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="border-t border-gray-200 bg-white mt-auto">
        <div class="container mx-auto px-4 py-4 md:px-6">
            <p class="text-xs text-gray-500 text-center">Sistema de gesti√≥n de coaches - Datos en localStorage</p>
        </div>
    </footer>

    <!-- Panel de pruebas (solo para desarrollo) -->
    <div id="panel-pruebas" class="fixed bottom-2 right-2 sm:bottom-4 sm:right-4 bg-purple-600 text-white p-1.5 sm:p-2 rounded-lg shadow-lg z-50 cursor-pointer text-xs sm:text-sm" onclick="togglePanelPruebas()">
        üß™ Modo Prueba
    </div>
    
    <div id="contenido-panel-pruebas" class="hidden fixed bottom-12 right-2 sm:bottom-16 sm:right-4 bg-white rounded-xl shadow-2xl p-3 sm:p-4 z-50 border-2 border-purple-300 w-[calc(100vw-1rem)] max-w-xs sm:w-80">
        <div class="flex justify-between items-center mb-3">
            <h3 class="font-bold text-gray-900">üß™ Panel de Pruebas</h3>
            <button onclick="togglePanelPruebas()" class="text-gray-400 hover:text-gray-600">‚úï</button>
        </div>
        <div class="space-y-3">
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Simular fecha actual:</label>
                <input 
                    type="date" 
                    id="fecha-simulada"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                >
            </div>
            <button 
                onclick="aplicarFechaSimulada()"
                class="w-full px-4 py-2 text-sm font-medium text-white bg-purple-600 rounded-lg hover:bg-purple-700"
            >
                Aplicar fecha
            </button>
            <button 
                onclick="resetearFecha()"
                class="w-full px-4 py-2 text-sm font-medium text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50"
            >
                Resetear a fecha real
            </button>
            <div id="fecha-actual-info" class="text-xs text-gray-600 text-center pt-2 border-t">
                Fecha real: <span class="font-semibold"></span>
            </div>
        </div>
    </div>

    <!-- Modal Historial de Pagos -->
    <div id="modal-historial-pagos" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden overflow-y-auto p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl my-8 flex flex-col max-h-[calc(100vh-4rem)]">
            <div class="flex justify-between items-center p-6 border-b border-gray-200 flex-shrink-0">
                <h2 id="modal-historial-titulo" class="text-xl font-bold text-gray-900">üìã Todos los periodos</h2>
                <button onclick="cerrarModalHistorialPagos()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-6 overflow-y-auto flex-1 min-h-0">
                <div id="lista-pagos" class="space-y-3">
                    <!-- Se llena din√°micamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Editar Periodo -->
    <div id="modal-editar-periodo" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-6">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h2 class="text-xl font-bold text-gray-900">Editar Periodo</h2>
                    <p class="text-sm text-gray-600 mt-1">Modifica las fechas del periodo de entrenamiento</p>
                </div>
                <button onclick="cerrarModalEditarPeriodo()" class="text-gray-400 hover:text-gray-600 flex-shrink-0 ml-4">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <form id="form-editar-periodo" class="space-y-4">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                    <p class="text-xs font-semibold text-blue-900 mb-1">üí° Extensi√≥n de periodo</p>
                    <p class="text-xs text-blue-800">Las clases programadas se calculan con base en el periodo ORIGINAL. Los d√≠as extras que agregues solo sirven para completar pendientes mediante reposiciones o asistencias tard√≠as.</p>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label for="editar-periodo-inicio" class="block text-sm font-medium text-gray-700 mb-1">Inicio del periodo *</label>
                        <input 
                            type="date" 
                            id="editar-periodo-inicio"
                            disabled
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed"
                        >
                        <p class="text-xs text-gray-500 mt-1">No se puede cambiar</p>
                    </div>
                    <div>
                        <label for="editar-periodo-fin" class="block text-sm font-medium text-gray-700 mb-1">Fin del periodo *</label>
                        <input 
                            type="date" 
                            id="editar-periodo-fin"
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                    </div>
                </div>

                <div>
                    <label for="editar-fecha-pago" class="block text-sm font-medium text-gray-700 mb-1">Fecha de pago *</label>
                    <input 
                        type="date" 
                        id="editar-fecha-pago"
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                </div>

                <div>
                    <label for="editar-monto" class="block text-sm font-medium text-gray-700 mb-1">Monto pagado (COP) *</label>
                    <input 
                        type="text" 
                        id="editar-monto"
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 font-semibold text-lg"
                        placeholder="450.000"
                    >
                </div>

                <div>
                    <label for="editar-nota" class="block text-sm font-medium text-gray-700 mb-1">Nota (opcional)</label>
                    <textarea 
                        id="editar-nota" 
                        rows="2"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="Observaciones sobre el periodo o el pago..."
                    ></textarea>
                </div>

                <div class="flex gap-3 pt-4">
                    <button 
                        type="button"
                        onclick="cerrarModalEditarPeriodo()"
                        class="flex-1 px-4 py-2 text-sm font-medium text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50"
                    >
                        Cancelar
                    </button>
                    <button 
                        type="submit"
                        class="flex-1 px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700"
                    >
                        Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Gestionar Ejercicios -->
    <div id="modal-ejercicios-biblioteca" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[60] p-2 sm:p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] sm:max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center p-3 sm:p-4 border-b border-gray-200 flex-shrink-0">
                <div>
                    <h2 class="text-base sm:text-lg font-bold text-gray-900">üìö Biblioteca de Ejercicios</h2>
                    <p class="text-xs text-gray-500 mt-1">Gestiona tu cat√°logo de ejercicios</p>
                </div>
                <button onclick="cerrarModalBibliotecaEjercicios()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="p-3 sm:p-4 flex-1 overflow-y-auto">
                <!-- Agregar nuevo ejercicio -->
                <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-3 sm:p-4 mb-3 sm:mb-4">
                    <h3 class="text-xs sm:text-sm font-bold text-blue-900 mb-2 sm:mb-3">‚ûï Agregar nuevo ejercicio</h3>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <input 
                            type="text" 
                            id="nuevo-ejercicio-nombre"
                            placeholder="Nombre del ejercicio..."
                            class="flex-1 px-3 py-2 text-xs sm:text-sm border border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                        <button 
                            onclick="agregarEjercicioABiblioteca()"
                            class="px-4 py-2 text-xs sm:text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 whitespace-nowrap"
                        >
                            + Agregar
                        </button>
                    </div>
                </div>
                
                <!-- Buscador -->
                <div class="mb-3">
                    <input 
                        type="text" 
                        id="buscar-ejercicio-biblioteca"
                        placeholder="üîç Buscar ejercicio..."
                        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        oninput="renderBibliotecaEjercicios()"
                    >
                </div>
                
                <!-- Lista de ejercicios -->
                <div id="lista-ejercicios-biblioteca" class="space-y-2">
                    <!-- Se llena din√°micamente -->
                </div>
                
                <div id="mensaje-sin-ejercicios-biblioteca" class="hidden text-center py-8 text-gray-500">
                    <p class="text-sm">No hay ejercicios en la biblioteca</p>
                    <p class="text-xs mt-1">Agrega tu primer ejercicio arriba</p>
                </div>
            </div>
            
            <div class="p-3 sm:p-4 border-t border-gray-200 flex-shrink-0">
                <button 
                    onclick="cerrarModalBibliotecaEjercicios()"
                    class="w-full px-4 py-2 text-xs sm:text-sm font-medium text-white bg-gray-800 rounded-lg hover:bg-gray-900"
                >
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Nota del D√≠a -->
    <div id="modal-nota-dia" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden overflow-y-auto p-2 sm:p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl my-4 sm:my-8 max-h-[95vh] sm:max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-3 sm:p-5 border-b border-gray-200 flex-shrink-0">
                <div>
                    <h2 class="text-lg sm:text-xl font-bold text-gray-900">üèãÔ∏è Rutina del d√≠a</h2>
                    <p id="nota-fecha-display" class="text-xs sm:text-sm text-gray-500 mt-1"></p>
                </div>
                <button onclick="cerrarModalNotaDia()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <form id="form-nota-dia" class="p-3 sm:p-4 space-y-3 sm:space-y-4 overflow-y-auto flex-1">
                <!-- Calentamiento -->
                <div class="bg-orange-50 border border-orange-200 rounded-lg p-3">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input 
                            type="checkbox" 
                            id="calentamiento-check"
                            class="w-4 h-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"
                            checked
                        >
                        <span class="text-sm font-semibold text-orange-900">üî• Incluy√≥ calentamiento</span>
                    </label>
                </div>

                <!-- Tipo de entrenamiento -->
                <div class="grid grid-cols-2 gap-2">
                    <label class="flex items-center gap-2 p-2 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-blue-50 transition-colors has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
                        <input 
                            type="checkbox" 
                            id="tipo-maquinas"
                            class="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                            checked
                        >
                        <span class="text-sm font-medium text-gray-700">‚öôÔ∏è M√°quinas</span>
                    </label>
                    <label class="flex items-center gap-2 p-2 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-green-50 transition-colors has-[:checked]:border-green-500 has-[:checked]:bg-green-50">
                        <input 
                            type="checkbox" 
                            id="tipo-calistenia"
                            class="w-4 h-4 rounded border-gray-300 text-green-600 focus:ring-green-500"
                        >
                        <span class="text-sm font-medium text-gray-700">üí™ Calistenia</span>
                    </label>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                    <!-- Tren trabajado -->
                    <div>
                        <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-2">Tren trabajado</label>
                        <div class="grid grid-cols-1 gap-2">
                            <label class="flex items-center gap-2 p-2 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-purple-50 transition-colors has-[:checked]:border-purple-500 has-[:checked]:bg-purple-50">
                                <input 
                                    type="radio" 
                                    name="tren"
                                    id="tren-superior"
                                    value="superior"
                                    class="w-4 h-4 text-purple-600 focus:ring-purple-500"
                                >
                                <span class="text-sm font-medium text-gray-700">üí™ Tren Superior</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-indigo-50 transition-colors has-[:checked]:border-indigo-500 has-[:checked]:bg-indigo-50">
                                <input 
                                    type="radio" 
                                    name="tren"
                                    id="tren-inferior"
                                    value="inferior"
                                    class="w-4 h-4 text-indigo-600 focus:ring-indigo-500"
                                >
                                <span class="text-sm font-medium text-gray-700">ü¶µ Tren Inferior</span>
                            </label>
                        </div>
                    </div>

                    <!-- Unidad de peso -->
                    <div>
                        <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-2">Unidad de peso</label>
                        <div class="grid grid-cols-1 gap-2">
                            <label class="flex items-center gap-2 p-2 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-teal-50 transition-colors has-[:checked]:border-teal-500 has-[:checked]:bg-teal-50">
                                <input 
                                    type="radio" 
                                    name="unidad-peso"
                                    id="peso-kg"
                                    value="kg"
                                    class="w-4 h-4 text-teal-600 focus:ring-teal-500"
                                    checked
                                >
                                <span class="text-sm font-medium text-gray-700">‚öñÔ∏è Kilogramos (kg)</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-cyan-50 transition-colors has-[:checked]:border-cyan-500 has-[:checked]:bg-cyan-50">
                                <input 
                                    type="radio" 
                                    name="unidad-peso"
                                    id="peso-lb"
                                    value="lb"
                                    class="w-4 h-4 text-cyan-600 focus:ring-cyan-500"
                                >
                                <span class="text-sm font-medium text-gray-700">‚öñÔ∏è Libras (lb)</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Lista de ejercicios -->
                <div>
                    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 sm:gap-0 mb-3">
                        <label class="text-xs sm:text-sm font-bold text-gray-900">Ejercicios realizados</label>
                        <div class="flex gap-2 w-full sm:w-auto">
                            <button 
                                type="button"
                                onclick="abrirModalBibliotecaEjercicios()"
                                class="flex-1 sm:flex-initial px-3 py-1.5 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 flex items-center justify-center gap-1.5"
                            >
                                üìö <span class="hidden xs:inline">Biblioteca</span>
                            </button>
                            <button 
                                type="button"
                                onclick="agregarEjercicio()"
                                class="flex-1 sm:flex-initial px-3 py-1.5 text-xs font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-1"
                            >
                                <span class="text-base">+</span> Agregar
                            </button>
                        </div>
                    </div>
                    <div id="lista-ejercicios" class="space-y-3">
                        <!-- Se llena din√°micamente -->
                    </div>
                    <p class="text-xs text-gray-400 mt-2">üí° Tip: Usa la biblioteca para guardar y reutilizar tus ejercicios favoritos</p>
                </div>

                <!-- Nota adicional (opcional) -->
                <div>
                    <label for="nota-dia-texto" class="block text-sm font-medium text-gray-700 mb-1">Nota adicional (opcional)</label>
                    <textarea 
                        id="nota-dia-texto" 
                        rows="2"
                        maxlength="200"
                        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
                        placeholder="Observaciones, sensaciones, logros..."
                    ></textarea>
                </div>
                
                <div class="flex gap-2 pt-2 border-t flex-shrink-0">
                    <button 
                        type="submit"
                        class="flex-1 bg-blue-600 text-white px-3 sm:px-4 py-2 rounded-lg hover:bg-blue-700 font-medium text-xs sm:text-sm"
                    >
                        üíæ Guardar rutina
                    </button>
                    <button 
                        type="button"
                        onclick="eliminarNotaDia()"
                        class="px-3 sm:px-4 py-2 border border-red-300 text-red-600 rounded-lg hover:bg-red-50 font-medium text-xs sm:text-sm"
                    >
                        üóëÔ∏è
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ========================================
        // CONFIGURACI√ìN Y ESTADO GLOBAL
        // ========================================
        
        const STORAGE_KEY = 'coaches_data';
        const CONFIG_KEY = 'coaches_config';
        const EJERCICIOS_KEY = 'ejercicios_biblioteca';
        
        let currentCoachId = null;
        let currentPagoId = null; // ID del pago/periodo actualmente seleccionado
        let fechaSimulada = null; // Para pruebas: simular una fecha diferente
        
        const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                           'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

        // ========================================
        // GESTI√ìN DE DATOS
        // ========================================

        function loadData() {
            const data = localStorage.getItem(STORAGE_KEY);
            return data ? JSON.parse(data) : { coaches: [], asistencias: {}, pagos: {} };
        }

        function saveData(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function loadConfig() {
            const config = localStorage.getItem(CONFIG_KEY);
            return config ? JSON.parse(config) : { modoPruebas: false };
        }

        function saveConfig(config) {
            localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
        }

        function generateId() {
            return Date.now().toString() + Math.random().toString(36).substr(2, 9);
        }

        // ========================================
        // BIBLIOTECA DE EJERCICIOS
        // ========================================

        function loadEjercicios() {
            const ejercicios = localStorage.getItem(EJERCICIOS_KEY);
            if (ejercicios) {
                return JSON.parse(ejercicios);
            }
            
            // Ejercicios por defecto si la biblioteca est√° vac√≠a
            const ejerciciosDefault = [
                // Pecho
                'Press de banca',
                'Press inclinado con mancuernas',
                'Press declinado',
                'Aperturas con mancuernas',
                'Fondos en paralelas',
                'Press con mancuernas plano',
                'Cruces en polea',
                'Peck deck',
                
                // Espalda
                'Dominadas',
                'Remo con barra',
                'Remo con mancuerna',
                'Jal√≥n al pecho',
                'Jal√≥n tras nuca',
                'Peso muerto',
                'Remo en polea baja',
                'Pull over',
                'Remo en T',
                
                // Hombros
                'Press militar',
                'Press Arnold',
                'Elevaciones laterales',
                'Elevaciones frontales',
                'P√°jaros (elevaciones posteriores)',
                'Press con mancuernas sentado',
                'Encogimientos de hombros',
                
                // Brazos - B√≠ceps
                'Curl con barra',
                'Curl con mancuernas',
                'Curl martillo',
                'Curl concentrado',
                'Curl en polea',
                'Curl predicador',
                
                // Brazos - Tr√≠ceps
                'Press franc√©s',
                'Extensiones en polea',
                'Fondos en banco',
                'Patada de tr√≠ceps',
                'Press cerrado',
                
                // Piernas
                'Sentadilla',
                'Prensa de piernas',
                'Zancadas',
                'Extensiones de cu√°driceps',
                'Curl femoral',
                'Peso muerto rumano',
                'Elevaciones de gemelos',
                'Sentadilla b√∫lgara',
                'Hip thrust',
                'Abductores en m√°quina',
                'Aductores en m√°quina',
                
                // Core/Abdominales
                'Plancha',
                'Abdominales crunch',
                'Elevaciones de piernas',
                'Bicicleta en el suelo',
                'Plancha lateral',
                'Russian twists',
                'Mountain climbers',
                
                // Calistenia
                'Flexiones',
                'Burpees',
                'Sentadilla con peso corporal',
                'Jumping jacks',
                'Dips',
                'Pull-ups',
                'Chin-ups'
            ].sort();
            
            const ejerciciosIniciales = ejerciciosDefault.map(nombre => ({
                id: generateId(),
                nombre: nombre,
                fechaCreacion: new Date().toISOString(),
                porDefecto: true
            }));
            
            saveEjercicios(ejerciciosIniciales);
            return ejerciciosIniciales;
        }

        function saveEjercicios(ejercicios) {
            localStorage.setItem(EJERCICIOS_KEY, JSON.stringify(ejercicios));
        }

        function agregarEjercicioABiblioteca() {
            const input = document.getElementById('nuevo-ejercicio-nombre');
            const nombre = input.value.trim();
            
            if (!nombre) {
                alert('Por favor ingresa el nombre del ejercicio');
                return;
            }
            
            const ejercicios = loadEjercicios();
            
            // Verificar si ya existe
            if (ejercicios.some(e => e.nombre.toLowerCase() === nombre.toLowerCase())) {
                alert('Este ejercicio ya existe en la biblioteca');
                return;
            }
            
            ejercicios.push({
                id: generateId(),
                nombre: nombre,
                fechaCreacion: new Date().toISOString()
            });
            
            ejercicios.sort((a, b) => a.nombre.localeCompare(b.nombre));
            saveEjercicios(ejercicios);
            
            input.value = '';
            renderBibliotecaEjercicios();
        }

        function eliminarEjercicioDeBiblioteca(id) {
            if (!confirm('¬øEliminar este ejercicio de la biblioteca?')) return;
            
            let ejercicios = loadEjercicios();
            ejercicios = ejercicios.filter(e => e.id !== id);
            saveEjercicios(ejercicios);
            renderBibliotecaEjercicios();
        }

        function renderBibliotecaEjercicios() {
            const ejercicios = loadEjercicios();
            const busqueda = document.getElementById('buscar-ejercicio-biblioteca')?.value.toLowerCase() || '';
            const lista = document.getElementById('lista-ejercicios-biblioteca');
            const mensaje = document.getElementById('mensaje-sin-ejercicios-biblioteca');
            
            const ejerciciosFiltrados = ejercicios.filter(e => 
                e.nombre.toLowerCase().includes(busqueda)
            );
            
            if (ejerciciosFiltrados.length === 0) {
                lista.innerHTML = '';
                mensaje?.classList.remove('hidden');
                return;
            }
            
            mensaje?.classList.add('hidden');
            
            lista.innerHTML = ejerciciosFiltrados.map(ejercicio => `
                <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                    <span class="text-sm font-medium text-gray-900">${ejercicio.nombre}</span>
                    <button 
                        onclick="eliminarEjercicioDeBiblioteca('${ejercicio.id}')"
                        class="px-2 py-1 text-xs text-red-600 hover:bg-red-50 rounded"
                    >
                        üóëÔ∏è
                    </button>
                </div>
            `).join('');
        }

        function abrirModalBibliotecaEjercicios() {
            renderBibliotecaEjercicios();
            document.getElementById('modal-ejercicios-biblioteca').classList.remove('hidden');
        }

        function cerrarModalBibliotecaEjercicios() {
            document.getElementById('modal-ejercicios-biblioteca').classList.add('hidden');
        }

        function mostrarSugerenciasEjercicios(input, ejercicioId) {
            const valor = input.value.toLowerCase();
            const sugerenciasDiv = document.getElementById(`sugerencias-${ejercicioId}`);
            
            if (!valor) {
                sugerenciasDiv.classList.add('hidden');
                return;
            }
            
            const ejercicios = loadEjercicios();
            const sugerencias = ejercicios.filter(e => 
                e.nombre.toLowerCase().includes(valor)
            ).slice(0, 5);
            
            if (sugerencias.length === 0) {
                sugerenciasDiv.classList.add('hidden');
                return;
            }
            
            sugerenciasDiv.innerHTML = sugerencias.map(ejercicio => `
                <div 
                    class="px-3 py-2 hover:bg-blue-50 cursor-pointer text-sm"
                    onclick="seleccionarEjercicio('${ejercicioId}', '${ejercicio.nombre.replace(/'/g, "\\'")}')"
                >
                    ${ejercicio.nombre}
                </div>
            `).join('');
            
            sugerenciasDiv.classList.remove('hidden');
        }

        function seleccionarEjercicio(ejercicioId, nombre) {
            const ejercicioDiv = document.getElementById(ejercicioId);
            const input = ejercicioDiv.querySelector('.ejercicio-nombre');
            input.value = nombre;
            
            const sugerenciasDiv = document.getElementById(`sugerencias-${ejercicioId}`);
            sugerenciasDiv.classList.add('hidden');
        }

        // Cerrar sugerencias al hacer clic fuera
        document.addEventListener('click', (e) => {
            if (!e.target.classList.contains('ejercicio-nombre')) {
                document.querySelectorAll('[id^="sugerencias-"]').forEach(div => {
                    div.classList.add('hidden');
                });
            }
        });

        // ========================================
        // UTILIDADES
        // ========================================

        function formatDate(date) {
            if (typeof date === 'string') return date;
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function formatDateDisplay(dateStr) {
            const [y, m, d] = dateStr.split('-');
            const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            const mesTexto = meses[parseInt(m) - 1];
            return `${d} ${mesTexto} ${y}`;
        }

        function calcularFinDeMes(inicioStr) {
            const inicio = new Date(inicioStr + 'T00:00:00');
            const fin = new Date(inicio.getFullYear(), inicio.getMonth() + 1, 0);
            return formatDate(fin);
        }

        // ========================================
        // VISTAS
        // ========================================

        function mostrarVistaLista() {
            document.getElementById('vista-lista-coaches').classList.remove('hidden');
            document.getElementById('vista-dashboard-coach').classList.add('hidden');
            document.getElementById('btn-volver-lista').classList.add('hidden');
            currentCoachId = null;
            currentPagoId = null; // Limpiar periodo seleccionado
            renderCoachesList();
        }

        function mostrarVistaDashboard(coachId) {
            currentCoachId = coachId;
            currentPagoId = null; // Limpiar selecci√≥n de periodo (el usuario debe seleccionar manualmente)
            document.getElementById('vista-lista-coaches').classList.add('hidden');
            document.getElementById('vista-dashboard-coach').classList.remove('hidden');
            document.getElementById('btn-volver-lista').classList.remove('hidden');
            
            renderDashboard();
        }
        
        function toggleHistorialPagos() {
            // Actualizar t√≠tulo con nombre del coach
            const data = loadData();
            const coach = data.coaches.find(c => c.id === currentCoachId);
            if (coach) {
                document.getElementById('modal-historial-titulo').textContent = `üìã Todos los periodos de Coach ${coach.nombre}`;
            }
            
            renderHistorialPagos(); // Actualizar la lista antes de mostrar el modal
            document.getElementById('modal-historial-pagos').classList.remove('hidden');
        }
        
        function cerrarModalHistorialPagos() {
            document.getElementById('modal-historial-pagos').classList.add('hidden');
        }

        // ========================================
        // LISTA DE COACHES
        // ========================================

        function renderCoachesList() {
            const data = loadData();
            const grid = document.getElementById('grid-coaches');
            const mensaje = document.getElementById('mensaje-sin-coaches');
            const busqueda = document.getElementById('buscar-coach').value.toLowerCase();
            
            let coaches = data.coaches.filter(c => 
                c.nombre.toLowerCase().includes(busqueda)
            );

            if (coaches.length === 0) {
                grid.innerHTML = '';
                mensaje.classList.remove('hidden');
                return;
            }

            mensaje.classList.add('hidden');
            
            grid.innerHTML = coaches.map(coach => {
                const diasTexto = getDiasTexto(coach.diasLaborables);
                const pagos = data.pagos[coach.id] || [];
                const totalPagos = pagos.reduce((sum, pago) => sum + (pago.monto || 0), 0);
                
                // Determinar estado y colores
                const estado = coach.estado || 'activo';
                let estadoClasses = '';
                let estadoTexto = '';
                
                switch(estado) {
                    case 'activo':
                        estadoClasses = 'bg-green-100 text-green-700';
                        estadoTexto = 'Activo';
                        break;
                    case 'inactivo':
                        estadoClasses = 'bg-red-100 text-red-700';
                        estadoTexto = 'Inactivo';
                        break;
                    case 'pausado':
                        estadoClasses = 'bg-yellow-100 text-yellow-700';
                        estadoTexto = 'Pausado';
                        break;
                    default:
                        estadoClasses = 'bg-gray-100 text-gray-700';
                        estadoTexto = estado;
                }
                
                return `
                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-5 hover:shadow-md transition-shadow">
                        <div class="mb-4">
                            <div class="flex items-start justify-between mb-3">
                                <h3 class="text-lg font-bold text-gray-900">${coach.nombre}</h3>
                                <span class="px-2 py-1 text-xs font-semibold ${estadoClasses} rounded">${estadoTexto}</span>
                            </div>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-500">D√≠as laborables:</span>
                                    <span class="text-xs font-medium">${diasTexto}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Total pagado:</span>
                                    <span class="text-xs font-semibold text-blue-600">${formatCurrency(totalPagos)}</span>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <button 
                                onclick="mostrarVistaDashboard('${coach.id}')"
                                class="w-full px-3 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors"
                            >
                                üìä Ver Dashboard
                            </button>
                            <div class="flex gap-2">
                                <button 
                                    onclick="event.stopPropagation(); editarCoachDesdeLista('${coach.id}')"
                                    class="flex-1 px-3 py-2 text-xs font-medium text-blue-600 border border-blue-300 rounded-lg hover:bg-blue-50 transition-colors"
                                >
                                    ‚úèÔ∏è Editar
                                </button>
                                <button 
                                    onclick="event.stopPropagation(); eliminarCoachDesdeLista('${coach.id}')"
                                    class="flex-1 px-3 py-2 text-xs font-medium text-red-600 border border-red-300 rounded-lg hover:bg-red-50 transition-colors"
                                >
                                    üóëÔ∏è Eliminar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getDiasTexto(dias) {
            const nombres = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
            return dias.map(d => nombres[d]).join(', ');
        }

        // ========================================
        // DASHBOARD DEL COACH
        // ========================================

        function renderDashboard() {
            const data = loadData();
            const coach = data.coaches.find(c => c.id === currentCoachId);
            
            if (!coach) {
                mostrarVistaLista();
                return;
            }

            // Info del coach
            document.getElementById('coach-nombre').textContent = `Coach ${coach.nombre}`;
            document.getElementById('coach-dias').textContent = getDiasTexto(coach.diasLaborables);
            
            // Mostrar estado con colores
            const estado = coach.estado || 'activo';
            const estadoBadge = document.getElementById('coach-estado-badge');
            switch(estado) {
                case 'activo':
                    estadoBadge.className = 'px-3 py-1 text-xs font-semibold rounded bg-green-100 text-green-700';
                    estadoBadge.textContent = 'Activo';
                    break;
                case 'inactivo':
                    estadoBadge.className = 'px-3 py-1 text-xs font-semibold rounded bg-red-100 text-red-700';
                    estadoBadge.textContent = 'Inactivo';
                    break;
                case 'pausado':
                    estadoBadge.className = 'px-3 py-1 text-xs font-semibold rounded bg-yellow-100 text-yellow-700';
                    estadoBadge.textContent = 'Pausado';
                    break;
                default:
                    estadoBadge.className = 'px-3 py-1 text-xs font-semibold rounded bg-gray-100 text-gray-700';
                    estadoBadge.textContent = estado;
            }
            
            const pagos = data.pagos[currentCoachId] || [];
            const sumaTotalPagos = pagos.reduce((sum, pago) => sum + (pago.monto || 0), 0);
            document.getElementById('coach-total-pagos').textContent = formatCurrency(sumaTotalPagos);
            document.getElementById('coach-cantidad-pagos').textContent = pagos.length;

            // Verificar si hay pagos
            if (pagos.length === 0) {
                // Sin pagos: mostrar mensaje
                document.getElementById('mensaje-sin-pagos').classList.remove('hidden');
                document.getElementById('contenido-con-pagos').classList.add('hidden');
                document.getElementById('contenido-calendario-metricas').classList.add('hidden');
            } else {
                // Con pagos: mostrar contenido
                document.getElementById('mensaje-sin-pagos').classList.add('hidden');
                document.getElementById('contenido-con-pagos').classList.remove('hidden');
                
                // Cargar selector de periodos
                cargarSelectorPeriodos();
                
                // Buscar periodo que contenga la fecha actual
                const fechaActual = fechaSimulada || formatDate(new Date());
                let periodoActual = pagos.find(pago => {
                    return fechaActual >= pago.periodoInicio && fechaActual <= pago.periodoFin;
                });
                
                // Si hay un periodo actual, seleccionarlo autom√°ticamente
                if (periodoActual && !currentPagoId) {
                    currentPagoId = periodoActual.id;
                    const selector = document.getElementById('select-periodo-pago');
                    if (selector) selector.value = currentPagoId;
                }
                
                // Solo renderizar si hay un periodo seleccionado
                if (currentPagoId) {
                    const pagoSeleccionado = pagos.find(p => p.id === currentPagoId);
                    if (pagoSeleccionado) {
                        document.getElementById('contenido-calendario-metricas').classList.remove('hidden');
                        renderCalendarioPeriodo();
                        renderHistorialPagos();
                    } else {
                        // Si el periodo no existe, limpiar selecci√≥n
                        currentPagoId = null;
                        document.getElementById('contenido-calendario-metricas').classList.add('hidden');
                    }
                } else {
                    // No hay periodo seleccionado, ocultar calendario y m√©tricas
                    document.getElementById('contenido-calendario-metricas').classList.add('hidden');
                }
            }
        }

        function cargarSelectorPeriodos() {
            const data = loadData();
            const pagos = (data.pagos[currentCoachId] || []).sort((a, b) => 
                new Date(a.periodoInicio) - new Date(b.periodoInicio)
            );
            
            const selector = document.getElementById('select-periodo-pago');
            
            // Opci√≥n por defecto
            let opciones = '<option value="">Selecciona un periodo...</option>';
            
            // Agregar todos los periodos
            opciones += pagos.map(pago => `
                <option value="${pago.id}">
                    ${formatDateDisplay(pago.periodoInicio)} - ${formatDateDisplay(pago.periodoFin)} 
                    (${formatCurrency(pago.monto)})
                </option>
            `).join('');
            
            selector.innerHTML = opciones;
            
            // Asegurar que el valor seleccionado coincida con currentPagoId
            if (currentPagoId) {
                selector.value = currentPagoId;
                console.log('Selector sincronizado con currentPagoId:', currentPagoId, '- Valor del selector:', selector.value);
            } else {
                selector.value = '';
                console.log('No hay periodo seleccionado - mostrando opci√≥n por defecto');
            }
        }

        // ========================================
        // CALENDARIO
        // ========================================

        function getDiasLaborablesPeriodo(inicio, fin, diasLaborables) {
            const days = [];
            const inicioDate = new Date(inicio + 'T00:00:00');
            const finDate = new Date(fin + 'T00:00:00');
            
            let currentDate = new Date(inicioDate);
            
            while (currentDate <= finDate) {
                const dayOfWeek = currentDate.getDay();
                if (diasLaborables.includes(dayOfWeek)) {
                    days.push(formatDate(currentDate));
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            return days;
        }
        
        function getTodosDiasPeriodo(inicio, fin) {
            const days = [];
            const inicioDate = new Date(inicio + 'T00:00:00');
            const finDate = new Date(fin + 'T00:00:00');
            
            let currentDate = new Date(inicioDate);
            
            while (currentDate <= finDate) {
                days.push({
                    fecha: formatDate(currentDate),
                    diaSemana: currentDate.getDay()
                });
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            return days;
        }

        function renderCalendarioPeriodo() {
            const data = loadData();
            const coach = data.coaches.find(c => c.id === currentCoachId);
            const pago = (data.pagos[currentCoachId] || []).find(p => p.id === currentPagoId);
            
            if (!pago || !currentPagoId) {
                // Ocultar calendario y m√©tricas si no hay periodo seleccionado
                document.getElementById('calendar-grid').innerHTML = '<p class="text-center text-gray-500 py-8">Selecciona un periodo para ver el calendario</p>';
                document.getElementById('periodo-label').textContent = '';
                
                // Limpiar m√©tricas
                document.getElementById('metric-programadas').textContent = '0';
                document.getElementById('metric-asistidas').textContent = '0';
                document.getElementById('metric-faltas').textContent = '0';
                document.getElementById('metric-reposiciones').textContent = '0/0';
                document.getElementById('metric-pendientes').textContent = '0';
                
                const indicador = document.getElementById('reposiciones-disponibles');
                if (indicador) indicador.style.display = 'none';
                
                // Ocultar alertas
                const alertaCompletado = document.getElementById('alerta-completado');
                const alertaPendientes = document.getElementById('alerta-pendientes');
                if (alertaCompletado) alertaCompletado.classList.add('hidden');
                if (alertaPendientes) alertaPendientes.classList.add('hidden');
                
                return;
            }
            
            const grid = document.getElementById('calendar-grid');
            const periodoLabel = document.getElementById('periodo-label');
            
            periodoLabel.textContent = `${formatDateDisplay(pago.periodoInicio)} - ${formatDateDisplay(pago.periodoFin)}`;
            console.log('Renderizando calendario para periodo:', pago.periodoInicio, '-', pago.periodoFin, 'ID:', pago.id);
            
            const days = getTodosDiasPeriodo(pago.periodoInicio, pago.periodoFin);
            const asistencias = data.asistencias[currentCoachId] || {};
            
            // Calcular reposiciones disponibles
            const daysLaborables = getDiasLaborablesPeriodo(pago.periodoInicio, pago.periodoFin, coach.diasLaborables);
            let asistidas = 0;
            daysLaborables.forEach(day => {
                const asist = asistencias[day];
                if (asist?.asistio) asistidas++;
            });
            const programadas = daysLaborables.length;
            const faltas = programadas - asistidas;
            
            let reposicionesExistentes = 0;
            days.forEach(({fecha}) => {
                const asist = asistencias[fecha];
                if (asist?.reposicion) reposicionesExistentes++;
            });
            
            const hayReposicionesDisponibles = reposicionesExistentes < faltas;
            
            let html = `<div class="grid grid-cols-7 gap-1 sm:gap-2" style="min-width: 640px;">`;
            
            // Headers (todos los d√≠as de la semana)
            const diasNombres = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
            diasNombres.forEach(dia => {
                html += `<div class="text-[10px] sm:text-xs font-semibold text-gray-700 text-center py-1 sm:py-2">${dia}</div>`;
            });
            
            // Agregar espacios vac√≠os al inicio si el mes no empieza en domingo
            const primerDia = days[0].diaSemana;
            for (let i = 0; i < primerDia; i++) {
                html += `<div class="border border-transparent rounded-lg p-1 sm:p-2 h-32 sm:h-40 md:h-44"></div>`;
            }
            
            // Obtener fecha actual (solo fecha, sin hora) - usar fecha simulada si existe
            const hoy = fechaSimulada ? new Date(fechaSimulada) : new Date();
            const fechaActual = formatDate(hoy);
            
            // Renderizar todos los d√≠as
            days.forEach(({fecha: dateStr, diaSemana}) => {
                const asist = asistencias[dateStr] || { asistio: false, reposicion: false, nota: '' };
                const esLaborable = coach.diasLaborables.includes(diaSemana);
                const esDiaActual = dateStr === fechaActual;
                
                // Determinar clases de borde
                let borderClasses = '';
                if (esDiaActual) {
                    borderClasses = 'border-4 border-blue-500 shadow-lg';
                } else if (esLaborable) {
                    borderClasses = 'border border-gray-300';
                } else {
                    borderClasses = 'border border-gray-200';
                }
                
                // Obtener informaci√≥n de la rutina si existe
                const tieneRutina = asist.rutina && (asist.rutina.ejercicios?.length > 0 || asist.rutina.nota);
                const numEjercicios = tieneRutina ? (asist.rutina.ejercicios?.length || 0) : 0;
                const tieneCalentamiento = tieneRutina && asist.rutina.calentamiento;
                const tipos = [];
                if (tieneRutina) {
                    if (asist.rutina.tipoMaquinas) tipos.push('‚öôÔ∏è');
                    if (asist.rutina.tipoCalistenia) tipos.push('üí™');
                }
                const trenTexto = tieneRutina && asist.rutina.tren ? 
                    (asist.rutina.tren === 'superior' ? 'üí™ Superior' : 'ü¶µ Inferior') : '';
                
                html += `
                    <div class="${borderClasses} rounded-lg p-1 sm:p-2 ${asist.asistio ? 'bg-green-50' : (esLaborable ? 'bg-white' : 'bg-gray-100')} ${esLaborable ? '' : 'opacity-60'} h-32 sm:h-40 md:h-44 flex flex-col overflow-hidden ${esDiaActual ? 'relative' : ''}">
                        <div class="flex justify-between items-start mb-0.5 sm:mb-1 flex-shrink-0">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-0.5 sm:gap-1 flex-wrap">
                                    <p class="text-[10px] sm:text-xs ${esLaborable ? 'text-gray-700 font-semibold' : 'text-gray-400'}">${formatDateDisplay(dateStr).split(' ').slice(0,2).join(' ')}</p>
                                    ${esDiaActual ? '<span class="px-1 py-0.5 text-[8px] sm:text-xs font-bold bg-blue-500 text-white rounded">HOY</span>' : ''}
                                </div>
                                ${!esLaborable ? '<p class="text-[9px] sm:text-xs text-gray-400 leading-tight">No laboral</p>' : ''}
                            </div>
                            <button 
                                onclick="abrirModalNotaDia('${dateStr}')"
                                class="text-xs sm:text-sm ${tieneRutina ? 'text-blue-600 hover:text-blue-700' : 'text-gray-400 hover:text-gray-600'} flex-shrink-0 ml-0.5 sm:ml-1"
                                title="${tieneRutina ? 'Ver/editar rutina' : 'Agregar rutina'}"
                            >
                                ${tieneRutina ? 'üèãÔ∏è' : '‚ûï'}
                            </button>
                        </div>
                        ${esLaborable ? `
                            <label class="flex items-center gap-0.5 sm:gap-1 text-[10px] sm:text-xs cursor-pointer mb-0.5 sm:mb-1 flex-shrink-0">
                                <input 
                                    type="checkbox" 
                                    ${asist.asistio ? 'checked' : ''}
                                    onchange="toggleAsistencia('${dateStr}')"
                                    class="rounded border-gray-300 flex-shrink-0 w-3 h-3"
                                >
                                <span class="text-gray-900">Asisti√≥</span>
                            </label>
                        ` : `
                            <button 
                                onclick="toggleReposicion('${dateStr}')"
                                class="flex items-center gap-0.5 sm:gap-1 text-[9px] sm:text-xs ${asist.reposicion ? 'text-blue-700 bg-blue-100 hover:bg-blue-200' : (hayReposicionesDisponibles ? 'text-gray-500 bg-gray-100 hover:bg-gray-200' : 'text-gray-400 bg-gray-50 cursor-not-allowed opacity-50')} px-1 sm:px-2 py-0.5 sm:py-1 rounded transition-colors mb-0.5 sm:mb-1 flex-shrink-0"
                                title="${asist.reposicion ? 'Quitar reposici√≥n' : (hayReposicionesDisponibles ? 'Marcar como reposici√≥n' : 'No hay reposiciones disponibles (no hay faltas)')}"
                                ${!asist.reposicion && !hayReposicionesDisponibles ? 'disabled' : ''}
                            >
                                <span class="font-semibold">R</span>
                                <span class="hidden sm:inline">${asist.reposicion ? 'Reposici√≥n' : 'Marcar repos.'}</span>
                            </button>
                        `}
                        <div class="flex-1 overflow-hidden min-h-0">
                            ${tieneRutina ? `
                                <div class="text-[9px] sm:text-xs space-y-0.5 sm:space-y-1">
                                    ${tieneCalentamiento ? '<p class="text-orange-600 font-medium">üî• <span class="hidden sm:inline">Calentamiento</span></p>' : ''}
                                    ${trenTexto ? `<p class="text-purple-700 font-semibold">${trenTexto}</p>` : ''}
                                    ${tipos.length > 0 || numEjercicios > 0 ? `<p class="text-gray-700">${tipos.join(' ')} ${numEjercicios} <span class="hidden sm:inline">ejercicio${numEjercicios !== 1 ? 's' : ''}</span><span class="sm:hidden">ej</span></p>` : ''}
                                    ${asist.rutina.nota ? '<p class="text-gray-600 italic truncate-multiline hidden sm:block">"' + asist.rutina.nota + '"</p>' : ''}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            grid.innerHTML = html;
            
            updateMetrics();
        }

        function toggleAsistencia(dateStr) {
            const data = loadData();
            
            if (!data.asistencias[currentCoachId]) {
                data.asistencias[currentCoachId] = {};
            }
            
            if (!data.asistencias[currentCoachId][dateStr]) {
                data.asistencias[currentCoachId][dateStr] = { asistio: false, reposicion: false, rutina: null };
            }
            
            data.asistencias[currentCoachId][dateStr].asistio = !data.asistencias[currentCoachId][dateStr].asistio;
            saveData(data);
            renderCalendarioPeriodo();
        }

        function toggleReposicion(dateStr) {
            const data = loadData();
            const coach = data.coaches.find(c => c.id === currentCoachId);
            const pago = (data.pagos[currentCoachId] || []).find(p => p.id === currentPagoId);
            
            if (!pago) return;
            
            if (!data.asistencias[currentCoachId]) {
                data.asistencias[currentCoachId] = {};
            }
            
            if (!data.asistencias[currentCoachId][dateStr]) {
                data.asistencias[currentCoachId][dateStr] = { asistio: false, reposicion: false, rutina: null };
            }
            
            const reposicionActual = data.asistencias[currentCoachId][dateStr].reposicion;
            
            // Si est√° intentando MARCAR una reposici√≥n (no quitarla)
            if (!reposicionActual) {
                // Calcular faltas y reposiciones actuales
                const daysLaborables = getDiasLaborablesPeriodo(pago.periodoInicio, pago.periodoFin, coach.diasLaborables);
                const asistencias = data.asistencias[currentCoachId] || {};
                
                let asistidas = 0;
                daysLaborables.forEach(day => {
                    const asist = asistencias[day];
                    if (asist?.asistio) asistidas++;
                });
                
                const programadas = daysLaborables.length;
                const faltas = programadas - asistidas;
                
                // Contar reposiciones ya existentes
                const todosDias = getTodosDiasPeriodo(pago.periodoInicio, pago.periodoFin);
                let reposicionesExistentes = 0;
                todosDias.forEach(({fecha}) => {
                    const asist = asistencias[fecha];
                    if (asist?.reposicion) reposicionesExistentes++;
                });
                
                // Verificar si hay faltas disponibles para reponer
                if (reposicionesExistentes >= faltas) {
                    alert(`No puedes marcar m√°s reposiciones.\n\nFaltas en el periodo: ${faltas}\nReposiciones ya registradas: ${reposicionesExistentes}\n\nSolo puedes reponer las clases que faltaste.`);
                    return;
                }
            }
            
            // Alternar reposici√≥n
            const nuevaReposicion = !data.asistencias[currentCoachId][dateStr].reposicion;
            data.asistencias[currentCoachId][dateStr].reposicion = nuevaReposicion;
            
            // Si se marca reposici√≥n, autom√°ticamente marca asistencia
            // Si se quita reposici√≥n, autom√°ticamente quita asistencia
            data.asistencias[currentCoachId][dateStr].asistio = nuevaReposicion;
            
            saveData(data);
            renderCalendarioPeriodo();
            updateMetrics();
        }

        function updateMetrics() {
            const data = loadData();
            const coach = data.coaches.find(c => c.id === currentCoachId);
            const pago = (data.pagos[currentCoachId] || []).find(p => p.id === currentPagoId);
            
            if (!pago) return;
            
            // Usar periodoFinOriginal si existe, sino usar periodoFin
            // Esto asegura que al extender el periodo, las programadas no aumenten
            const fechaFinParaProgramadas = pago.periodoFinOriginal || pago.periodoFin;
            
            // D√≠as laborables ORIGINALES (para contar programadas)
            const daysLaborablesOriginales = getDiasLaborablesPeriodo(pago.periodoInicio, fechaFinParaProgramadas, coach.diasLaborables);
            const programadas = daysLaborablesOriginales.length;
            
            // D√≠as laborables TOTALES (incluyendo extensi√≥n, para contar asistidas)
            const daysLaborablesTotales = getDiasLaborablesPeriodo(pago.periodoInicio, pago.periodoFin, coach.diasLaborables);
            const asistencias = data.asistencias[currentCoachId] || {};
            
            let asistidas = 0;
            
            // Contar asistencias en TODOS los d√≠as laborables (incluyendo extensi√≥n)
            daysLaborablesTotales.forEach(day => {
                const asist = asistencias[day];
                if (asist?.asistio) asistidas++;
            });
            
            const faltas = programadas - asistidas;
            
            // Contar reposiciones en TODOS los d√≠as del periodo (incluyendo no laborables)
            const todosDias = getTodosDiasPeriodo(pago.periodoInicio, pago.periodoFin);
            let reposiciones = 0;
            
            // Limpiar reposiciones inv√°lidas (si hay m√°s reposiciones que faltas)
            let hayReposicionesInvalidas = false;
            todosDias.forEach(({fecha}) => {
                const asist = asistencias[fecha];
                if (asist?.reposicion) {
                    reposiciones++;
                    // Si hay m√°s reposiciones que faltas, marcar para limpiar
                    if (faltas === 0 || reposiciones > faltas) {
                        hayReposicionesInvalidas = true;
                    }
                }
            });
            
            // Si hay reposiciones inv√°lidas, limpiarlas
            if (hayReposicionesInvalidas && faltas === 0) {
                todosDias.forEach(({fecha}) => {
                    if (asistencias[fecha]?.reposicion) {
                        asistencias[fecha].reposicion = false;
                        asistencias[fecha].asistio = false;
                    }
                });
                saveData(data);
                reposiciones = 0;
            }
            
            // Calcular pendientes (clases que faltan por completar)
            const pendientes = Math.max(0, faltas - reposiciones);
            
            document.getElementById('metric-programadas').textContent = programadas;
            document.getElementById('metric-asistidas').textContent = asistidas;
            document.getElementById('metric-faltas').textContent = faltas;
            document.getElementById('metric-reposiciones').textContent = `${reposiciones}/${faltas}`;
            document.getElementById('metric-pendientes').textContent = pendientes;
            
            // Actualizar indicador de reposiciones disponibles
            const indicador = document.getElementById('reposiciones-disponibles');
            if (indicador) {
                // Solo mostrar si hay faltas
                if (faltas > 0) {
                    const reposicionesDisponibles = faltas - reposiciones;
                    indicador.textContent = `Reposiciones disponibles: ${reposicionesDisponibles} de ${faltas}`;
                    indicador.style.display = 'inline-block';
                    
                    // Cambiar color seg√∫n disponibilidad
                    if (reposicionesDisponibles === 0) {
                        indicador.className = 'text-xs font-semibold px-3 py-1 bg-gray-100 text-gray-500 rounded-full';
                    } else if (reposicionesDisponibles <= 2) {
                        indicador.className = 'text-xs font-semibold px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full';
                    } else {
                        indicador.className = 'text-xs font-semibold px-3 py-1 bg-blue-100 text-blue-700 rounded-full';
                    }
                } else {
                    // Sin faltas, ocultar el indicador
                    indicador.style.display = 'none';
                }
            }
            
            // Mostrar alerta de periodo completado o pendientes
            const alertaCompletado = document.getElementById('alerta-completado');
            const alertaPendientes = document.getElementById('alerta-pendientes');
            
            if (pendientes === 0) {
                // Periodo completado: mostrar alerta verde
                if (alertaCompletado) alertaCompletado.classList.remove('hidden');
                if (alertaPendientes) alertaPendientes.classList.add('hidden');
            } else {
                // Hay pendientes: ocultar alerta verde
                if (alertaCompletado) alertaCompletado.classList.add('hidden');
                
                // Mostrar alerta naranja si el periodo est√° cerca de terminar o ya termin√≥
                if (alertaPendientes) {
                    // Usar fecha simulada si existe, sino usar fecha real
                    const hoy = fechaSimulada ? new Date(fechaSimulada) : new Date();
                    hoy.setHours(0, 0, 0, 0);
                    const fechaFin = new Date(pago.periodoFin);
                    fechaFin.setHours(0, 0, 0, 0);
                    
                    // Calcular d√≠as restantes del periodo
                    const diasRestantes = Math.ceil((fechaFin - hoy) / (1000 * 60 * 60 * 24));
                    
                    // Mostrar alerta si hay pendientes y quedan 3 d√≠as o menos (o ya termin√≥)
                    if (diasRestantes <= 3) {
                        document.getElementById('alerta-pendientes-cantidad').textContent = pendientes;
                        alertaPendientes.classList.remove('hidden');
                    } else {
                        alertaPendientes.classList.add('hidden');
                    }
                }
            }
        }

        // ========================================
        // HISTORIAL DE PAGOS
        // ========================================

        function renderHistorialPagos() {
            const data = loadData();
            const coach = data.coaches.find(c => c.id === currentCoachId);
            const pagos = (data.pagos[currentCoachId] || []).sort((a, b) => 
                new Date(b.fecha) - new Date(a.fecha)
            );
            
            const lista = document.getElementById('lista-pagos');
            
            if (pagos.length === 0) {
                lista.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">No hay periodos registrados</p>';
                return;
            }
            
            lista.innerHTML = pagos.map((pago, index) => {
                // Recalcular estad√≠sticas en tiempo real (pasar periodoFinOriginal si existe)
                const stats = calcularEstadisticasPeriodo(pago.periodoInicio, pago.periodoFin, currentCoachId, pago.montoBase, pago.periodoFinOriginal);
                
                return `
                <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex gap-3 flex-1">
                            <span class="flex-shrink-0 w-7 h-7 rounded-full ${index === 0 ? 'bg-gradient-to-br from-green-500 to-green-600' : 'bg-gradient-to-br from-gray-400 to-gray-500'} text-white text-xs font-bold flex items-center justify-center shadow-sm">
                                ${index + 1}
                            </span>
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <p class="text-xl font-bold text-gray-900">${formatCurrency(pago.monto)}</p>
                                    ${index === 0 ? '<span class="px-2 py-1 text-xs font-semibold bg-green-100 text-green-700 rounded-md">M√°s reciente</span>' : ''}
                                </div>
                                <p class="text-xs text-gray-600">üìÖ Pagado: ${formatDateDisplay(pago.fecha)}</p>
                                <p class="text-xs text-blue-600 font-medium mt-1">
                                    üìÜ ${formatDateDisplay(pago.periodoInicio)} - ${formatDateDisplay(pago.periodoFin)}
                                </p>
                                ${pago.montoBase ? `<p class="text-xs text-gray-500 mt-1">üíµ Base: ${formatCurrency(pago.montoBase)}</p>` : ''}
                            </div>
                        </div>
                        <div class="flex flex-col gap-2">
                            <button 
                                onclick="editarPeriodoDesdeModal('${pago.id}')"
                                class="text-xs text-blue-600 hover:text-blue-700 hover:bg-blue-50 rounded px-3 py-1 transition-colors border border-blue-300 font-medium"
                                title="Editar periodo"
                            >
                                ‚úèÔ∏è Editar
                            </button>
                            <button 
                                onclick="eliminarPago('${pago.id}')"
                                class="text-xs text-red-600 hover:text-red-700 hover:bg-red-50 rounded px-3 py-1 transition-colors border border-red-300 font-medium"
                                title="Eliminar periodo"
                            >
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 sm:grid-cols-5 gap-2 text-xs mt-3 pt-3 border-t border-gray-200">
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-gray-500"></span>
                            <span class="text-gray-600">Prog:</span>
                            <span class="font-bold text-gray-900">${stats.programadas}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-green-500"></span>
                            <span class="text-green-700">Asist:</span>
                            <span class="font-bold text-green-900">${stats.asistidas}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-red-500"></span>
                            <span class="text-red-600">Faltas:</span>
                            <span class="font-bold text-red-900">${stats.faltas}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-blue-500"></span>
                            <span class="text-blue-600">Repos:</span>
                            <span class="font-bold text-blue-900">${stats.reposiciones}/${stats.faltas}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-orange-500"></span>
                            <span class="text-orange-600">Pend:</span>
                            <span class="font-bold text-orange-900">${stats.pendientes}</span>
                        </div>
                    </div>
                    ${pago.nota ? `<p class="text-xs text-gray-600 mt-3 p-2 bg-gray-50 rounded italic">"${pago.nota}"</p>` : ''}
                </div>
            `;
            }).join('');
        }

        function editarPeriodoDesdeModal(pagoId) {
            // Cambiar al periodo seleccionado
            currentPagoId = pagoId;
            
            // Cerrar modal de historial
            cerrarModalHistorialPagos();
            
            // Actualizar el selector
            const selector = document.getElementById('select-periodo-pago');
            selector.value = currentPagoId;
            
            // Renderizar calendario con el periodo seleccionado
            renderCalendarioPeriodo();
            
            // Abrir modal de editar
            abrirModalEditarPeriodo();
        }
        
        function eliminarPago(pagoId) {
            if (!confirm('¬øEst√°s seguro de eliminar este periodo? Se perder√°n todas las asistencias registradas en √©l.')) return;
            
            const data = loadData();
            
            // Encontrar el periodo a eliminar
            const pago = (data.pagos[currentCoachId] || []).find(p => p.id === pagoId);
            
            if (pago) {
                // Obtener todas las fechas del periodo
                const diasPeriodo = getTodosDiasPeriodo(pago.periodoInicio, pago.periodoFin);
                
                // Eliminar asistencias de esas fechas
                if (data.asistencias[currentCoachId]) {
                    diasPeriodo.forEach(({fecha}) => {
                        delete data.asistencias[currentCoachId][fecha];
                    });
                }
            }
            
            // Eliminar el periodo
            data.pagos[currentCoachId] = data.pagos[currentCoachId].filter(p => p.id !== pagoId);
            saveData(data);
            
            // Si era el pago seleccionado, limpiar selecci√≥n
            if (currentPagoId === pagoId) {
                currentPagoId = null;
            }
            
            // Cerrar modal de historial si est√° abierto
            cerrarModalHistorialPagos();
            
            renderDashboard(); // Recargar todo
        }

        // ========================================
        // MODAL COACH
        // ========================================

        function abrirModalCoach(coachId = null) {
            const modal = document.getElementById('modal-coach');
            const titulo = document.getElementById('modal-coach-titulo');
            
            if (coachId) {
                // Editar
                const data = loadData();
                const coach = data.coaches.find(c => c.id === coachId);
                
                titulo.textContent = 'Editar Coach';
                document.getElementById('coach-id-input').value = coach.id;
                document.getElementById('coach-nombre-input').value = coach.nombre;
                document.getElementById('coach-estado-input').value = coach.estado || 'activo';
                
                // Marcar d√≠as
                document.querySelectorAll('.dia-checkbox').forEach(cb => {
                    cb.checked = coach.diasLaborables.includes(parseInt(cb.value));
                });
            } else {
                // Nuevo
                titulo.textContent = 'Agregar Coach';
                document.getElementById('form-coach').reset();
                document.getElementById('coach-id-input').value = '';
                document.getElementById('coach-estado-input').value = 'activo';
                
                // D√≠as por defecto: L-V
                document.querySelectorAll('.dia-checkbox').forEach(cb => {
                    const dia = parseInt(cb.value);
                    cb.checked = dia >= 1 && dia <= 5;
                });
            }
            
            modal.classList.remove('hidden');
        }

        function cerrarModalCoach() {
            document.getElementById('modal-coach').classList.add('hidden');
        }
        
        // Editar coach desde la lista
        function editarCoachDesdeLista(coachId) {
            abrirModalCoach(coachId);
        }
        
        // Eliminar coach desde la lista
        function eliminarCoachDesdeLista(coachId) {
            const data = loadData();
            const coach = data.coaches.find(c => c.id === coachId);
            
            if (!coach) return;
            
            if (!confirm(`¬øEst√°s seguro de eliminar al coach "${coach.nombre}"?\n\nSe eliminar√°n todos sus periodos y asistencias registradas.`)) {
                return;
            }
            
            // Eliminar coach y sus datos asociados
            data.coaches = data.coaches.filter(c => c.id !== coachId);
            delete data.pagos[coachId];
            delete data.asistencias[coachId];
            
            saveData(data);
            renderCoachesList();
        }

        // ========================================
        // MODAL PAGO
        // ========================================

        function calcularEstadisticasPeriodo(inicio, fin, coachId, montoBase, finOriginal = null) {
            const data = loadData();
            const coach = data.coaches.find(c => c.id === coachId);
            const asistencias = data.asistencias[coachId] || {};
            
            // Usar finOriginal si existe para calcular programadas
            const fechaFinParaProgramadas = finOriginal || fin;
            
            // Obtener d√≠as laborables ORIGINALES (para programadas)
            const diasLaborablesOriginales = getDiasLaborablesPeriodo(inicio, fechaFinParaProgramadas, coach.diasLaborables);
            const programadas = diasLaborablesOriginales.length;
            
            // Obtener d√≠as laborables TOTALES (para asistidas)
            const diasLaborablesTotales = getDiasLaborablesPeriodo(inicio, fin, coach.diasLaborables);
            
            let asistidas = 0;
            
            // Contar asistencias en TODOS los d√≠as laborables (incluyendo extensi√≥n)
            diasLaborablesTotales.forEach(day => {
                const asist = asistencias[day];
                if (asist?.asistio) asistidas++;
            });
            
            const faltas = programadas - asistidas;
            
            // Contar reposiciones en TODOS los d√≠as del periodo
            const todosDias = getTodosDiasPeriodo(inicio, fin);
            let reposiciones = 0;
            
            todosDias.forEach(({fecha}) => {
                const asist = asistencias[fecha];
                if (asist?.reposicion) reposiciones++;
            });
            
            // Calcular monto proporcional basado en asistencias
            const porcentajeAsistencia = programadas > 0 ? asistidas / programadas : 1;
            const montoSugerido = montoBase ? Math.round(montoBase * porcentajeAsistencia) : 0;
            
            // Calcular pendientes
            const pendientes = Math.max(0, faltas - reposiciones);
            
            return {
                programadas,
                asistidas,
                faltas,
                reposiciones,
                pendientes,
                montoSugerido
            };
        }

        function formatearMontoInput(valor) {
            // Eliminar todo excepto n√∫meros
            const numero = valor.replace(/\D/g, '');
            if (!numero) return '';
            
            // Formatear con puntos de miles
            return parseInt(numero).toLocaleString('es-CO');
        }
        
        function obtenerValorMontoRaw() {
            const valorFormateado = document.getElementById('pago-monto').value;
            return parseInt(valorFormateado.replace(/\D/g, '') || '0');
        }

        function abrirModalPago() {
            const modal = document.getElementById('modal-pago');
            
            document.getElementById('form-pago').reset();
            
            // Valores por defecto: mes actual
            const hoy = new Date();
            const primerDia = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
            const ultimoDia = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);
            
            document.getElementById('pago-periodo-inicio').value = formatDate(primerDia);
            document.getElementById('pago-periodo-fin').value = formatDate(ultimoDia);
            document.getElementById('pago-fecha').value = formatDate(new Date());
            
            modal.classList.remove('hidden');
        }

        function cerrarModalPago() {
            document.getElementById('modal-pago').classList.add('hidden');
        }

        // ========================================
        // MODAL EDITAR PERIODO
        // ========================================
        
        function abrirModalEditarPeriodo() {
            if (!currentPagoId) {
                alert('Selecciona un periodo primero');
                return;
            }
            
            const data = loadData();
            const pago = (data.pagos[currentCoachId] || []).find(p => p.id === currentPagoId);
            
            if (!pago) return;
            
            document.getElementById('editar-periodo-inicio').value = pago.periodoInicio;
            document.getElementById('editar-periodo-fin').value = pago.periodoFin;
            document.getElementById('editar-fecha-pago').value = pago.fecha;
            document.getElementById('editar-monto').value = formatearMontoInput(pago.monto.toString());
            document.getElementById('editar-nota').value = pago.nota || '';
            document.getElementById('modal-editar-periodo').classList.remove('hidden');
        }
        
        function cerrarModalEditarPeriodo() {
            document.getElementById('modal-editar-periodo').classList.add('hidden');
        }

        // ========================================
        // MODAL NOTA DEL D√çA
        // ========================================
        
        let currentNotaDate = null;
        let ejerciciosCount = 0;
        
        function agregarEjercicio(nombre = '', series = '', repeticiones = '', peso = '') {
            ejerciciosCount++;
            const lista = document.getElementById('lista-ejercicios');
            const id = `ejercicio-${ejerciciosCount}`;
            
            // Contar cu√°ntos ejercicios hay actualmente en la lista
            const numeroEjercicio = lista.children.length + 1;
            
            const ejercicioHTML = `
                <div class="bg-white border-2 border-gray-200 rounded-lg p-2 sm:p-3 hover:border-blue-300 transition-colors" id="${id}">
                    <div class="flex gap-2 mb-2 sm:mb-3">
                        <div class="flex-shrink-0 flex items-center justify-center w-7 h-7 sm:w-8 sm:h-8 bg-blue-600 text-white rounded-full font-bold text-xs sm:text-sm">
                            ${numeroEjercicio}
                        </div>
                        <div class="flex-1 relative">
                            <input 
                                type="text" 
                                placeholder="üîç Nombre del ejercicio..."
                                value="${nombre}"
                                class="w-full px-2 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm font-medium border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 ejercicio-nombre"
                                oninput="mostrarSugerenciasEjercicios(this, '${id}')"
                                onfocus="mostrarSugerenciasEjercicios(this, '${id}')"
                            >
                            <div id="sugerencias-${id}" class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto"></div>
                        </div>
                        <button 
                            type="button"
                            onclick="eliminarEjercicio('${id}')"
                            class="px-2 sm:px-3 py-1.5 sm:py-2 text-red-600 hover:bg-red-50 rounded-lg text-xs sm:text-sm font-bold border-2 border-red-200 hover:border-red-300 transition-colors"
                            title="Eliminar ejercicio"
                        >
                            ‚úï
                        </button>
                    </div>
                    <div class="grid grid-cols-3 gap-2 sm:gap-3">
                        <div>
                            <label class="block text-[10px] sm:text-xs font-semibold text-gray-600 mb-1">Series</label>
                            <input 
                                type="text" 
                                placeholder="3"
                                value="${series}"
                                class="w-full px-2 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm text-center border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-medium ejercicio-series"
                            >
                        </div>
                        <div>
                            <label class="block text-[10px] sm:text-xs font-semibold text-gray-600 mb-1">Reps</label>
                            <input 
                                type="text" 
                                placeholder="12"
                                value="${repeticiones}"
                                class="w-full px-2 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm text-center border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-medium ejercicio-reps"
                            >
                        </div>
                        <div>
                            <label class="block text-[10px] sm:text-xs font-semibold text-gray-600 mb-1">Peso <span class="unidad-peso-label">(kg)</span></label>
                            <input 
                                type="text" 
                                placeholder="50"
                                value="${peso}"
                                class="w-full px-2 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm text-center border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-medium ejercicio-peso"
                            >
                        </div>
                    </div>
                </div>
            `;
            
            lista.insertAdjacentHTML('beforeend', ejercicioHTML);
        }
        
        function eliminarEjercicio(id) {
            document.getElementById(id)?.remove();
            renumerarEjercicios();
        }
        
        function renumerarEjercicios() {
            const lista = document.getElementById('lista-ejercicios');
            const ejercicios = lista.children;
            
            Array.from(ejercicios).forEach((ejercicio, index) => {
                const numeroSpan = ejercicio.querySelector('.flex-shrink-0');
                if (numeroSpan) {
                    numeroSpan.textContent = index + 1;
                }
            });
        }
        
        function actualizarUnidadPeso() {
            const unidad = document.querySelector('input[name="unidad-peso"]:checked')?.value || 'kg';
            document.querySelectorAll('.unidad-peso-label').forEach(label => {
                label.textContent = `(${unidad})`;
            });
        }
        
        function abrirModalNotaDia(dateStr) {
            currentNotaDate = dateStr;
            ejerciciosCount = 0;
            const data = loadData();
            
            if (!data.asistencias[currentCoachId]) {
                data.asistencias[currentCoachId] = {};
            }
            
            if (!data.asistencias[currentCoachId][dateStr]) {
                data.asistencias[currentCoachId][dateStr] = { 
                    asistio: false, 
                    reposicion: false, 
                    rutina: null 
                };
            }
            
            const rutina = data.asistencias[currentCoachId][dateStr].rutina;
            
            document.getElementById('nota-fecha-display').textContent = formatDateDisplay(dateStr);
            
            // Limpiar lista de ejercicios
            document.getElementById('lista-ejercicios').innerHTML = '';
            
            // Cargar datos si existen
            if (rutina) {
                document.getElementById('calentamiento-check').checked = rutina.calentamiento !== undefined ? rutina.calentamiento : true;
                document.getElementById('tipo-maquinas').checked = rutina.tipoMaquinas !== undefined ? rutina.tipoMaquinas : true;
                document.getElementById('tipo-calistenia').checked = rutina.tipoCalistenia || false;
                document.getElementById('nota-dia-texto').value = rutina.nota || '';
                
                // Cargar tren
                if (rutina.tren === 'superior') {
                    document.getElementById('tren-superior').checked = true;
                } else if (rutina.tren === 'inferior') {
                    document.getElementById('tren-inferior').checked = true;
                }
                
                // Cargar unidad de peso
                if (rutina.unidadPeso === 'lb') {
                    document.getElementById('peso-lb').checked = true;
                } else {
                    document.getElementById('peso-kg').checked = true;
                }
                
                // Cargar ejercicios
                if (rutina.ejercicios && rutina.ejercicios.length > 0) {
                    rutina.ejercicios.forEach(ej => {
                        agregarEjercicio(ej.nombre, ej.series, ej.repeticiones, ej.peso);
                    });
                } else {
                    // Agregar un ejercicio vac√≠o por defecto
                    agregarEjercicio();
                }
            } else {
                // Valores por defecto: calentamiento y m√°quinas activados
                document.getElementById('calentamiento-check').checked = true;
                document.getElementById('tipo-maquinas').checked = true;
                document.getElementById('tipo-calistenia').checked = false;
                document.getElementById('nota-dia-texto').value = '';
                
                // Limpiar tren
                document.getElementById('tren-superior').checked = false;
                document.getElementById('tren-inferior').checked = false;
                
                // Unidad de peso por defecto: kg
                document.getElementById('peso-kg').checked = true;
                
                // Agregar un ejercicio vac√≠o por defecto
                agregarEjercicio();
            }
            
            // Actualizar labels de unidad de peso
            actualizarUnidadPeso();
            
            document.getElementById('modal-nota-dia').classList.remove('hidden');
        }
        
        function cerrarModalNotaDia() {
            document.getElementById('modal-nota-dia').classList.add('hidden');
            currentNotaDate = null;
            ejerciciosCount = 0;
        }
        
        function eliminarNotaDia() {
            if (!currentNotaDate) return;
            
            if (!confirm('¬øEliminar la rutina de este d√≠a?')) return;
            
            const data = loadData();
            
            if (data.asistencias[currentCoachId] && data.asistencias[currentCoachId][currentNotaDate]) {
                data.asistencias[currentCoachId][currentNotaDate].rutina = null;
                saveData(data);
                renderCalendarioPeriodo();
            }
            
            cerrarModalNotaDia();
        }

        // ========================================
        // EVENTOS (Se inicializan en DOMContentLoaded)
        // ========================================
        // Nota: Los event listeners principales se registran en inicializarEventListeners()
        
        // Cancelar modal coach
        document.getElementById('btn-cancelar-modal').addEventListener('click', cerrarModalCoach);
        
        // Guardar coach
        document.getElementById('form-coach').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const data = loadData();
            const coachId = document.getElementById('coach-id-input').value;
            
            const diasLaborables = Array.from(document.querySelectorAll('.dia-checkbox:checked'))
                .map(cb => parseInt(cb.value))
                .sort((a, b) => (a === 0 ? 7 : a) - (b === 0 ? 7 : b));
            
            if (diasLaborables.length === 0) {
                alert('Selecciona al menos un d√≠a laborable');
                return;
            }
            
            const coachData = {
                nombre: document.getElementById('coach-nombre-input').value.trim(),
                estado: document.getElementById('coach-estado-input').value,
                diasLaborables
            };
            
            if (coachId) {
                // Editar
                const index = data.coaches.findIndex(c => c.id === coachId);
                data.coaches[index] = { ...data.coaches[index], ...coachData };
            } else {
                // Crear
                coachData.id = generateId();
                coachData.fechaCreacion = formatDate(new Date());
                data.coaches.push(coachData);
            }
            
            saveData(data);
            cerrarModalCoach();
            
            if (currentCoachId) {
                renderDashboard();
            } else {
                renderCoachesList();
            }
        });
        
        // Los event listeners se inicializan en DOMContentLoaded (ver inicializarEventListeners)
        
        // Selector de periodo
        document.getElementById('select-periodo-pago').addEventListener('change', (e) => {
            currentPagoId = e.target.value || null;
            console.log('Periodo cambiado a:', currentPagoId);
            
            if (currentPagoId) {
                document.getElementById('contenido-calendario-metricas').classList.remove('hidden');
                renderCalendarioPeriodo();
                renderHistorialPagos();
            } else {
                document.getElementById('contenido-calendario-metricas').classList.add('hidden');
            }
        });
        
        // Bot√≥n registrar primer pago
        document.getElementById('btn-registrar-pago-inicio').addEventListener('click', abrirModalPago);
        
        // Event listeners de pago se registran en inicializarEventListeners()
        
        document.getElementById('form-pago').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const data = loadData();
            
            if (!data.pagos[currentCoachId]) {
                data.pagos[currentCoachId] = [];
            }
            
            const periodoInicio = document.getElementById('pago-periodo-inicio').value;
            const periodoFin = document.getElementById('pago-periodo-fin').value;
            
            // Validar que no haya solapamiento con otros periodos
            const periodosExistentes = data.pagos[currentCoachId] || [];
            const haySolapamiento = periodosExistentes.some(p => {
                // Verificar si hay solapamiento entre el nuevo periodo y uno existente
                return (periodoInicio <= p.periodoFin && periodoFin >= p.periodoInicio);
            });
            
            if (haySolapamiento) {
                alert('‚ùå Error: Ya existe un periodo con fechas que se solapan con las que intentas registrar.\n\nPor favor, verifica los periodos existentes y elige fechas diferentes.');
                return;
            }
            
            const monto = obtenerValorMontoRaw();
            const stats = calcularEstadisticasPeriodo(periodoInicio, periodoFin, currentCoachId, monto);
            
            const pago = {
                id: generateId(),
                fecha: document.getElementById('pago-fecha').value,
                periodoInicio,
                periodoFin,
                periodoFinOriginal: periodoFin, // Guardar fecha fin original
                montoBase: monto,
                monto: monto,
                nota: document.getElementById('pago-nota').value.trim(),
                stats: {
                    programadas: stats.programadas,
                    asistidas: stats.asistidas,
                    faltas: stats.faltas,
                    reposiciones: stats.reposiciones
                }
            };
            
            data.pagos[currentCoachId].push(pago);
            saveData(data);
            
            // Seleccionar el pago reci√©n creado
            currentPagoId = pago.id;
            
            cerrarModalPago();
            renderDashboard(); // Recargar todo el dashboard
        });
        
        // Guardar cambios del periodo editado
        document.getElementById('form-editar-periodo').addEventListener('submit', (e) => {
            e.preventDefault();
            
            if (!currentPagoId) return;
            
            const data = loadData();
            const pago = (data.pagos[currentCoachId] || []).find(p => p.id === currentPagoId);
            
            if (!pago) return;
            
            const nuevaFechaFin = document.getElementById('editar-periodo-fin').value;
            
            // Si no existe periodoFinOriginal, guardarlo ahora (para periodos antiguos)
            if (!pago.periodoFinOriginal) {
                pago.periodoFinOriginal = pago.periodoFin;
            }
            
            // Validar que la nueva fecha sea posterior o igual a la ORIGINAL
            if (new Date(nuevaFechaFin) < new Date(pago.periodoFinOriginal)) {
                alert('La nueva fecha de fin debe ser posterior o igual a la fecha original del periodo');
                return;
            }
            
            // Validar que la extensi√≥n no se solape con otros periodos
            const periodosExistentes = data.pagos[currentCoachId] || [];
            const haySolapamiento = periodosExistentes.some(p => {
                // Ignorar el periodo que estamos editando
                if (p.id === currentPagoId) return false;
                
                // Verificar si hay solapamiento con otros periodos
                return (pago.periodoInicio <= p.periodoFin && nuevaFechaFin >= p.periodoInicio);
            });
            
            if (haySolapamiento) {
                alert('‚ùå Error: La extensi√≥n del periodo se solapar√≠a con otro periodo existente.\n\nPor favor, elige una fecha que no se solape con otros periodos.');
                return;
            }
            
            // Obtener monto sin formato
            const montoFormateado = document.getElementById('editar-monto').value;
            const monto = parseInt(montoFormateado.replace(/\D/g, '') || '0');
            
            // Actualizar todos los campos (EXCEPTO periodoFinOriginal que se mantiene)
            pago.periodoFin = nuevaFechaFin;
            pago.fecha = document.getElementById('editar-fecha-pago').value;
            pago.monto = monto;
            pago.montoBase = monto;
            pago.nota = document.getElementById('editar-nota').value.trim();
            
            saveData(data);
            
            // Recargar el dashboard
            cerrarModalEditarPeriodo();
            renderDashboard();
        });
        
        // Guardar nota del d√≠a
        document.getElementById('form-nota-dia').addEventListener('submit', (e) => {
            e.preventDefault();
            
            if (!currentNotaDate) return;
            
            const data = loadData();
            
            if (!data.asistencias[currentCoachId]) {
                data.asistencias[currentCoachId] = {};
            }
            
            if (!data.asistencias[currentCoachId][currentNotaDate]) {
                data.asistencias[currentCoachId][currentNotaDate] = { 
                    asistio: false, 
                    reposicion: false, 
                    rutina: null 
                };
            }
            
            // Recopilar ejercicios
            const ejercicios = [];
            document.querySelectorAll('#lista-ejercicios > div').forEach(ejercicioDiv => {
                const nombre = ejercicioDiv.querySelector('.ejercicio-nombre').value.trim();
                const series = ejercicioDiv.querySelector('.ejercicio-series').value.trim();
                const repeticiones = ejercicioDiv.querySelector('.ejercicio-reps').value.trim();
                const peso = ejercicioDiv.querySelector('.ejercicio-peso').value.trim();
                
                // Solo agregar si al menos el nombre tiene contenido
                if (nombre) {
                    ejercicios.push({ nombre, series, repeticiones, peso });
                }
            });
            
            // Obtener tren trabajado
            let tren = null;
            if (document.getElementById('tren-superior').checked) {
                tren = 'superior';
            } else if (document.getElementById('tren-inferior').checked) {
                tren = 'inferior';
            }
            
            // Obtener unidad de peso
            const unidadPeso = document.querySelector('input[name="unidad-peso"]:checked')?.value || 'kg';
            
            // Crear objeto de rutina
            const rutina = {
                calentamiento: document.getElementById('calentamiento-check').checked,
                tipoMaquinas: document.getElementById('tipo-maquinas').checked,
                tipoCalistenia: document.getElementById('tipo-calistenia').checked,
                tren: tren,
                unidadPeso: unidadPeso,
                ejercicios: ejercicios,
                nota: document.getElementById('nota-dia-texto').value.trim()
            };
            
            // Guardar rutina
            data.asistencias[currentCoachId][currentNotaDate].rutina = rutina;
            saveData(data);
            renderCalendarioPeriodo();
            
            cerrarModalNotaDia();
        });
        
        // Formatear monto mientras se escribe (modal crear periodo)
        document.getElementById('pago-monto').addEventListener('input', function(e) {
            const cursorPos = e.target.selectionStart;
            const valorAnterior = e.target.value;
            const valorFormateado = formatearMontoInput(valorAnterior);
            
            e.target.value = valorFormateado;
            
            // Ajustar posici√≥n del cursor
            const diff = valorFormateado.length - valorAnterior.length;
            e.target.setSelectionRange(cursorPos + diff, cursorPos + diff);
        });
        
        // Formatear monto mientras se escribe (modal editar periodo)
        document.getElementById('editar-monto').addEventListener('input', function(e) {
            const cursorPos = e.target.selectionStart;
            const valorAnterior = e.target.value;
            const valorFormateado = formatearMontoInput(valorAnterior);
            
            e.target.value = valorFormateado;
            
            // Ajustar posici√≥n del cursor
            const diff = valorFormateado.length - valorAnterior.length;
            e.target.setSelectionRange(cursorPos + diff, cursorPos + diff);
        });
        
        // Auto-calcular fin de periodo en pago
        document.getElementById('pago-periodo-inicio').addEventListener('change', (e) => {
            const inicio = e.target.value;
            if (inicio && !document.getElementById('pago-periodo-fin').value) {
                document.getElementById('pago-periodo-fin').value = calcularFinDeMes(inicio);
            }
        });
        
        // ========================================
        // INICIALIZACI√ìN
        // ========================================
        // Cerrar modal de historial al hacer clic fuera de √©l
        document.getElementById('modal-historial-pagos')?.addEventListener('click', (e) => {
            if (e.target.id === 'modal-historial-pagos') {
                cerrarModalHistorialPagos();
            }
        });
        
        // Cerrar modal de pago al hacer clic fuera de √©l
        document.getElementById('modal-pago')?.addEventListener('click', (e) => {
            if (e.target.id === 'modal-pago') {
                cerrarModalPago();
            }
        });
        
        // Cerrar modal de coach al hacer clic fuera de √©l
        document.getElementById('modal-coach')?.addEventListener('click', (e) => {
            if (e.target.id === 'modal-coach') {
                cerrarModalCoach();
            }
        });
        
        // Cerrar modal de editar periodo al hacer clic fuera de √©l
        document.getElementById('modal-editar-periodo')?.addEventListener('click', (e) => {
            if (e.target.id === 'modal-editar-periodo') {
                cerrarModalEditarPeriodo();
            }
        });
        
        // Cerrar modal de biblioteca al hacer clic fuera de √©l
        document.getElementById('modal-ejercicios-biblioteca')?.addEventListener('click', (e) => {
            if (e.target.id === 'modal-ejercicios-biblioteca') {
                cerrarModalBibliotecaEjercicios();
            }
        });
        
        // Event listener para agregar ejercicio con Enter
        document.getElementById('nuevo-ejercicio-nombre')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                agregarEjercicioABiblioteca();
            }
        });
        
        // Event listeners para cambiar unidad de peso
        document.addEventListener('change', (e) => {
            if (e.target.name === 'unidad-peso') {
                actualizarUnidadPeso();
            }
        });

        // Cerrar modales con la tecla ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                // Cerrar modal de biblioteca de ejercicios
                const modalBiblioteca = document.getElementById('modal-ejercicios-biblioteca');
                if (modalBiblioteca && !modalBiblioteca.classList.contains('hidden')) {
                    cerrarModalBibliotecaEjercicios();
                    return;
                }
                
                // Cerrar modal de historial si est√° abierto
                const modalHistorial = document.getElementById('modal-historial-pagos');
                if (modalHistorial && !modalHistorial.classList.contains('hidden')) {
                    cerrarModalHistorialPagos();
                }
                
                // Cerrar modal de nota si est√° abierto
                const modalNota = document.getElementById('modal-nota-dia');
                if (modalNota && !modalNota.classList.contains('hidden')) {
                    cerrarModalNotaDia();
                }
                
                // Cerrar modal de pago si est√° abierto
                const modalPago = document.getElementById('modal-pago');
                if (modalPago && !modalPago.classList.contains('hidden')) {
                    cerrarModalPago();
                }
                
                // Cerrar modal de coach si est√° abierto
                const modalCoach = document.getElementById('modal-coach');
                if (modalCoach && !modalCoach.classList.contains('hidden')) {
                    cerrarModalCoach();
                }
                
                // Cerrar modal de editar periodo si est√° abierto
                const modalEditarPeriodo = document.getElementById('modal-editar-periodo');
                if (modalEditarPeriodo && !modalEditarPeriodo.classList.contains('hidden')) {
                    cerrarModalEditarPeriodo();
                }
                
                // Cerrar modal de configuraci√≥n si est√° abierto
                const modalConfiguracion = document.getElementById('modal-configuracion');
                if (modalConfiguracion && !modalConfiguracion.classList.contains('hidden')) {
                    cerrarModalConfiguracion();
                }
            }
        });
        
        // ========================================
        // PANEL DE PRUEBAS (DESARROLLO)
        // ========================================
        
        function togglePanelPruebas() {
            const panel = document.getElementById('contenido-panel-pruebas');
            panel.classList.toggle('hidden');
            
            // Actualizar fecha real
            const fechaRealSpan = document.querySelector('#fecha-actual-info span');
            if (fechaRealSpan) {
                const hoy = new Date();
                fechaRealSpan.textContent = formatDate(hoy);
            }
            
            // Si hay fecha simulada, mostrarla en el input
            if (fechaSimulada) {
                document.getElementById('fecha-simulada').value = fechaSimulada;
            }
        }
        
        function aplicarFechaSimulada() {
            const fecha = document.getElementById('fecha-simulada').value;
            if (!fecha) {
                alert('Por favor selecciona una fecha');
                return;
            }
            
            fechaSimulada = fecha;
            alert(`Fecha simulada aplicada: ${formatDateDisplay(fecha)}\n\nEl sistema ahora act√∫a como si fuera ese d√≠a.`);
            
            // Actualizar la vista si estamos en un dashboard
            if (currentCoachId && currentPagoId) {
                renderCalendarioPeriodo();
            }
        }
        
        function resetearFecha() {
            fechaSimulada = null;
            document.getElementById('fecha-simulada').value = '';
            alert('Fecha reseteada. El sistema ahora usa la fecha real.');
            
            // Actualizar la vista si estamos en un dashboard
            if (currentCoachId && currentPagoId) {
                renderCalendarioPeriodo();
            }
        }

        // ========================================
        // CONFIGURACI√ìN
        // ========================================
        
        function abrirModalConfiguracion() {
            console.log('üìÇ Funci√≥n abrirModalConfiguracion ejecutada');
            const modal = document.getElementById('modal-configuracion');
            
            if (!modal) {
                console.error('‚ùå Modal de configuraci√≥n no encontrado');
                return;
            }
            
            console.log('‚úÖ Modal encontrado, removiendo clase hidden');
            modal.classList.remove('hidden');
            
            // Cargar estado actual del modo de pruebas
            const config = loadConfig();
            const toggle = document.getElementById('toggle-modo-pruebas');
            const estadoTexto = document.getElementById('estado-modo-pruebas');
            
            if (toggle) {
                toggle.checked = config.modoPruebas;
            }
            if (estadoTexto) {
                estadoTexto.textContent = config.modoPruebas ? 'Activado' : 'Desactivado';
            }
            
            console.log('‚úÖ Modal de configuraci√≥n abierto. Modo pruebas:', config.modoPruebas);
        }
        
        function cerrarModalConfiguracion() {
            const modal = document.getElementById('modal-configuracion');
            modal.classList.add('hidden');
        }
        
        function toggleModoPruebas(activo) {
            const config = loadConfig();
            config.modoPruebas = activo;
            saveConfig(config);
            
            // Actualizar texto del estado
            const estadoTexto = document.getElementById('estado-modo-pruebas');
            estadoTexto.textContent = activo ? 'Activado' : 'Desactivado';
            
            // Mostrar u ocultar panel de pruebas
            const panel = document.getElementById('panel-pruebas');
            if (activo) {
                panel.classList.remove('hidden');
            } else {
                panel.classList.add('hidden');
                // Si se desactiva, tambi√©n cerrar el contenido del panel y resetear fecha
                document.getElementById('contenido-panel-pruebas').classList.add('hidden');
                fechaSimulada = null;
                document.getElementById('fecha-simulada').value = '';
            }
            
            console.log('Modo de pruebas:', activo ? 'Activado' : 'Desactivado');
        }
        
        function actualizarVisibilidadPanelPruebas() {
            const config = loadConfig();
            const panel = document.getElementById('panel-pruebas');
            
            if (config.modoPruebas) {
                panel.classList.remove('hidden');
            } else {
                panel.classList.add('hidden');
            }
        }

        // ========================================
        // BACKUP DE BASE DE DATOS
        // ========================================
        
        function descargarBackup() {
            try {
                // Obtener todos los datos del localStorage
                const data = loadData();
                const config = loadConfig();
                
                // Crear un objeto con metadatos adicionales
                const backup = {
                    version: '1.0',
                    fecha_backup: new Date().toISOString(),
                    fecha_backup_legible: formatDateDisplay(formatDate(new Date())) + ' ' + new Date().toLocaleTimeString('es-CO'),
                    datos: data,
                    configuracion: config
                };
                
                // Convertir a JSON con formato legible
                const jsonStr = JSON.stringify(backup, null, 2);
                
                // Crear un blob con el contenido
                const blob = new Blob([jsonStr], { type: 'application/json' });
                
                // Crear un link temporal para descargar
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                
                // Nombre del archivo con fecha
                const fechaArchivo = formatDate(new Date()).replace(/-/g, '');
                const horaArchivo = new Date().toTimeString().slice(0, 8).replace(/:/g, '');
                link.download = `backup_coaches_${fechaArchivo}_${horaArchivo}.json`;
                
                // Simular clic y descargar
                document.body.appendChild(link);
                link.click();
                
                // Limpiar
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                console.log('‚úÖ Backup descargado exitosamente');
            } catch (error) {
                console.error('‚ùå Error al descargar backup:', error);
                alert('Error al crear el backup. Revisa la consola para m√°s detalles.');
            }
        }

        function importarBackup(file) {
            // Validar que sea un archivo JSON
            if (!file.name.endsWith('.json')) {
                alert('‚ùå Por favor selecciona un archivo JSON v√°lido');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    // Parsear el JSON
                    const contenido = JSON.parse(e.target.result);
                    
                    // Validar estructura del backup
                    if (!contenido.datos) {
                        alert('‚ùå El archivo no tiene el formato correcto de backup');
                        return;
                    }
                    
                    const datos = contenido.datos;
                    const configuracion = contenido.configuracion || { modoPruebas: false };
                    
                    // Validar que tenga las propiedades esperadas
                    if (!datos.coaches || !datos.pagos || !datos.asistencias) {
                        alert('‚ùå El backup no contiene todos los datos necesarios (coaches, pagos, asistencias)');
                        return;
                    }
                    
                    // Mostrar informaci√≥n del backup
                    const numCoaches = datos.coaches.length;
                    const numPagos = Object.values(datos.pagos).reduce((sum, arr) => sum + arr.length, 0);
                    const fechaBackup = contenido.fecha_backup_legible || contenido.fecha_backup || 'Desconocida';
                    const modoPruebasTexto = configuracion.modoPruebas ? 'Activado' : 'Desactivado';
                    
                    // Confirmar antes de importar
                    const confirmacion = confirm(
                        `‚ö†Ô∏è ADVERTENCIA: Esta acci√≥n sobrescribir√° TODOS los datos actuales.\n\n` +
                        `Informaci√≥n del backup:\n` +
                        `‚Ä¢ Fecha: ${fechaBackup}\n` +
                        `‚Ä¢ Coaches: ${numCoaches}\n` +
                        `‚Ä¢ Periodos: ${numPagos}\n` +
                        `‚Ä¢ Modo de pruebas: ${modoPruebasTexto}\n\n` +
                        `¬øEst√°s seguro de que deseas continuar?`
                    );
                    
                    if (!confirmacion) {
                        console.log('‚ùå Importaci√≥n cancelada por el usuario');
                        return;
                    }
                    
                    // Guardar los datos y configuraci√≥n en localStorage
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(datos));
                    localStorage.setItem(CONFIG_KEY, JSON.stringify(configuracion));
                    
                    console.log('‚úÖ Backup importado exitosamente:', {
                        coaches: numCoaches,
                        pagos: numPagos,
                        fecha: fechaBackup,
                        modoPruebas: configuracion.modoPruebas
                    });
                    
                    // Mostrar confirmaci√≥n
                    alert(`‚úÖ Backup importado exitosamente!\n\n‚Ä¢ ${numCoaches} coaches\n‚Ä¢ ${numPagos} periodos de pago\n‚Ä¢ Modo de pruebas: ${modoPruebasTexto}`);
                    
                    // Actualizar visibilidad del panel de pruebas
                    actualizarVisibilidadPanelPruebas();
                    
                    // Recargar la vista
                    currentCoachId = null;
                    currentPagoId = null;
                    mostrarVistaLista();
                    
                } catch (error) {
                    console.error('‚ùå Error al importar backup:', error);
                    alert('‚ùå Error al procesar el archivo JSON. Aseg√∫rate de que sea un backup v√°lido.\n\n' + error.message);
                }
            };
            
            reader.onerror = () => {
                console.error('‚ùå Error al leer el archivo');
                alert('‚ùå Error al leer el archivo');
            };
            
            // Leer el archivo como texto
            reader.readAsText(file);
        }

        // ========================================
        // INICIALIZACI√ìN
        // ========================================
        
        function inicializarEventListeners() {
            // Agregar coach
            document.getElementById('btn-agregar-coach')?.addEventListener('click', () => abrirModalCoach());
            
            // Cancelar modal coach
            document.getElementById('btn-cancelar-modal')?.addEventListener('click', cerrarModalCoach);
            
            // Volver a lista
            document.getElementById('btn-volver-lista')?.addEventListener('click', mostrarVistaLista);
            
            // Configuraci√≥n
            document.getElementById('btn-configuracion')?.addEventListener('click', () => {
                console.log('üîß Abriendo modal de configuraci√≥n...');
                abrirModalConfiguracion();
            });
            
            // Toggle modo de pruebas
            document.getElementById('toggle-modo-pruebas')?.addEventListener('change', (e) => {
                toggleModoPruebas(e.target.checked);
            });
            
            // Cerrar modal de configuraci√≥n con clic fuera
            document.getElementById('modal-configuracion')?.addEventListener('click', (e) => {
                if (e.target.id === 'modal-configuracion') {
                    cerrarModalConfiguracion();
                }
            });
            
            // Descargar backup
            document.getElementById('btn-descargar-backup')?.addEventListener('click', descargarBackup);
            
            // Importar backup
            document.getElementById('btn-importar-backup')?.addEventListener('click', () => {
                document.getElementById('input-importar-backup').click();
            });
            
            document.getElementById('input-importar-backup')?.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    importarBackup(file);
                }
                e.target.value = '';
            });
            
            // Buscar coach
            document.getElementById('buscar-coach')?.addEventListener('input', renderCoachesList);
            
            // Registrar pago
            document.getElementById('btn-registrar-pago')?.addEventListener('click', abrirModalPago);
            document.getElementById('btn-cancelar-pago')?.addEventListener('click', cerrarModalPago);
            
            console.log('‚úÖ Event listeners inicializados');
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ DOM Cargado, inicializando aplicaci√≥n...');
            
            // Inicializar event listeners
            inicializarEventListeners();
            
            // Actualizar visibilidad del panel de pruebas seg√∫n configuraci√≥n
            actualizarVisibilidadPanelPruebas();
            
            mostrarVistaLista();
            
            // Actualizar info de fecha real en panel de pruebas
            const fechaRealSpan = document.querySelector('#fecha-actual-info span');
            if (fechaRealSpan) {
                const hoy = new Date();
                fechaRealSpan.textContent = formatDate(hoy);
            }
            
            console.log('‚úÖ Aplicaci√≥n inicializada correctamente');
        });
    </script>
</body>
</html>
