<!DOCTYPE html>
<html lang="es-CO" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Panel de administraci√≥n de coaches">
    <title>Gesti√≥n de Coaches - Panel</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%232563eb;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%233b82f6;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='22' fill='url(%23grad)'/%3E%3Ccircle cx='50' cy='32' r='8' fill='white'/%3E%3Cpath d='M50 42 L38 55 L38 72 L44 72 L44 58 L50 52 L56 58 L56 72 L62 72 L62 55 Z' fill='white'/%3E%3Cpath d='M32 48 L68 48 L68 52 L32 52 Z' fill='white'/%3E%3Ccircle cx='28' cy='50' r='5' fill='white'/%3E%3Ccircle cx='72' cy='50' r='5' fill='white'/%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
        // Dark mode: Cargar preferencia antes de renderizar
        if (localStorage.getItem('darkMode') === 'true' || (!localStorage.getItem('darkMode') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        }
    </script>
    <style>
        /* Prevenir zoom en iOS y scroll horizontal */
        html,
        body {
            overflow-x: hidden;
            position: relative;
            width: 100%;
        }

        /* Asegurar que los inputs tengan m√≠nimo 16px en iOS para evitar auto-zoom */
        input,
        textarea,
        select {
            font-size: 16px !important;
        }

        /* Para pantallas m√°s grandes, usar tama√±os normales */
        @media (min-width: 640px) {

            input,
            textarea,
            select {
                font-size: inherit !important;
            }
        }

        /* Prevenir el comportamiento de zoom t√°ctil */
        * {
            touch-action: manipulation;
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .truncate-multiline {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            word-break: break-word;
            line-height: 1.3;
            max-height: 3.9em;
            /* 3 l√≠neas x 1.3em */
        }

        /* SweetAlert2 Dark Mode Styles */
        .dark .swal2-popup {
            background: rgb(31 41 55) !important;
            border: 1px solid rgb(55 65 81) !important;
        }

        .dark .swal2-title {
            color: rgb(243 244 246) !important;
        }

        .dark .swal2-html-container {
            color: rgb(209 213 219) !important;
        }

        .dark .swal2-input,
        .dark .swal2-textarea {
            background: rgb(17 24 39) !important;
            border-color: rgb(75 85 99) !important;
            color: rgb(243 244 246) !important;
        }

        .dark .swal2-input::placeholder,
        .dark .swal2-textarea::placeholder {
            color: rgb(107 114 128) !important;
        }

        .dark .swal2-validation-message {
            background: rgb(127 29 29) !important;
            color: rgb(254 226 226) !important;
        }

        /* Botones personalizados */
        .swal2-confirm {
            background-color: rgb(37 99 235) !important;
            border-radius: 0.5rem !important;
            padding: 0.625rem 1.25rem !important;
            font-weight: 600 !important;
        }

        .swal2-confirm:hover {
            background-color: rgb(29 78 216) !important;
        }

        .swal2-cancel {
            background-color: rgb(107 114 128) !important;
            border-radius: 0.5rem !important;
            padding: 0.625rem 1.25rem !important;
            font-weight: 600 !important;
        }

        .swal2-cancel:hover {
            background-color: rgb(75 85 99) !important;
        }

        .swal2-deny {
            background-color: rgb(220 38 38) !important;
            border-radius: 0.5rem !important;
            padding: 0.625rem 1.25rem !important;
            font-weight: 600 !important;
        }

        .swal2-deny:hover {
            background-color: rgb(185 28 28) !important;
        }

        /* Checkbox personalizado de asistencia */
        .asistencia-check:checked ~ div {
            background-color: rgb(34 197 94) !important;
            border-color: rgb(34 197 94) !important;
        }

        .asistencia-check:checked ~ div .check-icon {
            opacity: 1 !important;
            transform: scale(1) !important;
        }

        .asistencia-check:not(:checked) ~ div .check-icon {
            opacity: 0 !important;
            transform: scale(0) !important;
        }

        .dark .asistencia-check:checked ~ div {
            background-color: rgb(34 197 94) !important;
            border-color: rgb(34 197 94) !important;
        }
    </style>
</head>

<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 antialiased min-h-screen flex flex-col">

    <!-- Encabezado -->
    <header class="fixed top-0 left-0 right-0 z-[100] bg-white/80 dark:bg-gray-800/80 backdrop-blur-md border-b border-gray-200 dark:border-gray-700 shadow-sm">
        <div class="container mx-auto px-3 py-2 sm:px-4 sm:py-2.5">
            <div class="flex items-center justify-between gap-2">
                <div class="min-w-0 flex-1 flex items-center gap-2">
                    <!-- Logo -->
                    <div class="flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" class="w-8 h-8 sm:w-9 sm:h-9 transition-transform hover:scale-105">
                            <defs>
                                <linearGradient id="logoGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#2563eb;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:1" />
                                </linearGradient>
                            </defs>
                            <!-- Fondo con bordes redondeados -->
                            <rect width="100" height="100" rx="22" fill="url(#logoGrad)"/>
                            <!-- Cabeza de la persona -->
                            <circle cx="50" cy="32" r="8" fill="white"/>
                            <!-- Cuerpo y piernas de la persona levantando -->
                            <path d="M50 42 L38 55 L38 72 L44 72 L44 58 L50 52 L56 58 L56 72 L62 72 L62 55 Z" fill="white"/>
                            <!-- Barra de pesas -->
                            <path d="M32 48 L68 48 L68 52 L32 52 Z" fill="white"/>
                            <!-- Discos de pesas -->
                            <circle cx="28" cy="50" r="5" fill="white"/>
                            <circle cx="72" cy="50" r="5" fill="white"/>
                        </svg>
                    </div>
                    <!-- T√≠tulo -->
                    <div class="min-w-0 flex-1">
                        <h1
                            class="text-base sm:text-lg font-bold text-gray-900 dark:text-white truncate">
                            Gesti√≥n de Coaches</h1>
                        <p class="text-xs text-gray-500 dark:text-gray-400 hidden sm:block">Administra tus
                            entrenamientos y pagos</p>
                    </div>
                </div>
                <div class="flex items-center gap-2 sm:gap-3 flex-shrink-0">
                    <!-- Input file oculto para importar -->
                    <input type="file" id="input-importar-backup" accept="application/json,.json" class="hidden">

                    <button id="btn-volver-lista"
                        class="hidden p-2 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border-2 border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                        title="Volver a la lista">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                    </button>

                    <button id="btn-perfil"
                        class="p-2 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border-2 border-gray-300 dark:border-teal-600 rounded-lg hover:bg-teal-50 dark:hover:bg-teal-900/30 transition-colors"
                        title="Mi Perfil">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                    </button>

                    <button id="btn-dark-mode"
                        class="p-2 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border-2 border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                        title="Cambiar tema">
                        <svg id="icon-sun" class="h-5 w-5 hidden dark:block" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                        <svg id="icon-moon" class="h-5 w-5 block dark:hidden" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                        </svg>
                    </button>

                    <button id="btn-configuracion"
                        class="p-2 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border-2 border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                        title="Configuraci√≥n">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1 container mx-auto px-3 sm:px-4 md:px-6 pt-20 sm:pt-24 pb-4 sm:pb-6 md:pb-8">

        <!-- VISTA: Lista de Coaches -->
        <div id="vista-lista-coaches">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white">Mis Coaches</h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Selecciona un coach para ver sus detalles
                    </p>
                </div>
                <button id="btn-agregar-coach"
                    class="px-4 py-2 text-sm font-medium text-white bg-blue-600 dark:bg-blue-500 rounded-lg hover:bg-blue-700 dark:hover:bg-blue-600 transition-colors">
                    + Agregar Coach
                </button>
            </div>

            <!-- Buscador -->
            <div class="mb-4">
                <input type="text" id="buscar-coach" placeholder="Buscar coach por nombre..."
                    class="w-full sm:w-96 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400">
            </div>

            <!-- Grid de coaches -->
            <div id="grid-coaches" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Se llena din√°micamente -->
            </div>

            <!-- Mensaje vac√≠o -->
            <div id="mensaje-sin-coaches" class="hidden text-center py-12">
                <div class="text-gray-400 text-5xl mb-4">üë§</div>
                <h3 class="text-lg font-semibold text-gray-700 mb-2">No hay coaches registrados</h3>
                <p class="text-sm text-gray-500 mb-4">Comienza agregando tu primer coach</p>
                <button onclick="document.getElementById('btn-agregar-coach').click()"
                    class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">
                    + Agregar Coach
                </button>
            </div>
        </div>

        <!-- VISTA: Dashboard del Coach -->
        <div id="vista-dashboard-coach" class="hidden">

            <!-- Info del coach y selector de periodo -->
            <div
                class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm p-4 sm:p-6 mb-6">
                <!-- Info del coach -->
                <div class="flex flex-col sm:flex-row items-start justify-between gap-4">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-3 flex-wrap">
                            <h2 id="coach-nombre" class="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white capitalize">
                            </h2>
                            <span id="coach-estado-badge" class="px-3 py-1 text-xs font-semibold rounded"></span>
                        </div>
                    </div>

                    <!-- Botones de acci√≥n -->
                    <div class="flex-shrink-0 grid grid-cols-3 gap-2 w-full sm:flex sm:w-auto">
                        <button id="btn-info-coach" onclick="abrirModalInfoCoach()"
                            class="px-2 py-2.5 text-xs font-semibold text-blue-700 dark:text-blue-300 bg-blue-50 dark:bg-blue-900/50 hover:bg-blue-100 dark:hover:bg-blue-900/70 rounded-lg flex flex-col sm:flex-row items-center justify-center gap-1 sm:gap-1.5 transition-colors border border-blue-200 dark:border-blue-700">
                            <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span class="text-[10px] sm:text-xs leading-tight text-center">Ver informaci√≥n</span>
                        </button>
                        <button id="btn-ver-historial" onclick="toggleHistorialPagos()"
                            class="hidden px-2 py-2.5 text-xs font-semibold text-white bg-green-600 dark:bg-green-500 rounded-lg hover:bg-green-700 dark:hover:bg-green-600 flex-col sm:flex-row items-center justify-center gap-1 sm:gap-1.5 transition-colors">
                            <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                            <span class="text-[10px] sm:text-xs leading-tight text-center">Gestionar periodos</span>
                        </button>
                        <button id="btn-registrar-pago"
                            class="px-2 py-2.5 text-xs font-semibold text-white bg-blue-600 dark:bg-blue-500 rounded-lg hover:bg-blue-700 dark:hover:bg-blue-600 flex flex-col sm:flex-row items-center justify-center gap-1 sm:gap-1.5 transition-colors">
                            <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4v16m8-8H4" />
                            </svg>
                            <span class="text-[10px] sm:text-xs leading-tight text-center">Nuevo periodo</span>
                        </button>
                    </div>
                </div>

                <!-- Mensaje sin pagos -->
                <div id="mensaje-sin-pagos" class="text-center py-8 border-t border-gray-200 dark:border-gray-700 mt-4">
                    <div class="flex justify-center mb-3">
                        <svg class="w-16 h-16 text-gray-300 dark:text-gray-600" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">No hay periodos registrados todav√≠a</p>
                    <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">Usa el bot√≥n "Nuevo periodo" de arriba para
                        crear el primero</p>
                </div>
            </div>

            <!-- Contenido del periodo seleccionado -->
            <div id="contenido-calendario-metricas" class="hidden">

                <!-- M√©tricas del periodo seleccionado -->
                <section class="mb-4">
                    
                    <div class="flex items-center gap-2 mb-2">
                        <svg class="w-5 h-5 text-gray-600 dark:text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                        <h3 class="text-sm sm:text-base font-bold text-gray-900 dark:text-white">Estad√≠sticas del periodo seleccionado</h3>
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-2">
                        
                        <!-- Programadas -->
                        <div class="bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 shadow-sm p-2 hover:shadow-md transition-all">
                            <div class="flex items-center gap-2 mb-1">
                                <div class="bg-gray-200 dark:bg-gray-600 p-1 rounded-md">
                                    <svg class="w-3 h-3 text-gray-700 dark:text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                    </svg>
                                </div>
                                <h3 class="text-[9px] sm:text-[10px] font-semibold text-gray-600 dark:text-gray-300">Programadas</h3>
                            </div>
                            <p id="metric-programadas" class="text-lg sm:text-xl font-bold text-gray-900 dark:text-white">0</p>
                        </div>

                        <!-- Asistidas -->
                        <div class="bg-gradient-to-br from-green-50 to-green-100 dark:from-green-900/30 dark:to-green-800/30 rounded-lg border border-green-200 dark:border-green-700 shadow-sm p-2 hover:shadow-md transition-all">
                            <div class="flex items-center gap-2 mb-1">
                                <div class="bg-green-200 dark:bg-green-700 p-1 rounded-md">
                                    <svg class="w-3 h-3 text-green-700 dark:text-green-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </div>
                                <h3 class="text-[9px] sm:text-[10px] font-semibold text-green-700 dark:text-green-300">Asistidas</h3>
                            </div>
                            <p id="metric-asistidas" class="text-lg sm:text-xl font-bold text-green-700 dark:text-green-400">0</p>
                        </div>

                        <!-- Faltas -->
                        <div class="bg-gradient-to-br from-red-50 to-red-100 dark:from-red-900/30 dark:to-red-800/30 rounded-lg border border-red-200 dark:border-red-700 shadow-sm p-2 hover:shadow-md transition-all">
                            <div class="flex items-center gap-2 mb-1">
                                <div class="bg-red-200 dark:bg-red-700 p-1 rounded-md">
                                    <svg class="w-3 h-3 text-red-700 dark:text-red-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </div>
                                <h3 class="text-[9px] sm:text-[10px] font-semibold text-red-700 dark:text-red-300">Faltas</h3>
                            </div>
                            <p id="metric-faltas" class="text-lg sm:text-xl font-bold text-red-700 dark:text-red-400">0</p>
                        </div>

                        <!-- Reprogramaciones -->
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/30 dark:to-blue-800/30 rounded-lg border border-blue-200 dark:border-blue-700 shadow-sm p-2 hover:shadow-md transition-all">
                            <div class="flex items-center gap-2 mb-1">
                                <div class="bg-blue-200 dark:bg-blue-700 p-1 rounded-md">
                                    <svg class="w-3 h-3 text-blue-700 dark:text-blue-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                    </svg>
                                </div>
                                <h3 class="text-[9px] sm:text-[10px] font-semibold text-blue-700 dark:text-blue-300">Reprog.</h3>
                            </div>
                            <p id="metric-reprogramaciones" class="text-lg sm:text-xl font-bold text-blue-700 dark:text-blue-400">0/0</p>
                        </div>

                        <!-- Pendientes -->
                        <div class="bg-gradient-to-br from-orange-50 to-orange-100 dark:from-orange-900/30 dark:to-orange-800/30 rounded-lg border border-orange-200 dark:border-orange-700 shadow-sm p-2 hover:shadow-md transition-all">
                            <div class="flex items-center gap-2 mb-1">
                                <div class="bg-orange-200 dark:bg-orange-700 p-1 rounded-md">
                                    <svg class="w-3 h-3 text-orange-700 dark:text-orange-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </div>
                                <h3 class="text-[9px] sm:text-[10px] font-semibold text-orange-700 dark:text-orange-300">Pendientes</h3>
                            </div>
                            <p id="metric-pendientes" class="text-lg sm:text-xl font-bold text-orange-700 dark:text-orange-400">0</p>
                        </div>

                    </div>
                </section>

                <div id="alerta-completado" class="hidden bg-green-50 border-2 border-green-400 rounded-xl p-4 mb-6">
                    <div class="flex items-start gap-3">
                        <div class="text-3xl">‚úÖ</div>
                        <div class="flex-1">
                            <h4 class="text-sm font-bold text-green-900 mb-1">¬°Periodo completado!</h4>
                            <p class="text-xs text-green-700">Todas las clases programadas han sido completadas. No hay
                                pendientes en este periodo.</p>
                        </div>
                    </div>
                </div>

                <!-- Alerta de pendientes -->
                <div id="alerta-pendientes" class="hidden bg-orange-50 border-2 border-orange-300 rounded-xl p-4 mb-6">
                    <div class="flex items-start gap-3">
                        <div class="flex-shrink-0">
                            <svg class="w-8 h-8 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                        </div>
                        <div class="flex-1">
                            <h4 class="text-sm font-bold text-orange-900 mb-1">Tienes <span
                                    id="alerta-pendientes-cantidad" class="text-lg">0</span> clase(s) pendiente(s)</h4>
                            <p class="text-xs text-orange-700 mb-3">El periodo actual est√° por terminar o ya termin√≥.
                                Extiende el periodo para agregar m√°s d√≠as y completar las clases pendientes.</p>
                            <button onclick="abrirModalEditarPeriodo()"
                                class="px-4 py-2 text-sm font-medium text-white bg-orange-600 rounded-lg hover:bg-orange-700 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                <span>Extender periodo para completar pendientes</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Calendario -->
                <div
                    class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm p-3 sm:p-4 md:p-6">
                    <div
                        class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 mb-3 sm:mb-4">
                        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3 flex-1">
                            <div class="flex items-center gap-2">
                                <svg class="w-5 h-5 text-gray-600 dark:text-gray-400 flex-shrink-0" fill="none"
                                    stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                <h3 class="text-base sm:text-lg font-bold text-gray-900 dark:text-white">Periodo de
                                    entrenamiento</h3>
                            </div>
                            <select id="select-periodo-pago"
                                class="px-3 py-1.5 text-xs sm:text-sm font-semibold text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-blue-500 dark:focus:border-blue-400 hover:border-gray-400 dark:hover:border-gray-500 transition-colors">
                                <!-- Se llena din√°micamente -->
                            </select>
                        </div>
                        <div class="flex gap-1 bg-gray-100 dark:bg-gray-700 p-1 rounded-lg">
                            <button onclick="cambiarVistaCalendario('mensual')" id="vista-mensual-btn"
                                class="vista-calendario-btn px-3 py-1.5 text-xs font-medium rounded-md transition-colors bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm"
                                title="Vista mensual">
                                <svg class="w-4 h-4 m-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                <span class="hidden sm:inline ml-1">Mensual</span>
                            </button>
                            <button onclick="cambiarVistaCalendario('semanal')" id="vista-semanal-btn"
                                class="vista-calendario-btn px-3 py-1.5 text-xs font-medium text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white hover:bg-white/50 dark:hover:bg-gray-600/50 rounded-md transition-colors"
                                title="Vista semanal">
                                <svg class="w-4 h-4 m-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                                </svg>
                                <span class="hidden sm:inline ml-1">Semanal</span>
                            </button>
                            <button onclick="cambiarVistaCalendario('lista')" id="vista-lista-btn"
                                class="vista-calendario-btn px-3 py-1.5 text-xs font-medium text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white hover:bg-white/50 dark:hover:bg-gray-600/50 rounded-md transition-colors"
                                title="Vista lista">
                                <svg class="w-4 h-4 m-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                                </svg>
                                <span class="hidden sm:inline ml-1">Lista</span>
                            </button>
                        </div>
                    </div>

                    <div
                        class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 mb-3 sm:mb-4">
                        <p class="text-[10px] sm:text-xs text-gray-500">Las reprogramaciones solo se pueden marcar en
                            d√≠as no laborales (s√°bados/domingos)</p>
                        <span id="reprogramaciones-disponibles"
                            class="text-[10px] sm:text-xs font-semibold px-2 sm:px-3 py-1 bg-blue-100 text-blue-700 rounded-full whitespace-nowrap"></span>
                    </div>

                    <div id="calendar-grid" class="overflow-x-auto -mx-3 sm:-mx-4 md:-mx-6 px-3 sm:px-4 md:px-6 pb-2">
                        <!-- Se genera din√°micamente -->
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Modal: Agregar/Editar Coach -->
    <div id="modal-coach"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-2 sm:p-4 z-[200] overflow-y-auto">
        <div
            class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-lg w-full my-4 sm:my-8 max-h-[95vh] sm:max-h-[90vh] flex flex-col">
            <div
                class="flex justify-between items-center p-3 sm:p-5 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
                <div class="flex items-center gap-2">
                    <svg class="w-6 h-6 text-gray-700 dark:text-gray-300 flex-shrink-0" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <div>
                        <h2 id="modal-coach-titulo" class="text-lg sm:text-xl font-bold text-gray-900 dark:text-white">
                            Agregar Coach</h2>
                    </div>
                </div>
                <button onclick="cerrarModalCoach()"
                    class="text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300">
                    <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <form id="form-coach" class="p-3 sm:p-5 space-y-4 overflow-y-auto flex-1">
                <div>
                    <label for="coach-nombre-input"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nombre del coach
                        *</label>
                    <input type="text" id="coach-nombre-input" required
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400"
                        placeholder="Ej: Carlos P√©rez">
                </div>

                <div>
                    <label for="coach-estado-input"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Estado *</label>
                    <select id="coach-estado-input" required
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400">
                        <option value="activo">Activo</option>
                        <option value="inactivo">Inactivo</option>
                        <option value="pausado">Pausado</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">D√≠as laborables
                        *</label>
                    <div class="flex flex-wrap gap-3">
                        <label class="flex items-center gap-2 text-sm text-gray-900 dark:text-gray-100">
                            <input type="checkbox" value="1" class="dia-checkbox rounded" checked>
                            <span>Lunes</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-gray-900 dark:text-gray-100">
                            <input type="checkbox" value="2" class="dia-checkbox rounded" checked>
                            <span>Martes</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-gray-900 dark:text-gray-100">
                            <input type="checkbox" value="3" class="dia-checkbox rounded" checked>
                            <span>Mi√©rcoles</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-gray-900 dark:text-gray-100">
                            <input type="checkbox" value="4" class="dia-checkbox rounded" checked>
                            <span>Jueves</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-gray-900 dark:text-gray-100">
                            <input type="checkbox" value="5" class="dia-checkbox rounded" checked>
                            <span>Viernes</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-gray-900 dark:text-gray-100">
                            <input type="checkbox" value="6" class="dia-checkbox rounded">
                            <span>S√°bado</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-gray-900 dark:text-gray-100">
                            <input type="checkbox" value="0" class="dia-checkbox rounded">
                            <span>Domingo</span>
                        </label>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Selecciona los d√≠as en que el coach
                        entrena. Puedes incluir s√°bado/domingo para reprogramaciones.</p>
                </div>

                <input type="hidden" id="coach-id-input">
            </form>

            <div
                class="border-t border-gray-200 dark:border-gray-700 p-3 sm:p-4 flex flex-col sm:flex-row gap-2 sm:gap-3 flex-shrink-0">
                <button type="submit" form="form-coach"
                    class="flex-1 px-4 py-2.5 sm:py-3 text-sm font-semibold text-white bg-blue-600 dark:bg-blue-500 rounded-lg hover:bg-blue-700 dark:hover:bg-blue-600 transition-colors flex items-center justify-center gap-2">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    Guardar
                </button>
                <button type="button" id="btn-cancelar-modal" onclick="cerrarModalCoach()"
                    class="px-4 py-2.5 sm:py-3 text-sm font-semibold text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Registrar Pago -->
    <div id="modal-pago"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-2 sm:p-4 z-[200] overflow-y-auto">
        <div
            class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-lg w-full my-4 sm:my-8 max-h-[95vh] sm:max-h-[90vh] flex flex-col">
            <div
                class="flex justify-between items-center p-3 sm:p-5 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
                <div class="flex items-center gap-2">
                    <svg class="w-6 h-6 text-gray-700 flex-shrink-0" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    <div>
                        <h2 class="text-lg sm:text-xl font-bold text-gray-900 dark:text-white">Nuevo Periodo</h2>
                        <p class="text-xs sm:text-sm text-gray-500 mt-1">Registrar periodo de entrenamiento</p>
                    </div>
                </div>
                <button onclick="cerrarModalPago()"
                    class="text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300">
                    <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <form id="form-pago" class="p-3 sm:p-5 space-y-4 overflow-y-auto flex-1">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label for="pago-periodo-inicio"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Inicio del periodo
                            *</label>
                        <input type="date" id="pago-periodo-inicio" required
                            class="w-full px-3 py-2.5 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400"
                            style="color-scheme: light dark;">
                    </div>
                    <div>
                        <label for="pago-periodo-fin"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Fin del periodo
                            *</label>
                        <input type="date" id="pago-periodo-fin" required
                            class="w-full px-3 py-2.5 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400"
                            style="color-scheme: light dark;">
                    </div>
                </div>

                <div>
                    <label for="pago-fecha"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Fecha de pago *</label>
                    <input type="date" id="pago-fecha" required
                        class="w-full px-3 py-2.5 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400"
                        style="color-scheme: light dark;">
                </div>

                <div>
                    <label for="pago-monto"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Monto pagado (COP)
                        *</label>
                    <input type="text" id="pago-monto" inputmode="numeric" pattern="[0-9.]*" required
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 font-semibold text-lg"
                        placeholder="450.000">
                    <input type="hidden" id="pago-monto-raw">
                </div>

                <div>
                    <label for="pago-nota" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nota
                        (opcional)</label>
                    <textarea id="pago-nota" rows="2"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400"
                        placeholder="Observaciones sobre el periodo o el pago..."></textarea>
                </div>
            </form>

            <div
                class="border-t border-gray-200 dark:border-gray-700 p-3 sm:p-4 flex flex-col sm:flex-row gap-2 sm:gap-3 flex-shrink-0">
                <button type="submit" form="form-pago"
                    class="flex-1 px-4 py-2.5 sm:py-3 text-sm font-semibold text-white bg-blue-600 dark:bg-blue-500 rounded-lg hover:bg-blue-700 dark:hover:bg-blue-600 transition-colors flex items-center justify-center gap-2">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    Guardar Periodo
                </button>
                <button type="button" id="btn-cancelar-pago" onclick="cerrarModalPago()"
                    class="px-4 py-2.5 sm:py-3 text-sm font-semibold text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL: Configuraci√≥n -->
    <div id="modal-configuracion"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-[200] flex items-center justify-center p-2 sm:p-4 overflow-y-auto">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md my-4 sm:my-8 max-h-[95vh] sm:max-h-[90vh] flex flex-col"
            onclick="event.stopPropagation()">
            <div
                class="flex justify-between items-center p-3 sm:p-5 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
                <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        class="w-6 h-6 text-gray-700 dark:text-gray-300 flex-shrink-0" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <div>
                        <h2 class="text-lg sm:text-xl font-bold text-gray-900 dark:text-white">Configuraci√≥n</h2>
                    </div>
                </div>
                <button onclick="cerrarModalConfiguracion()"
                    class="text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300">
                    <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <div class="p-3 sm:p-5 space-y-6 overflow-y-auto flex-1">
                <!-- Modo de pruebas -->
                <div
                    class="bg-purple-50 dark:bg-purple-900/30 border border-purple-200 dark:border-purple-700 rounded-lg p-4">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-2xl">üß™</span>
                                <h3 class="text-sm font-bold text-gray-900 dark:text-white">Modo de pruebas</h3>
                            </div>
                            <p class="text-xs text-gray-600 dark:text-gray-400 mb-3">Activa el modo de pruebas para
                                simular fechas y probar funcionalidades sin afectar los datos reales.</p>

                            <!-- Toggle Switch -->
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="toggle-modo-pruebas" class="sr-only peer">
                                <div
                                    class="w-11 h-6 bg-gray-300 dark:bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 dark:peer-focus:ring-purple-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600">
                                </div>
                                <span class="ml-3 text-sm font-medium text-gray-700 dark:text-gray-300"
                                    id="estado-modo-pruebas">Desactivado</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Informaci√≥n adicional -->
                <div class="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-700 rounded-lg p-3">
                    <p class="text-xs text-blue-800 dark:text-blue-300">
                        <strong>üí° Tip:</strong> El modo de pruebas te permite simular fechas futuras para probar
                        alertas de pendientes y otros comportamientos del sistema.
                    </p>
                </div>

                <!-- Herramientas -->
                <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                    <h3 class="text-sm font-bold text-gray-900 dark:text-white mb-3">Herramientas</h3>
                    <div class="space-y-2">
                        <button onclick="abrirModalBibliotecaEjercicios(); cerrarModalConfiguracion();"
                            class="w-full p-3 text-left bg-purple-50 dark:bg-purple-900/30 hover:bg-purple-100 dark:hover:bg-purple-900/50 border border-purple-300 dark:border-purple-700 rounded-lg flex items-center gap-3 transition-colors">
                            <div class="p-2 bg-purple-600 dark:bg-purple-500 rounded-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-semibold text-purple-900 dark:text-purple-300">Biblioteca de
                                    Ejercicios</p>
                                <p class="text-xs text-purple-700 dark:text-purple-400">Gestiona tu biblioteca de
                                    ejercicios</p>
                            </div>
                            <svg class="w-5 h-5 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 5l7 7-7 7" />
                            </svg>
                        </button>

                        <button id="btn-importar-backup-config"
                            class="w-full p-3 text-left bg-green-50 dark:bg-green-900/30 hover:bg-green-100 dark:hover:bg-green-900/50 border border-green-300 dark:border-green-700 rounded-lg flex items-center gap-3 transition-colors">
                            <div class="p-2 bg-green-600 dark:bg-green-500 rounded-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L9 8m4-4v12" />
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-semibold text-green-900 dark:text-green-300">Importar datos</p>
                                <p class="text-xs text-green-700 dark:text-green-400">Cargar backup desde archivo JSON
                                </p>
                            </div>
                            <svg class="w-5 h-5 text-green-600 dark:text-green-400" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 5l7 7-7 7" />
                            </svg>
                        </button>

                        <button id="btn-descargar-backup-config"
                            class="w-full p-3 text-left bg-blue-50 dark:bg-blue-900/30 hover:bg-blue-100 dark:hover:bg-blue-900/50 border border-blue-300 dark:border-blue-700 rounded-lg flex items-center gap-3 transition-colors">
                            <div class="p-2 bg-blue-600 dark:bg-blue-500 rounded-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-semibold text-blue-900 dark:text-blue-300">Exportar datos</p>
                                <p class="text-xs text-blue-700 dark:text-blue-400">Descargar backup completo en JSON
                                </p>
                            </div>
                            <svg class="w-5 h-5 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 5l7 7-7 7" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <div class="border-t border-gray-200 dark:border-gray-700 p-3 sm:p-4 flex-shrink-0">
                <button onclick="cerrarModalConfiguracion()"
                    class="w-full px-4 py-2.5 sm:py-3 text-sm font-semibold text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Mi Perfil -->
    <div id="modal-perfil"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-[200] flex items-center justify-center p-2 sm:p-4 overflow-y-auto">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg my-4 sm:my-8 max-h-[95vh] sm:max-h-[90vh] flex flex-col"
            onclick="event.stopPropagation()">
            <div
                class="flex justify-between items-center p-3 sm:p-5 border-b border-gray-200 dark:border-gray-700 flex-shrink-0 bg-gradient-to-r from-teal-600 to-emerald-600 dark:from-teal-500 dark:to-emerald-500 rounded-t-xl">
                <div class="flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7 text-white flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <div class="flex-1">
                        <h2 class="text-lg sm:text-xl font-bold text-white">Mi Perfil</h2>
                        <p class="text-xs sm:text-sm text-teal-100">Tus datos personales y objetivos</p>
                        <p id="perfil-periodo-actual" class="text-xs text-teal-200 font-semibold mt-1">
                            <!-- Se llena din√°micamente con el periodo actual -->
                        </p>
                    </div>
                </div>
                <button onclick="cerrarModalPerfil()"
                    class="text-white hover:text-teal-200 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <div class="p-4 sm:p-6 space-y-4 overflow-y-auto flex-1">
                <!-- Formulario de Medidas Corporales (oculto por defecto) -->
                <div id="form-medidas-container" class="hidden bg-gradient-to-r from-teal-50 to-emerald-50 dark:from-teal-900/30 dark:to-emerald-900/30 border border-teal-200 dark:border-teal-700 rounded-lg p-4">
                    <div class="flex items-center justify-between gap-2 mb-3">
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">üìè</span>
                            <h3 class="text-sm font-bold text-gray-900 dark:text-white" id="form-medidas-titulo">Nueva Medida</h3>
                        </div>
                        <button onclick="ocultarFormularioMedidas()" 
                            class="px-2 py-1 text-xs font-semibold text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors"
                            title="Cancelar">
                            Cancelar
                        </button>
                    </div>
                    <p class="text-xs text-gray-600 dark:text-gray-400 mb-4">
                        Completa los campos para registrar tus medidas en este periodo.
                    </p>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <!-- Peso -->
                        <div>
                            <label class="block text-xs font-semibold text-gray-700 dark:text-gray-300 mb-1.5">
                                ‚öñÔ∏è Peso (kg)
                            </label>
                            <input 
                                type="number" 
                                id="medida-peso"
                                step="0.1"
                                placeholder="70.5"
                                class="w-full px-3 py-2 text-sm border-2 border-teal-300 dark:border-teal-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 dark:focus:ring-teal-400 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                            >
                        </div>

                        <!-- Altura -->
                        <div>
                            <label class="block text-xs font-semibold text-gray-700 dark:text-gray-300 mb-1.5">
                                üìê Altura (cm)
                            </label>
                            <input 
                                type="number" 
                                id="medida-altura"
                                placeholder="175"
                                class="w-full px-3 py-2 text-sm border-2 border-teal-300 dark:border-teal-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 dark:focus:ring-teal-400 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                            >
                        </div>

                        <!-- Edad -->
                        <div>
                            <label class="block text-xs font-semibold text-gray-700 dark:text-gray-300 mb-1.5">
                                üéÇ Edad (a√±os)
                            </label>
                            <input 
                                type="number" 
                                id="medida-edad"
                                placeholder="25"
                                class="w-full px-3 py-2 text-sm border-2 border-teal-300 dark:border-teal-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 dark:focus:ring-teal-400 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                            >
                        </div>

                        <!-- G√©nero -->
                        <div>
                            <label class="block text-xs font-semibold text-gray-700 dark:text-gray-300 mb-1.5">
                                üë§ G√©nero
                            </label>
                            <select 
                                id="medida-genero"
                                class="w-full px-3 py-2 text-sm border-2 border-teal-300 dark:border-teal-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 dark:focus:ring-teal-400 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                            >
                                <option value="">Seleccionar</option>
                                <option value="masculino">Masculino</option>
                                <option value="femenino">Femenino</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                    </div>

                    <!-- Objetivo -->
                    <div class="mt-3">
                        <label class="block text-xs font-semibold text-gray-700 dark:text-gray-300 mb-1.5">
                            üéØ Objetivo Principal
                        </label>
                        <select 
                            id="medida-objetivo"
                            class="w-full px-3 py-2 text-sm border-2 border-teal-300 dark:border-teal-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 dark:focus:ring-teal-400 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                        >
                            <option value="">Seleccionar objetivo</option>
                            <option value="perder-peso">Perder peso / Definici√≥n</option>
                            <option value="ganar-masa">Ganar masa muscular / Volumen</option>
                            <option value="mantener">Mantener condici√≥n f√≠sica</option>
                            <option value="fuerza">Aumentar fuerza</option>
                            <option value="resistencia">Mejorar resistencia</option>
                        </select>
                    </div>

                    <!-- Nivel de experiencia -->
                    <div class="mt-3">
                        <label class="block text-xs font-semibold text-gray-700 dark:text-gray-300 mb-1.5">
                            üí™ Nivel de Experiencia
                        </label>
                        <select 
                            id="medida-nivel"
                            class="w-full px-3 py-2 text-sm border-2 border-teal-300 dark:border-teal-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 dark:focus:ring-teal-400 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                        >
                            <option value="">Seleccionar nivel</option>
                            <option value="principiante">Principiante (0-6 meses)</option>
                            <option value="intermedio">Intermedio (6 meses - 2 a√±os)</option>
                            <option value="avanzado">Avanzado (2+ a√±os)</option>
                            <option value="experto">Experto/Competidor</option>
                        </select>
                    </div>

                    <!-- Bot√≥n guardar -->
                    <button 
                        id="btn-guardar-medida"
                        onclick="guardarMedidasCorporales()"
                        class="mt-4 w-full px-4 py-2.5 text-sm font-semibold text-white bg-gradient-to-r from-emerald-600 to-teal-600 rounded-lg hover:from-emerald-700 hover:to-teal-700 transition-all shadow-md hover:shadow-lg"
                    >
                        üíæ Guardar Medida
                    </button>

                    <!-- IMC (se mostrar√° despu√©s de guardar) -->
                    <div id="imc-resultado" class="hidden mt-4 p-3 bg-white/50 dark:bg-gray-800/50 rounded-lg border border-teal-200 dark:border-teal-700">
                        <p class="text-xs font-semibold text-gray-700 dark:text-gray-300 mb-1">Tu IMC:</p>
                        <p id="imc-valor" class="text-lg font-bold text-teal-600 dark:text-teal-400"></p>
                        <p id="imc-categoria" class="text-xs text-gray-600 dark:text-gray-400"></p>
                    </div>
                </div>

                <!-- Medidas del Periodo Actual -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/30 dark:to-indigo-900/30 border border-blue-200 dark:border-blue-700 rounded-lg p-4">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="text-2xl">üìä</span>
                        <h3 class="text-sm font-bold text-gray-900 dark:text-white">Mis Registros en este Periodo</h3>
                    </div>
                    <p class="text-xs text-gray-600 dark:text-gray-400 mb-3">
                        Puedes registrar tus medidas varias veces durante el periodo para ver tu progresi√≥n
                    </p>
                    <div id="medidas-periodo-lista" class="space-y-2 max-h-60 overflow-y-auto">
                        <!-- Se llena din√°micamente -->
                    </div>
                </div>

                <!-- Historial de Periodos Anteriores -->
                <div id="historial-medidas-container" class="bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/30 dark:to-pink-900/30 border border-purple-200 dark:border-purple-700 rounded-lg p-4">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="text-2xl">üìà</span>
                        <h3 class="text-sm font-bold text-gray-900 dark:text-white">Periodos Anteriores</h3>
                    </div>
                    <div id="historial-medidas-lista" class="space-y-2 max-h-60 overflow-y-auto">
                        <!-- Se llena din√°micamente -->
                    </div>
                </div>
            </div>

            <!-- Footer con bot√≥n para agregar nuevas medidas -->
            <div class="border-t border-gray-200 dark:border-gray-700 p-3 sm:p-4 flex-shrink-0">
                <button 
                    onclick="mostrarFormularioMedidas()"
                    class="w-full px-4 py-2.5 text-sm font-semibold text-white bg-gradient-to-r from-emerald-600 to-teal-600 rounded-lg hover:from-emerald-700 hover:to-teal-700 transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-2"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    Agregar nuevas medidas a este mes
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 mt-auto">
        <div class="container mx-auto px-4 py-4 md:px-6">
            <p class="text-xs text-gray-500 dark:text-gray-400 text-center">Sistema de gesti√≥n de coaches - Datos en
                localStorage</p>
        </div>
    </footer>

    <!-- Panel de pruebas (solo para desarrollo) - Posicionado en esquina inferior izquierda -->
    <div id="panel-pruebas"
        class="fixed bottom-2 left-2 sm:bottom-4 sm:left-4 bg-purple-600 dark:bg-purple-500 text-white p-1.5 sm:p-2 rounded-lg shadow-lg z-50 cursor-pointer text-xs sm:text-sm"
        onclick="togglePanelPruebas()">
        üß™ Modo Prueba
    </div>

    <div id="contenido-panel-pruebas"
        class="hidden fixed bottom-12 left-2 sm:bottom-16 sm:left-4 bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-3 sm:p-4 z-50 border-2 border-purple-300 dark:border-purple-600 w-[calc(100vw-1rem)] max-w-xs sm:w-80">
        <div class="flex justify-between items-center mb-3">
            <h3 class="font-bold text-gray-900 dark:text-white">üß™ Panel de Pruebas</h3>
            <button onclick="togglePanelPruebas()"
                class="text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300">‚úï</button>
        </div>
        <div class="space-y-3">
            <div>
                <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Simular fecha
                    actual:</label>
                <input type="date" id="fecha-simulada"
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 text-sm">
            </div>
            <button onclick="aplicarFechaSimulada()"
                class="w-full px-4 py-2 text-sm font-medium text-white bg-purple-600 dark:bg-purple-500 rounded-lg hover:bg-purple-700 dark:hover:bg-purple-600">
                Aplicar fecha
            </button>
            <button onclick="resetearFecha()"
                class="w-full px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">
                Resetear a fecha real
            </button>
            <div id="fecha-actual-info"
                class="text-xs text-gray-600 dark:text-gray-400 text-center pt-2 border-t border-gray-200 dark:border-gray-700">
                Fecha real: <span class="font-semibold"></span>
            </div>
        </div>
    </div>

    <!-- Modal Informaci√≥n del Coach -->
    <div id="modal-info-coach"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[200] hidden overflow-y-auto p-2 sm:p-4">
        <div
            class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl my-4 sm:my-8 max-h-[95vh] sm:max-h-[90vh] flex flex-col">
            <div
                class="flex justify-between items-center p-3 sm:p-5 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
                <div class="flex items-center gap-2">
                    <svg class="w-6 h-6 text-gray-700 dark:text-gray-300 flex-shrink-0" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <div>
                        <h2 class="text-lg sm:text-xl font-bold text-gray-900 dark:text-white">Informaci√≥n del Coach
                        </h2>
                    </div>
                </div>
                <button onclick="cerrarModalInfoCoach()"
                    class="text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300">
                    <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <div class="p-3 sm:p-5 space-y-6 overflow-y-auto flex-1">
                <!-- Informaci√≥n b√°sica -->
                <div
                    class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/30 dark:to-indigo-900/30 rounded-lg p-4 border border-blue-200 dark:border-blue-800">
                    <h3 id="modal-info-nombre" class="text-2xl font-bold text-gray-900 dark:text-white mb-2"></h3>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-600 dark:text-gray-400">Estado:</span>
                        <span id="modal-info-estado-badge" class="px-3 py-1 text-xs font-semibold rounded"></span>
                    </div>
                </div>

                <!-- Grid de estad√≠sticas -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white dark:bg-gray-700 border-2 border-gray-200 dark:border-gray-600 rounded-lg p-4">
                        <div class="flex items-center gap-2 mb-2">
                            <svg class="w-5 h-5 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <p class="text-sm font-medium text-gray-600 dark:text-gray-400">D√≠as laborables</p>
                        </div>
                        <p id="modal-info-dias" class="text-lg font-bold text-gray-900 dark:text-white"></p>
                    </div>

                    <div class="bg-white dark:bg-gray-700 border-2 border-blue-200 dark:border-blue-700 rounded-lg p-4">
                        <div class="flex items-center gap-2 mb-2">
                            <svg class="w-5 h-5 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Total pagado</p>
                        </div>
                        <p id="modal-info-total-pagado" class="text-lg font-bold text-blue-600 dark:text-blue-400"></p>
                    </div>

                    <div
                        class="bg-white dark:bg-gray-700 border-2 border-green-200 dark:border-green-700 rounded-lg p-4">
                        <div class="flex items-center gap-2 mb-2">
                            <svg class="w-5 h-5 text-green-600 dark:text-green-400" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                            </svg>
                            <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Cantidad de periodos</p>
                        </div>
                        <p id="modal-info-cantidad-pagos" class="text-lg font-bold text-green-600 dark:text-green-400">
                        </p>
                    </div>

                    <div
                        class="bg-white dark:bg-gray-700 border-2 border-purple-200 dark:border-purple-700 rounded-lg p-4">
                        <div class="flex items-center gap-2 mb-2">
                            <svg class="w-5 h-5 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                            </svg>
                            <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Clases programadas</p>
                        </div>
                        <p id="modal-info-total-clases" class="text-lg font-bold text-purple-600 dark:text-purple-400">
                        </p>
                    </div>
                </div>

                <!-- Costo por clase -->
                <div
                    class="bg-gradient-to-r from-amber-50 to-orange-50 dark:from-amber-900/30 dark:to-orange-900/30 border-2 border-amber-300 dark:border-amber-700 rounded-lg p-5">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-12 h-12 bg-amber-500 dark:bg-amber-600 rounded-lg flex items-center justify-center">
                                <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-amber-900 dark:text-amber-300">Costo promedio por
                                    clase</p>
                                <p class="text-xs text-amber-700 dark:text-amber-400">Basado en clases asistidas</p>
                            </div>
                        </div>
                        <p id="modal-info-costo-clase" class="text-2xl font-bold text-amber-900 dark:text-amber-300">
                        </p>
                    </div>
                </div>

                <!-- Informaci√≥n adicional -->
                <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                    <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">Estad√≠sticas adicionales
                    </h4>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700 rounded">
                            <span class="text-gray-600 dark:text-gray-400">Clases asistidas:</span>
                            <span id="modal-info-clases-asistidas"
                                class="font-semibold text-gray-900 dark:text-white"></span>
                        </div>
                        <div class="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700 rounded">
                            <span class="text-gray-600 dark:text-gray-400">Clases faltadas:</span>
                            <span id="modal-info-clases-faltadas"
                                class="font-semibold text-gray-900 dark:text-white"></span>
                        </div>
                        <div class="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700 rounded">
                            <span class="text-gray-600 dark:text-gray-400">Reprogramaciones:</span>
                            <span id="modal-info-reprogramaciones"
                                class="font-semibold text-gray-900 dark:text-white"></span>
                        </div>
                        <div class="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700 rounded">
                            <span class="text-gray-600 dark:text-gray-400">% Asistencia:</span>
                            <span id="modal-info-porcentaje-asistencia"
                                class="font-semibold text-gray-900 dark:text-white"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="border-t border-gray-200 dark:border-gray-700 p-3 sm:p-4 flex-shrink-0">
                <button onclick="cerrarModalInfoCoach()"
                    class="w-full px-4 py-2.5 sm:py-3 text-sm font-semibold text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Historial de Pagos -->
    <div id="modal-historial-pagos"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[200] hidden overflow-y-auto p-2 sm:p-4">
        <div
            class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-3xl my-4 sm:my-8 max-h-[95vh] sm:max-h-[90vh] flex flex-col">
            <div
                class="flex justify-between items-center p-3 sm:p-5 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
                <div class="flex items-center gap-2">
                    <svg class="w-6 h-6 text-gray-700 dark:text-gray-300 flex-shrink-0" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                    </svg>
                    <div>
                        <h2 id="modal-historial-titulo"
                            class="text-lg sm:text-xl font-bold text-gray-900 dark:text-white">Todos los periodos</h2>
                    </div>
                </div>
                <button onclick="cerrarModalHistorialPagos()"
                    class="text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300">
                    <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <div class="p-3 sm:p-5 overflow-y-auto flex-1">
                <div id="lista-pagos" class="space-y-3">
                    <!-- Se llena din√°micamente -->
                </div>
            </div>

            <div class="border-t border-gray-200 dark:border-gray-700 p-3 sm:p-4 flex-shrink-0">
                <button onclick="cerrarModalHistorialPagos()"
                    class="w-full px-4 py-2.5 sm:py-3 text-sm font-semibold text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Editar Periodo -->
    <div id="modal-editar-periodo"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-2 sm:p-4 z-[200] overflow-y-auto">
        <div
            class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-lg w-full my-4 sm:my-8 max-h-[95vh] sm:max-h-[90vh] flex flex-col">
            <div
                class="flex justify-between items-center p-3 sm:p-5 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
                <div class="flex items-center gap-2">
                    <svg class="w-6 h-6 text-gray-700 flex-shrink-0" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                    <div>
                        <h2 class="text-lg sm:text-xl font-bold text-gray-900 dark:text-white">Editar Periodo</h2>
                        <p class="text-xs sm:text-sm text-gray-500 mt-1">Modificar periodo de entrenamiento</p>
                    </div>
                </div>
                <button onclick="cerrarModalEditarPeriodo()"
                    class="text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300">
                    <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <form id="form-editar-periodo" class="p-3 sm:p-5 space-y-4 overflow-y-auto flex-1">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                    <p class="text-xs font-semibold text-blue-900 mb-1">üí° Extensi√≥n de periodo</p>
                    <p class="text-xs text-blue-800">Las clases programadas se calculan con base en el periodo ORIGINAL.
                        Los d√≠as extras que agregues solo sirven para completar pendientes mediante reprogramaciones o
                        asistencias tard√≠as.</p>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label for="editar-periodo-inicio"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Inicio del periodo
                            *</label>
                        <input type="date" id="editar-periodo-inicio" disabled
                            class="w-full px-3 py-2.5 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400 cursor-not-allowed"
                            style="color-scheme: light dark;">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">No se puede cambiar</p>
                    </div>
                    <div>
                        <label for="editar-periodo-fin"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Fin del periodo
                            *</label>
                        <input type="date" id="editar-periodo-fin" required
                            class="w-full px-3 py-2.5 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400"
                            style="color-scheme: light dark;">
                    </div>
                </div>

                <div>
                    <label for="editar-fecha-pago"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Fecha de pago *</label>
                    <input type="date" id="editar-fecha-pago" required
                        class="w-full px-3 py-2.5 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400"
                        style="color-scheme: light dark;">
                </div>

                <div>
                    <label for="editar-monto"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Monto pagado (COP)
                        *</label>
                    <input type="text" id="editar-monto" inputmode="numeric" pattern="[0-9.]*" required
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 font-semibold text-lg"
                        placeholder="450.000">
                </div>

                <div>
                    <label for="editar-nota"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nota (opcional)</label>
                    <textarea id="editar-nota" rows="2"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400"
                        placeholder="Observaciones sobre el periodo o el pago..."></textarea>
                </div>
            </form>

            <div
                class="border-t border-gray-200 dark:border-gray-700 p-3 sm:p-4 flex flex-col sm:flex-row gap-2 sm:gap-3 flex-shrink-0">
                <button type="submit" form="form-editar-periodo"
                    class="flex-1 px-4 py-2.5 sm:py-3 text-sm font-semibold text-white bg-blue-600 dark:bg-blue-500 rounded-lg hover:bg-blue-700 dark:hover:bg-blue-600 transition-colors flex items-center justify-center gap-2">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    Guardar Cambios
                </button>
                <button type="button" onclick="cerrarModalEditarPeriodo()"
                    class="px-4 py-2.5 sm:py-3 text-sm font-semibold text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Gestionar Ejercicios -->
    <div id="modal-ejercicios-biblioteca"
        class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[60] p-2 sm:p-4 overflow-y-auto">
        <div
            class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl my-4 sm:my-8 max-h-[95vh] sm:max-h-[90vh] flex flex-col">
            <div
                class="flex justify-between items-center p-3 sm:p-5 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
                <div class="flex items-center gap-2">
                    <svg class="w-6 h-6 text-gray-700 dark:text-gray-300 flex-shrink-0" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                    </svg>
                    <div>
                        <h2 class="text-lg sm:text-xl font-bold text-gray-900 dark:text-white">Biblioteca de Ejercicios
                        </h2>
                        <p class="text-xs sm:text-sm text-gray-500 dark:text-gray-400 mt-1">Gestiona tu cat√°logo</p>
                    </div>
                </div>
                <button onclick="cerrarModalBibliotecaEjercicios()"
                    class="text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300">
                    <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <div class="p-3 sm:p-4 flex-1 overflow-y-auto bg-gray-50 dark:bg-gray-900">
                <!-- Agregar nuevo ejercicio -->
                <div
                    class="bg-blue-50 dark:bg-blue-900/30 border-2 border-blue-200 dark:border-blue-700 rounded-lg p-3 sm:p-4 mb-3 sm:mb-4">
                    <h3 class="text-xs sm:text-sm font-bold text-blue-900 dark:text-blue-300 mb-2 sm:mb-3">Agregar nuevo
                        ejercicio</h3>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <input type="text" id="nuevo-ejercicio-nombre" placeholder="Nombre del ejercicio..."
                            class="flex-1 px-3 py-2 text-xs sm:text-sm border border-blue-300 dark:border-blue-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500">
                        <button onclick="agregarEjercicioABiblioteca()"
                            class="px-4 py-2 text-xs sm:text-sm font-medium text-white bg-blue-600 dark:bg-blue-500 rounded-lg hover:bg-blue-700 dark:hover:bg-blue-600 whitespace-nowrap transition-colors">
                            + Agregar
                        </button>
                    </div>
                </div>

                <!-- Buscador -->
                <div class="mb-3">
                    <input type="text" id="buscar-ejercicio-biblioteca" placeholder="üîç Buscar ejercicio..."
                        class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500"
                        oninput="renderBibliotecaEjercicios()">
                </div>

                <!-- Lista de ejercicios -->
                <div id="lista-ejercicios-biblioteca" class="space-y-2">
                    <!-- Se llena din√°micamente -->
                </div>

                <div id="mensaje-sin-ejercicios-biblioteca"
                    class="hidden text-center py-8 text-gray-500 dark:text-gray-400">
                    <p class="text-sm">No hay ejercicios en la biblioteca</p>
                    <p class="text-xs mt-1">Agrega tu primer ejercicio arriba</p>
                </div>
            </div>

            <div
                class="border-t border-gray-200 dark:border-gray-700 p-3 sm:p-4 flex-shrink-0 bg-white dark:bg-gray-800">
                <button onclick="cerrarModalBibliotecaEjercicios()"
                    class="w-full px-4 py-2.5 sm:py-3 text-sm font-semibold text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Vista Previa de Rutina (Solo Lectura) -->
    <div id="modal-vista-rutina"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[200] hidden overflow-y-auto p-2 sm:p-4">
        <div
            class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-3xl my-4 sm:my-8 max-h-[95vh] sm:max-h-[90vh] flex flex-col">
            <div
                class="flex justify-between items-center p-3 sm:p-5 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
                <div class="flex items-center gap-2">
                    <svg class="w-6 h-6 text-gray-700 dark:text-gray-300 flex-shrink-0" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <div>
                        <h2 class="text-lg sm:text-xl font-bold text-gray-900 dark:text-white">Rutina del d√≠a</h2>
                        <p id="vista-fecha-display" class="text-xs sm:text-sm text-gray-500 dark:text-gray-400 mt-1">
                        </p>
                    </div>
                </div>
                <button onclick="cerrarModalVistaRutina()"
                    class="text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300">
                    <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <!-- Contenido de solo lectura -->
            <div class="p-3 sm:p-5 space-y-3 sm:space-y-4 overflow-y-auto flex-1 bg-gray-50 dark:bg-gray-900">
                <div id="vista-contenido-rutina">
                    <!-- Se llenar√° din√°micamente -->
                </div>
            </div>

            <!-- Footer con botones -->
            <div
                class="border-t border-gray-200 dark:border-gray-700 p-3 sm:p-4 flex flex-col sm:flex-row gap-2 sm:gap-3 flex-shrink-0 bg-white dark:bg-gray-800">
                <button type="button" onclick="abrirEdicionDesdeVista()"
                    class="flex-1 px-4 py-2.5 sm:py-3 text-sm font-semibold text-white bg-blue-600 dark:bg-blue-500 rounded-lg hover:bg-blue-700 dark:hover:bg-blue-600 transition-colors flex items-center justify-center gap-2">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                    Editar Rutina
                </button>
                <button type="button" onclick="eliminarNotaDia()"
                    class="px-4 py-2.5 sm:py-3 text-sm font-semibold text-white bg-red-600 dark:bg-red-500 rounded-lg hover:bg-red-700 dark:hover:bg-red-600 transition-colors flex items-center justify-center gap-2">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    Eliminar
                </button>
                <button type="button" onclick="cerrarModalVistaRutina()"
                    class="px-4 py-2.5 sm:py-3 text-sm font-semibold text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Nota del D√≠a (Edici√≥n) -->
    <div id="modal-nota-dia"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[200] hidden overflow-y-auto p-2 sm:p-4">
        <div
            class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-3xl my-4 sm:my-8 max-h-[95vh] sm:max-h-[90vh] flex flex-col">
            <div class="border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
                <div class="flex justify-between items-center p-3 sm:p-5">
                    <div class="flex items-center gap-2">
                        <svg class="w-6 h-6 text-gray-700 dark:text-gray-300 flex-shrink-0" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 flex-wrap">
                                <h2 class="text-lg sm:text-xl font-bold text-gray-900 dark:text-white">Rutina del d√≠a</h2>
                                <span id="badge-ia-rutina" class="hidden px-2.5 py-1 text-xs font-bold text-white bg-gradient-to-r from-emerald-600 to-teal-600 rounded-full shadow-md border-2 border-emerald-400/50 animate-pulse">
                                    ü§ñ IA
                                </span>
                            </div>
                            <p id="nota-fecha-display" class="text-xs sm:text-sm text-gray-500 dark:text-gray-400 mt-1">
                            </p>
                        </div>
                    </div>
                    <button onclick="cerrarModalNotaDia()"
                        class="text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="px-3 sm:px-5 pb-3 sm:pb-4">
                    <button type="button" onclick="generarRutinaConIA()"
                        class="w-full px-3 py-2.5 text-sm font-semibold text-white bg-gradient-to-r from-emerald-600 to-teal-600 dark:from-emerald-500 dark:to-teal-500 rounded-lg hover:from-emerald-700 hover:to-teal-700 dark:hover:from-emerald-600 dark:hover:to-teal-600 transition-all shadow-lg hover:shadow-xl flex items-center justify-center gap-2 border border-emerald-500/30"
                        title="El Coach IA crear√° la rutina de este d√≠a autom√°ticamente">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z"/>
                        </svg>
                        <span>Generar rutina con IA</span>
                    </button>
                </div>
            </div>
            <form id="form-nota-dia" class="p-3 sm:p-4 space-y-3 sm:space-y-4 overflow-y-auto flex-1">
                <!-- Campo oculto para marcar si fue generada por IA -->
                <input type="hidden" id="rutina-generada-por-ia" value="false">
                <!-- Campo oculto para el enfoque muscular -->
                <input type="hidden" id="enfoque-musculo-hidden" value="">
                
                <!-- Grid compacto de configuraci√≥n -->
                <!-- Lista de ejercicios -->
                <div
                    class="bg-gray-100 dark:bg-gray-900 border-2 border-gray-300 dark:border-gray-700 rounded-xl p-3 sm:p-4">
                    <label class="text-xs sm:text-sm font-bold text-gray-900 dark:text-white mb-3 block">Ejercicios
                        realizados</label>
                    <div id="lista-ejercicios" class="space-y-3">
                        <!-- Se llena din√°micamente -->
                    </div>
                </div>

                <!-- Configuraci√≥n de rutina -->
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                    <!-- Calentamiento -->
                    <label
                        class="flex items-center gap-2 p-2.5 sm:p-3 bg-orange-50 dark:bg-orange-900/30 border-2 border-orange-200 dark:border-orange-700 rounded-lg cursor-pointer hover:bg-orange-100 dark:hover:bg-orange-900/50 transition-colors">
                        <input type="checkbox" id="calentamiento-check"
                            class="w-4 h-4 rounded border-gray-300 dark:border-gray-600 text-orange-600 focus:ring-orange-500"
                            checked>
                        <span
                            class="text-xs sm:text-sm font-semibold text-orange-900 dark:text-orange-300">Calentamiento</span>
                    </label>

                    <!-- M√°quinas -->
                    <label
                        class="flex items-center gap-2 p-2.5 sm:p-3 border-2 border-gray-200 dark:border-gray-700 rounded-lg cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/30 transition-colors has-[:checked]:border-blue-500 dark:has-[:checked]:border-blue-400 has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/30">
                        <input type="checkbox" id="tipo-maquinas"
                            class="w-4 h-4 rounded border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-blue-500"
                            checked>
                        <span class="text-xs sm:text-sm font-semibold text-gray-700 dark:text-gray-300">M√°quinas</span>
                    </label>

                    <!-- Calistenia -->
                    <label
                        class="flex items-center gap-2 p-2.5 sm:p-3 border-2 border-gray-200 dark:border-gray-700 rounded-lg cursor-pointer hover:bg-green-50 dark:hover:bg-green-900/30 transition-colors has-[:checked]:border-green-500 dark:has-[:checked]:border-green-400 has-[:checked]:bg-green-50 dark:has-[:checked]:bg-green-900/30">
                        <input type="checkbox" id="tipo-calistenia"
                            class="w-4 h-4 rounded border-gray-300 dark:border-gray-600 text-green-600 focus:ring-green-500">
                        <span
                            class="text-xs sm:text-sm font-semibold text-gray-700 dark:text-gray-300">Calistenia</span>
                    </label>
                </div>

                <!-- Tren trabajado -->
                <div class="grid grid-cols-2 gap-2">
                    <label
                        class="flex items-center gap-2 p-2.5 sm:p-3 border-2 border-gray-200 dark:border-gray-700 rounded-lg cursor-pointer hover:bg-purple-50 dark:hover:bg-purple-900/30 transition-colors has-[:checked]:border-purple-500 dark:has-[:checked]:border-purple-400 has-[:checked]:bg-purple-50 dark:has-[:checked]:bg-purple-900/30">
                        <input type="radio" name="tren" id="tren-superior" value="superior"
                            class="w-4 h-4 text-purple-600 focus:ring-purple-500">
                        <span class="text-xs sm:text-sm font-semibold text-gray-700 dark:text-gray-300">Tren
                            Superior</span>
                    </label>
                    <label
                        class="flex items-center gap-2 p-2.5 sm:p-3 border-2 border-gray-200 dark:border-gray-700 rounded-lg cursor-pointer hover:bg-indigo-50 dark:hover:bg-indigo-900/30 transition-colors has-[:checked]:border-indigo-500 dark:has-[:checked]:border-indigo-400 has-[:checked]:bg-indigo-50 dark:has-[:checked]:bg-indigo-900/30">
                        <input type="radio" name="tren" id="tren-inferior" value="inferior"
                            class="w-4 h-4 text-indigo-600 focus:ring-indigo-500">
                        <span class="text-xs sm:text-sm font-semibold text-gray-700 dark:text-gray-300">Tren
                            Inferior</span>
                    </label>
                </div>

                <!-- Nota adicional (opcional) -->
                <div>
                    <label for="nota-dia-texto"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nota adicional
                        (opcional)</label>
                    <textarea id="nota-dia-texto" rows="2" maxlength="200"
                        class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 resize-none bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400"
                        placeholder="Observaciones, sensaciones, logros..."></textarea>
                </div>

            </form>
            <!-- Footer fijo con botones de acci√≥n -->
            <div class="border-t border-gray-200 dark:border-gray-700 p-3 sm:p-4 flex-shrink-0 bg-gray-50 dark:bg-gray-800">
                <div class="grid grid-cols-3 gap-2">
                    <button type="button" onclick="agregarEjercicio()"
                        class="px-3 py-2.5 text-sm font-semibold text-white bg-blue-600 dark:bg-blue-500 rounded-lg hover:bg-blue-700 dark:hover:bg-blue-600 transition-colors flex items-center justify-center gap-1.5"
                        title="A√±adir otro ejercicio a la rutina">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        <span class="hidden sm:inline">A√±adir Ejercicio</span>
                        <span class="sm:hidden">A√±adir</span>
                    </button>
                    <button type="submit" form="form-nota-dia"
                        class="px-3 py-2.5 text-sm font-semibold text-white bg-green-600 dark:bg-green-500 rounded-lg hover:bg-green-700 dark:hover:bg-green-600 transition-colors flex items-center justify-center gap-1.5"
                        title="Guardar rutina del d√≠a">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        <span class="hidden sm:inline">Guardar Rutina</span>
                        <span class="sm:hidden">Guardar</span>
                    </button>
                    <button type="button" onclick="eliminarNotaDia()"
                        class="px-3 py-2.5 text-sm font-semibold text-white bg-red-600 dark:bg-red-500 rounded-lg hover:bg-red-700 dark:hover:bg-red-600 transition-colors flex items-center justify-center gap-1.5"
                        title="Eliminar rutina del d√≠a">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        <span class="hidden sm:inline">Eliminar Rutina</span>
                        <span class="sm:hidden">Eliminar</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Asistente IA -->
    <div id="modal-asistente-ia"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[200] hidden overflow-y-auto p-2 sm:p-4">
        <div
            class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-4xl my-4 sm:my-8 max-h-[95vh] sm:max-h-[90vh] flex flex-col">
            <div
                class="flex justify-between items-center p-3 sm:p-5 border-b border-gray-200 dark:border-gray-700 flex-shrink-0 bg-gradient-to-r from-purple-600 to-blue-600 dark:from-purple-500 dark:to-blue-500 rounded-t-xl">
                <div class="flex items-center gap-3">
                    <svg class="w-7 h-7 text-white flex-shrink-0" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                    </svg>
                    <div>
                        <h2 class="text-lg sm:text-xl font-bold text-white">Asistente IA - DeepSeek</h2>
                        <p class="text-xs sm:text-sm text-purple-100">Pregunta sobre tus entrenamientos y estad√≠sticas</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <!-- Men√∫ de opciones -->
                    <div class="relative">
                        <button onclick="toggleMenuIA()" id="btn-menu-ia"
                            class="text-white hover:text-purple-200 transition-colors p-1">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/>
                            </svg>
                        </button>
                        <div id="menu-ia-opciones" class="hidden absolute right-0 mt-2 w-56 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 z-10">
                            <button onclick="cambiarAPIKey(); toggleMenuIA();" class="w-full text-left px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2 text-gray-700 dark:text-gray-300 rounded-t-lg">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
                                </svg>
                                <span class="text-sm">Cambiar API Key</span>
                            </button>
                            <button onclick="limpiarHistorialChat(); toggleMenuIA();" class="w-full text-left px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2 text-gray-700 dark:text-gray-300 rounded-b-lg">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                                <span class="text-sm">Limpiar historial</span>
                            </button>
                        </div>
                    </div>
                    <button onclick="cerrarModalAsistenteIA()"
                        class="text-white hover:text-purple-200 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                            </path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- √Årea de chat -->
            <div id="chat-container" class="flex-1 overflow-y-auto p-3 sm:p-5 space-y-4 bg-gray-50 dark:bg-gray-900">
                <!-- Mensaje de bienvenida -->
                <div class="flex items-start gap-3">
                    <div class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 bg-gradient-to-br from-purple-500 to-blue-500 rounded-full flex items-center justify-center">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                        </svg>
                    </div>
                    <div class="flex-1 bg-white dark:bg-gray-800 rounded-lg p-3 sm:p-4 shadow-sm border border-gray-200 dark:border-gray-700">
                        <p class="text-sm sm:text-base text-gray-800 dark:text-gray-200 font-semibold mb-2">
                            ¬°Hola! üëã Soy tu asistente personal de entrenamiento con IA
                        </p>
                        <p class="text-sm text-gray-700 dark:text-gray-300 mb-3">
                            Tengo acceso completo a tu historial de entrenamientos y puedo ayudarte de varias formas:
                        </p>
                        
                        <div class="bg-gradient-to-r from-purple-50 to-blue-50 dark:from-purple-900/20 dark:to-blue-900/20 rounded-lg p-3 mb-3">
                            <p class="text-xs font-semibold text-purple-700 dark:text-purple-300 mb-1">üèãÔ∏è Generar Rutinas</p>
                            <p class="text-xs text-gray-600 dark:text-gray-400">"Dame la rutina para hoy" o "Act√∫a como mi coach y dame una rutina de pecho"</p>
                        </div>
                        
                        <div class="bg-gradient-to-r from-green-50 to-teal-50 dark:from-green-900/20 dark:to-teal-900/20 rounded-lg p-3 mb-3">
                            <p class="text-xs font-semibold text-green-700 dark:text-green-300 mb-1">üìä Analizar Progreso</p>
                            <p class="text-xs text-gray-600 dark:text-gray-400">"¬øC√≥mo ha sido mi progreso en sentadillas?" o "Muestra mi tasa de asistencia"</p>
                        </div>
                        
                        <div class="bg-gradient-to-r from-amber-50 to-orange-50 dark:from-amber-900/20 dark:to-orange-900/20 rounded-lg p-3">
                            <p class="text-xs font-semibold text-amber-700 dark:text-amber-300 mb-1">üí° Consultas Generales</p>
                            <p class="text-xs text-gray-600 dark:text-gray-400">"¬øQu√© ejercicios hago m√°s?" o "Resume mis √∫ltimos entrenamientos"</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- √Årea de entrada -->
            <div class="border-t border-gray-200 dark:border-gray-700 p-3 sm:p-4 flex-shrink-0 bg-white dark:bg-gray-800">
                <div class="flex gap-2">
                    <textarea id="ia-input" rows="1"
                        placeholder="Escribe tu pregunta aqu√≠..."
                        class="flex-1 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 dark:focus:ring-purple-400 resize-none"
                        style="max-height: 120px;"></textarea>
                    <button id="btn-enviar-ia" onclick="enviarPreguntaIA()"
                        class="px-4 sm:px-6 py-3 bg-gradient-to-r from-purple-600 to-blue-600 dark:from-purple-500 dark:to-blue-500 text-white rounded-lg hover:from-purple-700 hover:to-blue-700 dark:hover:from-purple-600 dark:hover:to-blue-600 transition-all font-medium shadow-lg hover:shadow-xl flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                        </svg>
                        <span class="hidden sm:inline">Enviar</span>
                    </button>
                </div>
                <div class="mt-2 text-xs text-gray-500 dark:text-gray-400 flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span>Presiona Enter para enviar, Shift+Enter para nueva l√≠nea</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // CONFIGURACI√ìN Y ESTADO GLOBAL
        // ========================================

        const STORAGE_KEY = 'coaches_data';
        const CONFIG_KEY = 'coaches_config';
        const EJERCICIOS_KEY = 'ejercicios_biblioteca';

        let currentCoachId = null;
        let currentPagoId = null; // ID del pago/periodo actualmente seleccionado
        let fechaSimulada = null; // Para pruebas: simular una fecha diferente

        // Vista por defecto seg√∫n el tama√±o de pantalla
        const esMobile = () => window.innerWidth < 640; // 640px = breakpoint 'sm' de Tailwind
        let currentVistaCalendario = esMobile() ? 'lista' : 'mensual'; // Vista actual del calendario: 'mensual', 'semanal', 'lista'

        const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
            'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

        // ========================================
        // GESTI√ìN DE DATOS
        // ========================================

        function loadData() {
            const data = localStorage.getItem(STORAGE_KEY);
            return data ? JSON.parse(data) : { coaches: [], asistencias: {}, pagos: {} };
        }

        function saveData(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function loadConfig() {
            const config = localStorage.getItem(CONFIG_KEY);
            return config ? JSON.parse(config) : { modoPruebas: false };
        }

        function saveConfig(config) {
            localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
        }

        function generateId() {
            return Date.now().toString() + Math.random().toString(36).substr(2, 9);
        }

        // ========================================
        // MEDIDAS CORPORALES
        // ========================================

        const MEDIDAS_KEY = 'usuario_medidas';

        function loadMedidasCorporales(coachId = null, periodoId = null) {
            // Si no se especifica, usar el coach y periodo actuales
            const cId = coachId || currentCoachId;
            const pId = periodoId || currentPagoId;
            
            if (!cId || !pId) {
                return [];
            }

            const todasMedidas = JSON.parse(localStorage.getItem(MEDIDAS_KEY) || '{}');
            
            // Estructura: { coachId: { periodoId: [array de medidas] } }
            if (todasMedidas[cId] && todasMedidas[cId][pId]) {
                const medidas = todasMedidas[cId][pId];
                
                // Verificar si es el formato antiguo (objeto) y convertirlo a array
                if (!Array.isArray(medidas)) {
                    console.log('üîÑ Migrando medidas del formato antiguo al nuevo');
                    const medidaArray = [{
                        id: Date.now().toString(),
                        ...medidas
                    }];
                    
                    // Guardar en el nuevo formato
                    todasMedidas[cId][pId] = medidaArray;
                    localStorage.setItem(MEDIDAS_KEY, JSON.stringify(todasMedidas));
                    
                    return medidaArray;
                }
                
                return medidas;
            }
            
            return [];
        }
        
        function getMedidaMasReciente(coachId = null, periodoId = null) {
            const medidas = loadMedidasCorporales(coachId, periodoId);
            
            if (medidas.length === 0) {
                return {
                    peso: '',
                    altura: '',
                    edad: '',
                    genero: '',
                    objetivo: '',
                    nivel: '',
                    fechaRegistro: null
                };
            }
            
            // Ordenar por fecha m√°s reciente primero
            const medidasOrdenadas = [...medidas].sort((a, b) => 
                new Date(b.fechaRegistro) - new Date(a.fechaRegistro)
            );
            
            return medidasOrdenadas[0];
        }

        function guardarMedidasCorporales(editandoId = null) {
            if (!currentCoachId || !currentPagoId) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Selecciona un periodo',
                    text: 'Debes seleccionar un coach y un periodo activo antes de guardar tus medidas',
                    confirmButtonText: 'Entendido'
                });
                return;
            }

            const peso = document.getElementById('medida-peso').value;
            const altura = document.getElementById('medida-altura').value;
            const edad = document.getElementById('medida-edad').value;
            const genero = document.getElementById('medida-genero').value;
            const objetivo = document.getElementById('medida-objetivo').value;
            const nivel = document.getElementById('medida-nivel').value;

            if (!peso && !altura && !edad) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Datos incompletos',
                    text: 'Por favor, completa al menos peso, altura y edad',
                    confirmButtonText: 'Entendido'
                });
                return;
            }

            const nuevaMedida = {
                id: editandoId || Date.now().toString(),
                peso: parseFloat(peso) || null,
                altura: parseFloat(altura) || null,
                edad: parseInt(edad) || null,
                genero: genero || null,
                objetivo: objetivo || null,
                nivel: nivel || null,
                fechaRegistro: new Date().toISOString()
            };

            // Cargar todas las medidas
            const todasMedidas = JSON.parse(localStorage.getItem(MEDIDAS_KEY) || '{}');
            
            // Crear estructura si no existe
            if (!todasMedidas[currentCoachId]) {
                todasMedidas[currentCoachId] = {};
            }
            if (!todasMedidas[currentCoachId][currentPagoId]) {
                todasMedidas[currentCoachId][currentPagoId] = [];
            }
            
            // Si estamos editando, reemplazar la medida existente
            if (editandoId) {
                const index = todasMedidas[currentCoachId][currentPagoId].findIndex(m => m.id === editandoId);
                if (index !== -1) {
                    todasMedidas[currentCoachId][currentPagoId][index] = nuevaMedida;
                }
            } else {
                // Agregar nueva medida al array
                todasMedidas[currentCoachId][currentPagoId].push(nuevaMedida);
            }
            
            localStorage.setItem(MEDIDAS_KEY, JSON.stringify(todasMedidas));

            // Limpiar y ocultar formulario
            limpiarFormularioMedidas();
            document.getElementById('form-medidas-container').classList.add('hidden');

            // Calcular y mostrar IMC si hay peso y altura
            if (nuevaMedida.peso && nuevaMedida.altura) {
                calcularYMostrarIMC(nuevaMedida.peso, nuevaMedida.altura);
            }

            // Recargar lista de medidas del periodo
            cargarMedidasDelPeriodo();

            // Obtener info del periodo para mostrar
            const data = loadData();
            const pago = (data.pagos[currentCoachId] || []).find(p => p.id === currentPagoId);
            const periodoTexto = pago ? `${pago.periodoInicio} - ${pago.periodoFin}` : 'este periodo';

            Swal.fire({
                icon: 'success',
                title: editandoId ? '¬°Medida actualizada!' : '¬°Nueva medida registrada!',
                html: `Tus medidas para el periodo <strong>${periodoTexto}</strong> han sido guardadas correctamente`,
                timer: 2000,
                showConfirmButton: false
            });
        }
        
        function eliminarMedida(medidaId) {
            Swal.fire({
                title: '¬øEliminar medida?',
                text: 'Esta acci√≥n no se puede deshacer',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'S√≠, eliminar',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#dc2626'
            }).then((result) => {
                if (result.isConfirmed) {
                    const todasMedidas = JSON.parse(localStorage.getItem(MEDIDAS_KEY) || '{}');
                    
                    if (todasMedidas[currentCoachId] && todasMedidas[currentCoachId][currentPagoId]) {
                        todasMedidas[currentCoachId][currentPagoId] = 
                            todasMedidas[currentCoachId][currentPagoId].filter(m => m.id !== medidaId);
                        
                        localStorage.setItem(MEDIDAS_KEY, JSON.stringify(todasMedidas));
                        cargarMedidasDelPeriodo();
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'Medida eliminada',
                            timer: 1500,
                            showConfirmButton: false
                        });
                    }
                }
            });
        }
        
        function editarMedida(medidaId) {
            const medidas = loadMedidasCorporales();
            const medida = medidas.find(m => m.id === medidaId);
            
            if (!medida) return;
            
            // Mostrar el formulario
            mostrarFormularioMedidas();
            
            // Llenar el formulario con los datos de la medida
            document.getElementById('medida-peso').value = medida.peso || '';
            document.getElementById('medida-altura').value = medida.altura || '';
            document.getElementById('medida-edad').value = medida.edad || '';
            document.getElementById('medida-genero').value = medida.genero || '';
            document.getElementById('medida-objetivo').value = medida.objetivo || '';
            document.getElementById('medida-nivel').value = medida.nivel || '';
            
            // Cambiar el t√≠tulo del formulario
            document.getElementById('form-medidas-titulo').textContent = 'Editar Medida';
            
            // Cambiar el bot√≥n de guardar para indicar que estamos editando
            const btnGuardar = document.getElementById('btn-guardar-medida');
            if (btnGuardar) {
                btnGuardar.textContent = 'üíæ Actualizar Medida';
                btnGuardar.onclick = () => guardarMedidasCorporales(medidaId);
            }
        }
        
        function limpiarFormularioMedidas() {
            document.getElementById('medida-peso').value = '';
            document.getElementById('medida-altura').value = '';
            document.getElementById('medida-edad').value = '';
            document.getElementById('medida-genero').value = '';
            document.getElementById('medida-objetivo').value = '';
            document.getElementById('medida-nivel').value = '';
            
            // Restaurar el t√≠tulo del formulario
            document.getElementById('form-medidas-titulo').textContent = 'Nueva Medida';
            
            // Restaurar el bot√≥n de guardar
            const btnGuardar = document.getElementById('btn-guardar-medida');
            if (btnGuardar) {
                btnGuardar.textContent = 'üíæ Guardar Medida';
                btnGuardar.onclick = () => guardarMedidasCorporales();
            }
        }
        
        function obtenerHistorialMedidas(coachId) {
            if (!coachId) return [];
            
            const todasMedidas = JSON.parse(localStorage.getItem(MEDIDAS_KEY) || '{}');
            const medidasCoach = todasMedidas[coachId] || {};
            
            // Convertir a array con informaci√≥n del periodo
            const historial = [];
            const data = loadData();
            const pagos = data.pagos[coachId] || [];
            
            for (const [periodoId, medidasArray] of Object.entries(medidasCoach)) {
                const pago = pagos.find(p => p.id === periodoId);
                if (pago && medidasArray && medidasArray.length > 0) {
                    historial.push({
                        periodoId: periodoId,
                        fechaInicio: pago.periodoInicio,
                        fechaFin: pago.periodoFin,
                        periodo: `${pago.periodoInicio} - ${pago.periodoFin}`,
                        medidas: medidasArray // Array de medidas del periodo
                    });
                }
            }
            
            // Ordenar por fecha de inicio (m√°s reciente primero)
            historial.sort((a, b) => new Date(b.fechaInicio) - new Date(a.fechaInicio));
            
            return historial;
        }

        function calcularYMostrarIMC(peso, altura) {
            const alturaMetros = altura / 100;
            const imc = peso / (alturaMetros * alturaMetros);
            const imcRedondeado = imc.toFixed(1);

            let categoria = '';
            let colorClass = '';
            
            if (imc < 18.5) {
                categoria = 'Bajo peso';
                colorClass = 'text-yellow-600 dark:text-yellow-400';
            } else if (imc < 25) {
                categoria = 'Peso normal';
                colorClass = 'text-green-600 dark:text-green-400';
            } else if (imc < 30) {
                categoria = 'Sobrepeso';
                colorClass = 'text-orange-600 dark:text-orange-400';
            } else {
                categoria = 'Obesidad';
                colorClass = 'text-red-600 dark:text-red-400';
            }

            document.getElementById('imc-resultado').classList.remove('hidden');
            document.getElementById('imc-valor').textContent = imcRedondeado;
            document.getElementById('imc-valor').className = `text-lg font-bold ${colorClass}`;
            document.getElementById('imc-categoria').textContent = categoria;
        }

        // ========================================
        // BIBLIOTECA DE EJERCICIOS
        // ========================================

        function loadEjercicios() {
            const ejercicios = localStorage.getItem(EJERCICIOS_KEY);
            if (ejercicios) {
                return JSON.parse(ejercicios);
            }

            // Ejercicios por defecto si la biblioteca est√° vac√≠a
            const ejerciciosDefault = [
                // Pecho
                'Press de banca',
                'Press inclinado con mancuernas',
                'Press declinado',
                'Aperturas con mancuernas',
                'Fondos en paralelas',
                'Press con mancuernas plano',
                'Cruces en polea',
                'Peck deck',

                // Espalda
                'Dominadas',
                'Remo con barra',
                'Remo con mancuerna',
                'Jal√≥n al pecho',
                'Jal√≥n tras nuca',
                'Peso muerto',
                'Remo en polea baja',
                'Pull over',
                'Remo en T',

                // Hombros
                'Press militar',
                'Press Arnold',
                'Elevaciones laterales',
                'Elevaciones frontales',
                'P√°jaros (elevaciones posteriores)',
                'Press con mancuernas sentado',
                'Encogimientos de hombros',

                // Brazos - B√≠ceps
                'Curl con barra',
                'Curl con mancuernas',
                'Curl martillo',
                'Curl concentrado',
                'Curl en polea',
                'Curl predicador',

                // Brazos - Tr√≠ceps
                'Press franc√©s',
                'Extensiones en polea',
                'Fondos en banco',
                'Patada de tr√≠ceps',
                'Press cerrado',

                // Piernas
                'Sentadilla',
                'Prensa de piernas',
                'Zancadas',
                'Extensiones de cu√°driceps',
                'Curl femoral',
                'Peso muerto rumano',
                'Elevaciones de gemelos',
                'Sentadilla b√∫lgara',
                'Hip thrust',
                'Abductores en m√°quina',
                'Aductores en m√°quina',

                // Core/Abdominales
                'Plancha',
                'Abdominales crunch',
                'Elevaciones de piernas',
                'Bicicleta en el suelo',
                'Plancha lateral',
                'Russian twists',
                'Mountain climbers',

                // Calistenia
                'Flexiones',
                'Burpees',
                'Sentadilla con peso corporal',
                'Jumping jacks',
                'Dips',
                'Pull-ups',
                'Chin-ups'
            ].sort();

            const ejerciciosIniciales = ejerciciosDefault.map(nombre => ({
                id: generateId(),
                nombre: nombre,
                fechaCreacion: new Date().toISOString(),
                porDefecto: true
            }));

            saveEjercicios(ejerciciosIniciales);
            return ejerciciosIniciales;
        }

        function saveEjercicios(ejercicios) {
            localStorage.setItem(EJERCICIOS_KEY, JSON.stringify(ejercicios));
        }

        function agregarEjercicioABiblioteca() {
            const input = document.getElementById('nuevo-ejercicio-nombre');
            const nombre = input.value.trim();

            if (!nombre) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Campo vac√≠o',
                    text: 'Por favor ingresa el nombre del ejercicio',
                    confirmButtonText: 'Entendido'
                });
                return;
            }

            const ejercicios = loadEjercicios();

            // Verificar si ya existe
            if (ejercicios.some(e => e.nombre.toLowerCase() === nombre.toLowerCase())) {
                Swal.fire({
                    icon: 'error',
                    title: 'Ejercicio duplicado',
                    text: 'Este ejercicio ya existe en la biblioteca',
                    confirmButtonText: 'Entendido'
                });
                return;
            }

            ejercicios.push({
                id: generateId(),
                nombre: nombre,
                fechaCreacion: new Date().toISOString()
            });

            ejercicios.sort((a, b) => a.nombre.localeCompare(b.nombre));
            saveEjercicios(ejercicios);

            input.value = '';
            renderBibliotecaEjercicios();
        }

        async function editarEjercicioDeBiblioteca(id) {
            let ejercicios = loadEjercicios();
            const ejercicio = ejercicios.find(e => e.id === id);

            if (!ejercicio) return;

            const { value: nuevoNombre } = await Swal.fire({
                title: 'Editar ejercicio',
                input: 'text',
                inputLabel: 'Nombre del ejercicio',
                inputValue: ejercicio.nombre,
                showCancelButton: true,
                confirmButtonText: 'Guardar',
                cancelButtonText: 'Cancelar',
                inputValidator: (value) => {
                    if (!value || !value.trim()) {
                        return 'El nombre no puede estar vac√≠o';
                    }
                }
            });

            if (!nuevoNombre) return;

            const nombreTrimmed = nuevoNombre.trim();

            // Verificar si ya existe otro ejercicio con ese nombre (excepto el actual)
            if (ejercicios.some(e => e.id !== id && e.nombre.toLowerCase() === nombreTrimmed.toLowerCase())) {
                Swal.fire({
                    icon: 'error',
                    title: 'Ejercicio duplicado',
                    text: 'Ya existe un ejercicio con ese nombre',
                    confirmButtonText: 'Entendido'
                });
                return;
            }

            // Actualizar el nombre
            ejercicio.nombre = nombreTrimmed;
            saveEjercicios(ejercicios);
            renderBibliotecaEjercicios();
        }

        async function eliminarEjercicioDeBiblioteca(id) {
            const result = await Swal.fire({
                title: '¬øEliminar ejercicio?',
                text: '¬øEst√°s seguro de eliminar este ejercicio de la biblioteca?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'S√≠, eliminar',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#dc2626'
            });

            if (!result.isConfirmed) return;

            let ejercicios = loadEjercicios();
            ejercicios = ejercicios.filter(e => e.id !== id);
            saveEjercicios(ejercicios);
            renderBibliotecaEjercicios();

            Swal.fire({
                icon: 'success',
                title: 'Ejercicio eliminado',
                text: 'El ejercicio ha sido eliminado de la biblioteca',
                timer: 2000,
                showConfirmButton: false
            });
        }

        function renderBibliotecaEjercicios() {
            const ejercicios = loadEjercicios();
            const busqueda = document.getElementById('buscar-ejercicio-biblioteca')?.value.toLowerCase() || '';
            const lista = document.getElementById('lista-ejercicios-biblioteca');
            const mensaje = document.getElementById('mensaje-sin-ejercicios-biblioteca');

            const ejerciciosFiltrados = ejercicios.filter(e =>
                e.nombre.toLowerCase().includes(busqueda)
            );

            if (ejerciciosFiltrados.length === 0) {
                lista.innerHTML = '';
                mensaje?.classList.remove('hidden');
                return;
            }

            mensaje?.classList.add('hidden');

            lista.innerHTML = ejerciciosFiltrados.map(ejercicio => `
                <div class="flex items-center justify-between p-2 sm:p-3 bg-gray-50 dark:bg-gray-900 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors gap-2">
                    <span class="text-sm font-medium text-gray-900 dark:text-white flex-1 truncate">${ejercicio.nombre}</span>
                    <div class="flex gap-1 sm:gap-2 flex-shrink-0">
                        <button 
                            onclick="editarEjercicioDeBiblioteca('${ejercicio.id}')"
                            class="p-2 text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/30 rounded border border-blue-200 dark:border-blue-600 transition-colors"
                            title="Editar ejercicio"
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                        </button>
                        <button 
                            onclick="eliminarEjercicioDeBiblioteca('${ejercicio.id}')"
                            class="p-2 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/30 rounded border border-red-200 dark:border-red-600 transition-colors"
                            title="Eliminar ejercicio"
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function abrirModalBibliotecaEjercicios() {
            renderBibliotecaEjercicios();
            document.getElementById('modal-ejercicios-biblioteca').classList.remove('hidden');
        }

        function cerrarModalBibliotecaEjercicios() {
            document.getElementById('modal-ejercicios-biblioteca').classList.add('hidden');
        }

        function mostrarSugerenciasEjercicios(input, ejercicioId) {
            const valor = input.value.toLowerCase();
            const sugerenciasDiv = document.getElementById(`sugerencias-${ejercicioId}`);

            if (!valor) {
                sugerenciasDiv.classList.add('hidden');
                return;
            }

            const ejercicios = loadEjercicios();
            const sugerencias = ejercicios.filter(e =>
                e.nombre.toLowerCase().includes(valor)
            ).slice(0, 5);

            if (sugerencias.length === 0) {
                sugerenciasDiv.classList.add('hidden');
                return;
            }

            sugerenciasDiv.innerHTML = sugerencias.map(ejercicio => `
                <div 
                    class="px-3 py-2 hover:bg-blue-50 dark:hover:bg-blue-900/30 cursor-pointer text-sm text-gray-900 dark:text-gray-100"
                    onclick="seleccionarEjercicio('${ejercicioId}', '${ejercicio.nombre.replace(/'/g, "\\'")}')"
                >
                    ${ejercicio.nombre}
                </div>
            `).join('');

            sugerenciasDiv.classList.remove('hidden');
        }

        function seleccionarEjercicio(ejercicioId, nombre) {
            const ejercicioDiv = document.getElementById(ejercicioId);
            const input = ejercicioDiv.querySelector('.ejercicio-nombre');
            input.value = nombre;

            const sugerenciasDiv = document.getElementById(`sugerencias-${ejercicioId}`);
            sugerenciasDiv.classList.add('hidden');
        }

        // Cerrar sugerencias al hacer clic fuera
        document.addEventListener('click', (e) => {
            if (!e.target.classList.contains('ejercicio-nombre')) {
                document.querySelectorAll('[id^="sugerencias-"]').forEach(div => {
                    div.classList.add('hidden');
                });
            }
        });

        // ========================================
        // UTILIDADES
        // ========================================

        function formatDate(date) {
            if (typeof date === 'string') return date;
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function formatDateDisplay(dateStr) {
            const [y, m, d] = dateStr.split('-');
            const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            const mesTexto = meses[parseInt(m) - 1];
            return `${d} ${mesTexto} ${y}`;
        }

        function getFechaActual() {
            // Devolver fecha simulada si existe (modo pruebas), sino la fecha real
            if (fechaSimulada) {
                return fechaSimulada;
            }
            return formatDate(new Date());
        }

        function calcularFinDeMes(inicioStr) {
            const inicio = new Date(inicioStr + 'T00:00:00');
            const fin = new Date(inicio.getFullYear(), inicio.getMonth() + 1, 0);
            return formatDate(fin);
        }

        // ========================================
        // VISTAS
        // ========================================

        function mostrarVistaLista() {
            document.getElementById('vista-lista-coaches').classList.remove('hidden');
            document.getElementById('vista-dashboard-coach').classList.add('hidden');
            document.getElementById('btn-volver-lista').classList.add('hidden');
            currentCoachId = null;
            currentPagoId = null; // Limpiar periodo seleccionado
            renderCoachesList();
        }

        function mostrarVistaDashboard(coachId) {
            currentCoachId = coachId;
            currentPagoId = null; // Limpiar selecci√≥n de periodo (el usuario debe seleccionar manualmente)
            document.getElementById('vista-lista-coaches').classList.add('hidden');
            document.getElementById('vista-dashboard-coach').classList.remove('hidden');
            document.getElementById('btn-volver-lista').classList.remove('hidden');

            renderDashboard();
        }

        function toggleHistorialPagos() {
            // Actualizar t√≠tulo con nombre del coach
            const data = loadData();
            const coach = data.coaches.find(c => c.id === currentCoachId);
            if (coach) {
                const tituloElement = document.getElementById('modal-historial-titulo');
                const spanElement = tituloElement.querySelector('span');
                if (spanElement) {
                    spanElement.textContent = `Todos los periodos de Coach ${coach.nombre}`;
                }
            }

            renderHistorialPagos(); // Actualizar la lista antes de mostrar el modal
            document.getElementById('modal-historial-pagos').classList.remove('hidden');
        }

        function cerrarModalHistorialPagos() {
            document.getElementById('modal-historial-pagos').classList.add('hidden');
        }

        // ========================================
        // MODAL INFORMACI√ìN DEL COACH
        // ========================================

        function abrirModalInfoCoach() {
            const data = loadData();
            const coach = data.coaches.find(c => c.id === currentCoachId);

            if (!coach) return;

            // Informaci√≥n b√°sica
            document.getElementById('modal-info-nombre').textContent = `Coach ${coach.nombre}`;

            // Estado con colores
            const estado = coach.estado || 'activo';
            const estadoBadge = document.getElementById('modal-info-estado-badge');
            switch (estado) {
                case 'activo':
                    estadoBadge.className = 'px-3 py-1 text-xs font-semibold rounded bg-green-100 text-green-700';
                    estadoBadge.textContent = 'Activo';
                    break;
                case 'inactivo':
                    estadoBadge.className = 'px-3 py-1 text-xs font-semibold rounded bg-red-100 text-red-700';
                    estadoBadge.textContent = 'Inactivo';
                    break;
                case 'pausado':
                    estadoBadge.className = 'px-3 py-1 text-xs font-semibold rounded bg-yellow-100 text-yellow-700';
                    estadoBadge.textContent = 'Pausado';
                    break;
                default:
                    estadoBadge.className = 'px-3 py-1 text-xs font-semibold rounded bg-gray-100 text-gray-700';
                    estadoBadge.textContent = estado;
            }

            // D√≠as laborables
            document.getElementById('modal-info-dias').textContent = getDiasTexto(coach.diasLaborables);

            // Informaci√≥n de pagos
            const pagos = data.pagos[currentCoachId] || [];
            const sumaTotalPagos = pagos.reduce((sum, pago) => sum + (pago.monto || 0), 0);
            document.getElementById('modal-info-total-pagado').textContent = formatCurrency(sumaTotalPagos);
            document.getElementById('modal-info-cantidad-pagos').textContent = pagos.length;

            // Calcular estad√≠sticas de todas las clases
            const asistencias = data.asistencias[currentCoachId] || {};
            const hoy = getFechaActual();
            let totalClasesProgramadas = 0;
            let totalClasesAsistidas = 0;
            let totalClasesFaltadas = 0;
            let totalReprogramaciones = 0;

            pagos.forEach(pago => {
                // Usar periodoFinOriginal si existe para contar las programadas
                const fechaFinParaProgramadas = pago.periodoFinOriginal || pago.periodoFin;
                const daysLaborables = getDiasLaborablesPeriodo(pago.periodoInicio, fechaFinParaProgramadas, coach.diasLaborables);
                totalClasesProgramadas += daysLaborables.length;

                // Contar asistencias (sin reprogramaciones)
                const daysLaborablesTotales = getDiasLaborablesPeriodo(pago.periodoInicio, pago.periodoFin, coach.diasLaborables);
                daysLaborablesTotales.forEach(day => {
                    const asist = asistencias[day];
                    // Solo contar asistencias regulares (no reprogramaciones)
                    if (asist?.asistio && !asist?.reprogramacion) {
                        totalClasesAsistidas++;
                    }

                    // Contar faltas: solo d√≠as pasados donde NO asisti√≥
                    if (day <= hoy && !asist?.asistio) {
                        totalClasesFaltadas++;
                    }
                });

                // Contar reprogramaciones en todo el periodo
                const days = getTodosDiasPeriodo(pago.periodoInicio, pago.periodoFin);
                days.forEach(({ fecha }) => {
                    const asist = asistencias[fecha];
                    if (asist?.reprogramacion && asist?.asistio) {
                        totalReprogramaciones++;
                    }
                });
            });

            // Calcular porcentaje de asistencia basado en d√≠as ya pasados
            let diasPasadosLaborables = 0;
            pagos.forEach(pago => {
                const daysLaborables = getDiasLaborablesPeriodo(pago.periodoInicio, pago.periodoFin, coach.diasLaborables);
                daysLaborables.forEach(day => {
                    if (day <= hoy) diasPasadosLaborables++;
                });
            });

            const porcentajeAsistencia = diasPasadosLaborables > 0
                ? (((totalClasesAsistidas + totalReprogramaciones) / diasPasadosLaborables) * 100).toFixed(1)
                : 0;

            // Llenar estad√≠sticas
            document.getElementById('modal-info-total-clases').textContent = totalClasesProgramadas;
            document.getElementById('modal-info-clases-asistidas').textContent = totalClasesAsistidas;
            document.getElementById('modal-info-clases-faltadas').textContent = totalClasesFaltadas;
            document.getElementById('modal-info-reprogramaciones').textContent = totalReprogramaciones;
            document.getElementById('modal-info-porcentaje-asistencia').textContent = `${porcentajeAsistencia}%`;

            // Calcular costo por clase (asistidas + reprogramaciones)
            const totalClasesCompletadas = totalClasesAsistidas + totalReprogramaciones;
            const costoPorClase = totalClasesCompletadas > 0
                ? (sumaTotalPagos / totalClasesCompletadas)
                : 0;
            document.getElementById('modal-info-costo-clase').textContent = formatCurrency(costoPorClase);

            // Mostrar modal
            document.getElementById('modal-info-coach').classList.remove('hidden');
        }

        function cerrarModalInfoCoach() {
            document.getElementById('modal-info-coach').classList.add('hidden');
        }

        // ========================================
        // LISTA DE COACHES
        // ========================================

        function renderCoachesList() {
            const data = loadData();
            const grid = document.getElementById('grid-coaches');
            const mensaje = document.getElementById('mensaje-sin-coaches');
            const busqueda = document.getElementById('buscar-coach').value.toLowerCase();

            let coaches = data.coaches.filter(c =>
                c.nombre.toLowerCase().includes(busqueda)
            );

            if (coaches.length === 0) {
                grid.innerHTML = '';
                mensaje.classList.remove('hidden');
                return;
            }

            mensaje.classList.add('hidden');

            grid.innerHTML = coaches.map(coach => {
                const diasTexto = getDiasTexto(coach.diasLaborables);
                const pagos = data.pagos[coach.id] || [];
                const totalPagos = pagos.reduce((sum, pago) => sum + (pago.monto || 0), 0);

                // Determinar estado y colores
                const estado = coach.estado || 'activo';
                let estadoClasses = '';
                let estadoTexto = '';

                switch (estado) {
                    case 'activo':
                        estadoClasses = 'bg-green-100 text-green-700';
                        estadoTexto = 'Activo';
                        break;
                    case 'inactivo':
                        estadoClasses = 'bg-red-100 text-red-700';
                        estadoTexto = 'Inactivo';
                        break;
                    case 'pausado':
                        estadoClasses = 'bg-yellow-100 text-yellow-700';
                        estadoTexto = 'Pausado';
                        break;
                    default:
                        estadoClasses = 'bg-gray-100 text-gray-700';
                        estadoTexto = estado;
                }

                return `
                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm p-5 hover:shadow-md transition-shadow">
                        <div class="mb-4">
                            <div class="flex items-start justify-between mb-3">
                                <h3 class="text-lg font-bold text-gray-900 dark:text-white">${coach.nombre}</h3>
                                <span class="px-2 py-1 text-xs font-semibold ${estadoClasses} rounded">${estadoTexto}</span>
                            </div>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-500 dark:text-gray-400">D√≠as laborables:</span>
                                    <span class="text-xs font-medium text-gray-900 dark:text-gray-100">${diasTexto}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500 dark:text-gray-400">Total pagado:</span>
                                    <span class="text-xs font-semibold text-blue-600 dark:text-blue-400">${formatCurrency(totalPagos)}</span>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <button 
                                onclick="mostrarVistaDashboard('${coach.id}')"
                                class="w-full px-3 py-2 text-sm font-medium text-white bg-blue-600 dark:bg-blue-500 rounded-lg hover:bg-blue-700 dark:hover:bg-blue-600 transition-colors"
                            >
                                Ver Dashboard
                            </button>
                            <div class="flex gap-2">
                                <button 
                                    onclick="event.stopPropagation(); editarCoachDesdeLista('${coach.id}')"
                                    class="flex-1 px-3 py-2 text-xs font-medium text-blue-600 dark:text-blue-400 border border-blue-300 dark:border-blue-600 rounded-lg hover:bg-blue-50 dark:hover:bg-blue-900/30 transition-colors flex items-center justify-center gap-1.5"
                                >
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                    Editar
                                </button>
                                <button 
                                    onclick="event.stopPropagation(); eliminarCoachDesdeLista('${coach.id}')"
                                    class="flex-1 px-3 py-2 text-xs font-medium text-red-600 dark:text-red-400 border border-red-300 dark:border-red-600 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/30 transition-colors flex items-center justify-center gap-1.5"
                                >
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                    Eliminar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getDiasTexto(dias) {
            const nombres = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
            return dias.map(d => nombres[d]).join(', ');
        }

        // ========================================
        // DASHBOARD DEL COACH
        // ========================================

        function renderDashboard() {
            const data = loadData();
            const coach = data.coaches.find(c => c.id === currentCoachId);

            if (!coach) {
                mostrarVistaLista();
                return;
            }

            // Info del coach
            document.getElementById('coach-nombre').textContent = `Coach ${coach.nombre}`;

            // Mostrar estado con colores
            const estado = coach.estado || 'activo';
            const estadoBadge = document.getElementById('coach-estado-badge');
            switch (estado) {
                case 'activo':
                    estadoBadge.className = 'px-3 py-1 text-xs font-semibold rounded bg-green-100 text-green-700';
                    estadoBadge.textContent = 'Activo';
                    break;
                case 'inactivo':
                    estadoBadge.className = 'px-3 py-1 text-xs font-semibold rounded bg-red-100 text-red-700';
                    estadoBadge.textContent = 'Inactivo';
                    break;
                case 'pausado':
                    estadoBadge.className = 'px-3 py-1 text-xs font-semibold rounded bg-yellow-100 text-yellow-700';
                    estadoBadge.textContent = 'Pausado';
                    break;
                default:
                    estadoBadge.className = 'px-3 py-1 text-xs font-semibold rounded bg-gray-100 text-gray-700';
                    estadoBadge.textContent = estado;
            }

            const pagos = data.pagos[currentCoachId] || [];

            // Verificar si hay pagos
            if (pagos.length === 0) {
                // Sin pagos: mostrar mensaje y ocultar bot√≥n gestionar
                document.getElementById('mensaje-sin-pagos').classList.remove('hidden');
                document.getElementById('btn-ver-historial').classList.add('hidden');
                document.getElementById('btn-ver-historial').classList.remove('flex');
                document.getElementById('contenido-calendario-metricas').classList.add('hidden');
            } else {
                // Con pagos: mostrar contenido y bot√≥n gestionar
                document.getElementById('mensaje-sin-pagos').classList.add('hidden');
                document.getElementById('btn-ver-historial').classList.remove('hidden');
                document.getElementById('btn-ver-historial').classList.add('flex');

                // Cargar selector de periodos
                cargarSelectorPeriodos();

                // Buscar periodo que contenga la fecha actual
                const fechaActual = fechaSimulada || formatDate(new Date());
                let periodoActual = pagos.find(pago => {
                    return fechaActual >= pago.periodoInicio && fechaActual <= pago.periodoFin;
                });

                // Si hay un periodo actual, seleccionarlo autom√°ticamente
                if (periodoActual && !currentPagoId) {
                    currentPagoId = periodoActual.id;
                    const selector = document.getElementById('select-periodo-pago');
                    if (selector) selector.value = currentPagoId;
                }

                // Solo renderizar si hay un periodo seleccionado
                if (currentPagoId) {
                    const pagoSeleccionado = pagos.find(p => p.id === currentPagoId);
                    if (pagoSeleccionado) {
                        document.getElementById('contenido-calendario-metricas').classList.remove('hidden');
                        inicializarVistaCalendario(); // Establecer vista por defecto seg√∫n dispositivo
                        renderCalendarioPeriodo();
                        renderHistorialPagos();
                    } else {
                        // Si el periodo no existe, limpiar selecci√≥n
                        currentPagoId = null;
                        document.getElementById('contenido-calendario-metricas').classList.add('hidden');
                    }
                } else {
                    // No hay periodo seleccionado, ocultar calendario y m√©tricas
                    document.getElementById('contenido-calendario-metricas').classList.add('hidden');
                }
            }
        }

        function cargarSelectorPeriodos() {
            const data = loadData();
            const pagos = (data.pagos[currentCoachId] || []).sort((a, b) =>
                new Date(a.periodoInicio) - new Date(b.periodoInicio)
            );

            const selector = document.getElementById('select-periodo-pago');

            // Opci√≥n por defecto
            let opciones = '<option value="">Selecciona un periodo...</option>';

            // Agregar todos los periodos
            opciones += pagos.map(pago => `
                <option value="${pago.id}">
                    ${formatDateDisplay(pago.periodoInicio)} - ${formatDateDisplay(pago.periodoFin)} 
                    (${formatCurrency(pago.monto)})
                </option>
            `).join('');

            selector.innerHTML = opciones;

            // Asegurar que el valor seleccionado coincida con currentPagoId
            if (currentPagoId) {
                selector.value = currentPagoId;
                console.log('Selector sincronizado con currentPagoId:', currentPagoId, '- Valor del selector:', selector.value);
            } else {
                selector.value = '';
                console.log('No hay periodo seleccionado - mostrando opci√≥n por defecto');
            }
        }

        // ========================================
        // CALENDARIO
        // ========================================

        function getDiasLaborablesPeriodo(inicio, fin, diasLaborables) {
            const days = [];
            const inicioDate = new Date(inicio + 'T00:00:00');
            const finDate = new Date(fin + 'T00:00:00');

            let currentDate = new Date(inicioDate);

            while (currentDate <= finDate) {
                const dayOfWeek = currentDate.getDay();
                if (diasLaborables.includes(dayOfWeek)) {
                    days.push(formatDate(currentDate));
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }

            return days;
        }

        function getTodosDiasPeriodo(inicio, fin) {
            const days = [];
            const inicioDate = new Date(inicio + 'T00:00:00');
            const finDate = new Date(fin + 'T00:00:00');

            let currentDate = new Date(inicioDate);

            while (currentDate <= finDate) {
                days.push({
                    fecha: formatDate(currentDate),
                    diaSemana: currentDate.getDay()
                });
                currentDate.setDate(currentDate.getDate() + 1);
            }

            return days;
        }

        // ========================================
        // VISTAS DEL CALENDARIO
        // ========================================

        function actualizarBotonesVista() {
            // Actualizar estilos de los botones
            document.querySelectorAll('.vista-calendario-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'dark:bg-gray-600', 'text-gray-900', 'dark:text-white', 'shadow-sm');
                btn.classList.add('text-gray-600', 'dark:text-gray-400', 'hover:text-gray-900', 'dark:hover:text-white', 'hover:bg-white/50', 'dark:hover:bg-gray-600/50');
            });

            const botonActivo = document.getElementById(`vista-${currentVistaCalendario}-btn`);
            if (botonActivo) {
                botonActivo.classList.remove('text-gray-600', 'dark:text-gray-400', 'hover:text-gray-900', 'dark:hover:text-white', 'hover:bg-white/50', 'dark:hover:bg-gray-600/50');
                botonActivo.classList.add('bg-white', 'dark:bg-gray-600', 'text-gray-900', 'dark:text-white', 'shadow-sm');
            }
        }

        function cambiarVistaCalendario(vista) {
            currentVistaCalendario = vista;
            actualizarBotonesVista();

            // Re-renderizar calendario con la nueva vista
            renderCalendarioPeriodo();
        }

        function inicializarVistaCalendario() {
            // Establecer vista por defecto seg√∫n el tama√±o de pantalla
            currentVistaCalendario = esMobile() ? 'lista' : 'mensual';
            actualizarBotonesVista();
        }

        function renderCalendarioPeriodo() {
            const data = loadData();
            const coach = data.coaches.find(c => c.id === currentCoachId);
            const pago = (data.pagos[currentCoachId] || []).find(p => p.id === currentPagoId);

            if (!pago || !currentPagoId) {
                // Ocultar calendario y m√©tricas si no hay periodo seleccionado
                document.getElementById('calendar-grid').innerHTML = '<p class="text-center text-gray-500 py-8">Selecciona un periodo para ver el calendario</p>';

                // Limpiar m√©tricas
                document.getElementById('metric-programadas').textContent = '0';
                document.getElementById('metric-asistidas').textContent = '0';
                document.getElementById('metric-faltas').textContent = '0';
                document.getElementById('metric-reprogramaciones').textContent = '0/0';
                document.getElementById('metric-pendientes').textContent = '0';

                const indicador = document.getElementById('reprogramaciones-disponibles');
                if (indicador) indicador.style.display = 'none';

                // Ocultar alertas
                const alertaCompletado = document.getElementById('alerta-completado');
                const alertaPendientes = document.getElementById('alerta-pendientes');
                if (alertaCompletado) alertaCompletado.classList.add('hidden');
                if (alertaPendientes) alertaPendientes.classList.add('hidden');

                return;
            }

            // Renderizar seg√∫n la vista seleccionada
            if (currentVistaCalendario === 'semanal') {
                renderVistaSemanal(data, coach, pago);
            } else if (currentVistaCalendario === 'lista') {
                renderVistaLista(data, coach, pago);
            } else {
                renderVistaMensual(data, coach, pago);
            }

            updateMetrics();
        }

        function renderVistaMensual(data, coach, pago) {
            const grid = document.getElementById('calendar-grid');

            console.log('Renderizando calendario para periodo:', pago.periodoInicio, '-', pago.periodoFin, 'ID:', pago.id);

            const days = getTodosDiasPeriodo(pago.periodoInicio, pago.periodoFin);
            const asistencias = data.asistencias[currentCoachId] || {};

            // Calcular reprogramaciones disponibles
            const daysLaborables = getDiasLaborablesPeriodo(pago.periodoInicio, pago.periodoFin, coach.diasLaborables);
            let asistidas = 0;
            daysLaborables.forEach(day => {
                const asist = asistencias[day];
                if (asist?.asistio) asistidas++;
            });
            const programadas = daysLaborables.length;
            const faltas = programadas - asistidas;

            let reprogramacionesExistentes = 0;
            days.forEach(({ fecha }) => {
                const asist = asistencias[fecha];
                if (asist?.reprogramacion) reprogramacionesExistentes++;
            });

            const hayReprogramacionesDisponibles = reprogramacionesExistentes < faltas;

            let html = `<div class="grid grid-cols-7 gap-3 sm:gap-3" style="min-width: 1100px;">`;

            // Headers (todos los d√≠as de la semana)
            const diasNombres = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
            diasNombres.forEach(dia => {
                html += `<div class="text-base sm:text-lg font-semibold text-gray-700 dark:text-gray-300 text-center py-3">${dia}</div>`;
            });

            // Agregar espacios vac√≠os al inicio si el mes no empieza en domingo
            const primerDia = days[0].diaSemana;
            for (let i = 0; i < primerDia; i++) {
                html += `<div class="border border-transparent rounded-lg p-3 h-48 sm:h-52 md:h-56"></div>`;
            }

            // Obtener fecha actual (solo fecha, sin hora) - usar fecha simulada si existe
            const hoy = fechaSimulada ? new Date(fechaSimulada) : new Date();
            const fechaActual = formatDate(hoy);
            
            // Cargar configuraci√≥n para verificar modo de pruebas
            const config = loadConfig();
            const modoPruebas = config.modoPruebas || false;

            // Renderizar todos los d√≠as
            days.forEach(({ fecha: dateStr, diaSemana }) => {
                const asist = asistencias[dateStr] || { asistio: null, reprogramacion: false, nota: '' };
                const esLaborable = coach.diasLaborables.includes(diaSemana);
                const esDiaActual = dateStr === fechaActual;
                const esDiaFuturo = dateStr > fechaActual;
                const mostrarCheckAsistencia = !esDiaFuturo || modoPruebas; // Mostrar si NO es futuro O si est√° en modo pruebas

                // Determinar clases de borde
                let borderClasses = '';
                if (esDiaActual) {
                    borderClasses = 'border-4 border-blue-500 dark:border-blue-400 shadow-lg';
                } else if (esLaborable) {
                    borderClasses = 'border border-gray-300 dark:border-gray-600';
                } else {
                    borderClasses = 'border border-gray-200 dark:border-gray-700';
                }

                // Obtener informaci√≥n de la rutina si existe
                const tieneRutina = asist.rutina && (asist.rutina.ejercicios?.length > 0 || asist.rutina.nota);
                const numEjercicios = tieneRutina ? (asist.rutina.ejercicios?.length || 0) : 0;
                const tieneCalentamiento = tieneRutina && asist.rutina.calentamiento;
                const esRutinaIA = tieneRutina && asist.rutina.generadaPorIA;

                // Crear badges para tipos de entrenamiento
                let tiposBadges = '';
                if (tieneRutina) {
                    // Badge de IA (prominente)
                    if (esRutinaIA) {
                        tiposBadges += '<span class="inline-flex items-center gap-0.5 px-1.5 py-0.5 text-[10px] sm:text-xs font-bold bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded shadow-sm">ü§ñ IA</span> ';
                    }
                    if (asist.rutina.tipoMaquinas) {
                        tiposBadges += '<span class="inline-block px-1.5 py-0.5 text-[10px] sm:text-xs font-semibold bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded">M√°q</span> ';
                    }
                    if (asist.rutina.tipoCalistenia) {
                        tiposBadges += '<span class="inline-block px-1.5 py-0.5 text-[10px] sm:text-xs font-semibold bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 rounded">Calis</span> ';
                    }
                }

                const trenTexto = tieneRutina && asist.rutina.tren ?
                    (asist.rutina.tren === 'superior' ? 'Tren Superior' : 'Tren Inferior') : '';

                html += `
                    <div class="${borderClasses} rounded-lg p-3 ${esLaborable ? (asist.asistio === true ? 'bg-green-50 dark:bg-green-900/20' : (asist.asistio === false ? 'bg-red-50 dark:bg-red-900/10' : 'bg-white dark:bg-gray-800')) : 'bg-white dark:bg-gray-800'} h-48 sm:h-52 md:h-56 flex flex-col overflow-hidden ${esDiaActual ? 'relative' : ''}">
                        <div class="flex justify-between items-start mb-2 flex-shrink-0">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-1.5 flex-wrap">
                                    <p class="text-base sm:text-lg font-bold ${esLaborable ? 'text-gray-700 dark:text-gray-300' : 'text-gray-400 dark:text-gray-600'}">${formatDateDisplay(dateStr).split(' ').slice(0, 2).join(' ')}</p>
                                    ${esDiaActual ? '<span class="px-2 py-1 text-xs sm:text-sm font-bold bg-blue-500 dark:bg-blue-600 text-white rounded">HOY</span>' : ''}
                                </div>
                                ${!esLaborable ? '<p class="text-xs sm:text-sm text-gray-500 dark:text-gray-500 leading-tight font-medium">üõå D√≠a de descanso</p>' : ''}
                            </div>
                            ${(tieneRutina || mostrarCheckAsistencia) ? `
                                <button 
                                    onclick="abrirModalNotaDia('${dateStr}')"
                                    class="flex-shrink-0 ml-1 p-1.5 rounded-lg ${tieneRutina ? 'text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/30' : 'text-gray-400 dark:text-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700'} transition-colors"
                                    title="${tieneRutina ? 'Ver rutina' : 'Agregar rutina'}"
                                >
                                    ${tieneRutina ? '<svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>' : '<svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>'}
                                </button>
                            ` : ''}
                        </div>
                        ${esLaborable && mostrarCheckAsistencia ? `
                            <button onclick="toggleAsistencia('${dateStr}')" class="flex items-center gap-2 cursor-pointer mb-2 flex-shrink-0 group">
                                <div class="relative flex-shrink-0">
                                    <div class="w-5 h-5 sm:w-6 sm:h-6 rounded border-2 flex items-center justify-center transition-all relative
                                        ${asist.asistio === true 
                                            ? 'bg-green-500 dark:bg-green-600 border-green-500 dark:border-green-600' 
                                            : (asist.asistio === false 
                                                ? 'bg-red-50 dark:bg-red-900/20 border-red-400 dark:border-red-600' 
                                                : 'bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600')}
                                        group-hover:scale-110 group-hover:shadow-sm">
                                        <!-- Check verde cuando asisti√≥ -->
                                        ${asist.asistio === true ? `
                                            <svg class="w-4 h-4 sm:w-5 sm:h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="stroke-width: 3">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                                            </svg>
                                        ` : ''}
                                        <!-- X roja cuando NO asisti√≥ -->
                                        ${asist.asistio === false ? `
                                            <svg class="w-4 h-4 sm:w-5 sm:h-5 text-red-500 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="stroke-width: 3">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                                            </svg>
                                        ` : ''}
                                        <!-- Vac√≠o cuando es null -->
                                    </div>
                                </div>
                                <span class="text-sm sm:text-base font-medium transition-colors
                                    ${asist.asistio === true 
                                        ? 'text-green-700 dark:text-green-400' 
                                        : (asist.asistio === false 
                                            ? 'text-red-600 dark:text-red-400' 
                                            : 'text-gray-500 dark:text-gray-400')}">
                                    ${asist.asistio === true ? 'Asisti√≥ ‚úì' : (asist.asistio === false ? 'No Asisti√≥ ‚úó' : 'Sin marcar')}
                                </span>
                            </button>
                        ` : ''}
                        ${esLaborable && !mostrarCheckAsistencia && !tieneRutina ? `
                            <div class="flex items-center gap-2 mb-2 flex-shrink-0">
                                <div class="flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
                                    <svg class="w-4 h-4 text-blue-500 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    <span class="text-xs sm:text-sm font-medium text-blue-700 dark:text-blue-300">Pr√≥xima clase</span>
                                </div>
                            </div>
                        ` : ''}
                        ${!esLaborable ? `
                            ${asist.reprogramacion ? `
                                <button onclick="toggleAsistencia('${dateStr}')" class="flex items-center gap-2 cursor-pointer mb-2 flex-shrink-0 group">
                                    <div class="relative flex-shrink-0">
                                        <div class="w-5 h-5 sm:w-6 sm:h-6 rounded border-2 flex items-center justify-center transition-all relative
                                            ${asist.asistio === true 
                                                ? 'bg-green-500 dark:bg-green-600 border-green-500 dark:border-green-600' 
                                                : (asist.asistio === false 
                                                    ? 'bg-red-50 dark:bg-red-900/20 border-red-400 dark:border-red-600' 
                                                    : 'bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600')}
                                            group-hover:scale-110 group-hover:shadow-sm">
                                            ${asist.asistio === true ? `
                                                <svg class="w-4 h-4 sm:w-5 sm:h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="stroke-width: 3">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                                                </svg>
                                            ` : ''}
                                            ${asist.asistio === false ? `
                                                <svg class="w-4 h-4 sm:w-5 sm:h-5 text-red-500 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="stroke-width: 3">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                                                </svg>
                                            ` : ''}
                                        </div>
                                    </div>
                                    <span class="text-sm sm:text-base font-medium transition-colors
                                        ${asist.asistio === true 
                                            ? 'text-green-700 dark:text-green-400' 
                                            : (asist.asistio === false 
                                                ? 'text-red-600 dark:text-red-400' 
                                                : 'text-gray-500 dark:text-gray-400')}">
                                        ${asist.asistio === true ? 'Asisti√≥ ‚úì' : (asist.asistio === false ? 'No Asisti√≥ ‚úó' : 'Sin marcar')}
                                    </span>
                                </button>
                            ` : ''}
                            <button 
                                onclick="toggleReprogramacion('${dateStr}')"
                                class="flex flex-col gap-0.5 text-xs sm:text-sm ${asist.reprogramacion ? 'text-blue-700 dark:text-blue-300 bg-blue-100 dark:bg-blue-900/50 hover:bg-blue-200 dark:hover:bg-blue-900/70' : (hayReprogramacionesDisponibles && esDiaFuturo ? 'text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600' : 'text-gray-400 dark:text-gray-600 bg-gray-50 dark:bg-gray-800 cursor-not-allowed opacity-50')} px-2.5 py-1.5 rounded transition-colors mb-2 flex-shrink-0"
                                title="${asist.reprogramacion ? 'Quitar reagendamiento' : (esDiaFuturo ? (hayReprogramacionesDisponibles ? 'Reagendar una clase perdida en este d√≠a' : 'No hay clases pendientes por reagendar') : 'Solo se puede reagendar en d√≠as futuros')}"
                                ${!asist.reprogramacion && (!hayReprogramacionesDisponibles || !esDiaFuturo) ? 'disabled' : ''}
                            >
                                <span class="font-semibold flex items-center gap-1">
                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                    </svg>
                                    ${asist.reprogramacion ? 'Clase reagendada' : 'Reagendar clase'}
                                </span>
                                ${asist.reprogramacion && asist.reprogramacionDe ? `<span class="text-[10px] font-normal opacity-75">üìÖ Recupera falta del: ${formatDateDisplay(asist.reprogramacionDe).split(' ').slice(0, 2).join(' ')}</span>` : ''}
                            </button>
                        ` : ''}
                        <div class="flex-1 overflow-hidden min-h-0">
                            ${tieneRutina ? `
                                <div class="space-y-1.5">
                                    ${tieneCalentamiento ? '<div class="inline-block px-2 py-0.5 text-[10px] sm:text-xs font-semibold bg-orange-100 dark:bg-orange-900 text-orange-700 dark:text-orange-300 rounded">Calentamiento</div>' : ''}
                                    ${trenTexto ? `<p class="text-xs sm:text-sm font-semibold text-purple-700 dark:text-purple-300">${trenTexto}</p>` : ''}
                                    <div class="flex items-center gap-1 flex-wrap">
                                        ${tiposBadges}
                                        ${numEjercicios > 0 ? `<span class="text-xs sm:text-sm text-gray-700 dark:text-gray-300 font-medium">${numEjercicios} ejercicio${numEjercicios !== 1 ? 's' : ''}</span>` : ''}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            grid.innerHTML = html;
        }

        function renderVistaSemanal(data, coach, pago) {
            const grid = document.getElementById('calendar-grid');

            const days = getTodosDiasPeriodo(pago.periodoInicio, pago.periodoFin);
            const asistencias = data.asistencias[currentCoachId] || {};

            // Calcular reprogramaciones disponibles
            const daysLaborables = getDiasLaborablesPeriodo(pago.periodoInicio, pago.periodoFin, coach.diasLaborables);
            let asistidas = 0;
            daysLaborables.forEach(day => {
                const asist = asistencias[day];
                if (asist?.asistio) asistidas++;
            });
            const programadas = daysLaborables.length;
            const faltas = programadas - asistidas;

            let reprogramacionesExistentes = 0;
            days.forEach(({ fecha }) => {
                const asist = asistencias[fecha];
                if (asist?.reprogramacion) reprogramacionesExistentes++;
            });

            const hayReprogramacionesDisponibles = reprogramacionesExistentes < faltas;

            // Obtener fecha actual
            const hoy = fechaSimulada ? new Date(fechaSimulada) : new Date();
            const fechaActual = formatDate(hoy);
            
            // Cargar configuraci√≥n para verificar modo de pruebas
            const config = loadConfig();
            const modoPruebas = config.modoPruebas || false;

            // Agrupar d√≠as por semanas
            const semanas = [];
            let semanaActual = [];

            days.forEach(({ fecha, diaSemana }, index) => {
                if (diaSemana === 0 && semanaActual.length > 0) {
                    semanas.push(semanaActual);
                    semanaActual = [];
                }
                semanaActual.push({ fecha, diaSemana });

                if (index === days.length - 1) {
                    semanas.push(semanaActual);
                }
            });

            let html = '<div class="space-y-4">';

            semanas.forEach((semana, indexSemana) => {
                const primerDia = semana[0].fecha;
                const ultimoDia = semana[semana.length - 1].fecha;

                html += `
                    <div class="bg-gray-50 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
                        <div class="bg-gradient-to-r from-blue-600 to-purple-600 dark:from-blue-700 dark:to-purple-700 px-4 py-2">
                            <p class="text-white font-semibold">Semana ${indexSemana + 1}: ${formatDateDisplay(primerDia)} - ${formatDateDisplay(ultimoDia)}</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-7 divide-y md:divide-y-0 md:divide-x divide-gray-200 dark:divide-gray-700">
                `;

                const diasNombres = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];

                semana.forEach(({ fecha: dateStr, diaSemana }) => {
                    const asist = asistencias[dateStr] || { asistio: null, reprogramacion: false, nota: '' };
                    const esLaborable = coach.diasLaborables.includes(diaSemana);
                    const esDiaActual = dateStr === fechaActual;
                    const esDiaFuturo = dateStr > fechaActual;
                    const mostrarCheckAsistencia = !esDiaFuturo || modoPruebas; // Mostrar si NO es futuro O si est√° en modo pruebas

                    const tieneRutina = asist.rutina && (asist.rutina.ejercicios?.length > 0 || asist.rutina.nota);
                    const numEjercicios = tieneRutina ? (asist.rutina.ejercicios?.length || 0) : 0;
                    const tieneCalentamiento = tieneRutina && asist.rutina.calentamiento;

                    let tiposBadges = '';
                    if (tieneRutina) {
                        if (asist.rutina.tipoMaquinas) {
                            tiposBadges += '<span class="inline-block px-1.5 py-0.5 text-xs font-semibold bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded mr-1">M√°q</span>';
                        }
                        if (asist.rutina.tipoCalistenia) {
                            tiposBadges += '<span class="inline-block px-1.5 py-0.5 text-xs font-semibold bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 rounded">Calis</span>';
                        }
                    }

                    const trenTexto = tieneRutina && asist.rutina.tren ?
                        (asist.rutina.tren === 'superior' ? 'Tren Superior' : 'Tren Inferior') : '';

                    html += `
                        <div class="p-4 ${esLaborable ? (asist.asistio === true ? 'bg-green-50 dark:bg-green-900/20' : (asist.asistio === false ? 'bg-red-50 dark:bg-red-900/10' : 'bg-white dark:bg-gray-800')) : 'bg-white dark:bg-gray-800'} ${esDiaActual ? 'border-l-4 border-blue-500 dark:border-blue-400' : ''}">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <p class="text-sm font-semibold text-gray-500 dark:text-gray-400">${diasNombres[diaSemana]}</p>
                                    <p class="text-lg font-bold ${esLaborable ? 'text-gray-900 dark:text-white' : 'text-gray-400 dark:text-gray-600'}">${formatDateDisplay(dateStr).split(' ')[0]}</p>
                                    ${esDiaActual ? '<span class="inline-block px-2 py-0.5 text-xs font-bold bg-blue-500 dark:bg-blue-600 text-white rounded mt-1">HOY</span>' : ''}
                                    ${!esLaborable ? '<p class="text-xs text-gray-500 dark:text-gray-500 mt-1 font-medium">üõå D√≠a de descanso</p>' : ''}
                                </div>
                                ${(tieneRutina || mostrarCheckAsistencia) ? `
                                    <button 
                                        onclick="abrirModalNotaDia('${dateStr}')"
                                        class="p-1.5 rounded-lg ${tieneRutina ? 'text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/30' : 'text-gray-400 dark:text-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700'} transition-colors"
                                        title="${tieneRutina ? 'Ver rutina' : 'Agregar rutina'}"
                                    >
                                        ${tieneRutina ? '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>' : '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>'}
                                    </button>
                                ` : ''}
                            </div>
                            ${esLaborable && mostrarCheckAsistencia ? `
                                <button onclick="toggleAsistencia('${dateStr}')" class="flex items-center gap-2 cursor-pointer mb-3 group">
                                    <div class="relative flex-shrink-0">
                                        <div class="w-5 h-5 rounded border-2 flex items-center justify-center transition-all relative
                                            ${asist.asistio === true 
                                                ? 'bg-green-500 dark:bg-green-600 border-green-500 dark:border-green-600' 
                                                : (asist.asistio === false 
                                                    ? 'bg-red-50 dark:bg-red-900/20 border-red-400 dark:border-red-600' 
                                                    : 'bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600')}
                                            group-hover:scale-110 group-hover:shadow-sm">
                                            <!-- Check verde cuando asisti√≥ -->
                                            ${asist.asistio === true ? `
                                                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="stroke-width: 3">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                                                </svg>
                                            ` : ''}
                                            <!-- X roja cuando NO asisti√≥ -->
                                            ${asist.asistio === false ? `
                                                <svg class="w-4 h-4 text-red-500 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="stroke-width: 3">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                                                </svg>
                                            ` : ''}
                                        </div>
                                    </div>
                                    <span class="text-sm font-medium transition-colors
                                        ${asist.asistio === true 
                                            ? 'text-green-700 dark:text-green-400' 
                                            : (asist.asistio === false 
                                                ? 'text-red-600 dark:text-red-400' 
                                                : 'text-gray-500 dark:text-gray-400')}">
                                        ${asist.asistio === true ? 'Asisti√≥ ‚úì' : (asist.asistio === false ? 'No Asisti√≥ ‚úó' : 'Sin marcar')}
                                    </span>
                                </button>
                            ` : ''}
                            ${esLaborable && !mostrarCheckAsistencia && !tieneRutina ? `
                                <div class="flex items-center gap-2 mb-3">
                                    <div class="flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 border border-blue-200 dark:border-blue-800 rounded-lg w-full">
                                        <svg class="w-4 h-4 text-blue-500 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        <span class="text-xs font-medium text-blue-700 dark:text-blue-300">Pr√≥xima clase</span>
                                    </div>
                                </div>
                            ` : ''}
                            ${!esLaborable ? `
                                ${asist.reprogramacion ? `
                                    <button onclick="toggleAsistencia('${dateStr}')" class="flex items-center gap-2 cursor-pointer mb-3 group">
                                        <div class="relative flex-shrink-0">
                                            <div class="w-5 h-5 rounded border-2 flex items-center justify-center transition-all relative
                                                ${asist.asistio === true 
                                                    ? 'bg-green-500 dark:bg-green-600 border-green-500 dark:border-green-600' 
                                                    : (asist.asistio === false 
                                                        ? 'bg-red-50 dark:bg-red-900/20 border-red-400 dark:border-red-600' 
                                                        : 'bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600')}
                                                group-hover:scale-110 group-hover:shadow-sm">
                                                ${asist.asistio === true ? `
                                                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="stroke-width: 3">
                                                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                                                    </svg>
                                                ` : ''}
                                                ${asist.asistio === false ? `
                                                    <svg class="w-4 h-4 text-red-500 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="stroke-width: 3">
                                                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                                                    </svg>
                                                ` : ''}
                                            </div>
                                        </div>
                                        <span class="text-sm font-medium transition-colors
                                            ${asist.asistio === true 
                                                ? 'text-green-700 dark:text-green-400' 
                                                : (asist.asistio === false 
                                                    ? 'text-red-600 dark:text-red-400' 
                                                    : 'text-gray-500 dark:text-gray-400')}">
                                            ${asist.asistio === true ? 'Asisti√≥ ‚úì' : (asist.asistio === false ? 'No Asisti√≥ ‚úó' : 'Sin marcar')}
                                        </span>
                                    </button>
                                ` : ''}
                                <button 
                                    onclick="toggleReprogramacion('${dateStr}')"
                                    class="flex flex-col gap-0.5 text-sm ${asist.reprogramacion ? 'text-blue-700 dark:text-blue-300 bg-blue-100 dark:bg-blue-900/50 hover:bg-blue-200 dark:hover:bg-blue-900/70' : (hayReprogramacionesDisponibles && esDiaFuturo ? 'text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600' : 'text-gray-400 dark:text-gray-600 bg-gray-50 dark:bg-gray-800 cursor-not-allowed opacity-50')} px-2.5 py-1.5 rounded transition-colors mb-3 w-full items-center"
                                    title="${asist.reprogramacion ? 'Quitar reagendamiento' : (esDiaFuturo ? (hayReprogramacionesDisponibles ? 'Reagendar una clase perdida en este d√≠a' : 'No hay clases pendientes por reagendar') : 'Solo se puede reagendar en d√≠as futuros')}"
                                    ${!asist.reprogramacion && (!hayReprogramacionesDisponibles || !esDiaFuturo) ? 'disabled' : ''}
                                >
                                    <span class="font-semibold flex items-center gap-1">
                                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                        </svg>
                                        ${asist.reprogramacion ? 'Clase reagendada' : 'Reagendar clase'}
                                    </span>
                                    ${asist.reprogramacion && asist.reprogramacionDe ? `<span class="text-xs font-normal opacity-75">üìÖ Recupera falta del: ${formatDateDisplay(asist.reprogramacionDe).split(' ').slice(0, 2).join(' ')}</span>` : ''}
                                </button>
                            ` : ''}
                            ${tieneRutina ? `
                                <div class="space-y-2 text-sm">
                                    ${tieneCalentamiento ? '<div class="inline-block px-2 py-0.5 text-xs font-semibold bg-orange-100 text-orange-700 rounded">Calentamiento</div>' : ''}
                                    ${trenTexto ? `<p class="text-xs font-semibold text-purple-700">${trenTexto}</p>` : ''}
                                    <div class="flex items-center gap-1 flex-wrap">
                                        ${tiposBadges}
                                    </div>
                                    ${numEjercicios > 0 ? `<p class="text-sm text-gray-700 font-medium">${numEjercicios} ejercicio${numEjercicios !== 1 ? 's' : ''}</p>` : ''}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            grid.innerHTML = html;
        }

        function renderVistaLista(data, coach, pago) {
            const grid = document.getElementById('calendar-grid');

            const days = getTodosDiasPeriodo(pago.periodoInicio, pago.periodoFin);
            const asistencias = data.asistencias[currentCoachId] || {};

            // Calcular reprogramaciones disponibles
            const daysLaborables = getDiasLaborablesPeriodo(pago.periodoInicio, pago.periodoFin, coach.diasLaborables);
            let asistidas = 0;
            daysLaborables.forEach(day => {
                const asist = asistencias[day];
                if (asist?.asistio) asistidas++;
            });
            const programadas = daysLaborables.length;
            const faltas = programadas - asistidas;

            let reprogramacionesExistentes = 0;
            days.forEach(({ fecha }) => {
                const asist = asistencias[fecha];
                if (asist?.reprogramacion) reprogramacionesExistentes++;
            });

            const hayReprogramacionesDisponibles = reprogramacionesExistentes < faltas;

            // Obtener fecha actual
            const hoy = fechaSimulada ? new Date(fechaSimulada) : new Date();
            const fechaActual = formatDate(hoy);
            
            // Cargar configuraci√≥n para verificar modo de pruebas
            const config = loadConfig();
            const modoPruebas = config.modoPruebas || false;

            const diasNombres = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];

            let html = '<div class="grid grid-cols-1 lg:grid-cols-2 gap-3">';

            days.forEach(({ fecha: dateStr, diaSemana }) => {
                const asist = asistencias[dateStr] || { asistio: null, reprogramacion: false, nota: '' };
                const esLaborable = coach.diasLaborables.includes(diaSemana);
                const esDiaActual = dateStr === fechaActual;
                const esDiaFuturo = dateStr > fechaActual;
                const mostrarCheckAsistencia = !esDiaFuturo || modoPruebas; // Mostrar si NO es futuro O si est√° en modo pruebas

                const tieneRutina = asist.rutina && (asist.rutina.ejercicios?.length > 0 || asist.rutina.nota);
                const numEjercicios = tieneRutina ? (asist.rutina.ejercicios?.length || 0) : 0;
                const tieneCalentamiento = tieneRutina && asist.rutina.calentamiento;

                let tiposBadges = '';
                if (tieneRutina) {
                    if (asist.rutina.tipoMaquinas) {
                        tiposBadges += '<span class="inline-block px-2 py-0.5 text-xs font-semibold bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded mr-1">M√°q</span>';
                    }
                    if (asist.rutina.tipoCalistenia) {
                        tiposBadges += '<span class="inline-block px-2 py-0.5 text-xs font-semibold bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 rounded">Calis</span>';
                    }
                }

                const trenTexto = tieneRutina && asist.rutina.tren ?
                    (asist.rutina.tren === 'superior' ? 'Tren Superior' : 'Tren Inferior') : '';

                html += `
                    <div class="border ${esDiaActual ? 'border-blue-500 dark:border-blue-400 border-2' : 'border-gray-200 dark:border-gray-700'} rounded-lg p-4 ${esLaborable ? (asist.asistio === true ? 'bg-green-50 dark:bg-green-900/20' : (asist.asistio === false ? 'bg-red-50 dark:bg-red-900/10' : 'bg-white dark:bg-gray-800')) : 'bg-white dark:bg-gray-800'}">
                        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2 flex-wrap">
                                    <div>
                                        <p class="text-lg font-bold text-gray-900 dark:text-white">${formatDateDisplay(dateStr)}</p>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">${diasNombres[diaSemana]}</p>
                                    </div>
                                    ${esDiaActual ? '<span class="px-2 py-1 text-xs font-bold bg-blue-500 dark:bg-blue-600 text-white rounded">HOY</span>' : ''}
                                    ${!esLaborable ? '<span class="px-2 py-1 text-xs font-medium bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded">üõå D√≠a de descanso</span>' : ''}
                                </div>
                                
                                ${esLaborable && mostrarCheckAsistencia ? `
                                    <button onclick="toggleAsistencia('${dateStr}')" class="flex items-center gap-2 cursor-pointer mb-2 group">
                                        <div class="relative flex-shrink-0">
                                            <div class="w-5 h-5 rounded border-2 flex items-center justify-center transition-all relative
                                                ${asist.asistio === true 
                                                    ? 'bg-green-500 dark:bg-green-600 border-green-500 dark:border-green-600' 
                                                    : (asist.asistio === false 
                                                        ? 'bg-red-50 dark:bg-red-900/20 border-red-400 dark:border-red-600' 
                                                        : 'bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600')}
                                                group-hover:scale-110 group-hover:shadow-sm">
                                                <!-- Check verde cuando asisti√≥ -->
                                                ${asist.asistio === true ? `
                                                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="stroke-width: 3">
                                                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                                                    </svg>
                                                ` : ''}
                                                <!-- X roja cuando NO asisti√≥ -->
                                                ${asist.asistio === false ? `
                                                    <svg class="w-4 h-4 text-red-500 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="stroke-width: 3">
                                                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                                                    </svg>
                                                ` : ''}
                                            </div>
                                        </div>
                                        <span class="text-sm font-medium transition-colors
                                            ${asist.asistio === true 
                                                ? 'text-green-700 dark:text-green-400' 
                                                : (asist.asistio === false 
                                                    ? 'text-red-600 dark:text-red-400' 
                                                    : 'text-gray-500 dark:text-gray-400')}">
                                            ${asist.asistio === true ? 'Asisti√≥ ‚úì' : (asist.asistio === false ? 'No Asisti√≥ ‚úó' : 'Sin marcar')}
                                        </span>
                                    </button>
                                ` : ''}
                                ${!esLaborable ? `
                                    ${asist.reprogramacion ? `
                                        <button onclick="toggleAsistencia('${dateStr}')" class="flex items-center gap-2 cursor-pointer mb-2 group">
                                            <div class="relative flex-shrink-0">
                                                <div class="w-5 h-5 rounded border-2 flex items-center justify-center transition-all relative
                                                    ${asist.asistio === true 
                                                        ? 'bg-green-500 dark:bg-green-600 border-green-500 dark:border-green-600' 
                                                        : (asist.asistio === false 
                                                            ? 'bg-red-50 dark:bg-red-900/20 border-red-400 dark:border-red-600' 
                                                            : 'bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600')}
                                                    group-hover:scale-110 group-hover:shadow-sm">
                                                    ${asist.asistio === true ? `
                                                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="stroke-width: 3">
                                                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                                                        </svg>
                                                    ` : ''}
                                                    ${asist.asistio === false ? `
                                                        <svg class="w-4 h-4 text-red-500 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="stroke-width: 3">
                                                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                                                        </svg>
                                                    ` : ''}
                                                </div>
                                            </div>
                                            <span class="text-sm font-medium transition-colors
                                                ${asist.asistio === true 
                                                    ? 'text-green-700 dark:text-green-400' 
                                                    : (asist.asistio === false 
                                                        ? 'text-red-600 dark:text-red-400' 
                                                        : 'text-gray-500 dark:text-gray-400')}">
                                                ${asist.asistio === true ? 'Asisti√≥ ‚úì' : (asist.asistio === false ? 'No Asisti√≥ ‚úó' : 'Sin marcar')}
                                            </span>
                                        </button>
                                    ` : ''}
                                    <button 
                                        onclick="toggleReprogramacion('${dateStr}')"
                                        class="inline-flex flex-col gap-0.5 text-sm ${asist.reprogramacion ? 'text-blue-700 dark:text-blue-300 bg-blue-100 dark:bg-blue-900/50 hover:bg-blue-200 dark:hover:bg-blue-900/70' : (hayReprogramacionesDisponibles && esDiaFuturo ? 'text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600' : 'text-gray-400 dark:text-gray-600 bg-gray-50 dark:bg-gray-800 cursor-not-allowed opacity-50')} px-3 py-1.5 rounded transition-colors mb-2 items-start"
                                        title="${asist.reprogramacion ? 'Quitar reagendamiento' : (esDiaFuturo ? (hayReprogramacionesDisponibles ? 'Reagendar una clase perdida en este d√≠a' : 'No hay clases pendientes por reagendar') : 'Solo se puede reagendar en d√≠as futuros')}"
                                        ${!asist.reprogramacion && (!hayReprogramacionesDisponibles || !esDiaFuturo) ? 'disabled' : ''}
                                    >
                                        <span class="font-semibold flex items-center gap-1">
                                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            </svg>
                                            ${asist.reprogramacion ? 'Clase reagendada' : 'Reagendar clase'}
                                        </span>
                                        ${asist.reprogramacion && asist.reprogramacionDe ? `<span class="text-xs font-normal opacity-75">üìÖ Recupera falta del: ${formatDateDisplay(asist.reprogramacionDe)}</span>` : ''}
                                    </button>
                                ` : ''}
                                
                                ${tieneRutina ? `
                                    <div class="flex items-center gap-2 flex-wrap mt-2">
                                        ${tieneCalentamiento ? '<span class="inline-block px-2 py-1 text-xs font-semibold bg-orange-100 dark:bg-orange-900 text-orange-700 dark:text-orange-300 rounded">Calentamiento</span>' : ''}
                                        ${trenTexto ? `<span class="inline-block px-2 py-1 text-xs font-semibold bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300 rounded">${trenTexto}</span>` : ''}
                                        ${tiposBadges}
                                        ${numEjercicios > 0 ? `<span class="inline-block px-2 py-1 text-xs font-semibold bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded">${numEjercicios} ejercicio${numEjercicios !== 1 ? 's' : ''}</span>` : ''}
                                    </div>
                                ` : ''}
                            </div>
                            
                            <button 
                                onclick="abrirModalNotaDia('${dateStr}')"
                                class="flex-shrink-0 px-4 py-2 rounded-lg ${tieneRutina ? 'text-white bg-blue-600 dark:bg-blue-500 hover:bg-blue-700 dark:hover:bg-blue-600' : 'text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600'} transition-colors flex items-center gap-2"
                            >
                                ${tieneRutina ? '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>' : '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>'}
                                <span>${tieneRutina ? 'Ver rutina' : 'Agregar rutina'}</span>
                            </button>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            grid.innerHTML = html;
        }

        function toggleAsistencia(dateStr) {
            const data = loadData();

            if (!data.asistencias[currentCoachId]) {
                data.asistencias[currentCoachId] = {};
            }

            if (!data.asistencias[currentCoachId][dateStr]) {
                data.asistencias[currentCoachId][dateStr] = { asistio: null, reprogramacion: false, rutina: null };
            }

            // Ciclo de 3 estados: null ‚Üí true ‚Üí false ‚Üí null
            const estadoActual = data.asistencias[currentCoachId][dateStr].asistio;
            
            if (estadoActual === null || estadoActual === undefined) {
                // De null a asisti√≥ (true)
                data.asistencias[currentCoachId][dateStr].asistio = true;
            } else if (estadoActual === true) {
                // De asisti√≥ a no asisti√≥ (false)
                data.asistencias[currentCoachId][dateStr].asistio = false;
            } else {
                // De no asisti√≥ a sin marcar (null)
                data.asistencias[currentCoachId][dateStr].asistio = null;
            }
            
            saveData(data);
            renderCalendarioPeriodo();
        }

        async function toggleReprogramacion(dateStr) {
            const data = loadData();
            const coach = data.coaches.find(c => c.id === currentCoachId);
            const pago = (data.pagos[currentCoachId] || []).find(p => p.id === currentPagoId);

            if (!pago) return;

            if (!data.asistencias[currentCoachId]) {
                data.asistencias[currentCoachId] = {};
            }

            if (!data.asistencias[currentCoachId][dateStr]) {
                data.asistencias[currentCoachId][dateStr] = { asistio: false, reprogramacion: false, rutina: null };
            }

            const reprogramacionActual = data.asistencias[currentCoachId][dateStr].reprogramacion;

            // Si est√° intentando MARCAR una reprogramaci√≥n (no quitarla)
            if (!reprogramacionActual) {
                // Calcular faltas y reprogramaciones actuales
                const daysLaborables = getDiasLaborablesPeriodo(pago.periodoInicio, pago.periodoFin, coach.diasLaborables);
                const asistencias = data.asistencias[currentCoachId] || {};
                const hoy = getFechaActual();

                // Obtener lista de d√≠as que falt√≥ (solo d√≠as pasados)
                const diasFaltados = [];
                daysLaborables.forEach(day => {
                    const asist = asistencias[day];
                    // Solo considerar faltas: d√≠as pasados donde NO asisti√≥ y NO tiene reprogramaci√≥n asociada
                    if (day <= hoy && !asist?.asistio) {
                        // Verificar si este d√≠a ya fue repuesto por otra reprogramaci√≥n
                        const yaRepuesto = Object.values(asistencias).some(a => a.reprogramacionDe === day);
                        if (!yaRepuesto) {
                            diasFaltados.push(day);
                        }
                    }
                });

                // Verificar si hay faltas disponibles para reponer
                if (diasFaltados.length === 0) {
                    Swal.fire({
                        icon: 'info',
                        title: 'No hay faltas disponibles',
                        text: 'Solo puedes marcar reprogramaciones cuando tienes d√≠as en los que no asististe.',
                        confirmButtonText: 'Entendido'
                    });
                    return;
                }

                // Crear opciones para el select
                const opcionesDias = {};
                diasFaltados.forEach((dia) => {
                    opcionesDias[dia] = formatDateDisplay(dia);
                });

                // Mostrar di√°logo para seleccionar qu√© d√≠a est√° reponiendo
                const { value: diaRepuesto } = await Swal.fire({
                    title: '¬øQu√© d√≠a est√°s reponiendo?',
                    text: 'Selecciona el d√≠a que deseas reponer con esta clase',
                    input: 'select',
                    inputOptions: opcionesDias,
                    inputPlaceholder: 'Selecciona un d√≠a',
                    showCancelButton: true,
                    confirmButtonText: 'Confirmar',
                    cancelButtonText: 'Cancelar',
                    inputValidator: (value) => {
                        if (!value) {
                            return 'Debes seleccionar un d√≠a';
                        }
                    }
                });

                if (!diaRepuesto) return; // Usuario cancel√≥

                // Marcar la reprogramaci√≥n con el d√≠a que est√° reponiendo
                data.asistencias[currentCoachId][dateStr].reprogramacion = true;
                data.asistencias[currentCoachId][dateStr].reprogramacionDe = diaRepuesto;
                data.asistencias[currentCoachId][dateStr].asistio = true;
            } else {
                // Si est√° quitando la reprogramaci√≥n
                data.asistencias[currentCoachId][dateStr].reprogramacion = false;
                data.asistencias[currentCoachId][dateStr].reprogramacionDe = null;
                data.asistencias[currentCoachId][dateStr].asistio = false;
            }

            saveData(data);
            renderCalendarioPeriodo();
            updateMetrics();
        }

        function updateMetrics() {
            const data = loadData();
            const coach = data.coaches.find(c => c.id === currentCoachId);
            const pago = (data.pagos[currentCoachId] || []).find(p => p.id === currentPagoId);

            if (!pago) return;

            // Obtener fecha actual (considerando modo de pruebas)
            const hoy = getFechaActual();

            // Usar periodoFinOriginal si existe, sino usar periodoFin
            // Esto asegura que al extender el periodo, las programadas no aumenten
            const fechaFinParaProgramadas = pago.periodoFinOriginal || pago.periodoFin;

            // D√≠as laborables ORIGINALES (para contar programadas)
            const daysLaborablesOriginales = getDiasLaborablesPeriodo(pago.periodoInicio, fechaFinParaProgramadas, coach.diasLaborables);
            const programadas = daysLaborablesOriginales.length;

            // D√≠as laborables TOTALES (incluyendo extensi√≥n, para contar asistidas)
            const daysLaborablesTotales = getDiasLaborablesPeriodo(pago.periodoInicio, pago.periodoFin, coach.diasLaborables);
            const asistencias = data.asistencias[currentCoachId] || {};

            let asistidas = 0;
            let faltas = 0;

            // Contar asistencias en TODOS los d√≠as laborables (incluyendo extensi√≥n)
            daysLaborablesTotales.forEach(day => {
                const asist = asistencias[day];
                // Solo contar asistencias que NO sean reprogramaciones
                if (asist?.asistio && !asist?.reprogramacion) {
                    asistidas++;
                }
            });

            // Calcular faltas: solo d√≠as laborables PASADOS donde NO asisti√≥
            daysLaborablesTotales.forEach(day => {
                // Solo contar si el d√≠a ya pas√≥
                if (day <= hoy) {
                    const asist = asistencias[day];
                    // Si NO asisti√≥ (y no es reprogramaci√≥n)
                    if (!asist?.asistio) {
                        faltas++;
                    }
                }
            });

            // Contar reprogramaciones en TODOS los d√≠as del periodo (incluyendo no laborables)
            const todosDias = getTodosDiasPeriodo(pago.periodoInicio, pago.periodoFin);
            let reprogramaciones = 0;

            todosDias.forEach(({ fecha }) => {
                const asist = asistencias[fecha];
                if (asist?.reprogramacion && asist?.asistio) {
                    reprogramaciones++;
                }
            });

            // Calcular pendientes: Programadas - (Asistidas + Reprogramaciones)
            // Esto nos da cu√°ntas clases faltan por completar del total
            const pendientes = Math.max(0, programadas - (asistidas + reprogramaciones));

            document.getElementById('metric-programadas').textContent = programadas;
            document.getElementById('metric-asistidas').textContent = asistidas;
            document.getElementById('metric-faltas').textContent = faltas;
            document.getElementById('metric-reprogramaciones').textContent = `${reprogramaciones}/${faltas}`;
            document.getElementById('metric-pendientes').textContent = pendientes;

            // Actualizar indicador de reprogramaciones disponibles
            const indicador = document.getElementById('reprogramaciones-disponibles');
            if (indicador) {
                // Solo mostrar si hay faltas
                if (faltas > 0) {
                    const reprogramacionesDisponibles = faltas - reprogramaciones;
                    indicador.textContent = `Reprogramaciones disponibles: ${reprogramacionesDisponibles} de ${faltas}`;
                    indicador.style.display = 'inline-block';

                    // Cambiar color seg√∫n disponibilidad
                    if (reprogramacionesDisponibles === 0) {
                        indicador.className = 'text-xs font-semibold px-3 py-1 bg-gray-100 text-gray-500 rounded-full';
                    } else if (reprogramacionesDisponibles <= 2) {
                        indicador.className = 'text-xs font-semibold px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full';
                    } else {
                        indicador.className = 'text-xs font-semibold px-3 py-1 bg-blue-100 text-blue-700 rounded-full';
                    }
                } else {
                    // Sin faltas, ocultar el indicador
                    indicador.style.display = 'none';
                }
            }

            // Mostrar alerta de periodo completado o pendientes
            const alertaCompletado = document.getElementById('alerta-completado');
            const alertaPendientes = document.getElementById('alerta-pendientes');

            if (pendientes === 0) {
                // Periodo completado: mostrar alerta verde
                if (alertaCompletado) alertaCompletado.classList.remove('hidden');
                if (alertaPendientes) alertaPendientes.classList.add('hidden');
            } else {
                // Hay pendientes: ocultar alerta verde
                if (alertaCompletado) alertaCompletado.classList.add('hidden');

                // Mostrar alerta naranja si el periodo est√° cerca de terminar o ya termin√≥
                if (alertaPendientes) {
                    // Usar fecha simulada si existe, sino usar fecha real
                    const hoy = fechaSimulada ? new Date(fechaSimulada) : new Date();
                    hoy.setHours(0, 0, 0, 0);
                    const fechaFin = new Date(pago.periodoFin);
                    fechaFin.setHours(0, 0, 0, 0);

                    // Calcular d√≠as restantes del periodo
                    const diasRestantes = Math.ceil((fechaFin - hoy) / (1000 * 60 * 60 * 24));

                    // Mostrar alerta si hay pendientes y quedan 3 d√≠as o menos (o ya termin√≥)
                    if (diasRestantes <= 3) {
                        document.getElementById('alerta-pendientes-cantidad').textContent = pendientes;
                        alertaPendientes.classList.remove('hidden');
                    } else {
                        alertaPendientes.classList.add('hidden');
                    }
                }
            }
        }

        // ========================================
        // HISTORIAL DE PAGOS
        // ========================================

        function renderHistorialPagos() {
            const data = loadData();
            const coach = data.coaches.find(c => c.id === currentCoachId);
            const pagos = (data.pagos[currentCoachId] || []).sort((a, b) =>
                new Date(b.fecha) - new Date(a.fecha)
            );

            const lista = document.getElementById('lista-pagos');

            if (pagos.length === 0) {
                lista.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">No hay periodos registrados</p>';
                return;
            }

            lista.innerHTML = pagos.map((pago, index) => {
                // Recalcular estad√≠sticas en tiempo real (pasar periodoFinOriginal si existe)
                const stats = calcularEstadisticasPeriodo(pago.periodoInicio, pago.periodoFin, currentCoachId, pago.montoBase, pago.periodoFinOriginal);

                return `
                <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex gap-3 flex-1">
                            <span class="flex-shrink-0 w-7 h-7 rounded-full ${index === 0 ? 'bg-green-600 dark:bg-green-500' : 'bg-gray-500 dark:bg-gray-600'} text-white text-xs font-bold flex items-center justify-center">
                                ${index + 1}
                            </span>
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <p class="text-xl font-bold text-gray-900 dark:text-white">${formatCurrency(pago.monto)}</p>
                                    ${index === 0 ? '<span class="px-2 py-1 text-xs font-semibold bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 rounded-md">M√°s reciente</span>' : ''}
                                </div>
                                <p class="text-xs text-gray-600 dark:text-gray-400">üìÖ Pagado: ${formatDateDisplay(pago.fecha)}</p>
                                <p class="text-xs text-blue-600 dark:text-blue-400 font-medium mt-1">
                                    üìÜ ${formatDateDisplay(pago.periodoInicio)} - ${formatDateDisplay(pago.periodoFin)}
                                </p>
                                ${pago.montoBase ? `<p class="text-xs text-gray-500 dark:text-gray-400 mt-1">üíµ Base: ${formatCurrency(pago.montoBase)}</p>` : ''}
                            </div>
                        </div>
                        <div class="flex flex-col gap-2">
                            <button 
                                onclick="editarPeriodoDesdeModal('${pago.id}')"
                                class="text-xs text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 hover:bg-blue-50 dark:hover:bg-blue-900/30 rounded px-3 py-1 transition-colors border border-blue-300 dark:border-blue-600 font-medium flex items-center gap-1.5"
                                title="Editar periodo"
                            >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                                Editar
                            </button>
                            <button 
                                onclick="eliminarPago('${pago.id}')"
                                class="text-xs text-red-600 dark:text-red-400 hover:text-red-700 dark:hover:text-red-300 hover:bg-red-50 dark:hover:bg-red-900/30 rounded px-3 py-1 transition-colors border border-red-300 dark:border-red-600 font-medium flex items-center gap-1.5"
                                title="Eliminar periodo"
                            >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                                Eliminar
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 sm:grid-cols-5 gap-2 text-xs mt-3 pt-3 border-t border-gray-200 dark:border-gray-700">
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-gray-500 dark:bg-gray-400"></span>
                            <span class="text-gray-600 dark:text-gray-400">Prog:</span>
                            <span class="font-bold text-gray-900 dark:text-white">${stats.programadas}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-green-500 dark:bg-green-400"></span>
                            <span class="text-green-700 dark:text-green-400">Asist:</span>
                            <span class="font-bold text-green-900 dark:text-green-300">${stats.asistidas}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-red-500 dark:bg-red-400"></span>
                            <span class="text-red-600 dark:text-red-400">Faltas:</span>
                            <span class="font-bold text-red-900 dark:text-red-300">${stats.faltas}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-blue-500 dark:bg-blue-400"></span>
                            <span class="text-blue-600 dark:text-blue-400">Reprog:</span>
                            <span class="font-bold text-blue-900 dark:text-blue-300">${stats.reprogramaciones}/${stats.faltas}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-orange-500 dark:bg-orange-400"></span>
                            <span class="text-orange-600 dark:text-orange-400">Pend:</span>
                            <span class="font-bold text-orange-900 dark:text-orange-300">${stats.pendientes}</span>
                        </div>
                    </div>
                    ${pago.nota ? `<p class="text-xs text-gray-600 dark:text-gray-400 mt-3 p-2 bg-gray-50 dark:bg-gray-900 rounded italic">"${pago.nota}"</p>` : ''}
                </div>
            `;
            }).join('');
        }

        function editarPeriodoDesdeModal(pagoId) {
            // Cambiar al periodo seleccionado
            currentPagoId = pagoId;

            // Cerrar modal de historial
            cerrarModalHistorialPagos();

            // Actualizar el selector
            const selector = document.getElementById('select-periodo-pago');
            selector.value = currentPagoId;

            // Renderizar calendario con el periodo seleccionado
            renderCalendarioPeriodo();

            // Abrir modal de editar
            abrirModalEditarPeriodo();
        }

        async function eliminarPago(pagoId) {
            const result = await Swal.fire({
                title: '¬øEliminar periodo?',
                text: '¬øEst√°s seguro de eliminar este periodo? Se perder√°n todas las asistencias registradas en √©l.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'S√≠, eliminar',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#dc2626'
            });

            if (!result.isConfirmed) return;

            const data = loadData();

            // Encontrar el periodo a eliminar
            const pago = (data.pagos[currentCoachId] || []).find(p => p.id === pagoId);

            if (pago) {
                // Obtener todas las fechas del periodo
                const diasPeriodo = getTodosDiasPeriodo(pago.periodoInicio, pago.periodoFin);

                // Eliminar asistencias de esas fechas
                if (data.asistencias[currentCoachId]) {
                    diasPeriodo.forEach(({ fecha }) => {
                        delete data.asistencias[currentCoachId][fecha];
                    });
                }
            }

            // Eliminar el periodo
            data.pagos[currentCoachId] = data.pagos[currentCoachId].filter(p => p.id !== pagoId);
            saveData(data);

            Swal.fire({
                icon: 'success',
                title: 'Periodo eliminado',
                text: 'El periodo y sus asistencias han sido eliminados',
                timer: 2000,
                showConfirmButton: false
            });

            // Si era el pago seleccionado, limpiar selecci√≥n
            if (currentPagoId === pagoId) {
                currentPagoId = null;
            }

            // Cerrar modal de historial si est√° abierto
            cerrarModalHistorialPagos();

            renderDashboard(); // Recargar todo
        }

        // ========================================
        // MODAL COACH
        // ========================================

        function abrirModalCoach(coachId = null) {
            const modal = document.getElementById('modal-coach');
            const titulo = document.getElementById('modal-coach-titulo');

            if (coachId) {
                // Editar
                const data = loadData();
                const coach = data.coaches.find(c => c.id === coachId);

                titulo.textContent = 'Editar Coach';
                document.getElementById('coach-id-input').value = coach.id;
                document.getElementById('coach-nombre-input').value = coach.nombre;
                document.getElementById('coach-estado-input').value = coach.estado || 'activo';

                // Marcar d√≠as
                document.querySelectorAll('.dia-checkbox').forEach(cb => {
                    cb.checked = coach.diasLaborables.includes(parseInt(cb.value));
                });
            } else {
                // Nuevo
                titulo.textContent = 'Agregar Coach';
                document.getElementById('form-coach').reset();
                document.getElementById('coach-id-input').value = '';
                document.getElementById('coach-estado-input').value = 'activo';

                // D√≠as por defecto: L-V
                document.querySelectorAll('.dia-checkbox').forEach(cb => {
                    const dia = parseInt(cb.value);
                    cb.checked = dia >= 1 && dia <= 5;
                });
            }

            modal.classList.remove('hidden');
        }

        function cerrarModalCoach() {
            document.getElementById('modal-coach').classList.add('hidden');
        }

        // Editar coach desde la lista
        function editarCoachDesdeLista(coachId) {
            abrirModalCoach(coachId);
        }

        // Eliminar coach desde la lista
        async function eliminarCoachDesdeLista(coachId) {
            const data = loadData();
            const coach = data.coaches.find(c => c.id === coachId);

            if (!coach) return;

            const result = await Swal.fire({
                title: '¬øEliminar coach?',
                html: `¬øEst√°s seguro de eliminar al coach <strong>"${coach.nombre}"</strong>?<br><br>Se eliminar√°n todos sus periodos y asistencias registradas.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'S√≠, eliminar',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#dc2626'
            });

            if (!result.isConfirmed) return;

            // Eliminar coach y sus datos asociados
            data.coaches = data.coaches.filter(c => c.id !== coachId);
            delete data.pagos[coachId];
            delete data.asistencias[coachId];

            saveData(data);
            renderCoachesList();

            Swal.fire({
                icon: 'success',
                title: 'Coach eliminado',
                text: `${coach.nombre} y todos sus datos han sido eliminados`,
                timer: 2000,
                showConfirmButton: false
            });
        }

        // ========================================
        // MODAL PAGO
        // ========================================

        function calcularEstadisticasPeriodo(inicio, fin, coachId, montoBase, finOriginal = null) {
            const data = loadData();
            const coach = data.coaches.find(c => c.id === coachId);
            const asistencias = data.asistencias[coachId] || {};
            const hoy = getFechaActual();

            // Usar finOriginal si existe para calcular programadas
            const fechaFinParaProgramadas = finOriginal || fin;

            // Obtener d√≠as laborables ORIGINALES (para programadas)
            const diasLaborablesOriginales = getDiasLaborablesPeriodo(inicio, fechaFinParaProgramadas, coach.diasLaborables);
            const programadas = diasLaborablesOriginales.length;

            // Obtener d√≠as laborables TOTALES (para asistidas)
            const diasLaborablesTotales = getDiasLaborablesPeriodo(inicio, fin, coach.diasLaborables);

            let asistidas = 0;
            let faltas = 0;

            // Contar asistencias y faltas correctamente
            diasLaborablesTotales.forEach(day => {
                const asist = asistencias[day];
                // Solo contar asistencias regulares (sin reprogramaciones)
                if (asist?.asistio && !asist?.reprogramacion) {
                    asistidas++;
                }

                // Contar faltas: solo d√≠as pasados donde NO asisti√≥
                if (day <= hoy && !asist?.asistio) {
                    faltas++;
                }
            });

            // Contar reprogramaciones en TODOS los d√≠as del periodo
            const todosDias = getTodosDiasPeriodo(inicio, fin);
            let reprogramaciones = 0;

            todosDias.forEach(({ fecha }) => {
                const asist = asistencias[fecha];
                if (asist?.reprogramacion && asist?.asistio) {
                    reprogramaciones++;
                }
            });

            // Calcular monto proporcional basado en asistencias + reprogramaciones
            const totalCompletadas = asistidas + reprogramaciones;
            const porcentajeAsistencia = programadas > 0 ? totalCompletadas / programadas : 1;
            const montoSugerido = montoBase ? Math.round(montoBase * porcentajeAsistencia) : 0;

            // Calcular pendientes: Programadas - (Asistidas + Reprogramaciones)
            const pendientes = Math.max(0, programadas - (asistidas + reprogramaciones));

            return {
                programadas,
                asistidas,
                faltas,
                reprogramaciones,
                pendientes,
                montoSugerido
            };
        }

        function formatearMontoInput(valor) {
            // Eliminar todo excepto n√∫meros
            const numero = valor.replace(/\D/g, '');
            if (!numero) return '';

            // Formatear con puntos de miles
            return parseInt(numero).toLocaleString('es-CO');
        }

        function obtenerValorMontoRaw() {
            const valorFormateado = document.getElementById('pago-monto').value;
            return parseInt(valorFormateado.replace(/\D/g, '') || '0');
        }

        function abrirModalPago() {
            const modal = document.getElementById('modal-pago');

            document.getElementById('form-pago').reset();

            // Valores por defecto: mes actual
            const hoy = new Date();
            const primerDia = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
            const ultimoDia = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);

            document.getElementById('pago-periodo-inicio').value = formatDate(primerDia);
            document.getElementById('pago-periodo-fin').value = formatDate(ultimoDia);
            document.getElementById('pago-fecha').value = formatDate(new Date());

            modal.classList.remove('hidden');
        }

        function cerrarModalPago() {
            document.getElementById('modal-pago').classList.add('hidden');
        }

        // ========================================
        // MODAL EDITAR PERIODO
        // ========================================

        function abrirModalEditarPeriodo() {
            if (!currentPagoId) {
                Swal.fire({
                    icon: 'info',
                    title: 'No hay periodo seleccionado',
                    text: 'Selecciona un periodo primero',
                    confirmButtonText: 'Entendido'
                });
                return;
            }

            const data = loadData();
            const pago = (data.pagos[currentCoachId] || []).find(p => p.id === currentPagoId);

            if (!pago) return;

            document.getElementById('editar-periodo-inicio').value = pago.periodoInicio;
            document.getElementById('editar-periodo-fin').value = pago.periodoFin;
            document.getElementById('editar-fecha-pago').value = pago.fecha;
            document.getElementById('editar-monto').value = formatearMontoInput(pago.monto.toString());
            document.getElementById('editar-nota').value = pago.nota || '';
            document.getElementById('modal-editar-periodo').classList.remove('hidden');
        }

        function cerrarModalEditarPeriodo() {
            document.getElementById('modal-editar-periodo').classList.add('hidden');
        }

        // ========================================
        // MODAL NOTA DEL D√çA
        // ========================================

        let currentNotaDate = null;
        let ejerciciosCount = 0;

        function agregarEjercicio(nombre = '', series = '', repeticiones = '', peso = '', unidad = 'kg', nota = '') {
            ejerciciosCount++;
            const lista = document.getElementById('lista-ejercicios');
            const id = `ejercicio-${ejerciciosCount}`;

            // Contar cu√°ntos ejercicios hay actualmente en la lista
            const numeroEjercicio = lista.children.length + 1;

            const ejercicioHTML = `
                <div class="bg-white dark:bg-gray-800 border-2 border-gray-200 dark:border-gray-700 rounded-lg p-2 sm:p-3 hover:border-blue-300 dark:hover:border-blue-600 transition-colors" id="${id}">
                    <div class="flex gap-2 mb-2 sm:mb-3">
                        <div class="flex-shrink-0 flex items-center justify-center w-7 h-7 sm:w-8 sm:h-8 bg-blue-600 dark:bg-blue-500 text-white rounded-full font-bold text-xs sm:text-sm">
                            ${numeroEjercicio}
                        </div>
                        <div class="flex-1 relative">
                            <input 
                                type="text" 
                                placeholder="üîç Nombre del ejercicio..."
                                value="${nombre}"
                                class="w-full px-2 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm font-medium border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-blue-500 dark:focus:border-blue-400 ejercicio-nombre bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                                oninput="mostrarSugerenciasEjercicios(this, '${id}')"
                                onfocus="mostrarSugerenciasEjercicios(this, '${id}')"
                            >
                            <div id="sugerencias-${id}" class="hidden absolute z-10 w-full mt-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg max-h-48 overflow-y-auto"></div>
                        </div>
                        <button 
                            type="button"
                            onclick="eliminarEjercicio('${id}')"
                            class="px-2 sm:px-3 py-1.5 sm:py-2 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg text-xs sm:text-sm font-bold border-2 border-red-200 dark:border-red-600 hover:border-red-300 dark:hover:border-red-500 transition-colors"
                            title="Eliminar ejercicio"
                        >
                            ‚úï
                        </button>
                    </div>
                    <div class="grid grid-cols-4 gap-2 sm:gap-3 mb-2">
                        <div>
                            <label class="block text-[10px] sm:text-xs font-semibold text-gray-600 dark:text-gray-400 mb-1">Series</label>
                            <input 
                                type="text" 
                                inputmode="numeric"
                                pattern="[0-9]*"
                                placeholder="3"
                                value="${series}"
                                class="w-full px-2 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm text-center border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-blue-500 dark:focus:border-blue-400 font-medium ejercicio-series bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                            >
                        </div>
                        <div>
                            <label class="block text-[10px] sm:text-xs font-semibold text-gray-600 dark:text-gray-400 mb-1">Reps</label>
                            <input 
                                type="text" 
                                inputmode="numeric"
                                pattern="[0-9]*"
                                placeholder="12"
                                value="${repeticiones}"
                                class="w-full px-2 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm text-center border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-blue-500 dark:focus:border-blue-400 font-medium ejercicio-reps bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                            >
                        </div>
                        <div>
                            <label class="block text-[10px] sm:text-xs font-semibold text-gray-600 dark:text-gray-400 mb-1">Peso</label>
                            <input 
                                type="text" 
                                inputmode="decimal"
                                placeholder="50"
                                value="${peso}"
                                class="w-full px-2 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm text-center border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-blue-500 dark:focus:border-blue-400 font-medium ejercicio-peso bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                            >
                        </div>
                        <div>
                            <label class="block text-[10px] sm:text-xs font-semibold text-gray-600 dark:text-gray-400 mb-1">Unidad</label>
                            <select 
                                class="w-full px-1 sm:px-2 py-1.5 sm:py-2 text-xs sm:text-sm text-center border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-blue-500 dark:focus:border-blue-400 font-medium ejercicio-unidad bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                            >
                                <option value="kg" ${unidad === 'kg' ? 'selected' : ''}>kg</option>
                                <option value="lb" ${unidad === 'lb' ? 'selected' : ''}>lb</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-[10px] sm:text-xs font-semibold text-gray-600 dark:text-gray-400 mb-1">üí¨ Nota del ejercicio</label>
                        <textarea 
                            placeholder="Ej: Muy pesado, aumentar gradualmente..."
                            class="w-full px-2 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-blue-500 dark:focus:border-blue-400 resize-none ejercicio-nota bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400"
                            rows="2"
                        >${nota}</textarea>
                    </div>
                </div>
            `;

            lista.insertAdjacentHTML('beforeend', ejercicioHTML);
        }

        function eliminarEjercicio(id) {
            document.getElementById(id)?.remove();
            renumerarEjercicios();
        }

        function renumerarEjercicios() {
            const lista = document.getElementById('lista-ejercicios');
            const ejercicios = lista.children;

            Array.from(ejercicios).forEach((ejercicio, index) => {
                const numeroSpan = ejercicio.querySelector('.flex-shrink-0');
                if (numeroSpan) {
                    numeroSpan.textContent = index + 1;
                }
            });
        }


        function abrirModalNotaDia(dateStr) {
            currentNotaDate = dateStr;
            const data = loadData();

            if (!data.asistencias[currentCoachId]) {
                data.asistencias[currentCoachId] = {};
            }

            if (!data.asistencias[currentCoachId][dateStr]) {
                data.asistencias[currentCoachId][dateStr] = {
                    asistio: false,
                    reprogramacion: false,
                    rutina: null
                };
            }

            const rutina = data.asistencias[currentCoachId][dateStr].rutina;

            // Si hay rutina, mostrar vista previa. Si no, abrir editor directamente
            if (rutina) {
                mostrarVistaRutina(dateStr, rutina);
            } else {
                abrirEditorRutina(dateStr);
            }
        }

        function mostrarVistaRutina(dateStr, rutina) {
            document.getElementById('vista-fecha-display').textContent = formatDateDisplay(dateStr);

            let html = '<div class="space-y-3">';

            // Configuraci√≥n compacta
            const tags = [];
            
            // Badge de IA si corresponde (m√°s destacado)
            if (rutina.generadaPorIA) {
                tags.push('<span class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-gradient-to-r from-emerald-500 to-teal-500 border-2 border-emerald-300 dark:border-emerald-600 rounded-full text-xs font-bold text-white shadow-lg animate-pulse">ü§ñ Generada por IA</span>');
            }
            
            if (rutina.calentamiento) tags.push('<span class="inline-flex items-center gap-1 px-2.5 py-1 bg-orange-50 dark:bg-orange-900/30 border border-orange-200 dark:border-orange-700 rounded-full text-xs font-semibold text-orange-900 dark:text-orange-300">üî• Calentamiento</span>');
            if (rutina.tipoMaquinas) tags.push('<span class="inline-flex items-center gap-1 px-2.5 py-1 bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-700 rounded-full text-xs font-semibold text-blue-900 dark:text-blue-300">‚öôÔ∏è M√°quinas</span>');
            if (rutina.tipoCalistenia) tags.push('<span class="inline-flex items-center gap-1 px-2.5 py-1 bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-700 rounded-full text-xs font-semibold text-green-900 dark:text-green-300">üí™ Calistenia</span>');
            if (rutina.tren) {
                const trenTexto = rutina.tren === 'superior' ? 'üí™ Tren Superior' : 'ü¶µ Tren Inferior';
                const trenColor = rutina.tren === 'superior' ? 'purple' : 'indigo';
                tags.push(`<span class="inline-flex items-center gap-1 px-2.5 py-1 bg-${trenColor}-50 dark:bg-${trenColor}-900/30 border border-${trenColor}-200 dark:border-${trenColor}-700 rounded-full text-xs font-semibold text-${trenColor}-900 dark:text-${trenColor}-300">${trenTexto}</span>`);
            }

            if (tags.length > 0) {
                html += `<div class="flex flex-wrap gap-2">${tags.join('')}</div>`;
            }

            // Ejercicios
            if (rutina.ejercicios && rutina.ejercicios.length > 0) {
                html += '<div><h3 class="text-sm font-bold text-gray-900 dark:text-white mb-3">Ejercicios realizados</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">';
                rutina.ejercicios.forEach((ej, index) => {
                    html += `
                        <div class="bg-white dark:bg-gray-800 border-2 border-gray-200 dark:border-gray-700 rounded-xl p-3 hover:border-blue-300 dark:hover:border-blue-600 transition-all">
                            <div class="flex items-center gap-2 mb-3">
                                <div class="flex-shrink-0 flex items-center justify-center w-7 h-7 bg-blue-600 dark:bg-blue-500 text-white rounded-full font-bold text-xs">
                                    ${index + 1}
                                </div>
                                <h4 class="text-sm font-bold text-gray-900 dark:text-white truncate flex-1">${ej.nombre}</h4>
                            </div>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <div class="bg-blue-50 dark:bg-blue-900/30 rounded-lg px-2 py-2 text-center">
                                    <p class="text-[10px] text-blue-600 dark:text-blue-400 font-semibold mb-0.5">SERIES</p>
                                    <p class="text-lg font-bold text-blue-900 dark:text-blue-300">${ej.series || '-'}</p>
                                </div>
                                <div class="bg-green-50 dark:bg-green-900/30 rounded-lg px-2 py-2 text-center">
                                    <p class="text-[10px] text-green-600 dark:text-green-400 font-semibold mb-0.5">REPS</p>
                                    <p class="text-lg font-bold text-green-900 dark:text-green-300">${ej.repeticiones || '-'}</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div class="bg-orange-50 dark:bg-orange-900/30 rounded-lg px-2 py-2 text-center">
                                    <p class="text-[10px] text-orange-600 dark:text-orange-400 font-semibold mb-0.5">PESO</p>
                                    <p class="text-lg font-bold text-orange-900 dark:text-orange-300">${ej.peso || '-'}</p>
                                </div>
                                <div class="bg-purple-50 dark:bg-purple-900/30 rounded-lg px-2 py-2 text-center">
                                    <p class="text-[10px] text-purple-600 dark:text-purple-400 font-semibold mb-0.5">UNIDAD</p>
                                    <p class="text-base font-bold text-purple-900 dark:text-purple-300">${ej.unidad || 'kg'}</p>
                                </div>
                            </div>
                            ${ej.nota ? `<div class="mt-2 p-2 bg-yellow-50 dark:bg-yellow-900/30 border-l-4 border-yellow-400 dark:border-yellow-600 rounded-r"><p class="text-xs text-gray-700 dark:text-gray-300 leading-relaxed"><span class="font-bold">üí¨</span> ${ej.nota}</p></div>` : ''}
                        </div>
                    `;
                });
                html += '</div></div>';
            }

            // Nota adicional
            if (rutina.nota) {
                html += `<div class="p-3 bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-700 rounded-lg"><p class="text-xs font-semibold text-gray-700 dark:text-gray-300 mb-1">üìù Nota adicional</p><p class="text-sm text-gray-900 dark:text-white">${rutina.nota}</p></div>`;
            }

            html += '</div>';

            document.getElementById('vista-contenido-rutina').innerHTML = html;
            document.getElementById('modal-vista-rutina').classList.remove('hidden');
        }

        function cerrarModalVistaRutina(limpiarFecha = true) {
            document.getElementById('modal-vista-rutina').classList.add('hidden');
            if (limpiarFecha) {
                currentNotaDate = null;
            }
        }

        function abrirEdicionDesdeVista() {
            const fechaGuardada = currentNotaDate;
            cerrarModalVistaRutina(false);
            abrirEditorRutina(fechaGuardada);
        }

        function abrirEditorRutina(dateStr) {
            currentNotaDate = dateStr;
            ejerciciosCount = 0;
            const data = loadData();

            if (!data.asistencias[currentCoachId]) {
                data.asistencias[currentCoachId] = {};
            }

            if (!data.asistencias[currentCoachId][dateStr]) {
                data.asistencias[currentCoachId][dateStr] = {
                    asistio: false,
                    reprogramacion: false,
                    rutina: null
                };
            }

            const rutina = data.asistencias[currentCoachId][dateStr].rutina;

            document.getElementById('nota-fecha-display').textContent = formatDateDisplay(dateStr);

            // Limpiar lista de ejercicios
            document.getElementById('lista-ejercicios').innerHTML = '';

            // Cargar datos si existen
            if (rutina) {
                document.getElementById('calentamiento-check').checked = rutina.calentamiento !== undefined ? rutina.calentamiento : true;
                document.getElementById('tipo-maquinas').checked = rutina.tipoMaquinas !== undefined ? rutina.tipoMaquinas : true;
                document.getElementById('tipo-calistenia').checked = rutina.tipoCalistenia || false;
                document.getElementById('nota-dia-texto').value = rutina.nota || '';

                // Cargar tren
                if (rutina.tren === 'superior') {
                    document.getElementById('tren-superior').checked = true;
                } else if (rutina.tren === 'inferior') {
                    document.getElementById('tren-inferior').checked = true;
                }

                // Marcar si fue generada por IA y mostrar badge
                const esIA = rutina.generadaPorIA || false;
                document.getElementById('rutina-generada-por-ia').value = esIA.toString();
                const badgeIA = document.getElementById('badge-ia-rutina');
                if (esIA) {
                    badgeIA.classList.remove('hidden');
                } else {
                    badgeIA.classList.add('hidden');
                }

                // Cargar ejercicios
                if (rutina.ejercicios && rutina.ejercicios.length > 0) {
                    rutina.ejercicios.forEach(ej => {
                        agregarEjercicio(ej.nombre, ej.series, ej.repeticiones, ej.peso, ej.unidad, ej.nota);
                    });
                } else {
                    // Agregar un ejercicio vac√≠o por defecto
                    agregarEjercicio();
                }
            } else {
                // Valores por defecto: calentamiento y m√°quinas activados
                document.getElementById('calentamiento-check').checked = true;
                document.getElementById('tipo-maquinas').checked = true;
                document.getElementById('tipo-calistenia').checked = false;
                document.getElementById('nota-dia-texto').value = '';

                // Limpiar tren
                document.getElementById('tren-superior').checked = false;
                document.getElementById('tren-inferior').checked = false;

                // Resetear marca de IA
                document.getElementById('rutina-generada-por-ia').value = 'false';
                document.getElementById('badge-ia-rutina').classList.add('hidden');

                // Agregar un ejercicio vac√≠o por defecto
                agregarEjercicio();
            }

            document.getElementById('modal-nota-dia').classList.remove('hidden');
        }

        function cerrarModalNotaDia() {
            document.getElementById('modal-nota-dia').classList.add('hidden');
            currentNotaDate = null;
            ejerciciosCount = 0;
        }

        async function eliminarNotaDia() {
            if (!currentNotaDate) return;

            const result = await Swal.fire({
                title: '¬øEliminar rutina?',
                text: '¬øEst√°s seguro de eliminar la rutina de este d√≠a?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'S√≠, eliminar',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#dc2626'
            });

            if (!result.isConfirmed) return;

            const data = loadData();

            if (data.asistencias[currentCoachId] && data.asistencias[currentCoachId][currentNotaDate]) {
                data.asistencias[currentCoachId][currentNotaDate].rutina = null;
                data.asistencias[currentCoachId][currentNotaDate].asistio = null; // Resetear asistencia
                data.asistencias[currentCoachId][currentNotaDate].nota = ''; // Limpiar nota
                saveData(data);
                
                // Cerrar ambos modales (edici√≥n y visualizaci√≥n)
                cerrarModalNotaDia();
                cerrarModalVistaRutina(false); // false para no limpiar currentNotaDate
                
                // Actualizar el calendario
                renderCalendarioPeriodo();
                
                // Mostrar mensaje de √©xito
                Swal.fire({
                    icon: 'success',
                    title: 'Rutina eliminada',
                    text: 'La rutina ha sido eliminada correctamente',
                    timer: 2000,
                    showConfirmButton: false
                });
            }
        }

        // ========================================
        // EVENTOS (Se inicializan en DOMContentLoaded)
        // ========================================
        // Nota: Los event listeners principales se registran en inicializarEventListeners()

        // Cancelar modal coach
        document.getElementById('btn-cancelar-modal').addEventListener('click', cerrarModalCoach);

        // Guardar coach
        document.getElementById('form-coach').addEventListener('submit', (e) => {
            e.preventDefault();

            const data = loadData();
            const coachId = document.getElementById('coach-id-input').value;

            const diasLaborables = Array.from(document.querySelectorAll('.dia-checkbox:checked'))
                .map(cb => parseInt(cb.value))
                .sort((a, b) => (a === 0 ? 7 : a) - (b === 0 ? 7 : b));

            if (diasLaborables.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'D√≠as laborables requeridos',
                    text: 'Selecciona al menos un d√≠a laborable',
                    confirmButtonText: 'Entendido'
                });
                return;
            }

            const coachData = {
                nombre: document.getElementById('coach-nombre-input').value.trim(),
                estado: document.getElementById('coach-estado-input').value,
                diasLaborables
            };

            if (coachId) {
                // Editar
                const index = data.coaches.findIndex(c => c.id === coachId);
                data.coaches[index] = { ...data.coaches[index], ...coachData };
            } else {
                // Crear
                coachData.id = generateId();
                coachData.fechaCreacion = formatDate(new Date());
                data.coaches.push(coachData);
            }

            saveData(data);
            cerrarModalCoach();

            if (currentCoachId) {
                renderDashboard();
            } else {
                renderCoachesList();
            }
        });

        // Los event listeners se inicializan en DOMContentLoaded (ver inicializarEventListeners)

        // Selector de periodo
        document.getElementById('select-periodo-pago').addEventListener('change', (e) => {
            currentPagoId = e.target.value || null;
            console.log('Periodo cambiado a:', currentPagoId);

            if (currentPagoId) {
                document.getElementById('contenido-calendario-metricas').classList.remove('hidden');
                renderCalendarioPeriodo();
                renderHistorialPagos();
            } else {
                document.getElementById('contenido-calendario-metricas').classList.add('hidden');
            }
        });

        // Event listeners de pago se registran en inicializarEventListeners()

        document.getElementById('form-pago').addEventListener('submit', (e) => {
            e.preventDefault();

            const data = loadData();

            if (!data.pagos[currentCoachId]) {
                data.pagos[currentCoachId] = [];
            }

            const periodoInicio = document.getElementById('pago-periodo-inicio').value;
            const periodoFin = document.getElementById('pago-periodo-fin').value;

            // Validar que no haya solapamiento con otros periodos
            const periodosExistentes = data.pagos[currentCoachId] || [];
            const haySolapamiento = periodosExistentes.some(p => {
                // Verificar si hay solapamiento entre el nuevo periodo y uno existente
                return (periodoInicio <= p.periodoFin && periodoFin >= p.periodoInicio);
            });

            if (haySolapamiento) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error: Solapamiento de fechas',
                    text: 'Ya existe un periodo con fechas que se solapan con las que intentas registrar. Por favor, verifica los periodos existentes y elige fechas diferentes.',
                    confirmButtonText: 'Entendido'
                });
                return;
            }

            const monto = obtenerValorMontoRaw();
            const stats = calcularEstadisticasPeriodo(periodoInicio, periodoFin, currentCoachId, monto);

            const pago = {
                id: generateId(),
                fecha: document.getElementById('pago-fecha').value,
                periodoInicio,
                periodoFin,
                periodoFinOriginal: periodoFin, // Guardar fecha fin original
                montoBase: monto,
                monto: monto,
                nota: document.getElementById('pago-nota').value.trim(),
                stats: {
                    programadas: stats.programadas,
                    asistidas: stats.asistidas,
                    faltas: stats.faltas,
                    reprogramaciones: stats.reprogramaciones
                }
            };

            data.pagos[currentCoachId].push(pago);
            saveData(data);

            // Seleccionar el pago reci√©n creado
            currentPagoId = pago.id;

            cerrarModalPago();
            renderDashboard(); // Recargar todo el dashboard
        });

        // Guardar cambios del periodo editado
        document.getElementById('form-editar-periodo').addEventListener('submit', (e) => {
            e.preventDefault();

            if (!currentPagoId) return;

            const data = loadData();
            const pago = (data.pagos[currentCoachId] || []).find(p => p.id === currentPagoId);

            if (!pago) return;

            const nuevaFechaFin = document.getElementById('editar-periodo-fin').value;

            // Si no existe periodoFinOriginal, guardarlo ahora (para periodos antiguos)
            if (!pago.periodoFinOriginal) {
                pago.periodoFinOriginal = pago.periodoFin;
            }

            // Validar que la nueva fecha sea posterior o igual a la ORIGINAL
            if (new Date(nuevaFechaFin) < new Date(pago.periodoFinOriginal)) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Fecha inv√°lida',
                    text: 'La nueva fecha de fin debe ser posterior o igual a la fecha original del periodo',
                    confirmButtonText: 'Entendido'
                });
                return;
            }

            // Validar que la extensi√≥n no se solape con otros periodos
            const periodosExistentes = data.pagos[currentCoachId] || [];
            const haySolapamiento = periodosExistentes.some(p => {
                // Ignorar el periodo que estamos editando
                if (p.id === currentPagoId) return false;

                // Verificar si hay solapamiento con otros periodos
                return (pago.periodoInicio <= p.periodoFin && nuevaFechaFin >= p.periodoInicio);
            });

            if (haySolapamiento) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error: Solapamiento de fechas',
                    text: 'La extensi√≥n del periodo se solapar√≠a con otro periodo existente. Por favor, elige una fecha que no se solape con otros periodos.',
                    confirmButtonText: 'Entendido'
                });
                return;
            }

            // Obtener monto sin formato
            const montoFormateado = document.getElementById('editar-monto').value;
            const monto = parseInt(montoFormateado.replace(/\D/g, '') || '0');

            // Actualizar todos los campos (EXCEPTO periodoFinOriginal que se mantiene)
            pago.periodoFin = nuevaFechaFin;
            pago.fecha = document.getElementById('editar-fecha-pago').value;
            pago.monto = monto;
            pago.montoBase = monto;
            pago.nota = document.getElementById('editar-nota').value.trim();

            saveData(data);

            // Recargar el dashboard
            cerrarModalEditarPeriodo();
            renderDashboard();
        });

        // Guardar nota del d√≠a
        document.getElementById('form-nota-dia').addEventListener('submit', (e) => {
            e.preventDefault();

            if (!currentNotaDate) return;

            const data = loadData();

            if (!data.asistencias[currentCoachId]) {
                data.asistencias[currentCoachId] = {};
            }

            if (!data.asistencias[currentCoachId][currentNotaDate]) {
                data.asistencias[currentCoachId][currentNotaDate] = {
                    asistio: false,
                    reprogramacion: false,
                    rutina: null
                };
            }

            // Recopilar ejercicios
            const ejercicios = [];
            document.querySelectorAll('#lista-ejercicios > div').forEach(ejercicioDiv => {
                const nombre = ejercicioDiv.querySelector('.ejercicio-nombre').value.trim();
                const series = ejercicioDiv.querySelector('.ejercicio-series').value.trim();
                const repeticiones = ejercicioDiv.querySelector('.ejercicio-reps').value.trim();
                const peso = ejercicioDiv.querySelector('.ejercicio-peso').value.trim();
                const unidad = ejercicioDiv.querySelector('.ejercicio-unidad').value;
                const nota = ejercicioDiv.querySelector('.ejercicio-nota').value.trim();

                // Solo agregar si al menos el nombre tiene contenido
                if (nombre) {
                    ejercicios.push({ nombre, series, repeticiones, peso, unidad, nota });
                }
            });

            // Obtener tren trabajado
            let tren = null;
            if (document.getElementById('tren-superior').checked) {
                tren = 'superior';
            } else if (document.getElementById('tren-inferior').checked) {
                tren = 'inferior';
            }

            // Crear objeto de rutina
            const rutina = {
                calentamiento: document.getElementById('calentamiento-check').checked,
                tipoMaquinas: document.getElementById('tipo-maquinas').checked,
                tipoCalistenia: document.getElementById('tipo-calistenia').checked,
                tren: tren,
                enfoqueMusculo: document.getElementById('enfoque-musculo-hidden')?.value || null,
                ejercicios: ejercicios,
                nota: document.getElementById('nota-dia-texto').value.trim(),
                generadaPorIA: document.getElementById('rutina-generada-por-ia')?.value === 'true' || false
            };

            // Guardar rutina
            data.asistencias[currentCoachId][currentNotaDate].rutina = rutina;
            saveData(data);
            renderCalendarioPeriodo();

            cerrarModalNotaDia();
        });

        // Formatear monto mientras se escribe (modal crear periodo)
        document.getElementById('pago-monto').addEventListener('input', function (e) {
            const cursorPos = e.target.selectionStart;
            const valorAnterior = e.target.value;
            const valorFormateado = formatearMontoInput(valorAnterior);

            e.target.value = valorFormateado;

            // Ajustar posici√≥n del cursor
            const diff = valorFormateado.length - valorAnterior.length;
            e.target.setSelectionRange(cursorPos + diff, cursorPos + diff);
        });

        // Formatear monto mientras se escribe (modal editar periodo)
        document.getElementById('editar-monto').addEventListener('input', function (e) {
            const cursorPos = e.target.selectionStart;
            const valorAnterior = e.target.value;
            const valorFormateado = formatearMontoInput(valorAnterior);

            e.target.value = valorFormateado;

            // Ajustar posici√≥n del cursor
            const diff = valorFormateado.length - valorAnterior.length;
            e.target.setSelectionRange(cursorPos + diff, cursorPos + diff);
        });

        // Auto-calcular fin de periodo en pago
        document.getElementById('pago-periodo-inicio').addEventListener('change', (e) => {
            const inicio = e.target.value;
            if (inicio && !document.getElementById('pago-periodo-fin').value) {
                document.getElementById('pago-periodo-fin').value = calcularFinDeMes(inicio);
            }
        });

        // ========================================
        // INICIALIZACI√ìN
        // ========================================
        // Cerrar modal de historial al hacer clic fuera de √©l
        document.getElementById('modal-historial-pagos')?.addEventListener('click', (e) => {
            if (e.target.id === 'modal-historial-pagos') {
                cerrarModalHistorialPagos();
            }
        });

        // Cerrar modal de pago al hacer clic fuera de √©l
        document.getElementById('modal-pago')?.addEventListener('click', (e) => {
            if (e.target.id === 'modal-pago') {
                cerrarModalPago();
            }
        });

        // Cerrar modal de coach al hacer clic fuera de √©l
        document.getElementById('modal-coach')?.addEventListener('click', (e) => {
            if (e.target.id === 'modal-coach') {
                cerrarModalCoach();
            }
        });

        // Cerrar modal de editar periodo al hacer clic fuera de √©l
        document.getElementById('modal-editar-periodo')?.addEventListener('click', (e) => {
            if (e.target.id === 'modal-editar-periodo') {
                cerrarModalEditarPeriodo();
            }
        });

        // Cerrar modal de biblioteca al hacer clic fuera de √©l
        document.getElementById('modal-ejercicios-biblioteca')?.addEventListener('click', (e) => {
            if (e.target.id === 'modal-ejercicios-biblioteca') {
                cerrarModalBibliotecaEjercicios();
            }
        });

        // Event listener para agregar ejercicio con Enter
        document.getElementById('nuevo-ejercicio-nombre')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                agregarEjercicioABiblioteca();
            }
        });


        // Cerrar modales con la tecla ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                // Cerrar modal de biblioteca de ejercicios
                const modalBiblioteca = document.getElementById('modal-ejercicios-biblioteca');
                if (modalBiblioteca && !modalBiblioteca.classList.contains('hidden')) {
                    cerrarModalBibliotecaEjercicios();
                    return;
                }

                // Cerrar modal de vista de rutina si est√° abierto
                const modalVista = document.getElementById('modal-vista-rutina');
                if (modalVista && !modalVista.classList.contains('hidden')) {
                    cerrarModalVistaRutina();
                    return;
                }

                // Cerrar modal de info del coach si est√° abierto
                const modalInfoCoach = document.getElementById('modal-info-coach');
                if (modalInfoCoach && !modalInfoCoach.classList.contains('hidden')) {
                    cerrarModalInfoCoach();
                    return;
                }

                // Cerrar modal de historial si est√° abierto
                const modalHistorial = document.getElementById('modal-historial-pagos');
                if (modalHistorial && !modalHistorial.classList.contains('hidden')) {
                    cerrarModalHistorialPagos();
                }

                // Cerrar modal de nota si est√° abierto
                const modalNota = document.getElementById('modal-nota-dia');
                if (modalNota && !modalNota.classList.contains('hidden')) {
                    cerrarModalNotaDia();
                }

                // Cerrar modal de pago si est√° abierto
                const modalPago = document.getElementById('modal-pago');
                if (modalPago && !modalPago.classList.contains('hidden')) {
                    cerrarModalPago();
                }

                // Cerrar modal de coach si est√° abierto
                const modalCoach = document.getElementById('modal-coach');
                if (modalCoach && !modalCoach.classList.contains('hidden')) {
                    cerrarModalCoach();
                }

                // Cerrar modal de editar periodo si est√° abierto
                const modalEditarPeriodo = document.getElementById('modal-editar-periodo');
                if (modalEditarPeriodo && !modalEditarPeriodo.classList.contains('hidden')) {
                    cerrarModalEditarPeriodo();
                }

                // Cerrar modal de configuraci√≥n si est√° abierto
                const modalConfiguracion = document.getElementById('modal-configuracion');
                if (modalConfiguracion && !modalConfiguracion.classList.contains('hidden')) {
                    cerrarModalConfiguracion();
                }
            }
        });

        // ========================================
        // PANEL DE PRUEBAS (DESARROLLO)
        // ========================================

        function togglePanelPruebas() {
            const panel = document.getElementById('contenido-panel-pruebas');
            panel.classList.toggle('hidden');

            // Actualizar fecha real
            const fechaRealSpan = document.querySelector('#fecha-actual-info span');
            if (fechaRealSpan) {
                const hoy = new Date();
                fechaRealSpan.textContent = formatDate(hoy);
            }

            // Si hay fecha simulada, mostrarla en el input
            if (fechaSimulada) {
                document.getElementById('fecha-simulada').value = fechaSimulada;
            }
        }

        function aplicarFechaSimulada() {
            const fecha = document.getElementById('fecha-simulada').value;
            if (!fecha) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Fecha requerida',
                    text: 'Por favor selecciona una fecha',
                    confirmButtonText: 'Entendido'
                });
                return;
            }

            fechaSimulada = fecha;
            Swal.fire({
                icon: 'success',
                title: 'Fecha simulada aplicada',
                text: `El sistema ahora act√∫a como si fuera ${formatDateDisplay(fecha)}`,
                confirmButtonText: 'Entendido'
            });

            // Actualizar la vista si estamos en un dashboard
            if (currentCoachId && currentPagoId) {
                renderCalendarioPeriodo();
            }
        }

        function resetearFecha() {
            fechaSimulada = null;
            document.getElementById('fecha-simulada').value = '';
            Swal.fire({
                icon: 'info',
                title: 'Fecha reseteada',
                text: 'El sistema ahora usa la fecha real',
                timer: 2000,
                showConfirmButton: false
            });

            // Actualizar la vista si estamos en un dashboard
            if (currentCoachId && currentPagoId) {
                renderCalendarioPeriodo();
            }
        }

        // ========================================
        // CONFIGURACI√ìN
        // ========================================

        function abrirModalConfiguracion() {
            console.log('üìÇ Funci√≥n abrirModalConfiguracion ejecutada');
            const modal = document.getElementById('modal-configuracion');

            if (!modal) {
                console.error('‚ùå Modal de configuraci√≥n no encontrado');
                return;
            }

            console.log('‚úÖ Modal encontrado, removiendo clase hidden');
            modal.classList.remove('hidden');

            // Cargar estado actual del modo de pruebas
            const config = loadConfig();
            const toggle = document.getElementById('toggle-modo-pruebas');
            const estadoTexto = document.getElementById('estado-modo-pruebas');

            if (toggle) {
                toggle.checked = config.modoPruebas;
            }
            if (estadoTexto) {
                estadoTexto.textContent = config.modoPruebas ? 'Activado' : 'Desactivado';
            }

            console.log('‚úÖ Modal de configuraci√≥n abierto. Modo pruebas:', config.modoPruebas);
        }

        function cerrarModalConfiguracion() {
            const modal = document.getElementById('modal-configuracion');
            modal.classList.add('hidden');
        }

        // ========================================
        // FUNCIONES: Modal Mi Perfil
        // ========================================
        function abrirModalPerfil() {
            console.log('üë§ Funci√≥n abrirModalPerfil ejecutada');
            const modal = document.getElementById('modal-perfil');

            if (!modal) {
                console.error('‚ùå Modal de perfil no encontrado');
                return;
            }

            // Verificar que hay un periodo seleccionado
            if (!currentCoachId || !currentPagoId) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Selecciona un periodo',
                    text: 'Primero debes seleccionar un coach y un periodo para ver tu perfil',
                    confirmButtonText: 'Entendido'
                });
                return;
            }

            // Mostrar el periodo actual en el header
            const data = loadData();
            const pago = (data.pagos[currentCoachId] || []).find(p => p.id === currentPagoId);
            if (pago) {
                document.getElementById('perfil-periodo-actual').textContent = 
                    `üìÖ Periodo: ${pago.periodoInicio} - ${pago.periodoFin}`;
            }

            // Limpiar formulario y ocultarlo al abrir
            limpiarFormularioMedidas();
            document.getElementById('form-medidas-container').classList.add('hidden');
            
            // Cargar lista de medidas del periodo actual
            cargarMedidasDelPeriodo();
            
            // Cargar historial de periodos anteriores
            cargarHistorialMedidas();
            
            modal.classList.remove('hidden');
            console.log('‚úÖ Modal de perfil abierto');
        }
        
        function mostrarFormularioMedidas() {
            const formContainer = document.getElementById('form-medidas-container');
            formContainer.classList.remove('hidden');
            
            // Hacer scroll al formulario
            formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function ocultarFormularioMedidas() {
            const formContainer = document.getElementById('form-medidas-container');
            formContainer.classList.add('hidden');
            limpiarFormularioMedidas();
        }
        
        function cargarMedidasDelPeriodo() {
            const medidas = loadMedidasCorporales();
            const lista = document.getElementById('medidas-periodo-lista');
            
            if (medidas.length === 0) {
                lista.innerHTML = `
                    <p class="text-xs text-gray-500 dark:text-gray-400 text-center py-4">
                        üìù A√∫n no has registrado medidas en este periodo.<br>
                        Completa el formulario arriba para empezar.
                    </p>
                `;
                return;
            }
            
            // Ordenar por fecha m√°s reciente primero
            const medidasOrdenadas = [...medidas].sort((a, b) => 
                new Date(b.fechaRegistro) - new Date(a.fechaRegistro)
            );
            
            let html = '';
            medidasOrdenadas.forEach((m, index) => {
                // Calcular IMC si hay datos
                let imcTexto = '';
                let imcColor = '';
                if (m.peso && m.altura) {
                    const alturaMetros = m.altura / 100;
                    const imc = (m.peso / (alturaMetros * alturaMetros)).toFixed(1);
                    imcTexto = `IMC: ${imc}`;
                    
                    if (imc < 18.5) imcColor = 'text-yellow-600 dark:text-yellow-400';
                    else if (imc < 25) imcColor = 'text-green-600 dark:text-green-400';
                    else if (imc < 30) imcColor = 'text-orange-600 dark:text-orange-400';
                    else imcColor = 'text-red-600 dark:text-red-400';
                }
                
                const fecha = new Date(m.fechaRegistro);
                const fechaTexto = fecha.toLocaleDateString('es-CO', { 
                    day: 'numeric', 
                    month: 'short', 
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const esMasReciente = index === 0;
                
                html += `
                    <div class="p-3 rounded-lg border ${esMasReciente ? 'bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/40 dark:to-indigo-900/40 border-blue-400 dark:border-blue-600' : 'bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700'}">
                        <div class="flex items-start justify-between gap-2 mb-2">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <p class="text-xs font-bold text-gray-700 dark:text-gray-300">
                                        üìÖ ${fechaTexto}
                                    </p>
                                    ${esMasReciente ? '<span class="px-2 py-0.5 text-[10px] font-bold bg-blue-600 text-white rounded-full">M√ÅS RECIENTE</span>' : ''}
                                </div>
                            </div>
                            <div class="flex gap-1">
                                <button onclick="editarMedida('${m.id}')" 
                                    class="p-1.5 text-blue-600 dark:text-blue-400 hover:bg-blue-100 dark:hover:bg-blue-900/50 rounded transition-colors"
                                    title="Editar">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                </button>
                                <button onclick="eliminarMedida('${m.id}')" 
                                    class="p-1.5 text-red-600 dark:text-red-400 hover:bg-red-100 dark:hover:bg-red-900/50 rounded transition-colors"
                                    title="Eliminar">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-2 text-xs mb-2">
                            ${m.peso ? `<div class="bg-white/50 dark:bg-gray-700/50 p-2 rounded"><span class="text-gray-500 dark:text-gray-400 block">Peso</span> <strong class="text-gray-900 dark:text-white">${m.peso} kg</strong></div>` : ''}
                            ${m.altura ? `<div class="bg-white/50 dark:bg-gray-700/50 p-2 rounded"><span class="text-gray-500 dark:text-gray-400 block">Altura</span> <strong class="text-gray-900 dark:text-white">${m.altura} cm</strong></div>` : ''}
                            ${m.edad ? `<div class="bg-white/50 dark:bg-gray-700/50 p-2 rounded"><span class="text-gray-500 dark:text-gray-400 block">Edad</span> <strong class="text-gray-900 dark:text-white">${m.edad} a√±os</strong></div>` : ''}
                        </div>
                        <div class="flex flex-wrap gap-2 text-xs">
                            ${imcTexto ? `<span class="px-2 py-1 bg-white/70 dark:bg-gray-700/70 rounded font-semibold ${imcColor}">${imcTexto}</span>` : ''}
                            ${m.objetivo ? `<span class="px-2 py-1 bg-white/70 dark:bg-gray-700/70 rounded text-gray-700 dark:text-gray-300">üéØ ${m.objetivo.replace('-', ' ')}</span>` : ''}
                            ${m.nivel ? `<span class="px-2 py-1 bg-white/70 dark:bg-gray-700/70 rounded text-gray-700 dark:text-gray-300">üí™ ${m.nivel}</span>` : ''}
                        </div>
                    </div>
                `;
            });
            
            lista.innerHTML = html;
        }
        
        function cargarHistorialMedidas() {
            const historial = obtenerHistorialMedidas(currentCoachId);
            const lista = document.getElementById('historial-medidas-lista');
            
            // Filtrar para no mostrar el periodo actual
            const historiaSinActual = historial.filter(h => h.periodoId !== currentPagoId);
            
            if (historiaSinActual.length === 0) {
                lista.innerHTML = `
                    <p class="text-xs text-gray-500 dark:text-gray-400 text-center py-2">
                        No hay registros de periodos anteriores
                    </p>
                `;
                return;
            }
            
            let html = '';
            historiaSinActual.forEach((item) => {
                // Obtener la medida m√°s reciente de ese periodo
                const medida = item.medidas[item.medidas.length - 1];
                const totalRegistros = item.medidas.length;
                
                // Calcular IMC si hay datos
                let imcTexto = '';
                if (medida.peso && medida.altura) {
                    const alturaMetros = medida.altura / 100;
                    const imc = (medida.peso / (alturaMetros * alturaMetros)).toFixed(1);
                    imcTexto = `IMC: ${imc}`;
                }
                
                html += `
                    <div class="p-3 rounded-lg border bg-white dark:bg-gray-800 border-purple-200 dark:border-purple-700">
                        <div class="flex items-start justify-between gap-2 mb-2">
                            <div class="flex-1">
                                <p class="text-xs font-bold text-gray-700 dark:text-gray-300">
                                    ${item.periodo}
                                </p>
                                <p class="text-[10px] text-purple-600 dark:text-purple-400 mt-0.5">
                                    ${totalRegistros} registro${totalRegistros !== 1 ? 's' : ''} realizad${totalRegistros !== 1 ? 'os' : 'o'}
                                </p>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-2 text-xs">
                            ${medida.peso ? `<div><span class="text-gray-500 dark:text-gray-400">Peso:</span> <strong>${medida.peso} kg</strong></div>` : ''}
                            ${medida.altura ? `<div><span class="text-gray-500 dark:text-gray-400">Altura:</span> <strong>${medida.altura} cm</strong></div>` : ''}
                            ${medida.edad ? `<div><span class="text-gray-500 dark:text-gray-400">Edad:</span> <strong>${medida.edad} a√±os</strong></div>` : ''}
                        </div>
                        ${imcTexto ? `<p class="text-xs text-gray-600 dark:text-gray-400 mt-2">${imcTexto}</p>` : ''}
                        ${medida.objetivo ? `<p class="text-xs text-gray-600 dark:text-gray-400 mt-1">üéØ ${medida.objetivo.replace('-', ' ')}</p>` : ''}
                    </div>
                `;
            });
            
            lista.innerHTML = html;
        }

        function cerrarModalPerfil() {
            const modal = document.getElementById('modal-perfil');
            modal.classList.add('hidden');
        }

        // ========================================
        // ASISTENTE IA - DEEPSEEK
        // ========================================

        const DEEPSEEK_API_KEY_STORAGE = 'deepseek_api_key';
        const CHAT_HISTORY_STORAGE = 'chat_history';
        let conversationHistory = [];

        function abrirModalAsistenteIA() {
            const modal = document.getElementById('modal-asistente-ia');
            if (!modal) {
                console.error('‚ùå Modal de asistente IA no encontrado');
                return;
            }

            // Verificar si hay API key guardada
            const apiKey = localStorage.getItem(DEEPSEEK_API_KEY_STORAGE);
            if (!apiKey) {
                Swal.fire({
                    title: 'Configurar API Key',
                    html: `
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                            Para usar el asistente de IA, necesitas una API Key de DeepSeek.
                        </p>
                        <input id="swal-api-key" type="password" class="swal2-input" placeholder="Ingresa tu API Key de DeepSeek">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                            Puedes obtener tu API Key en <a href="https://platform.deepseek.com" target="_blank" class="text-blue-600 hover:underline">platform.deepseek.com</a>
                        </p>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Guardar',
                    cancelButtonText: 'Cancelar',
                    preConfirm: () => {
                        const apiKey = document.getElementById('swal-api-key').value;
                        if (!apiKey) {
                            Swal.showValidationMessage('Por favor ingresa una API Key');
                            return false;
                        }
                        return apiKey;
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        localStorage.setItem(DEEPSEEK_API_KEY_STORAGE, result.value);
                        modal.classList.remove('hidden');
                        cargarHistorialChat();
                        Swal.fire({
                            icon: 'success',
                            title: 'API Key guardada',
                            text: '¬°Ahora puedes usar el asistente de IA!',
                            timer: 2000,
                            showConfirmButton: false
                        });
                    }
                });
                return;
            }

            modal.classList.remove('hidden');
            cargarHistorialChat();
        }

        function cerrarModalAsistenteIA() {
            const modal = document.getElementById('modal-asistente-ia');
            modal.classList.add('hidden');
            // Cerrar el men√∫ si est√° abierto
            const menu = document.getElementById('menu-ia-opciones');
            if (menu) {
                menu.classList.add('hidden');
            }
        }

        function toggleMenuIA() {
            const menu = document.getElementById('menu-ia-opciones');
            if (menu) {
                menu.classList.toggle('hidden');
            }
        }

        function cargarHistorialChat() {
            const chatContainer = document.getElementById('chat-container');
            const historial = localStorage.getItem(CHAT_HISTORY_STORAGE);
            
            // Guardar el mensaje de bienvenida antes de limpiar
            const mensajeBienvenida = chatContainer.querySelector('.flex.items-start.gap-3');
            const bienvenidaHTML = mensajeBienvenida ? mensajeBienvenida.outerHTML : '';
            
            // Limpiar todo el chat
            chatContainer.innerHTML = '';
            
            // Restaurar mensaje de bienvenida
            if (bienvenidaHTML) {
                chatContainer.innerHTML = bienvenidaHTML;
            }
            
            if (historial) {
                conversationHistory = JSON.parse(historial);
                
                // Renderizar historial
                conversationHistory.forEach(msg => {
                    if (msg.role === 'user') {
                        agregarMensajeUsuario(msg.content, false);
                    } else if (msg.role === 'assistant') {
                        agregarMensajeIA(msg.content, false);
                    }
                });
            } else {
                conversationHistory = [];
            }
        }

        function guardarHistorialChat() {
            localStorage.setItem(CHAT_HISTORY_STORAGE, JSON.stringify(conversationHistory));
        }

        function agregarMensajeUsuario(mensaje, guardar = true) {
            const chatContainer = document.getElementById('chat-container');
            const mensajeDiv = document.createElement('div');
            mensajeDiv.className = 'flex items-start gap-3 justify-end';
            mensajeDiv.innerHTML = `
                <div class="flex-1 bg-blue-600 dark:bg-blue-500 text-white rounded-lg p-3 sm:p-4 shadow-sm max-w-[80%] ml-auto">
                    <p class="text-sm sm:text-base whitespace-pre-wrap">${escapeHtml(mensaje)}</p>
                </div>
                <div class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 bg-gray-600 dark:bg-gray-700 rounded-full flex items-center justify-center">
                    <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                </div>
            `;
            chatContainer.appendChild(mensajeDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            if (guardar) {
                conversationHistory.push({ role: 'user', content: mensaje });
                guardarHistorialChat();
            }
        }

        function agregarMensajeIA(mensaje, guardar = true) {
            const chatContainer = document.getElementById('chat-container');
            const mensajeDiv = document.createElement('div');
            mensajeDiv.className = 'flex items-start gap-3';
            mensajeDiv.innerHTML = `
                <div class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 bg-gradient-to-br from-purple-500 to-blue-500 rounded-full flex items-center justify-center">
                    <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                    </svg>
                </div>
                <div class="flex-1 bg-white dark:bg-gray-800 rounded-lg p-3 sm:p-4 shadow-sm border border-gray-200 dark:border-gray-700">
                    <p class="text-sm sm:text-base text-gray-800 dark:text-gray-200 whitespace-pre-wrap">${escapeHtml(mensaje)}</p>
                </div>
            `;
            chatContainer.appendChild(mensajeDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            if (guardar) {
                conversationHistory.push({ role: 'assistant', content: mensaje });
                guardarHistorialChat();
            }
        }

        function agregarMensajeCargando() {
            const chatContainer = document.getElementById('chat-container');
            const mensajeDiv = document.createElement('div');
            mensajeDiv.id = 'mensaje-cargando';
            mensajeDiv.className = 'flex items-start gap-3';
            mensajeDiv.innerHTML = `
                <div class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 bg-gradient-to-br from-purple-500 to-blue-500 rounded-full flex items-center justify-center">
                    <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                    </svg>
                </div>
                <div class="flex-1 bg-white dark:bg-gray-800 rounded-lg p-3 sm:p-4 shadow-sm border border-gray-200 dark:border-gray-700">
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 bg-purple-500 rounded-full animate-bounce" style="animation-delay: 0s;"></div>
                        <div class="w-2 h-2 bg-purple-500 rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
                        <div class="w-2 h-2 bg-purple-500 rounded-full animate-bounce" style="animation-delay: 0.4s;"></div>
                        <span class="text-sm text-gray-500 dark:text-gray-400 ml-2">Pensando...</span>
                    </div>
                </div>
            `;
            chatContainer.appendChild(mensajeDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function eliminarMensajeCargando() {
            const mensajeCargando = document.getElementById('mensaje-cargando');
            if (mensajeCargando) {
                mensajeCargando.remove();
            }
        }

        async function enviarPreguntaIA() {
            const input = document.getElementById('ia-input');
            const btnEnviar = document.getElementById('btn-enviar-ia');
            const pregunta = input.value.trim();

            if (!pregunta) return;

            // Deshabilitar input y bot√≥n
            input.disabled = true;
            btnEnviar.disabled = true;

            // Agregar mensaje del usuario
            agregarMensajeUsuario(pregunta);
            input.value = '';

            // Agregar mensaje de cargando
            agregarMensajeCargando();

            try {
                // Obtener datos de la aplicaci√≥n como contexto
                const data = loadData();
                const contexto = generarContextoParaIA(data);

                // Preparar mensajes para la API
                const mensajes = [
                    {
                        role: 'system',
                        content: `Eres un asistente personal de entrenamiento inteligente. Tienes acceso a todo el historial de entrenamientos del usuario.

TUS CAPACIDADES:
1. Analizar el historial completo de entrenamientos
2. Actuar como el coach del usuario cuando te lo pida
3. Generar rutinas de entrenamiento basadas en el historial previo
4. Responder preguntas sobre estad√≠sticas, pagos, asistencias y progresi√≥n
5. Dar recomendaciones basadas en datos reales

IMPORTANTE:
- Cuando te pidan actuar como el coach, analiza los entrenamientos previos y genera rutinas similares
- Adapta las rutinas seg√∫n el progreso mostrado en el historial
- Usa los ejercicios que el usuario ya ha realizado
- Mant√©n el formato y estructura de los entrenamientos hist√≥ricos
- Si preguntan algo no relacionado con entrenamientos, indica que solo ayudas con temas de fitness
- S√© espec√≠fico: incluye ejercicios, series, repeticiones y pesos cuando generes rutinas
- Usa formato claro y organizado

Contexto completo de datos del usuario:
${contexto}`
                    },
                    ...conversationHistory.slice(-10), // √öltimos 10 mensajes de conversaci√≥n
                    {
                        role: 'user',
                        content: pregunta
                    }
                ];

                // Llamar a la API de DeepSeek
                const apiKey = localStorage.getItem(DEEPSEEK_API_KEY_STORAGE);
                const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: mensajes,
                        temperature: 0.7,
                        max_tokens: 3000
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'Error al comunicarse con la API');
                }

                const resultado = await response.json();
                const respuesta = resultado.choices[0].message.content;

                // Eliminar mensaje de cargando
                eliminarMensajeCargando();

                // Agregar respuesta de la IA
                agregarMensajeIA(respuesta);

            } catch (error) {
                console.error('Error al consultar DeepSeek:', error);
                eliminarMensajeCargando();
                
                let mensajeError = 'Lo siento, hubo un error al procesar tu pregunta. ';
                if (error.message.includes('API')) {
                    mensajeError += 'Verifica que tu API Key sea correcta.';
                } else if (error.message.includes('network') || error.message.includes('fetch')) {
                    mensajeError += 'Verifica tu conexi√≥n a internet.';
                } else {
                    mensajeError += error.message;
                }
                
                agregarMensajeIA(mensajeError);
            } finally {
                // Rehabilitar input y bot√≥n
                input.disabled = false;
                btnEnviar.disabled = false;
                input.focus();
            }
        }

        function generarContextoParaIA(data) {
            const coaches = data.coaches || [];
            const asistencias = data.asistencias || {};
            const pagos = data.pagos || {};
            // Cargar la medida m√°s reciente del periodo actual si hay uno seleccionado
            const medidas = currentCoachId && currentPagoId ? 
                getMedidaMasReciente(currentCoachId, currentPagoId) : 
                {};

            let contexto = `=== INFORMACI√ìN COMPLETA DEL USUARIO ===\n\n`;
            contexto += `Fecha actual: ${new Date().toLocaleDateString('es-CO', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}\n\n`;
            
            // Agregar perfil del usuario si existe
            if (medidas.peso || medidas.altura || medidas.edad) {
                contexto += `--- PERFIL DEL USUARIO ---\n`;
                if (medidas.peso) contexto += `üí™ Peso: ${medidas.peso} kg\n`;
                if (medidas.altura) contexto += `üìè Altura: ${medidas.altura} cm\n`;
                if (medidas.edad) contexto += `üéÇ Edad: ${medidas.edad} a√±os\n`;
                if (medidas.genero) {
                    const generoTexto = medidas.genero === 'masculino' ? 'Masculino' : medidas.genero === 'femenino' ? 'Femenino' : 'Otro';
                    contexto += `üë§ G√©nero: ${generoTexto}\n`;
                }
                if (medidas.objetivo) {
                    let objetivoTexto = medidas.objetivo.replace('-', ' ');
                    objetivoTexto = objetivoTexto.charAt(0).toUpperCase() + objetivoTexto.slice(1);
                    contexto += `üéØ Objetivo: ${objetivoTexto}\n`;
                }
                if (medidas.nivel) {
                    let nivelTexto = medidas.nivel.charAt(0).toUpperCase() + medidas.nivel.slice(1);
                    contexto += `üí™ Nivel: ${nivelTexto}\n`;
                }
                
                // Calcular IMC si hay datos
                if (medidas.peso && medidas.altura) {
                    const alturaMetros = medidas.altura / 100;
                    const imc = (medidas.peso / (alturaMetros * alturaMetros)).toFixed(1);
                    contexto += `üìä IMC: ${imc}\n`;
                }
                contexto += `\n`;
            }
            
            contexto += `Total de coaches: ${coaches.length}\n\n`;

            coaches.forEach((coach, idx) => {
                contexto += `${'='.repeat(60)}\n`;
                contexto += `COACH: ${coach.nombre.toUpperCase()}\n`;
                contexto += `${'='.repeat(60)}\n`;
                contexto += `Estado: ${coach.activo ? '‚úÖ Activo' : '‚ùå Inactivo'}\n`;
                contexto += `D√≠as de entrenamiento: ${coach.diasLaborables?.join(', ') || 'No especificado'}\n`;

                // Informaci√≥n de pagos
                const pagosCoach = pagos[coach.id] || [];
                if (pagosCoach.length > 0) {
                    contexto += `\n--- INFORMACI√ìN DE PAGOS ---\n`;
                    contexto += `Total de periodos pagados: ${pagosCoach.length}\n`;
                    const totalPagado = pagosCoach.reduce((sum, p) => sum + (p.monto || 0), 0);
                    contexto += `Total pagado: $${totalPagado.toLocaleString()}\n`;
                    
                    const ultimoPago = pagosCoach[pagosCoach.length - 1];
                    if (ultimoPago) {
                        contexto += `√öltimo periodo: ${ultimoPago.fechaInicio} a ${ultimoPago.fechaFin}\n`;
                        contexto += `Monto √∫ltimo periodo: $${ultimoPago.monto?.toLocaleString() || 0}\n`;
                    }
                }

                // Informaci√≥n detallada de asistencias y entrenamientos
                const asistenciasCoach = asistencias[coach.id] || {};
                const fechasOrdenadas = Object.keys(asistenciasCoach).sort();
                const totalClases = fechasOrdenadas.length;
                const clasesAsistidas = fechasOrdenadas.filter(fecha => asistenciasCoach[fecha].asistio).length;
                
                if (totalClases > 0) {
                    contexto += `\n--- RESUMEN DE ASISTENCIAS ---\n`;
                    contexto += `Total de clases programadas: ${totalClases}\n`;
                    contexto += `Clases asistidas: ${clasesAsistidas}\n`;
                    contexto += `Clases faltadas: ${totalClases - clasesAsistidas}\n`;
                    contexto += `Tasa de asistencia: ${((clasesAsistidas / totalClases) * 100).toFixed(1)}%\n`;

                    // HISTORIAL COMPLETO DE ENTRENAMIENTOS
                    contexto += `\n--- HISTORIAL COMPLETO DE ENTRENAMIENTOS ---\n`;
                    contexto += `(Mostrando los √∫ltimos 30 entrenamientos m√°s recientes)\n\n`;
                    
                    // Tomar los √∫ltimos 30 entrenamientos
                    const ultimasClases = fechasOrdenadas.slice(-30);
                    
                    ultimasClases.forEach((fecha, idx) => {
                        const clase = asistenciasCoach[fecha];
                        const fechaObj = new Date(fecha + 'T12:00:00');
                        const nombreDia = fechaObj.toLocaleDateString('es-CO', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
                        
                        contexto += `üìÖ ${nombreDia.toUpperCase()}\n`;
                        contexto += `   Fecha: ${fecha}\n`;
                        contexto += `   Asistencia: ${clase.asistio ? '‚úÖ Asisti√≥' : '‚ùå No asisti√≥'}\n`;
                        
                        // Los ejercicios est√°n en clase.rutina.ejercicios
                        if (clase.asistio && clase.rutina && clase.rutina.ejercicios && clase.rutina.ejercicios.length > 0) {
                            contexto += `   \n   üèãÔ∏è RUTINA DEL D√çA:\n`;
                            
                            // Informaci√≥n del entrenamiento
                            if (clase.rutina.calentamiento) {
                                contexto += `   ‚úÖ Incluye calentamiento\n`;
                            }
                            if (clase.rutina.tren) {
                                contexto += `   üéØ Tren trabajado: ${clase.rutina.tren === 'superior' ? 'Superior' : 'Inferior'}\n`;
                            }
                            if (clase.rutina.tipoMaquinas) {
                                contexto += `   üèãÔ∏è Tipo: M√°quinas\n`;
                            }
                            if (clase.rutina.tipoCalistenia) {
                                contexto += `   ü§∏ Tipo: Calistenia\n`;
                            }
                            contexto += `\n`;
                            
                            clase.rutina.ejercicios.forEach((ejercicio, ejIdx) => {
                                contexto += `   ${ejIdx + 1}. ${ejercicio.nombre}\n`;
                                
                                // Los ejercicios tienen series, repeticiones y peso directamente
                                const detalles = [];
                                if (ejercicio.series) detalles.push(`${ejercicio.series} series`);
                                if (ejercicio.repeticiones) detalles.push(`${ejercicio.repeticiones} reps`);
                                if (ejercicio.peso) detalles.push(`${ejercicio.peso} ${ejercicio.unidad || 'kg'}`);
                                
                                if (detalles.length > 0) {
                                    contexto += `      ${detalles.join(' √ó ')}\n`;
                                }
                                
                                if (ejercicio.nota) {
                                    contexto += `      üìù Nota: ${ejercicio.nota}\n`;
                                }
                            });
                        }
                        
                        if (clase.rutina && clase.rutina.nota) {
                            contexto += `   \n   üí≠ NOTA DEL ENTRENAMIENTO: ${clase.rutina.nota}\n`;
                        }
                        
                        contexto += `\n`;
                    });

                    // An√°lisis de ejercicios m√°s frecuentes
                    const ejerciciosFrecuencia = {};
                    fechasOrdenadas.forEach(fecha => {
                        const clase = asistenciasCoach[fecha];
                        if (clase.asistio && clase.rutina && clase.rutina.ejercicios) {
                            clase.rutina.ejercicios.forEach(ej => {
                                if (!ejerciciosFrecuencia[ej.nombre]) {
                                    ejerciciosFrecuencia[ej.nombre] = {
                                        count: 0,
                                        pesoMax: 0,
                                        repsMax: 0,
                                        seriesMax: 0,
                                        ultimaVez: fecha
                                    };
                                }
                                ejerciciosFrecuencia[ej.nombre].count++;
                                ejerciciosFrecuencia[ej.nombre].ultimaVez = fecha;
                                
                                // Registrar peso, reps y series m√°ximas
                                if (ej.peso && ej.peso > ejerciciosFrecuencia[ej.nombre].pesoMax) {
                                    ejerciciosFrecuencia[ej.nombre].pesoMax = ej.peso;
                                }
                                if (ej.repeticiones && ej.repeticiones > ejerciciosFrecuencia[ej.nombre].repsMax) {
                                    ejerciciosFrecuencia[ej.nombre].repsMax = ej.repeticiones;
                                }
                                if (ej.series && ej.series > ejerciciosFrecuencia[ej.nombre].seriesMax) {
                                    ejerciciosFrecuencia[ej.nombre].seriesMax = ej.series;
                                }
                            });
                        }
                    });

                    // Mostrar ejercicios m√°s frecuentes
                    const ejerciciosOrdenados = Object.entries(ejerciciosFrecuencia)
                        .sort((a, b) => b[1].count - a[1].count)
                        .slice(0, 15);
                    
                    if (ejerciciosOrdenados.length > 0) {
                        contexto += `\n--- TOP 15 EJERCICIOS M√ÅS FRECUENTES ---\n`;
                        ejerciciosOrdenados.forEach(([nombre, datos], idx) => {
                            contexto += `${idx + 1}. ${nombre}\n`;
                            contexto += `   - Veces realizado: ${datos.count}\n`;
                            if (datos.pesoMax > 0) {
                                contexto += `   - Peso m√°ximo: ${datos.pesoMax} kg\n`;
                            }
                            if (datos.seriesMax > 0) {
                                contexto += `   - Series m√°ximas: ${datos.seriesMax}\n`;
                            }
                            if (datos.repsMax > 0) {
                                contexto += `   - Repeticiones m√°ximas: ${datos.repsMax}\n`;
                            }
                            contexto += `   - √öltima vez: ${datos.ultimaVez}\n`;
                        });
                    }
                }

                contexto += `\n`;
            });

            contexto += `\n${'='.repeat(60)}\n`;
            contexto += `INSTRUCCIONES FINALES:\n`;
            contexto += `- Cuando el usuario te pida una rutina, usa los ejercicios que ya ha realizado\n`;
            contexto += `- Adapta los pesos seg√∫n su progreso hist√≥rico\n`;
            contexto += `- Mant√©n el estilo y estructura de entrenamientos previos\n`;
            contexto += `- S√© espec√≠fico con series, repeticiones y pesos\n`;
            contexto += `${'='.repeat(60)}\n`;

            return contexto;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function limpiarHistorialChat() {
            conversationHistory = [];
            localStorage.removeItem(CHAT_HISTORY_STORAGE);
            cargarHistorialChat();
            Swal.fire({
                icon: 'success',
                title: 'Historial limpiado',
                text: 'El historial de conversaci√≥n ha sido eliminado',
                timer: 2000,
                showConfirmButton: false
            });
        }

        function cambiarAPIKey() {
            Swal.fire({
                title: 'Cambiar API Key',
                html: `
                    <input id="swal-api-key" type="password" class="swal2-input" placeholder="Nueva API Key de DeepSeek">
                `,
                showCancelButton: true,
                confirmButtonText: 'Guardar',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    const apiKey = document.getElementById('swal-api-key').value;
                    if (!apiKey) {
                        Swal.showValidationMessage('Por favor ingresa una API Key');
                        return false;
                    }
                    return apiKey;
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.setItem(DEEPSEEK_API_KEY_STORAGE, result.value);
                    Swal.fire({
                        icon: 'success',
                        title: 'API Key actualizada',
                        timer: 2000,
                        showConfirmButton: false
                    });
                }
            });
        }

        // ========================================
        // GENERAR RUTINA CON IA EN MODAL
        // ========================================
        
        async function generarRutinaConIA() {
            // Preguntar si quiere agregar instrucciones adicionales
            const resultInstrucciones = await Swal.fire({
                title: 'ü§ñ Generar Rutina con IA',
                html: `
                    <div class="text-left">
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                            ¬øQuieres darle instrucciones adicionales a la IA?
                        </p>
                        <textarea 
                            id="swal-instrucciones-ia" 
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-emerald-500 dark:bg-gray-700 dark:text-white resize-none" 
                            rows="4"
                            placeholder="Ejemplo: Enf√≥cate m√°s en ejercicios de fuerza, evita sentadillas por lesi√≥n, etc. (Opcional)"
                        ></textarea>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                            üí° Si no escribes nada, la IA generar√° la rutina seg√∫n tu historial normal.
                        </p>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Generar Rutina',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#10b981',
                width: '600px',
                preConfirm: () => {
                    const instrucciones = document.getElementById('swal-instrucciones-ia').value.trim();
                    return instrucciones; // Puede ser vac√≠o
                }
            });

            if (!resultInstrucciones.isConfirmed) return;
            
            const instruccionesUsuario = resultInstrucciones.value || '';
            
            // Verificar API Key
            const apiKey = localStorage.getItem(DEEPSEEK_API_KEY_STORAGE);
            if (!apiKey) {
                Swal.fire({
                    title: 'Configurar API Key',
                    html: `
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                            Para usar la IA, necesitas configurar tu API Key de DeepSeek.
                        </p>
                        <input id="swal-api-key" type="password" class="swal2-input" placeholder="Ingresa tu API Key de DeepSeek">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                            Puedes obtener tu API Key en <a href="https://platform.deepseek.com" target="_blank" class="text-blue-600 hover:underline">platform.deepseek.com</a>
                        </p>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Guardar',
                    cancelButtonText: 'Cancelar',
                    preConfirm: () => {
                        const apiKey = document.getElementById('swal-api-key').value;
                        if (!apiKey) {
                            Swal.showValidationMessage('Por favor ingresa una API Key');
                            return false;
                        }
                        return apiKey;
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        localStorage.setItem(DEEPSEEK_API_KEY_STORAGE, result.value);
                        generarRutinaConIA(); // Reintentar
                    }
                });
                return;
            }

            // Mostrar loading
            Swal.fire({
                title: 'Generando rutina con IA...',
                html: `
                    <div class="flex flex-col items-center gap-4 py-4">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-purple-500 rounded-full animate-bounce" style="animation-delay: 0s;"></div>
                            <div class="w-3 h-3 bg-purple-500 rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
                            <div class="w-3 h-3 bg-purple-500 rounded-full animate-bounce" style="animation-delay: 0.4s;"></div>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400">
                            Analizando tu historial y creando una rutina personalizada...
                        </p>
                    </div>
                `,
                allowOutsideClick: false,
                showConfirmButton: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                // Obtener datos
                const data = loadData();
                const coach = data.coaches.find(c => c.id === currentCoachId);
                const asistenciasCoach = data.asistencias[currentCoachId] || {};
                
                // Generar contexto espec√≠fico para la rutina usando la medida M√ÅS RECIENTE del PERIODO ACTUAL
                const medidas = getMedidaMasReciente(currentCoachId, currentPagoId);
                
                // Analizar el historial para detectar patrones
                const fechasOrdenadas = Object.keys(asistenciasCoach).sort();
                const ultimasClases = fechasOrdenadas.slice(-20); // √öltimos 20 entrenamientos para mejor an√°lisis
                
                if (ultimasClases.length === 0) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Sin historial',
                        text: 'No hay suficiente historial de entrenamientos para generar una rutina personalizada.',
                        confirmButtonText: 'Entendido'
                    });
                    return;
                }
                
                // Analizar el D√çA ANTERIOR con L√ìGICA DE ENTRENADOR
                const fechaActual = new Date(currentNotaDate + 'T12:00:00');
                const diaSemanActual = fechaActual.getDay(); // 0=Domingo, 1=Lunes, ..., 6=S√°bado
                
                // Funci√≥n para obtener el d√≠a de la semana
                const getDiaSemana = (fecha) => {
                    const dia = fecha.getDay();
                    return dia; // 0=Domingo, 6=S√°bado
                };
                
                // Buscar el √∫ltimo d√≠a de entrenamiento REGULAR (no fin de semana)
                let fechaReferencia = new Date(fechaActual);
                fechaReferencia.setDate(fechaReferencia.getDate() - 1);
                
                let diaReferencia = null;
                let fechaReferenciaStr = null;
                let esReprogramacion = false;
                let diasBuscados = 0;
                let maxDiasBusqueda = 7;
                
                // Buscar hacia atr√°s hasta encontrar un d√≠a de entrenamiento relevante
                while (diasBuscados < maxDiasBusqueda) {
                    fechaReferenciaStr = fechaReferencia.toISOString().split('T')[0];
                    const diaSemanRef = getDiaSemana(fechaReferencia);
                    const asistenciaRef = asistenciasCoach[fechaReferenciaStr];
                    
                    // Si es s√°bado o domingo (fin de semana)
                    if (diaSemanRef === 0 || diaSemanRef === 6) {
                        if (asistenciaRef && asistenciaRef.asistio) {
                            // Si hubo asistencia en fin de semana, ES UNA REPROGRAMACI√ìN
                            esReprogramacion = true;
                            // Seguir buscando el √∫ltimo d√≠a regular antes del fin de semana
                            fechaReferencia.setDate(fechaReferencia.getDate() - 1);
                            diasBuscados++;
                            continue;
                        } else {
                            // Si NO hubo asistencia en fin de semana, seguir buscando
                            fechaReferencia.setDate(fechaReferencia.getDate() - 1);
                            diasBuscados++;
                            continue;
                        }
                    } else {
                        // Es un d√≠a de semana regular (lunes-viernes)
                        if (asistenciaRef && asistenciaRef.asistio && asistenciaRef.rutina) {
                            // Encontramos el √∫ltimo d√≠a de entrenamiento regular
                            diaReferencia = asistenciaRef;
                            break;
                        }
                    }
                    
                    fechaReferencia.setDate(fechaReferencia.getDate() - 1);
                    diasBuscados++;
                }
                
                // Variables para el an√°lisis
                let trenDiaAnterior = null;
                let asistioDiaAnterior = false;
                let notasDiaAnterior = '';
                let explicacionReferencia = '';
                
                if (diaReferencia) {
                    asistioDiaAnterior = diaReferencia.asistio;
                    if (diaReferencia.rutina && diaReferencia.rutina.tren) {
                        trenDiaAnterior = diaReferencia.rutina.tren;
                    }
                    if (diaReferencia.notas) {
                        notasDiaAnterior = diaReferencia.notas;
                    }
                    
                    if (esReprogramacion) {
                        explicacionReferencia = `Se detect√≥ reprogramaci√≥n en fin de semana. Usando como referencia el √∫ltimo entrenamiento regular del ${fechaReferenciaStr}`;
                    } else {
                        explicacionReferencia = `√öltimo entrenamiento regular: ${fechaReferenciaStr}`;
                    }
                } else {
                    explicacionReferencia = 'No se encontr√≥ historial de entrenamientos recientes';
                }
                
                // Analizar patrones de trenes y ejercicios
                let ultimoTrenRegistrado = null;
                let contador = 0;
                const ejerciciosPorTren = {
                    superior: {},
                    inferior: {},
                    completo: {}
                };
                
                // Analizar el historial para obtener estad√≠sticas
                ultimasClases.forEach((fecha) => {
                    const clase = asistenciasCoach[fecha];
                    if (clase.asistio && clase.rutina && clase.rutina.ejercicios && clase.rutina.ejercicios.length > 0) {
                        const tren = clase.rutina.tren || 'completo';
                        ultimoTrenRegistrado = tren;
                        contador++;
                        
                        // Contar ejercicios por tren
                        clase.rutina.ejercicios.forEach((ej) => {
                            if (!ejerciciosPorTren[tren][ej.nombre]) {
                                ejerciciosPorTren[tren][ej.nombre] = {
                                    frecuencia: 0,
                                    seriesPromedio: 0,
                                    repsPromedio: 0,
                                    pesoPromedio: 0,
                                    totalPeso: 0,
                                    totalSeries: 0,
                                    totalReps: 0,
                                    count: 0,
                                    maxPeso: 0
                                };
                            }
                            const stats = ejerciciosPorTren[tren][ej.nombre];
                            stats.frecuencia++;
                            stats.count++;
                            if (ej.series) {
                                stats.totalSeries += parseInt(ej.series);
                            }
                            if (ej.repeticiones) {
                                stats.totalReps += parseInt(ej.repeticiones);
                            }
                            if (ej.peso) {
                                const peso = parseFloat(ej.peso);
                                stats.totalPeso += peso;
                                stats.maxPeso = Math.max(stats.maxPeso, peso);
                            }
                        });
                    }
                });
                
                // Calcular promedios
                Object.keys(ejerciciosPorTren).forEach(tren => {
                    Object.keys(ejerciciosPorTren[tren]).forEach(ejercicio => {
                        const stats = ejerciciosPorTren[tren][ejercicio];
                        stats.seriesPromedio = Math.round(stats.totalSeries / stats.count);
                        stats.repsPromedio = Math.round(stats.totalReps / stats.count);
                        stats.pesoPromedio = (stats.totalPeso / stats.count).toFixed(1);
                    });
                });
                
                // Determinar qu√© tren toca hoy con L√ìGICA 3:2 (3 d√≠as superior, 2 d√≠as inferior)
                // Primero: Contar cu√°ntos entrenamientos de cada tren lleva en la SEMANA ACTUAL
                const inicioSemana = new Date(fechaActual);
                inicioSemana.setDate(fechaActual.getDate() - fechaActual.getDay() + 1); // Lunes de esta semana
                const inicioSemanaStr = inicioSemana.toISOString().split('T')[0];
                
                let contadorSuperiorSemana = 0;
                let contadorInferiorSemana = 0;
                const enfoquesUsadosSemana = [];
                
                // Contar entrenamientos de la semana actual y enfoques usados
                Object.keys(asistenciasCoach).forEach(fecha => {
                    if (fecha >= inicioSemanaStr && fecha < currentNotaDate) {
                        const asist = asistenciasCoach[fecha];
                        const fechaAsist = new Date(fecha + 'T12:00:00');
                        const diaAsist = fechaAsist.getDay();
                        
                        // Solo contar d√≠as laborales (lunes a viernes)
                        if (diaAsist >= 1 && diaAsist <= 5 && asist.asistio && asist.rutina && asist.rutina.tren) {
                            if (asist.rutina.tren === 'superior') {
                                contadorSuperiorSemana++;
                                // Guardar el enfoque muscular si existe
                                if (asist.rutina.enfoqueMusculo) {
                                    enfoquesUsadosSemana.push(asist.rutina.enfoqueMusculo);
                                }
                            } else if (asist.rutina.tren === 'inferior') {
                                contadorInferiorSemana++;
                            }
                        }
                    }
                });
                
                let trenHoy = 'superior';
                let razonTren = 'Iniciando con tren superior';
                let enfoqueMusculo = '';
                
                // L√ìGICA 3:2 - Patr√≥n semanal: 3 superiores, 2 inferiores
                const totalEntrenamientosSemana = contadorSuperiorSemana + contadorInferiorSemana;
                
                // ENFOQUES MUSCULARES PARA TREN SUPERIOR (combinaciones profesionales)
                const enfoquesSuperior = [
                    { id: 'pecho-triceps', nombre: 'Pecho + Tr√≠ceps', musculos: ['pecho', 'tr√≠ceps'] },
                    { id: 'espalda-biceps', nombre: 'Espalda + B√≠ceps', musculos: ['espalda', 'b√≠ceps'] },
                    { id: 'hombros-trapecio', nombre: 'Hombros + Trapecio', musculos: ['hombros', 'trapecio'] }
                ];
                
                // ENFOQUES MUSCULARES PARA TREN INFERIOR
                const enfoquesInferior = [
                    { id: 'piernas-completo', nombre: 'Piernas completo', musculos: ['cu√°driceps', 'femoral', 'gl√∫teos', 'pantorrillas'] }
                ];
                
                // Construir explicaci√≥n considerando fin de semana
                let explicacionFinSemana = '';
                if (esReprogramacion) {
                    explicacionFinSemana = `El fin de semana no son d√≠as laborales de entrenamiento. `;
                }
                
                if (trenDiaAnterior) {
                    // Hay un entrenamiento de referencia
                    const nombreDiaRef = new Date(fechaReferenciaStr + 'T12:00:00').toLocaleDateString('es-CO', { weekday: 'long' });
                    
                    // Decidir seg√∫n el patr√≥n 3:2 y el d√≠a de la semana
                    if (diaSemanActual === 1) {
                        // LUNES - Generalmente empieza con superior
                        trenHoy = 'superior';
                        // Seleccionar enfoque muscular que NO se us√≥ esta semana
                        const enfoqueDisponible = enfoquesSuperior.find(e => !enfoquesUsadosSemana.includes(e.id)) || enfoquesSuperior[0];
                        enfoqueMusculo = enfoqueDisponible.id;
                        razonTren = `${explicacionFinSemana}Es lunes, inicio de semana laboral. El √∫ltimo entrenamiento fue el ${nombreDiaRef} (tren ${trenDiaAnterior}). Comenzamos con tren superior enfocado en ${enfoqueDisponible.nombre}, siguiendo el patr√≥n semanal √≥ptimo de 3 d√≠as de superior y 2 de inferior`;
                    } else if (diaSemanActual === 2) {
                        // MARTES
                        if (contadorSuperiorSemana >= 1) {
                            trenHoy = 'inferior';
                            enfoqueMusculo = 'piernas-completo';
                            razonTren = `${explicacionFinSemana}Ya trabajaste tren superior el lunes. Hoy toca tren inferior completo para equilibrar y dar descanso a la parte superior`;
                        } else {
                            trenHoy = 'superior';
                            const enfoqueDisponible = enfoquesSuperior.find(e => !enfoquesUsadosSemana.includes(e.id)) || enfoquesSuperior[0];
                            enfoqueMusculo = enfoqueDisponible.id;
                            razonTren = `${explicacionFinSemana}Continuamos construyendo con tren superior enfocado en ${enfoqueDisponible.nombre}`;
                        }
                    } else if (diaSemanActual === 3) {
                        // MI√âRCOLES
                        if (contadorInferiorSemana < 1) {
                            trenHoy = 'inferior';
                            enfoqueMusculo = 'piernas-completo';
                            razonTren = `${explicacionFinSemana}Es momento de trabajar tren inferior completo para mantener el equilibrio. Patr√≥n: 3 superiores, 2 inferiores por semana`;
                        } else {
                            trenHoy = 'superior';
                            const enfoqueDisponible = enfoquesSuperior.find(e => !enfoquesUsadosSemana.includes(e.id)) || enfoquesSuperior[1];
                            enfoqueMusculo = enfoqueDisponible.id;
                            razonTren = `${explicacionFinSemana}Retomamos tren superior enfocado en ${enfoqueDisponible.nombre} para completar el ciclo semanal`;
                        }
                    } else if (diaSemanActual === 4) {
                        // JUEVES
                        if (contadorInferiorSemana < 2) {
                            trenHoy = 'inferior';
                            enfoqueMusculo = 'piernas-completo';
                            razonTren = `${explicacionFinSemana}Segundo d√≠a de tren inferior en la semana. Importante para fortalecer piernas y gl√∫teos`;
                        } else {
                            trenHoy = 'superior';
                            const enfoqueDisponible = enfoquesSuperior.find(e => !enfoquesUsadosSemana.includes(e.id)) || enfoquesSuperior[2];
                            enfoqueMusculo = enfoqueDisponible.id;
                            razonTren = `${explicacionFinSemana}Ya completaste los 2 d√≠as de tren inferior. Continuamos con superior enfocado en ${enfoqueDisponible.nombre}`;
                        }
                    } else if (diaSemanActual === 5) {
                        // VIERNES
                        if (contadorSuperiorSemana < 3) {
                            trenHoy = 'superior';
                            const enfoqueDisponible = enfoquesSuperior.find(e => !enfoquesUsadosSemana.includes(e.id)) || enfoquesSuperior[2];
                            enfoqueMusculo = enfoqueDisponible.id;
                            razonTren = `${explicacionFinSemana}√öltimo d√≠a de la semana laboral. Completamos los 3 d√≠as de tren superior con enfoque en ${enfoqueDisponible.nombre} para cerrar el ciclo perfecto`;
                        } else {
                            trenHoy = 'inferior';
                            enfoqueMusculo = 'piernas-completo';
                            razonTren = `${explicacionFinSemana}√öltimo d√≠a. Reforzamos tren inferior completo antes del fin de semana`;
                        }
                    }
                } else {
                    // No hay referencia clara, usar l√≥gica por d√≠a de semana
                    if (diaSemanActual === 1 || diaSemanActual === 3 || diaSemanActual === 5) {
                        trenHoy = 'superior';
                        const enfoqueDisponible = enfoquesSuperior.find(e => !enfoquesUsadosSemana.includes(e.id)) || enfoquesSuperior[0];
                        enfoqueMusculo = enfoqueDisponible.id;
                        razonTren = `Iniciando ciclo con tren superior enfocado en ${enfoqueDisponible.nombre} seg√∫n patr√≥n semanal 3:2`;
                    } else {
                        trenHoy = 'inferior';
                        enfoqueMusculo = 'piernas-completo';
                        razonTren = 'D√≠a de tren inferior completo para equilibrar el desarrollo muscular';
                    }
                }
                
                // Generar contexto para la IA
                let contexto = `=== PERFIL Y CONTEXTO DEL ATLETA ===\n\n`;
                contexto += `Coach: ${coach.nombre}\n`;
                contexto += `Fecha para la rutina: ${currentNotaDate}\n\n`;
                
                // Agregar perfil del usuario
                if (medidas.peso || medidas.altura || medidas.edad) {
                    contexto += `--- DATOS PERSONALES ---\n`;
                    if (medidas.peso) contexto += `Peso: ${medidas.peso} kg\n`;
                    if (medidas.altura) contexto += `Altura: ${medidas.altura} cm\n`;
                    if (medidas.edad) contexto += `Edad: ${medidas.edad} a√±os\n`;
                    if (medidas.genero) contexto += `G√©nero: ${medidas.genero}\n`;
                    if (medidas.objetivo) contexto += `Objetivo: ${medidas.objetivo}\n`;
                    if (medidas.nivel) contexto += `Nivel: ${medidas.nivel}\n`;
                    
                    if (medidas.peso && medidas.altura) {
                        const alturaMetros = medidas.altura / 100;
                        const imc = (medidas.peso / (alturaMetros * alturaMetros)).toFixed(1);
                        contexto += `IMC: ${imc}\n`;
                    }
                    contexto += `\n`;
                }
                
                // An√°lisis del d√≠a de referencia (considerando reprogramaciones)
                contexto += `--- AN√ÅLISIS DEL √öLTIMO ENTRENAMIENTO DE REFERENCIA ---\n`;
                contexto += `üìç ${explicacionReferencia}\n\n`;
                
                if (esReprogramacion) {
                    contexto += `‚ö†Ô∏è IMPORTANTE: Se detect√≥ que hubo reprogramaci√≥n(es) en fin de semana.\n`;
                    contexto += `Las reprogramaciones son para recuperar faltas, por lo tanto NO se consideran\n`;
                    contexto += `como parte de la secuencia regular de entrenamiento.\n\n`;
                }
                
                if (diaReferencia) {
                    contexto += `Fecha de referencia: ${fechaReferenciaStr}\n`;
                    if (asistioDiaAnterior) {
                        contexto += `‚úÖ S√ç hubo entrenamiento\n`;
                        if (trenDiaAnterior) {
                            contexto += `Tren trabajado: ${trenDiaAnterior.toUpperCase()}\n`;
                        }
                        if (notasDiaAnterior) {
                            contexto += `Notas del entrenamiento: ${notasDiaAnterior}\n`;
                        }
                    }
                } else {
                    contexto += `‚ö†Ô∏è No se encontr√≥ un entrenamiento de referencia reciente en los √∫ltimos 7 d√≠as.\n`;
                    contexto += `Se proceder√° a generar una rutina basada en el historial general.\n`;
                }
                contexto += `\n`;
                
                // Buscar el enfoque seleccionado para obtener los m√∫sculos
                const enfoqueSeleccionado = trenHoy === 'superior' 
                    ? enfoquesSuperior.find(e => e.id === enfoqueMusculo)
                    : enfoquesInferior.find(e => e.id === enfoqueMusculo);
                
                // An√°lisis de patrones
                contexto += `--- AN√ÅLISIS Y PLANIFICACI√ìN ---\n`;
                contexto += `Total entrenamientos en el periodo: ${contador}\n`;
                contexto += `\n--- CONTEO DE LA SEMANA ACTUAL ---\n`;
                contexto += `D√≠as de tren superior esta semana: ${contadorSuperiorSemana}\n`;
                contexto += `D√≠as de tren inferior esta semana: ${contadorInferiorSemana}\n`;
                if (enfoquesUsadosSemana.length > 0) {
                    contexto += `Enfoques musculares ya usados esta semana: ${enfoquesUsadosSemana.join(', ')}\n`;
                }
                contexto += `Patr√≥n semanal objetivo: 3 d√≠as superior + 2 d√≠as inferior = 5 d√≠as laborales\n`;
                contexto += `\nüéØ TREN QUE CORRESPONDE HOY: ${trenHoy.toUpperCase()}\n`;
                contexto += `üí™ ENFOQUE MUSCULAR ESPEC√çFICO: ${enfoqueSeleccionado ? enfoqueSeleccionado.nombre : 'Completo'}\n`;
                if (enfoqueSeleccionado) {
                    contexto += `üéØ M√öSCULOS A TRABAJAR HOY: ${enfoqueSeleccionado.musculos.map(m => m.toUpperCase()).join(', ')}\n`;
                    contexto += `‚ö†Ô∏è IMPORTANTE: SOLO incluye ejercicios que trabajen estos m√∫sculos espec√≠ficos.\n`;
                    contexto += `   NO mezcles con otros grupos musculares del tren ${trenHoy}.\n`;
                }
                contexto += `üìã Raz√≥n: ${razonTren}\n`;
                contexto += `\n`;
                
                // Ejercicios frecuentes por tren
                const trenParaHoy = ejerciciosPorTren[trenHoy] || {};
                const ejerciciosOrdenados = Object.keys(trenParaHoy)
                    .sort((a, b) => trenParaHoy[b].frecuencia - trenParaHoy[a].frecuencia);
                
                if (ejerciciosOrdenados.length > 0) {
                    contexto += `--- EJERCICIOS DE TREN ${trenHoy.toUpperCase()} EN TU HISTORIAL ---\n`;
                    contexto += `(Ordenados por frecuencia de uso)\n\n`;
                    
                    ejerciciosOrdenados.slice(0, 15).forEach((ejercicio, idx) => {
                        const stats = trenParaHoy[ejercicio];
                        contexto += `${idx + 1}. ${ejercicio}\n`;
                        contexto += `   - Usado ${stats.frecuencia} veces\n`;
                        contexto += `   - Promedio: ${stats.seriesPromedio}s √ó ${stats.repsPromedio}r`;
                        if (stats.maxPeso > 0) {
                            contexto += ` √ó ${stats.pesoPromedio}kg (m√°x: ${stats.maxPeso}kg)`;
                        }
                        contexto += `\n\n`;
                    });
                }
                
                // Historial detallado de √∫ltimos entrenamientos
                contexto += `\n--- √öLTIMOS 10 ENTRENAMIENTOS COMPLETOS ---\n\n`;
                
                ultimasClases.slice(-10).forEach((fecha) => {
                    const clase = asistenciasCoach[fecha];
                    if (clase.asistio && clase.rutina && clase.rutina.ejercicios && clase.rutina.ejercicios.length > 0) {
                        const fechaObj = new Date(fecha + 'T12:00:00');
                        const nombreDia = fechaObj.toLocaleDateString('es-CO', { weekday: 'long', day: 'numeric', month: 'short' });
                        
                        contexto += `üìÖ ${nombreDia} - TREN ${(clase.rutina.tren || 'completo').toUpperCase()}\n`;
                        
                        clase.rutina.ejercicios.forEach((ej, idx) => {
                            contexto += `   ${idx + 1}. ${ej.nombre}`;
                            const detalles = [];
                            if (ej.series) detalles.push(`${ej.series}s`);
                            if (ej.repeticiones) detalles.push(`${ej.repeticiones}r`);
                            if (ej.peso) detalles.push(`${ej.peso}${ej.unidad || 'kg'}`);
                            if (detalles.length > 0) {
                                contexto += ` (${detalles.join(' √ó ')})`;
                            }
                            if (ej.nota) {
                                contexto += ` - ${ej.nota}`;
                            }
                            contexto += `\n`;
                        });
                        
                        if (clase.notas) {
                            contexto += `   üí¨ Notas: ${clase.notas}\n`;
                        }
                        contexto += `\n`;
                    }
                });

                // Llamar a la API de DeepSeek
                const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                            {
                                role: 'system',
                                content: `Eres el Coach Bairon, un entrenador personal experto, amigable y motivador. Tu trabajo es generar UNA RUTINA DE ENTRENAMIENTO personalizada bas√°ndote ESTRICTAMENTE en el historial real del atleta.

üéØ REGLAS FUNDAMENTALES:
1. SOLO usa ejercicios que aparecen en el historial del atleta
2. RESPETA el "ENFOQUE MUSCULAR ESPEC√çFICO" - SOLO selecciona ejercicios de esos m√∫sculos
3. NUNCA mezcles todos los m√∫sculos del tren en un solo d√≠a
4. Considera la l√≥gica de entrenamiento: si hubo reprogramaciones en fin de semana, ign√≥ralas
5. Las reprogramaciones (s√°bados/domingos con asistencia) NO afectan la secuencia normal
6. Usa los pesos, series y repeticiones similares a los hist√≥ricos, con peque√±as progresiones
7. Genera entre 6-9 ejercicios del enfoque muscular espec√≠fico
8. En CADA ejercicio, especifica qu√© m√∫sculo trabaja DENTRO de la instrucci√≥n (no en nota aparte)

üèãÔ∏è L√ìGICA DE ENTRENADOR:
- Patr√≥n semanal: 3 d√≠as de TREN SUPERIOR + 2 d√≠as de TREN INFERIOR = 5 d√≠as laborales (lunes a viernes)
- S√°bados y domingos con asistencia = REPROGRAMACIONES (recuperar faltas, NO cuentan en el patr√≥n semanal)
- Reprogramaciones NO afectan la secuencia regular de la semana laboral
- El sistema ya calcul√≥ qu√© tren toca bas√°ndose en el conteo de la semana actual
- Ejemplo semana t√≠pica: Lun(Superior) ‚Üí Mar(Inferior) ‚Üí Mi√©(Superior) ‚Üí Jue(Inferior) ‚Üí Vie(Superior)
- Si hubo faltas, el patr√≥n se ajusta autom√°ticamente para mantener el equilibrio 3:2

üìã FORMATO DE RESPUESTA:
Responde √öNICAMENTE con este JSON exacto, sin texto adicional antes o despu√©s:

{
  "tren": "superior" o "inferior",
  "enfoqueMusculo": "El ID del enfoque (ejemplo: pecho-triceps, espalda-biceps, etc.)",
  "resumen": "Explicaci√≥n de 2-3 oraciones que DEBE incluir: 1) Menci√≥n del fin de semana si aplica, 2) Qu√© se hizo el √∫ltimo d√≠a laboral, 3) Los M√öSCULOS ESPEC√çFICOS que se trabajar√°n hoy, 4) Por qu√© este enfoque seg√∫n el patr√≥n semanal",
  "ejercicios": [
    {
      "nombre": "Nombre EXACTO del ejercicio (del historial)",
      "series": n√∫mero,
      "repeticiones": n√∫mero,
      "peso": n√∫mero,
      "musculo": "M√∫sculo principal que trabaja (ejemplo: pecho, b√≠ceps, espalda, etc.)",
      "nota": "Instrucci√≥n t√©cnica: PRIMERO menciona qu√© m√∫sculo trabaja, LUEGO c√≥mo hacer el ejercicio, qu√© m√°quina/equipo usar, postura correcta, tips importantes"
    }
  ]
}

EJEMPLO de "nota" correcta:
"Trabaja PECHO (pectoral mayor). Usa barra ol√≠mpica en banco plano, baja controladamente hasta el pecho y empuja explosivamente, mant√©n los pies firmes en el suelo"

‚úÖ INSTRUCCIONES DETALLADAS:
1. Lee "AN√ÅLISIS DEL √öLTIMO ENTRENAMIENTO DE REFERENCIA" para entender el contexto
2. Lee "CONTEO DE LA SEMANA ACTUAL" para ver cu√°ntos d√≠as de cada tren se han hecho
3. Lee "ENFOQUE MUSCULAR ESPEC√çFICO" - ESTE ES EL M√ÅS IMPORTANTE
4. Lee "M√öSCULOS A TRABAJAR HOY" - SOLO selecciona ejercicios de estos m√∫sculos
5. Ejemplo: Si dice "PECHO, TR√çCEPS", NO incluyas ejercicios de espalda, b√≠ceps u hombros
6. Selecciona 6-9 ejercicios QUE TRABAJEN √öNICAMENTE los m√∫sculos del enfoque
7. VAR√çA los ejercicios - no repitas exactamente la rutina del √∫ltimo entrenamiento
8. Usa los promedios hist√≥ricos como base, aplica progresi√≥n gradual (+0.5 a +2kg)
9. En cada ejercicio:
   - Campo "musculo": Especifica el m√∫sculo principal (pecho, tr√≠ceps, espalda, b√≠ceps, hombros, etc.)
   - Campo "nota": INICIA con "Trabaja [M√öSCULO].", LUEGO la instrucci√≥n t√©cnica completa
10. En "resumen", DEBES mencionar:
   - Si hubo fin de semana de por medio (s√°bado/domingo no son laborales)
   - Qu√© se hizo el √∫ltimo d√≠a laboral (ejemplo: "el viernes trabajaste Pecho + Tr√≠ceps")
   - Los M√öSCULOS ESPEC√çFICOS que se trabajar√°n hoy (ejemplo: "Hoy toca Espalda + B√≠ceps")
   - Por qu√© este enfoque seg√∫n el patr√≥n semanal (rotaci√≥n de grupos musculares)
   - C√≥mo se alinea con el objetivo del atleta
11. Campo "enfoqueMusculo": Copia EXACTAMENTE el ID que aparece en el contexto
12. S√© espec√≠fico, motivador y profesional
13. NO inventes ejercicios - SOLO usa los del historial
14. RESPONDE SOLO CON JSON V√ÅLIDO, sin backticks de markdown ni texto extra`
                            },
                            {
                                role: 'user',
                                content: `¬°Hola Coach Bairon! Genera mi rutina de entrenamiento para HOY bas√°ndote en mi historial:\n\n${contexto}\n\n‚ö†Ô∏è RECUERDA: Solo usa ejercicios de mi historial para el tren que corresponde HOY (revisa la secci√≥n "TREN QUE CORRESPONDE HOY").`
                            }
                        ],
                        temperature: 0.7,
                        max_tokens: 3500
                    })
                });

                if (!response.ok) {
                    throw new Error('Error al comunicarse con la API');
                }

                const resultado = await response.json();
                let respuesta = resultado.choices[0].message.content.trim();
                console.log('ü§ñ Respuesta RAW de la IA:', respuesta);
                
                // Limpiar la respuesta por si hay texto adicional
                const jsonMatch = respuesta.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    respuesta = jsonMatch[0];
                }
                console.log('üìù Respuesta limpia:', respuesta);
                
                const rutinaGenerada = JSON.parse(respuesta);
                console.log('‚úÖ Rutina parseada:', rutinaGenerada);
                console.log('üìã Ejercicios:', rutinaGenerada.ejercicios);
                
                // Limpiar ejercicios actuales
                document.getElementById('lista-ejercicios').innerHTML = '';
                
                // Marcar como generada por IA y mostrar badge
                document.getElementById('rutina-generada-por-ia').value = 'true';
                document.getElementById('badge-ia-rutina').classList.remove('hidden');
                console.log('ü§ñ Rutina marcada como generada por IA');
                
                // Guardar el enfoque muscular
                if (rutinaGenerada.enfoqueMusculo) {
                    document.getElementById('enfoque-musculo-hidden').value = rutinaGenerada.enfoqueMusculo;
                    console.log('üí™ Enfoque muscular guardado:', rutinaGenerada.enfoqueMusculo);
                }
                
                // Configurar tren
                if (rutinaGenerada.tren === 'superior') {
                    document.getElementById('tren-superior').checked = true;
                } else if (rutinaGenerada.tren === 'inferior') {
                    document.getElementById('tren-inferior').checked = true;
                }
                console.log('üéØ Tren configurado:', rutinaGenerada.tren);
                
                // Agregar ejercicios generados
                rutinaGenerada.ejercicios.forEach((ejercicio, index) => {
                    console.log(`\nüí™ Agregando ejercicio ${index + 1}:`, ejercicio);
                    agregarEjercicio();
                    const lista = document.getElementById('lista-ejercicios');
                    const ultimoEjercicio = lista.lastElementChild;
                    console.log('üîç Elemento encontrado:', ultimoEjercicio);
                    
                    if (ultimoEjercicio) {
                        const nombreInput = ultimoEjercicio.querySelector('.ejercicio-nombre');
                        const seriesInput = ultimoEjercicio.querySelector('.ejercicio-series');
                        const repsInput = ultimoEjercicio.querySelector('.ejercicio-reps');
                        const pesoInput = ultimoEjercicio.querySelector('.ejercicio-peso');
                        const notaInput = ultimoEjercicio.querySelector('.ejercicio-nota');
                        
                        console.log('üìå Campos encontrados:', {
                            nombre: nombreInput,
                            series: seriesInput,
                            reps: repsInput,
                            peso: pesoInput,
                            nota: notaInput
                        });
                        
                        if (nombreInput) nombreInput.value = ejercicio.nombre || '';
                        if (seriesInput) seriesInput.value = ejercicio.series || '';
                        if (repsInput) repsInput.value = ejercicio.repeticiones || '';
                        if (pesoInput) pesoInput.value = ejercicio.peso || '';
                        if (notaInput && ejercicio.nota) notaInput.value = ejercicio.nota;
                        
                        console.log('‚úèÔ∏è Valores asignados:', {
                            nombre: ejercicio.nombre,
                            series: ejercicio.series,
                            reps: ejercicio.repeticiones,
                            peso: ejercicio.peso
                        });
                    } else {
                        console.error('‚ùå No se encontr√≥ el elemento del ejercicio');
                    }
                });
                
                // Mostrar resumen amigable con el an√°lisis de la IA
                const resumenHTML = `
                    <div class="text-left space-y-3">
                        <div class="bg-gradient-to-r from-emerald-50 to-teal-50 dark:from-emerald-900/30 dark:to-teal-900/30 border-l-4 border-emerald-500 p-4 rounded-lg">
                            <div class="flex items-start gap-3">
                                <svg class="w-6 h-6 text-emerald-600 dark:text-emerald-400 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z"/>
                                </svg>
                                <div class="flex-1">
                                    <h3 class="text-sm font-bold text-gray-900 dark:text-white mb-2">üí¨ Mensaje del Coach Bairon:</h3>
                                    <p class="text-sm text-gray-700 dark:text-gray-300 leading-relaxed">${rutinaGenerada.resumen || 'He preparado tu rutina bas√°ndome en tu historial y objetivos.'}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 dark:bg-blue-900/30 p-3 rounded-lg">
                            <p class="text-sm text-blue-900 dark:text-blue-300">
                                <strong>üìã Tren:</strong> ${rutinaGenerada.tren === 'superior' ? 'Superior üí™' : 'Inferior ü¶µ'}
                            </p>
                            ${rutinaGenerada.enfoqueMusculo ? `
                            <p class="text-sm text-blue-900 dark:text-blue-300 mt-1">
                                <strong>üí™ Enfoque:</strong> ${rutinaGenerada.enfoqueMusculo.replace('-', ' + ').replace(/\b\w/g, l => l.toUpperCase())}
                            </p>
                            ` : ''}
                            <p class="text-sm text-blue-900 dark:text-blue-300 mt-1">
                                <strong>üèãÔ∏è Ejercicios:</strong> ${rutinaGenerada.ejercicios.length} ejercicios agregados
                            </p>
                        </div>
                        
                        <div class="bg-yellow-50 dark:bg-yellow-900/30 border border-yellow-300 dark:border-yellow-700 p-3 rounded-lg">
                            <p class="text-xs text-yellow-800 dark:text-yellow-300">
                                üí° <strong>Tip:</strong> Cada ejercicio tiene notas con instrucciones sobre c√≥mo hacerlo correctamente. ¬°Rev√≠salas antes de empezar!
                            </p>
                        </div>
                    </div>
                `;
                
                // Guardar la rutina autom√°ticamente
                const dataGuardar = loadData();
                
                if (!dataGuardar.asistencias[currentCoachId]) {
                    dataGuardar.asistencias[currentCoachId] = {};
                }
                
                if (!dataGuardar.asistencias[currentCoachId][currentNotaDate]) {
                    dataGuardar.asistencias[currentCoachId][currentNotaDate] = {
                        asistio: null,
                        reprogramacion: false,
                        rutina: null,
                        nota: ''
                    };
                }
                
                // Recopilar ejercicios del modal
                const ejerciciosGuardar = [];
                document.querySelectorAll('#lista-ejercicios > div').forEach(ejercicioDiv => {
                    const nombre = ejercicioDiv.querySelector('.ejercicio-nombre').value.trim();
                    const series = ejercicioDiv.querySelector('.ejercicio-series').value.trim();
                    const repeticiones = ejercicioDiv.querySelector('.ejercicio-reps').value.trim();
                    const peso = ejercicioDiv.querySelector('.ejercicio-peso').value.trim();
                    const unidad = ejercicioDiv.querySelector('.ejercicio-unidad').value;
                    const nota = ejercicioDiv.querySelector('.ejercicio-nota').value.trim();
                    
                    if (nombre) {
                        ejerciciosGuardar.push({ nombre, series, repeticiones, peso, unidad, nota });
                    }
                });
                
                // Obtener tren trabajado
                let trenGuardar = null;
                if (document.getElementById('tren-superior').checked) {
                    trenGuardar = 'superior';
                } else if (document.getElementById('tren-inferior').checked) {
                    trenGuardar = 'inferior';
                }
                
                // Crear objeto de rutina
                const rutinaGuardar = {
                    calentamiento: document.getElementById('calentamiento-check').checked,
                    tipoMaquinas: document.getElementById('tipo-maquinas').checked,
                    tipoCalistenia: document.getElementById('tipo-calistenia').checked,
                    tren: trenGuardar,
                    enfoqueMusculo: document.getElementById('enfoque-musculo-hidden')?.value || null,
                    ejercicios: ejerciciosGuardar,
                    nota: document.getElementById('nota-dia-texto').value.trim(),
                    generadaPorIA: true
                };
                
                // Guardar rutina
                dataGuardar.asistencias[currentCoachId][currentNotaDate].rutina = rutinaGuardar;
                saveData(dataGuardar);
                renderCalendarioPeriodo();
                
                // Cerrar modal de edici√≥n
                cerrarModalNotaDia();
                
                // Mostrar mensaje de √©xito y luego abrir modal de vista
                Swal.fire({
                    icon: 'success',
                    title: 'üéâ ¬°Tu rutina est√° lista!',
                    html: resumenHTML,
                    confirmButtonText: 'Ver mi rutina üí™',
                    confirmButtonColor: '#10b981',
                    width: '600px',
                    customClass: {
                        popup: 'text-left'
                    }
                }).then(() => {
                    // Abrir modal de vista de rutina
                    abrirModalVistaRutina(currentNotaDate);
                });
                
            } catch (error) {
                console.error('Error al generar rutina:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error al generar rutina',
                    text: 'Hubo un problema al generar la rutina. Por favor, intenta nuevamente.',
                    confirmButtonText: 'Entendido'
                });
            }
        }

        // ========================================
        // DARK MODE
        // ========================================

        function toggleDarkMode() {
            const html = document.documentElement;
            const isDark = html.classList.contains('dark');

            if (isDark) {
                html.classList.remove('dark');
                localStorage.setItem('darkMode', 'false');
            } else {
                html.classList.add('dark');
                localStorage.setItem('darkMode', 'true');
            }
        }

        function toggleModoPruebas(activo) {
            const config = loadConfig();
            config.modoPruebas = activo;
            saveConfig(config);

            // Actualizar texto del estado
            const estadoTexto = document.getElementById('estado-modo-pruebas');
            estadoTexto.textContent = activo ? 'Activado' : 'Desactivado';

            // Mostrar u ocultar panel de pruebas
            const panel = document.getElementById('panel-pruebas');
            if (activo) {
                panel.classList.remove('hidden');
            } else {
                panel.classList.add('hidden');
                // Si se desactiva, tambi√©n cerrar el contenido del panel y resetear fecha
                document.getElementById('contenido-panel-pruebas').classList.add('hidden');
                fechaSimulada = null;
                document.getElementById('fecha-simulada').value = '';
            }

            console.log('Modo de pruebas:', activo ? 'Activado' : 'Desactivado');
        }

        function actualizarVisibilidadPanelPruebas() {
            const config = loadConfig();
            const panel = document.getElementById('panel-pruebas');

            if (config.modoPruebas) {
                panel.classList.remove('hidden');
            } else {
                panel.classList.add('hidden');
            }
        }

        // ========================================
        // BACKUP DE BASE DE DATOS
        // ========================================

        function descargarBackup() {
            try {
                // Obtener todos los datos del localStorage
                const data = loadData();
                const config = loadConfig();

                // Crear un objeto con metadatos adicionales
                const backup = {
                    version: '1.0',
                    fecha_backup: new Date().toISOString(),
                    fecha_backup_legible: formatDateDisplay(formatDate(new Date())) + ' ' + new Date().toLocaleTimeString('es-CO'),
                    datos: data,
                    configuracion: config
                };

                // Convertir a JSON con formato legible
                const jsonStr = JSON.stringify(backup, null, 2);

                // Crear un blob con el contenido
                const blob = new Blob([jsonStr], { type: 'application/json' });

                // Crear un link temporal para descargar
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;

                // Nombre del archivo con fecha
                const fechaArchivo = formatDate(new Date()).replace(/-/g, '');
                const horaArchivo = new Date().toTimeString().slice(0, 8).replace(/:/g, '');
                link.download = `backup_coaches_${fechaArchivo}_${horaArchivo}.json`;

                // Simular clic y descargar
                document.body.appendChild(link);
                link.click();

                // Limpiar
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                console.log('‚úÖ Backup descargado exitosamente');
            } catch (error) {
                console.error('‚ùå Error al descargar backup:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error al crear el backup',
                    text: 'Revisa la consola para m√°s detalles',
                    confirmButtonText: 'Entendido'
                });
            }
        }

        function importarBackup(file) {
            // Validar que sea un archivo JSON
            if (!file.name.endsWith('.json')) {
                Swal.fire({
                    icon: 'error',
                    title: 'Archivo inv√°lido',
                    text: 'Por favor selecciona un archivo JSON v√°lido',
                    confirmButtonText: 'Entendido'
                });
                return;
            }

            const reader = new FileReader();

            reader.onload = async (e) => {
                try {
                    // Parsear el JSON
                    const contenido = JSON.parse(e.target.result);

                    // Validar estructura del backup
                    if (!contenido.datos) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Formato incorrecto',
                            text: 'El archivo no tiene el formato correcto de backup',
                            confirmButtonText: 'Entendido'
                        });
                        return;
                    }

                    const datos = contenido.datos;
                    const configuracion = contenido.configuracion || { modoPruebas: false };

                    // Validar que tenga las propiedades esperadas
                    if (!datos.coaches || !datos.pagos || !datos.asistencias) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Backup incompleto',
                            text: 'El backup no contiene todos los datos necesarios (coaches, pagos, asistencias)',
                            confirmButtonText: 'Entendido'
                        });
                        return;
                    }

                    // Mostrar informaci√≥n del backup
                    const numCoaches = datos.coaches.length;
                    const numPagos = Object.values(datos.pagos).reduce((sum, arr) => sum + arr.length, 0);
                    const fechaBackup = contenido.fecha_backup_legible || contenido.fecha_backup || 'Desconocida';
                    const modoPruebasTexto = configuracion.modoPruebas ? 'Activado' : 'Desactivado';

                    // Confirmar antes de importar
                    const confirmacion = await Swal.fire({
                        title: '‚ö†Ô∏è ADVERTENCIA',
                        html: `Esta acci√≥n sobrescribir√° <strong>TODOS</strong> los datos actuales.<br><br>` +
                            `<strong>Informaci√≥n del backup:</strong><br>` +
                            `‚Ä¢ Fecha: ${fechaBackup}<br>` +
                            `‚Ä¢ Coaches: ${numCoaches}<br>` +
                            `‚Ä¢ Periodos: ${numPagos}<br>` +
                            `‚Ä¢ Modo de pruebas: ${modoPruebasTexto}<br><br>` +
                            `¬øEst√°s seguro de que deseas continuar?`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'S√≠, importar',
                        cancelButtonText: 'Cancelar',
                        confirmButtonColor: '#dc2626'
                    });

                    if (!confirmacion.isConfirmed) {
                        console.log('‚ùå Importaci√≥n cancelada por el usuario');
                        return;
                    }

                    // Guardar los datos y configuraci√≥n en localStorage
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(datos));
                    localStorage.setItem(CONFIG_KEY, JSON.stringify(configuracion));

                    console.log('‚úÖ Backup importado exitosamente:', {
                        coaches: numCoaches,
                        pagos: numPagos,
                        fecha: fechaBackup,
                        modoPruebas: configuracion.modoPruebas
                    });

                    // Mostrar confirmaci√≥n
                    await Swal.fire({
                        icon: 'success',
                        title: 'Backup importado exitosamente',
                        html: `‚Ä¢ ${numCoaches} coaches<br>‚Ä¢ ${numPagos} periodos de pago<br>‚Ä¢ Modo de pruebas: ${modoPruebasTexto}`,
                        confirmButtonText: 'Entendido'
                    });

                    // Actualizar visibilidad del panel de pruebas
                    actualizarVisibilidadPanelPruebas();

                    // Recargar la vista
                    currentCoachId = null;
                    currentPagoId = null;
                    mostrarVistaLista();

                } catch (error) {
                    console.error('‚ùå Error al importar backup:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error al procesar el archivo',
                        text: 'Aseg√∫rate de que sea un backup v√°lido. ' + error.message,
                        confirmButtonText: 'Entendido'
                    });
                }
            };

            reader.onerror = () => {
                console.error('‚ùå Error al leer el archivo');
                Swal.fire({
                    icon: 'error',
                    title: 'Error al leer el archivo',
                    text: 'No se pudo leer el archivo seleccionado',
                    confirmButtonText: 'Entendido'
                });
            };

            // Leer el archivo como texto
            reader.readAsText(file);
        }

        // ========================================
        // INICIALIZACI√ìN
        // ========================================

        function inicializarEventListeners() {
            // Agregar coach
            document.getElementById('btn-agregar-coach')?.addEventListener('click', () => abrirModalCoach());

            // Cancelar modal coach
            document.getElementById('btn-cancelar-modal')?.addEventListener('click', cerrarModalCoach);

            // Volver a lista
            document.getElementById('btn-volver-lista')?.addEventListener('click', mostrarVistaLista);

            // Configuraci√≥n
            document.getElementById('btn-configuracion')?.addEventListener('click', () => {
                console.log('üîß Abriendo modal de configuraci√≥n...');
                abrirModalConfiguracion();
            });

            // Mi Perfil
            document.getElementById('btn-perfil')?.addEventListener('click', () => {
                console.log('üë§ Abriendo modal de perfil...');
                abrirModalPerfil();
            });

            // Asistente IA
            document.getElementById('btn-asistente-ia')?.addEventListener('click', () => {
                console.log('ü§ñ Abriendo asistente IA...');
                abrirModalAsistenteIA();
            });

            // Asistente IA (bot√≥n flotante m√≥vil)
            document.getElementById('btn-asistente-ia-mobile')?.addEventListener('click', () => {
                console.log('ü§ñ Abriendo asistente IA desde m√≥vil...');
                abrirModalAsistenteIA();
            });

            // Dark Mode Toggle
            document.getElementById('btn-dark-mode')?.addEventListener('click', toggleDarkMode);

            // Toggle modo de pruebas
            document.getElementById('toggle-modo-pruebas')?.addEventListener('change', (e) => {
                toggleModoPruebas(e.target.checked);
            });

            // Cerrar modales con clic fuera (click en el overlay)
            document.getElementById('modal-configuracion')?.addEventListener('click', (e) => {
                if (e.target.id === 'modal-configuracion') {
                    cerrarModalConfiguracion();
                }
            });

            document.getElementById('modal-coach')?.addEventListener('click', (e) => {
                if (e.target.id === 'modal-coach') {
                    cerrarModalCoach();
                }
            });

            document.getElementById('modal-pago')?.addEventListener('click', (e) => {
                if (e.target.id === 'modal-pago') {
                    cerrarModalPago();
                }
            });

            document.getElementById('modal-historial-pagos')?.addEventListener('click', (e) => {
                if (e.target.id === 'modal-historial-pagos') {
                    cerrarModalHistorialPagos();
                }
            });

            document.getElementById('modal-editar-periodo')?.addEventListener('click', (e) => {
                if (e.target.id === 'modal-editar-periodo') {
                    cerrarModalEditarPeriodo();
                }
            });

            document.getElementById('modal-ejercicios-biblioteca')?.addEventListener('click', (e) => {
                if (e.target.id === 'modal-ejercicios-biblioteca') {
                    cerrarModalBibliotecaEjercicios();
                }
            });

            document.getElementById('modal-asistente-ia')?.addEventListener('click', (e) => {
                if (e.target.id === 'modal-asistente-ia') {
                    cerrarModalAsistenteIA();
                }
            });

            // Manejar Enter en el input del asistente IA
            document.getElementById('ia-input')?.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    enviarPreguntaIA();
                }
            });

            // Cerrar men√∫ de IA cuando se haga clic fuera
            document.addEventListener('click', (e) => {
                const menu = document.getElementById('menu-ia-opciones');
                const btnMenu = document.getElementById('btn-menu-ia');
                if (menu && btnMenu && !menu.contains(e.target) && !btnMenu.contains(e.target)) {
                    menu.classList.add('hidden');
                }
            });

            document.getElementById('modal-vista-rutina')?.addEventListener('click', (e) => {
                if (e.target.id === 'modal-vista-rutina') {
                    cerrarModalVistaRutina();
                }
            });

            document.getElementById('modal-nota-dia')?.addEventListener('click', (e) => {
                if (e.target.id === 'modal-nota-dia') {
                    cerrarModalNotaDia();
                }
            });

            document.getElementById('modal-info-coach')?.addEventListener('click', (e) => {
                if (e.target.id === 'modal-info-coach') {
                    cerrarModalInfoCoach();
                }
            });

            // Descargar backup (botones del modal de configuraci√≥n)
            document.getElementById('btn-descargar-backup-config')?.addEventListener('click', descargarBackup);

            // Importar backup (botones del modal de configuraci√≥n)
            document.getElementById('btn-importar-backup-config')?.addEventListener('click', () => {
                document.getElementById('input-importar-backup').click();
            });

            document.getElementById('input-importar-backup')?.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    importarBackup(file);
                }
                e.target.value = '';
            });

            // Buscar coach
            document.getElementById('buscar-coach')?.addEventListener('input', renderCoachesList);

            // Registrar pago
            document.getElementById('btn-registrar-pago')?.addEventListener('click', abrirModalPago);
            document.getElementById('btn-cancelar-pago')?.addEventListener('click', cerrarModalPago);

            console.log('‚úÖ Event listeners inicializados');
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ DOM Cargado, inicializando aplicaci√≥n...');

            // Inicializar event listeners
            inicializarEventListeners();

            // Actualizar visibilidad del panel de pruebas seg√∫n configuraci√≥n
            actualizarVisibilidadPanelPruebas();

            mostrarVistaLista();

            // Actualizar info de fecha real en panel de pruebas
            const fechaRealSpan = document.querySelector('#fecha-actual-info span');
            if (fechaRealSpan) {
                const hoy = new Date();
                fechaRealSpan.textContent = formatDate(hoy);
            }

            console.log('‚úÖ Aplicaci√≥n inicializada correctamente');
        });
    </script>

    <!-- Bot√≥n flotante Coach IA General - Visible en todas las pantallas -->
    <button id="btn-asistente-ia-mobile"
        class="group fixed bottom-6 right-6 z-[90] flex flex-col items-center gap-2"
        title="ü§ñ Coach IA General - Tu entrenador virtual inteligente">
        <!-- Badge identificador -->
        <div class="hidden sm:flex items-center gap-1.5 px-3 py-1.5 bg-gradient-to-r from-emerald-600 to-teal-600 text-white text-xs font-bold rounded-full shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 whitespace-nowrap">
            <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
            </svg>
            Coach IA
        </div>
        
        <!-- Bot√≥n circular principal -->
        <div class="relative">
            <div class="w-16 h-16 sm:w-20 sm:h-20 flex items-center justify-center text-white bg-gradient-to-br from-emerald-500 via-teal-500 to-cyan-500 rounded-full shadow-2xl hover:shadow-emerald-500/50 hover:scale-110 active:scale-95 transition-all duration-300 border-3 border-white/40"
                style="box-shadow: 0 0 30px rgba(16, 185, 129, 0.6), 0 0 60px rgba(20, 184, 166, 0.4), inset 0 0 20px rgba(255, 255, 255, 0.2);">
                <!-- Icono de robot/IA con cerebro -->
                <svg class="h-9 w-9 sm:h-11 sm:w-11 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z"/>
                </svg>
                <!-- Destello animado -->
                <div class="absolute inset-0 rounded-full bg-white opacity-0 group-hover:opacity-20 transition-opacity duration-300"></div>
            </div>
            <!-- Ping animado -->
            <div class="absolute inset-0 rounded-full bg-emerald-400 opacity-75 animate-ping"></div>
        </div>
    </button>
    
    <style>
        @keyframes glow-pulse {
            0%, 100% {
                box-shadow: 0 0 30px rgba(16, 185, 129, 0.6), 0 0 60px rgba(20, 184, 166, 0.4), inset 0 0 20px rgba(255, 255, 255, 0.2);
            }
            50% {
                box-shadow: 0 0 40px rgba(16, 185, 129, 0.8), 0 0 80px rgba(20, 184, 166, 0.6), inset 0 0 30px rgba(255, 255, 255, 0.3);
            }
        }
        
        /* Aplicar animaci√≥n de brillo al div interno del bot√≥n */
        #btn-asistente-ia-mobile > div > div:first-child {
            animation: glow-pulse 2s ease-in-out infinite;
        }
        
        /* Al hacer hover, intensificar el brillo */
        #btn-asistente-ia-mobile:hover > div > div:first-child {
            animation: none;
            box-shadow: 0 0 50px rgba(16, 185, 129, 0.9), 0 0 100px rgba(20, 184, 166, 0.7), inset 0 0 40px rgba(255, 255, 255, 0.4) !important;
        }
    </style>
</body>

</html>