<!DOCTYPE html>
<html lang="es-CO">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Panel de administraci√≥n de coaches">
    <title>Gesti√≥n de Coaches - Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900 antialiased">
    
    <!-- Encabezado -->
    <header class="sticky top-0 z-50 bg-white border-b border-gray-200 shadow-sm">
        <div class="container mx-auto px-4 py-4 md:px-6 md:py-5">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-900">Gesti√≥n de Coaches</h1>
                    <p class="text-sm text-gray-500 mt-1">Administra tus entrenamientos y pagos</p>
                </div>
                <button 
                    id="btn-volver-lista"
                    class="hidden px-4 py-2 text-sm font-medium text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50"
                >
                    ‚Üê Volver a lista
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6 md:px-6 md:py-8">
        
        <!-- VISTA: Lista de Coaches -->
        <div id="vista-lista-coaches">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-xl font-bold text-gray-900">Mis Coaches</h2>
                    <p class="text-sm text-gray-500 mt-1">Selecciona un coach para ver sus detalles</p>
                </div>
                <button 
                    id="btn-agregar-coach"
                    class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700"
                >
                    + Agregar Coach
                </button>
            </div>

            <!-- Buscador -->
            <div class="mb-4">
                <input 
                    type="text" 
                    id="buscar-coach"
                    placeholder="Buscar coach por nombre..."
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
            </div>

            <!-- Grid de coaches -->
            <div id="grid-coaches" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Se llena din√°micamente -->
            </div>

            <!-- Mensaje vac√≠o -->
            <div id="mensaje-sin-coaches" class="hidden text-center py-12">
                <div class="text-gray-400 text-5xl mb-4">üë§</div>
                <h3 class="text-lg font-semibold text-gray-700 mb-2">No hay coaches registrados</h3>
                <p class="text-sm text-gray-500 mb-4">Comienza agregando tu primer coach</p>
                <button 
                    onclick="document.getElementById('btn-agregar-coach').click()"
                    class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700"
                >
                    + Agregar Coach
                </button>
            </div>
        </div>

        <!-- VISTA: Dashboard del Coach -->
        <div id="vista-dashboard-coach" class="hidden">
            
            <!-- Info del coach -->
            <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 mb-6">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <h2 id="coach-nombre" class="text-2xl font-bold text-gray-900"></h2>
                        <div class="flex items-center gap-6 mt-3">
                            <div>
                                <p class="text-xs text-gray-500">D√≠as laborables</p>
                                <p id="coach-dias" class="text-sm font-medium text-gray-900 mt-1"></p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500">Total de pagos</p>
                                <p id="coach-total-pagos" class="text-sm font-semibold text-blue-600 mt-1">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button 
                            id="btn-editar-coach"
                            class="px-3 py-2 text-sm font-medium text-blue-600 border border-blue-300 rounded-lg hover:bg-blue-50"
                        >
                            Editar
                        </button>
                        <button 
                            id="btn-eliminar-coach"
                            class="px-3 py-2 text-sm font-medium text-red-600 border border-red-300 rounded-lg hover:bg-red-50"
                        >
                            Eliminar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Mensaje: Sin pagos -->
            <div id="mensaje-sin-pagos" class="bg-blue-50 border border-blue-200 rounded-xl p-8 text-center">
                <div class="text-blue-400 text-5xl mb-4">üí∞</div>
                <h3 class="text-lg font-semibold text-blue-900 mb-2">No hay pagos registrados</h3>
                <p class="text-sm text-blue-700 mb-4">Registra el primer pago para comenzar a marcar asistencias</p>
                <button 
                    onclick="document.getElementById('btn-registrar-pago-inicio').click()"
                    class="px-6 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700"
                >
                    + Registrar primer pago
                </button>
                <button 
                    id="btn-registrar-pago-inicio"
                    class="hidden"
                ></button>
            </div>

            <!-- Contenido con pagos -->
            <div id="contenido-con-pagos" class="hidden">
                
                <!-- Selector de periodo -->
                <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-4 mb-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <label for="select-periodo-pago" class="text-sm font-medium text-gray-700 mr-3">Ver periodo:</label>
                            <select 
                                id="select-periodo-pago"
                                class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                                <!-- Se llena din√°micamente -->
                            </select>
                        </div>
                        <button 
                            id="btn-registrar-pago"
                            class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700"
                        >
                            + Nuevo pago
                        </button>
                    </div>
                </div>

                <!-- M√©tricas del periodo seleccionado -->
                <section class="mb-6">
                    <h3 class="text-sm font-medium text-gray-600 mb-3">Estad√≠sticas del periodo seleccionado</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                        <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                            <h3 class="text-xs font-medium text-gray-500">Programadas</h3>
                            <p id="metric-programadas" class="text-2xl font-bold text-gray-900 mt-2">0</p>
                        </div>
                        <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                            <h3 class="text-xs font-medium text-gray-500">Asistidas</h3>
                            <p id="metric-asistidas" class="text-2xl font-bold text-green-600 mt-2">0</p>
                        </div>
                        <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                            <h3 class="text-xs font-medium text-gray-500">Faltas</h3>
                            <p id="metric-faltas" class="text-2xl font-bold text-red-600 mt-2">0</p>
                        </div>
                        <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                            <h3 class="text-xs font-medium text-gray-500">Reposiciones</h3>
                            <p id="metric-reposiciones" class="text-2xl font-bold text-blue-600 mt-2">0</p>
                        </div>
                    </div>
                </section>

                <!-- Grid: Calendario + Historial -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <!-- Calendario -->
                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold text-gray-900">Calendario del periodo</h3>
                                <span id="periodo-label" class="text-sm text-blue-600 font-medium"></span>
                            </div>
                            
                            <p class="text-xs text-gray-500 mb-4">Click derecho para marcar reposici√≥n</p>
                            
                            <div id="calendar-grid" class="overflow-x-auto">
                                <!-- Se genera din√°micamente -->
                            </div>
                        </div>
                    </div>

                    <!-- Historial de pagos -->
                    <div class="lg:col-span-1">
                        <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
                            <h3 class="text-lg font-bold text-gray-900 mb-4">Todos los pagos</h3>
                            
                            <div id="lista-pagos" class="space-y-3 max-h-96 overflow-y-auto">
                                <!-- Se llena din√°micamente -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Modal: Agregar/Editar Coach -->
    <div id="modal-coach" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-xl max-w-lg w-full p-6">
            <h2 id="modal-coach-titulo" class="text-xl font-bold text-gray-900 mb-4">Agregar Coach</h2>
            
            <form id="form-coach" class="space-y-4">
                <div>
                    <label for="coach-nombre-input" class="block text-sm font-medium text-gray-700 mb-1">Nombre del coach *</label>
                    <input 
                        type="text" 
                        id="coach-nombre-input"
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="Ej: Carlos P√©rez"
                    >
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">D√≠as laborables *</label>
                    <div class="flex flex-wrap gap-3">
                        <label class="flex items-center gap-2 text-sm">
                            <input type="checkbox" value="1" class="dia-checkbox rounded" checked>
                            <span>Lunes</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm">
                            <input type="checkbox" value="2" class="dia-checkbox rounded" checked>
                            <span>Martes</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm">
                            <input type="checkbox" value="3" class="dia-checkbox rounded" checked>
                            <span>Mi√©rcoles</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm">
                            <input type="checkbox" value="4" class="dia-checkbox rounded" checked>
                            <span>Jueves</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm">
                            <input type="checkbox" value="5" class="dia-checkbox rounded" checked>
                            <span>Viernes</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm">
                            <input type="checkbox" value="6" class="dia-checkbox rounded">
                            <span>S√°bado</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm">
                            <input type="checkbox" value="0" class="dia-checkbox rounded">
                            <span>Domingo</span>
                        </label>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Selecciona los d√≠as en que el coach entrena. Puedes incluir s√°bado/domingo para reposiciones.</p>
                </div>

                <input type="hidden" id="coach-id-input">

                <div class="flex gap-3 pt-4">
                    <button 
                        type="button"
                        id="btn-cancelar-modal"
                        class="flex-1 px-4 py-2 text-sm font-medium text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50"
                    >
                        Cancelar
                    </button>
                    <button 
                        type="submit"
                        class="flex-1 px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700"
                    >
                        Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Registrar Pago -->
    <div id="modal-pago" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-xl max-w-lg w-full p-6">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Registrar Pago</h2>
            
            <form id="form-pago" class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label for="pago-periodo-inicio" class="block text-sm font-medium text-gray-700 mb-1">Periodo inicio *</label>
                        <input 
                            type="date" 
                            id="pago-periodo-inicio"
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                    </div>
                    <div>
                        <label for="pago-periodo-fin" class="block text-sm font-medium text-gray-700 mb-1">Periodo fin *</label>
                        <input 
                            type="date" 
                            id="pago-periodo-fin"
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                    </div>
                </div>

                <!-- Resumen del periodo -->
                <div id="resumen-periodo" class="bg-blue-50 border border-blue-200 rounded-lg p-4 space-y-2">
                    <p class="text-sm font-semibold text-blue-900 mb-2">Resumen del periodo:</p>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div>
                            <span class="text-blue-700">Clases programadas:</span>
                            <span id="resumen-programadas" class="font-semibold text-blue-900">0</span>
                        </div>
                        <div>
                            <span class="text-green-700">Asistidas:</span>
                            <span id="resumen-asistidas" class="font-semibold text-green-900">0</span>
                        </div>
                        <div>
                            <span class="text-red-700">Faltas:</span>
                            <span id="resumen-faltas" class="font-semibold text-red-900">0</span>
                        </div>
                        <div>
                            <span class="text-blue-700">Reposiciones:</span>
                            <span id="resumen-reposiciones-pago" class="font-semibold text-blue-900">0</span>
                        </div>
                    </div>
                    <div class="pt-2 border-t border-blue-300">
                        <span class="text-sm text-blue-700">Monto sugerido:</span>
                        <span id="resumen-monto" class="text-lg font-bold text-blue-900">$0</span>
                    </div>
                </div>

                <div>
                    <label for="pago-fecha" class="block text-sm font-medium text-gray-700 mb-1">Fecha de pago *</label>
                    <input 
                        type="date" 
                        id="pago-fecha"
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                </div>

                <div>
                    <label for="pago-monto-base" class="block text-sm font-medium text-gray-700 mb-1">Monto base del periodo (COP) *</label>
                    <input 
                        type="number" 
                        id="pago-monto-base"
                        required
                        min="0"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="450000"
                    >
                    <p class="text-xs text-gray-500 mt-1">Monto acordado para el periodo completo</p>
                </div>

                <div>
                    <label for="pago-monto" class="block text-sm font-medium text-gray-700 mb-1">Monto real pagado (COP) *</label>
                    <input 
                        type="number" 
                        id="pago-monto"
                        required
                        min="0"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                    <p class="text-xs text-gray-500 mt-1">El sistema calcula el monto proporcional seg√∫n asistencias</p>
                </div>

                <div>
                    <label for="pago-nota" class="block text-sm font-medium text-gray-700 mb-1">Nota</label>
                    <textarea 
                        id="pago-nota" 
                        rows="2"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="Observaciones..."
                    ></textarea>
                </div>

                <div class="flex gap-3 pt-4">
                    <button 
                        type="button"
                        id="btn-cancelar-pago"
                        class="flex-1 px-4 py-2 text-sm font-medium text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50"
                    >
                        Cancelar
                    </button>
                    <button 
                        type="submit"
                        class="flex-1 px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700"
                    >
                        Guardar Pago
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <footer class="border-t border-gray-200 bg-white mt-12">
        <div class="container mx-auto px-4 py-4 md:px-6">
            <p class="text-xs text-gray-500 text-center">Sistema de gesti√≥n de coaches - Datos en localStorage</p>
        </div>
    </footer>

    <script>
        // ========================================
        // CONFIGURACI√ìN Y ESTADO GLOBAL
        // ========================================
        
        const STORAGE_KEY = 'coaches_data';
        
        let currentCoachId = null;
        let currentPagoId = null; // ID del pago/periodo actualmente seleccionado
        
        const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                           'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

        // ========================================
        // GESTI√ìN DE DATOS
        // ========================================

        function loadData() {
            const data = localStorage.getItem(STORAGE_KEY);
            return data ? JSON.parse(data) : { coaches: [], asistencias: {}, pagos: {} };
        }

        function saveData(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function generateId() {
            return Date.now().toString() + Math.random().toString(36).substr(2, 9);
        }

        // ========================================
        // UTILIDADES
        // ========================================

        function formatDate(date) {
            if (typeof date === 'string') return date;
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function formatDateDisplay(dateStr) {
            const [y, m, d] = dateStr.split('-');
            return `${d}/${m}/${y}`;
        }

        function calcularFinDeMes(inicioStr) {
            const inicio = new Date(inicioStr + 'T00:00:00');
            const fin = new Date(inicio.getFullYear(), inicio.getMonth() + 1, 0);
            return formatDate(fin);
        }

        // ========================================
        // VISTAS
        // ========================================

        function mostrarVistaLista() {
            document.getElementById('vista-lista-coaches').classList.remove('hidden');
            document.getElementById('vista-dashboard-coach').classList.add('hidden');
            document.getElementById('btn-volver-lista').classList.add('hidden');
            currentCoachId = null;
            currentPagoId = null; // Limpiar periodo seleccionado
            renderCoachesList();
        }

        function mostrarVistaDashboard(coachId) {
            currentCoachId = coachId;
            currentPagoId = null; // Limpiar para que se seleccione el m√°s reciente
            document.getElementById('vista-lista-coaches').classList.add('hidden');
            document.getElementById('vista-dashboard-coach').classList.remove('hidden');
            document.getElementById('btn-volver-lista').classList.remove('hidden');
            renderDashboard();
        }

        // ========================================
        // LISTA DE COACHES
        // ========================================

        function renderCoachesList() {
            const data = loadData();
            const grid = document.getElementById('grid-coaches');
            const mensaje = document.getElementById('mensaje-sin-coaches');
            const busqueda = document.getElementById('buscar-coach').value.toLowerCase();
            
            let coaches = data.coaches.filter(c => 
                c.nombre.toLowerCase().includes(busqueda)
            );

            if (coaches.length === 0) {
                grid.innerHTML = '';
                mensaje.classList.remove('hidden');
                return;
            }

            mensaje.classList.add('hidden');
            
            grid.innerHTML = coaches.map(coach => {
                const diasTexto = getDiasTexto(coach.diasLaborables);
                const pagos = data.pagos[coach.id] || [];
                const totalPagos = pagos.length;
                
                return `
                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-5 hover:shadow-md transition-shadow cursor-pointer"
                         onclick="mostrarVistaDashboard('${coach.id}')">
                        <div class="flex items-start justify-between mb-3">
                            <h3 class="text-lg font-bold text-gray-900">${coach.nombre}</h3>
                            <span class="px-2 py-1 text-xs font-semibold bg-green-100 text-green-700 rounded">Activo</span>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-500">D√≠as laborables:</span>
                                <span class="text-xs font-medium">${diasTexto}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">Pagos registrados:</span>
                                <span class="text-xs font-semibold text-blue-600">${totalPagos}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getDiasTexto(dias) {
            const nombres = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
            return dias.map(d => nombres[d]).join(', ');
        }

        // ========================================
        // DASHBOARD DEL COACH
        // ========================================

        function renderDashboard() {
            const data = loadData();
            const coach = data.coaches.find(c => c.id === currentCoachId);
            
            if (!coach) {
                mostrarVistaLista();
                return;
            }

            // Info del coach
            document.getElementById('coach-nombre').textContent = coach.nombre;
            document.getElementById('coach-dias').textContent = getDiasTexto(coach.diasLaborables);
            
            const pagos = data.pagos[currentCoachId] || [];
            document.getElementById('coach-total-pagos').textContent = pagos.length;

            // Verificar si hay pagos
            if (pagos.length === 0) {
                // Sin pagos: mostrar mensaje
                document.getElementById('mensaje-sin-pagos').classList.remove('hidden');
                document.getElementById('contenido-con-pagos').classList.add('hidden');
            } else {
                // Con pagos: mostrar contenido
                document.getElementById('mensaje-sin-pagos').classList.add('hidden');
                document.getElementById('contenido-con-pagos').classList.remove('hidden');
                
                // Cargar selector de periodos
                cargarSelectorPeriodos();
                
                // Si no hay periodo seleccionado, seleccionar el m√°s reciente
                if (!currentPagoId) {
                    currentPagoId = pagos[pagos.length - 1].id;
                }
                
                // Renderizar calendario y m√©tricas del periodo
                renderCalendarioPeriodo();
                renderHistorialPagos();
            }
        }

        function cargarSelectorPeriodos() {
            const data = loadData();
            const pagos = (data.pagos[currentCoachId] || []).sort((a, b) => 
                new Date(a.periodoInicio) - new Date(b.periodoInicio)
            );
            
            const selector = document.getElementById('select-periodo-pago');
            
            selector.innerHTML = pagos.map(pago => `
                <option value="${pago.id}" ${pago.id === currentPagoId ? 'selected' : ''}>
                    ${formatDateDisplay(pago.periodoInicio)} - ${formatDateDisplay(pago.periodoFin)} 
                    (${formatCurrency(pago.monto)})
                </option>
            `).join('');
        }

        // ========================================
        // CALENDARIO
        // ========================================

        function getDiasLaborablesPeriodo(inicio, fin, diasLaborables) {
            const days = [];
            const inicioDate = new Date(inicio + 'T00:00:00');
            const finDate = new Date(fin + 'T00:00:00');
            
            let currentDate = new Date(inicioDate);
            
            while (currentDate <= finDate) {
                const dayOfWeek = currentDate.getDay();
                if (diasLaborables.includes(dayOfWeek)) {
                    days.push(formatDate(currentDate));
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            return days;
        }

        function renderCalendarioPeriodo() {
            const data = loadData();
            const coach = data.coaches.find(c => c.id === currentCoachId);
            const pago = (data.pagos[currentCoachId] || []).find(p => p.id === currentPagoId);
            
            if (!pago) return;
            
            const grid = document.getElementById('calendar-grid');
            const periodoLabel = document.getElementById('periodo-label');
            
            periodoLabel.textContent = `${formatDateDisplay(pago.periodoInicio)} - ${formatDateDisplay(pago.periodoFin)}`;
            
            const days = getDiasLaborablesPeriodo(pago.periodoInicio, pago.periodoFin, coach.diasLaborables);
            const asistencias = data.asistencias[currentCoachId] || {};
            
            // Determinar n√∫mero de columnas
            const maxDias = coach.diasLaborables.length;
            
            let html = `<div class="grid grid-cols-${maxDias} gap-2 min-w-max">`;
            
            // Headers
            const diasNombres = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
            coach.diasLaborables.forEach(dia => {
                html += `<div class="text-xs font-semibold text-gray-700 text-center py-2">${diasNombres[dia]}</div>`;
            });
            
            // Renderizar d√≠as agrupados por semana
            let diaIndex = 0;
            let semanaIniciada = false;
            
            days.forEach(dateStr => {
                const asist = asistencias[dateStr] || { asistio: false, reposicion: false };
                
                html += `
                    <div class="border border-gray-200 rounded-lg p-3 ${asist.asistio ? 'bg-green-50' : 'bg-gray-50'}"
                         oncontextmenu="toggleReposicion('${dateStr}'); return false;">
                        <p class="text-xs text-gray-400 mb-2">${formatDateDisplay(dateStr).split('/').slice(0,2).join('/')}</p>
                        <label class="flex items-center gap-2 text-xs cursor-pointer">
                            <input 
                                type="checkbox" 
                                ${asist.asistio ? 'checked' : ''}
                                onchange="toggleAsistencia('${dateStr}')"
                                class="rounded border-gray-300"
                            >
                            <span>Asisti√≥</span>
                        </label>
                        ${asist.reposicion ? '<span class="inline-block mt-2 px-2 py-0.5 text-xs font-semibold text-blue-700 bg-blue-100 rounded">R</span>' : ''}
                    </div>
                `;
            });
            
            html += '</div>';
            grid.innerHTML = html;
            
            updateMetrics();
        }

        function toggleAsistencia(dateStr) {
            const data = loadData();
            
            if (!data.asistencias[currentCoachId]) {
                data.asistencias[currentCoachId] = {};
            }
            
            if (!data.asistencias[currentCoachId][dateStr]) {
                data.asistencias[currentCoachId][dateStr] = { asistio: false, reposicion: false };
            }
            
            data.asistencias[currentCoachId][dateStr].asistio = !data.asistencias[currentCoachId][dateStr].asistio;
            saveData(data);
            updateMetrics();
        }

        function toggleReposicion(dateStr) {
            const data = loadData();
            
            if (!data.asistencias[currentCoachId]) {
                data.asistencias[currentCoachId] = {};
            }
            
            if (!data.asistencias[currentCoachId][dateStr]) {
                data.asistencias[currentCoachId][dateStr] = { asistio: false, reposicion: false };
            }
            
            data.asistencias[currentCoachId][dateStr].reposicion = !data.asistencias[currentCoachId][dateStr].reposicion;
            saveData(data);
            renderCalendarioPeriodo();
        }

        function updateMetrics() {
            const data = loadData();
            const coach = data.coaches.find(c => c.id === currentCoachId);
            const pago = (data.pagos[currentCoachId] || []).find(p => p.id === currentPagoId);
            
            if (!pago) return;
            
            const days = getDiasLaborablesPeriodo(pago.periodoInicio, pago.periodoFin, coach.diasLaborables);
            const asistencias = data.asistencias[currentCoachId] || {};
            
            const programadas = days.length;
            let asistidas = 0;
            let reposiciones = 0;
            
            days.forEach(day => {
                const asist = asistencias[day];
                if (asist?.asistio) asistidas++;
                if (asist?.reposicion) reposiciones++;
            });
            
            const faltas = programadas - asistidas;
            
            document.getElementById('metric-programadas').textContent = programadas;
            document.getElementById('metric-asistidas').textContent = asistidas;
            document.getElementById('metric-faltas').textContent = faltas;
            document.getElementById('metric-reposiciones').textContent = reposiciones;
        }

        // ========================================
        // HISTORIAL DE PAGOS
        // ========================================

        function renderHistorialPagos() {
            const data = loadData();
            const pagos = (data.pagos[currentCoachId] || []).sort((a, b) => 
                new Date(b.fecha) - new Date(a.fecha)
            );
            
            const lista = document.getElementById('lista-pagos');
            
            if (pagos.length === 0) {
                lista.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">No hay pagos registrados</p>';
                return;
            }
            
            lista.innerHTML = pagos.map(pago => `
                <div class="border border-gray-200 rounded-lg p-3 hover:bg-gray-50">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <p class="text-lg font-bold text-gray-900">${formatCurrency(pago.monto)}</p>
                            <p class="text-xs text-gray-500">Pagado: ${formatDateDisplay(pago.fecha)}</p>
                            <p class="text-xs text-blue-600 font-medium mt-1">
                                Periodo: ${formatDateDisplay(pago.periodoInicio)} - ${formatDateDisplay(pago.periodoFin)}
                            </p>
                            ${pago.montoBase ? `<p class="text-xs text-gray-400">Base: ${formatCurrency(pago.montoBase)}</p>` : ''}
                        </div>
                        <button 
                            onclick="eliminarPago('${pago.id}')"
                            class="text-xs text-red-600 hover:text-red-700 ml-2"
                        >
                            ‚úï
                        </button>
                    </div>
                    <div class="grid grid-cols-4 gap-2 text-xs mt-2 pt-2 border-t border-gray-200">
                        <div>
                            <span class="text-gray-500">Prog:</span>
                            <span class="font-semibold text-gray-900">${pago.stats.programadas}</span>
                        </div>
                        <div>
                            <span class="text-green-600">Asist:</span>
                            <span class="font-semibold text-green-900">${pago.stats.asistidas}</span>
                        </div>
                        <div>
                            <span class="text-red-600">Faltas:</span>
                            <span class="font-semibold text-red-900">${pago.stats.faltas}</span>
                        </div>
                        <div>
                            <span class="text-blue-600">Repos:</span>
                            <span class="font-semibold text-blue-900">${pago.stats.reposiciones}</span>
                        </div>
                    </div>
                    ${pago.nota ? `<p class="text-xs text-gray-600 mt-2 italic">"${pago.nota}"</p>` : ''}
                </div>
            `).join('');
        }

        function eliminarPago(pagoId) {
            if (!confirm('¬øEliminar este pago?')) return;
            
            const data = loadData();
            data.pagos[currentCoachId] = data.pagos[currentCoachId].filter(p => p.id !== pagoId);
            saveData(data);
            
            // Si era el pago seleccionado, limpiar selecci√≥n
            if (currentPagoId === pagoId) {
                currentPagoId = null;
            }
            
            renderDashboard(); // Recargar todo
        }

        // ========================================
        // MODAL COACH
        // ========================================

        function abrirModalCoach(coachId = null) {
            const modal = document.getElementById('modal-coach');
            const titulo = document.getElementById('modal-coach-titulo');
            
            if (coachId) {
                // Editar
                const data = loadData();
                const coach = data.coaches.find(c => c.id === coachId);
                
                titulo.textContent = 'Editar Coach';
                document.getElementById('coach-id-input').value = coach.id;
                document.getElementById('coach-nombre-input').value = coach.nombre;
                
                // Marcar d√≠as
                document.querySelectorAll('.dia-checkbox').forEach(cb => {
                    cb.checked = coach.diasLaborables.includes(parseInt(cb.value));
                });
            } else {
                // Nuevo
                titulo.textContent = 'Agregar Coach';
                document.getElementById('form-coach').reset();
                document.getElementById('coach-id-input').value = '';
                
                // D√≠as por defecto: L-V
                document.querySelectorAll('.dia-checkbox').forEach(cb => {
                    const dia = parseInt(cb.value);
                    cb.checked = dia >= 1 && dia <= 5;
                });
            }
            
            modal.classList.remove('hidden');
        }

        function cerrarModalCoach() {
            document.getElementById('modal-coach').classList.add('hidden');
        }

        // ========================================
        // MODAL PAGO
        // ========================================

        function calcularEstadisticasPeriodo(inicio, fin, coachId, montoBase) {
            const data = loadData();
            const coach = data.coaches.find(c => c.id === coachId);
            const asistencias = data.asistencias[coachId] || {};
            
            // Obtener d√≠as laborables del periodo
            const inicioDate = new Date(inicio + 'T00:00:00');
            const finDate = new Date(fin + 'T00:00:00');
            
            const dias = [];
            let currentDate = new Date(inicioDate);
            
            while (currentDate <= finDate) {
                const dayOfWeek = currentDate.getDay();
                if (coach.diasLaborables.includes(dayOfWeek)) {
                    dias.push(formatDate(currentDate));
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            let asistidas = 0;
            let reposiciones = 0;
            
            dias.forEach(day => {
                const asist = asistencias[day];
                if (asist?.asistio) asistidas++;
                if (asist?.reposicion) reposiciones++;
            });
            
            const programadas = dias.length;
            const faltas = programadas - asistidas;
            
            // Calcular monto proporcional basado en asistencias
            const porcentajeAsistencia = programadas > 0 ? asistidas / programadas : 1;
            const montoSugerido = montoBase ? Math.round(montoBase * porcentajeAsistencia) : 0;
            
            return {
                programadas,
                asistidas,
                faltas,
                reposiciones,
                montoSugerido
            };
        }

        function actualizarResumenPago() {
            const inicio = document.getElementById('pago-periodo-inicio').value;
            const fin = document.getElementById('pago-periodo-fin').value;
            const montoBase = parseFloat(document.getElementById('pago-monto-base').value) || 0;
            
            if (!inicio || !fin || !montoBase) return;
            
            const stats = calcularEstadisticasPeriodo(inicio, fin, currentCoachId, montoBase);
            
            document.getElementById('resumen-programadas').textContent = stats.programadas;
            document.getElementById('resumen-asistidas').textContent = stats.asistidas;
            document.getElementById('resumen-faltas').textContent = stats.faltas;
            document.getElementById('resumen-reposiciones-pago').textContent = stats.reposiciones;
            document.getElementById('resumen-monto').textContent = formatCurrency(stats.montoSugerido);
            
            // Sugerir el monto calculado
            document.getElementById('pago-monto').value = stats.montoSugerido;
        }

        function abrirModalPago() {
            const modal = document.getElementById('modal-pago');
            
            document.getElementById('form-pago').reset();
            
            // Valores por defecto: mes actual
            const hoy = new Date();
            const primerDia = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
            const ultimoDia = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);
            
            document.getElementById('pago-periodo-inicio').value = formatDate(primerDia);
            document.getElementById('pago-periodo-fin').value = formatDate(ultimoDia);
            document.getElementById('pago-fecha').value = formatDate(new Date());
            
            modal.classList.remove('hidden');
        }

        function cerrarModalPago() {
            document.getElementById('modal-pago').classList.add('hidden');
        }

        // ========================================
        // EVENTOS
        // ========================================

        // Agregar coach
        document.getElementById('btn-agregar-coach').addEventListener('click', () => abrirModalCoach());
        
        // Cancelar modal coach
        document.getElementById('btn-cancelar-modal').addEventListener('click', cerrarModalCoach);
        
        // Guardar coach
        document.getElementById('form-coach').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const data = loadData();
            const coachId = document.getElementById('coach-id-input').value;
            
            const diasLaborables = Array.from(document.querySelectorAll('.dia-checkbox:checked'))
                .map(cb => parseInt(cb.value))
                .sort((a, b) => (a === 0 ? 7 : a) - (b === 0 ? 7 : b));
            
            if (diasLaborables.length === 0) {
                alert('Selecciona al menos un d√≠a laborable');
                return;
            }
            
            const coachData = {
                nombre: document.getElementById('coach-nombre-input').value.trim(),
                diasLaborables
            };
            
            if (coachId) {
                // Editar
                const index = data.coaches.findIndex(c => c.id === coachId);
                data.coaches[index] = { ...data.coaches[index], ...coachData };
            } else {
                // Crear
                coachData.id = generateId();
                coachData.fechaCreacion = formatDate(new Date());
                data.coaches.push(coachData);
            }
            
            saveData(data);
            cerrarModalCoach();
            
            if (currentCoachId) {
                renderDashboard();
            } else {
                renderCoachesList();
            }
        });
        
        // Editar coach
        document.getElementById('btn-editar-coach').addEventListener('click', () => {
            abrirModalCoach(currentCoachId);
        });
        
        // Eliminar coach
        document.getElementById('btn-eliminar-coach').addEventListener('click', () => {
            if (!confirm('¬øEst√°s seguro de eliminar este coach? Se eliminar√°n todas sus asistencias y pagos.')) return;
            
            const data = loadData();
            data.coaches = data.coaches.filter(c => c.id !== currentCoachId);
            delete data.asistencias[currentCoachId];
            delete data.pagos[currentCoachId];
            saveData(data);
            
            mostrarVistaLista();
        });
        
        // Volver a lista
        document.getElementById('btn-volver-lista').addEventListener('click', mostrarVistaLista);
        
        // Buscar coach
        document.getElementById('buscar-coach').addEventListener('input', renderCoachesList);
        
        // Selector de periodo
        document.getElementById('select-periodo-pago').addEventListener('change', (e) => {
            currentPagoId = e.target.value;
            renderCalendarioPeriodo();
        });
        
        // Bot√≥n registrar primer pago
        document.getElementById('btn-registrar-pago-inicio').addEventListener('click', abrirModalPago);
        
        // Registrar pago
        document.getElementById('btn-registrar-pago').addEventListener('click', abrirModalPago);
        document.getElementById('btn-cancelar-pago').addEventListener('click', cerrarModalPago);
        
        document.getElementById('form-pago').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const data = loadData();
            
            if (!data.pagos[currentCoachId]) {
                data.pagos[currentCoachId] = [];
            }
            
            const periodoInicio = document.getElementById('pago-periodo-inicio').value;
            const periodoFin = document.getElementById('pago-periodo-fin').value;
            const montoBase = parseFloat(document.getElementById('pago-monto-base').value);
            const stats = calcularEstadisticasPeriodo(periodoInicio, periodoFin, currentCoachId, montoBase);
            
            const pago = {
                id: generateId(),
                fecha: document.getElementById('pago-fecha').value,
                periodoInicio,
                periodoFin,
                montoBase,
                monto: parseFloat(document.getElementById('pago-monto').value),
                nota: document.getElementById('pago-nota').value.trim(),
                stats: {
                    programadas: stats.programadas,
                    asistidas: stats.asistidas,
                    faltas: stats.faltas,
                    reposiciones: stats.reposiciones
                }
            };
            
            data.pagos[currentCoachId].push(pago);
            saveData(data);
            
            // Seleccionar el pago reci√©n creado
            currentPagoId = pago.id;
            
            cerrarModalPago();
            renderDashboard(); // Recargar todo el dashboard
        });
        
        // Auto-calcular resumen al cambiar valores en modal de pago
        document.getElementById('pago-periodo-inicio').addEventListener('change', actualizarResumenPago);
        document.getElementById('pago-periodo-fin').addEventListener('change', actualizarResumenPago);
        document.getElementById('pago-monto-base').addEventListener('input', actualizarResumenPago);
        
        // Auto-calcular fin de periodo en pago
        document.getElementById('pago-periodo-inicio').addEventListener('change', (e) => {
            const inicio = e.target.value;
            if (inicio && !document.getElementById('pago-periodo-fin').value) {
                document.getElementById('pago-periodo-fin').value = calcularFinDeMes(inicio);
                actualizarResumenPago();
            }
        });
        
        // ========================================
        // INICIALIZACI√ìN
        // ========================================
        
        document.addEventListener('DOMContentLoaded', () => {
            mostrarVistaLista();
        });
    </script>
</body>
</html>
